---
phase: 7
plan: 1
title: "Prefix-first prompt assembly in protocol and vibe"
wave: 1
depends_on: []
must_haves:
  - "Execute-protocol injects compiled context content (not file path) as the first block of every Dev agent's Task description"
  - "Vibe Plan mode injects compiled context content at the top of Lead agent's Task description"
  - "Phase number moved from stable prefix header to volatile tail (enables cross-phase cache reuse)"
allowed_paths:
  - "references/execute-protocol.md"
  - "commands/vibe.md"
---

# Plan 07-01: Prefix-First Prompt Assembly in Protocol and Vibe

## Context

Currently, execute-protocol.md tells the orchestrator to pass a file path reference (`Phase context: {phase-dir}/.context-dev.md`) in Dev TaskCreate descriptions. The Dev agent then reads this file as a tool call mid-conversation. Because Anthropic's prompt cache operates on system prompt + leading user messages, tool results mid-conversation do NOT trigger cache hits.

The fix: inject the compiled context content verbatim as the FIRST block of every Task description. When multiple sibling Dev agents receive byte-identical content from position 0, the API caches the shared prefix and subsequent agents get cache reads instead of cold reads.

Similarly, vibe.md Plan mode step 4 compiles context and passes it as a file reference to Lead. It should inject the content directly.

The phase number must also move out of the stable prefix header into the volatile tail so that cross-phase reuse is possible (the prefix stays identical even when phase changes).

## Tasks

### Task 1: Refactor execute-protocol.md Dev TaskCreate template

**Files:** `references/execute-protocol.md`

Replace lines 183-196 (the Dev TaskCreate template) to inject compiled context content as the first block of the description, with the volatile per-agent instructions after.

Current pattern (file path reference):
```
description: |
  Execute all tasks in {PLAN_PATH}.
  Effort: {DEV_EFFORT}. Working directory: {pwd}.
  Model: ${DEV_MODEL}
  Phase context: {phase-dir}/.context-dev.md (if compiled)
  ...
```

New pattern (prefix-first injection):
```
description: |
  {COMPILED_CONTEXT_CONTENT}

  Execute all tasks in {PLAN_PATH}.
  Effort: {DEV_EFFORT}. Working directory: {pwd}.
  Model: ${DEV_MODEL}
  ...
```

Where `{COMPILED_CONTEXT_CONTENT}` is the literal file content of `.context-dev.md` read by the orchestrator (Lead) before spawning Dev agents. Add a note: "Read the compiled context file content into a variable BEFORE creating Dev tasks. All sibling Dev agents MUST receive byte-identical prefix content for cache hits."

Also update the context compilation section (lines 150-154) to clarify that the orchestrator reads the file content into a variable (not just passes the path).

Acceptance criteria:
- TaskCreate description starts with compiled context content, not a file path reference
- `Phase context: {phase-dir}/.context-dev.md` line is removed
- Clear instruction that orchestrator reads file content into variable before TaskCreate loop
- Volatile per-agent instructions (PLAN_PATH, resume state, autonomous flag) come AFTER the compiled context block

### Task 2: Refactor vibe.md Plan mode to inject compiled context into Lead prompt

**Files:** `commands/vibe.md`

Update Plan mode step 4 (line 214) and step 6 (line 248) so compiled context content is injected verbatim as the first block of the Lead agent's Task description, not passed as a file reference.

Current (step 4, line 214):
```
4. **Context compilation:** If `config_context_compiler=true`, run `yolo compile-context {phase} lead {phases_dir}`. Include `.context-lead.md` in Lead agent context if produced.
```

New:
```
4. **Context compilation:** If `config_context_compiler=true`, run `yolo compile-context {phase} lead {phases_dir}`. Read the output file `.context-lead.md` content into variable LEAD_CONTEXT for injection into the Lead agent's Task description.
```

Update step 6 (line 248) from:
```
- Spawn yolo-lead as subagent via Task tool with compiled context (or full file list as fallback).
```

To specify that the Task description starts with `{LEAD_CONTEXT}` content as the first block, followed by the planning instructions.

Acceptance criteria:
- Plan mode reads `.context-lead.md` content into a variable
- Lead Task description begins with compiled context content (prefix-first)
- Planning-specific instructions (phase goal, parallel dev guidance) come after the prefix

### Task 3: Move phase number from stable prefix to volatile tail markers

**Files:** `references/execute-protocol.md`, `commands/vibe.md`

Update all references to the compiled context format to reflect that `phase=N` should be in the volatile tail, not the stable prefix header. This means:
- The stable prefix header becomes `--- COMPILED CONTEXT (role={role}) ---` (no phase)
- The volatile tail section becomes `--- VOLATILE TAIL (phase={phase}) ---`

In execute-protocol.md: update any documentation of the compiled context format to show the new header.
In vibe.md: same â€” any references to the format markers.

Add a note in execute-protocol.md context compilation section: "Phase number is excluded from the stable prefix to enable cross-phase cache reuse. It appears in the volatile tail instead."

Acceptance criteria:
- Documentation shows `--- COMPILED CONTEXT (role={role}) ---` without phase in header
- Phase number appears in volatile tail marker
- Comment/note explains why (cross-phase cache reuse)

### Task 4: Commit protocol and vibe changes

Stage and commit:
```
feat(07-01): prefix-first prompt assembly for cache-optimal context injection
```
