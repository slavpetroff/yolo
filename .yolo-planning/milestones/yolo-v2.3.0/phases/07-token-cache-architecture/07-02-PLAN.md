---
phase: 7
plan: 2
title: "Stable/volatile split in Rust compile_context and report upgrade"
wave: 1
depends_on: []
must_haves:
  - "compile_context MCP tool returns separate stable_prefix and volatile_tail fields (plus prefix_hash and prefix_bytes)"
  - "compile-context CLI emits <!-- STABLE_PREFIX_END --> sentinel between stable and volatile sections"
  - "yolo report uses actual AVG(output_length) from telemetry DB instead of hardcoded 80K assumption"
  - "All existing tests pass + new tests for stable/volatile split"
allowed_paths:
  - "yolo-mcp-server/src/mcp/tools.rs"
  - "yolo-mcp-server/src/cli/router.rs"
  - "tests/mcp-integration.bats"
---

# Plan 07-02: Stable/Volatile Split in Rust + Report Upgrade

## Context

The `compile_context` MCP tool (tools.rs lines 22-97) currently returns a single fused JSON `{"content": [{"type": "text", "text": combined}]}` where `combined` includes BOTH stable files (CONVENTIONS.md, STACK.md, ROADMAP.md) AND volatile content (plan files, git diff). Callers cannot distinguish stable from volatile, preventing cache-aware prompt construction.

The `compile-context` CLI command (router.rs lines 324-386) similarly writes a single `.context-{role}.md` file without marking where stable ends and volatile begins.

The `yolo report` command (router.rs lines 8-41) uses `assumed_prefix_size = 80_000` and a hardcoded `1:10` write:read ratio. The telemetry DB already stores `output_length` per tool call — the report should use actual measured data.

## Tasks

### Task 1: Split MCP compile_context into stable_prefix + volatile_tail

**Files:** `yolo-mcp-server/src/mcp/tools.rs`

Refactor the `compile_context` handler (lines 22-97) to build stable and volatile content separately:

1. Build `stable_prefix` from the role-gated files (CONVENTIONS.md, STACK.md, ROADMAP.md, etc.) with header `--- COMPILED CONTEXT (role={role}) ---` (no phase number).
2. Build `volatile_tail` from phase-specific plan files and git diff, with header `--- VOLATILE TAIL (phase={phase}) ---`.
3. Compute `prefix_hash` as a hex-encoded SHA-256 of `stable_prefix` bytes (use the `sha2` crate, or a simple FNV/CRC if sha2 is not already a dependency — check Cargo.toml first. If neither is available, use `format!("{:x}", stable_prefix.len())` as a lightweight fingerprint).
4. Compute `prefix_bytes` as `stable_prefix.len()`.
5. Return JSON:
```json
{
  "content": [{"type": "text", "text": "{stable_prefix}\n{volatile_tail}"}],
  "stable_prefix": "{stable_prefix}",
  "volatile_tail": "{volatile_tail}",
  "prefix_hash": "{hash}",
  "prefix_bytes": N
}
```

The `content` field preserves backward compat (fused text). The new fields enable cache-aware callers.

Acceptance criteria:
- `stable_prefix` contains only role-gated reference files, no plan files or git diff
- `volatile_tail` contains plan files and git diff
- `prefix_hash` and `prefix_bytes` present in response
- Phase number NOT in stable prefix header (in volatile tail header instead)
- `content` field still contains the combined text (backward compat)

### Task 2: Add sentinel to CLI compile-context output

**Files:** `yolo-mcp-server/src/cli/router.rs`

Update the `compile-context` CLI handler (lines 324-386) to emit a `<!-- STABLE_PREFIX_END -->` sentinel between the stable context files and the volatile plan files / git diff.

Current flow:
1. Write header `--- COMPILED CONTEXT (phase={phase}, role={role}) ---`
2. Append reference files
3. Append plan files
4. Write footer `--- END COMPILED CONTEXT ---`

New flow:
1. Write header `--- COMPILED CONTEXT (role={role}) ---` (remove phase from header)
2. Append reference files
3. Emit `<!-- STABLE_PREFIX_END -->`
4. Write `--- VOLATILE TAIL (phase={phase}) ---`
5. Append plan files
6. Write footer `--- END COMPILED CONTEXT ---`

Acceptance criteria:
- `.context-{role}.md` output contains `<!-- STABLE_PREFIX_END -->` sentinel
- Phase number is in volatile tail header, not stable prefix header
- Reference files appear before sentinel, plan files after
- Existing callers that read the full file still work (sentinel is an HTML comment, invisible to markdown renderers)

### Task 3: Upgrade yolo report to use measured telemetry data

**Files:** `yolo-mcp-server/src/cli/router.rs`

Refactor `generate_report` and its caller in `run_cli` (lines 8-62):

1. Change `generate_report` signature to accept `avg_output_length: f64` instead of using hardcoded `80_000`.
2. In the `report` match arm, query: `SELECT AVG(output_length) FROM tool_usage WHERE tool_name = 'compile_context' AND output_length > 0`. Fall back to `80_000.0` if no rows or NULL.
3. Replace the hardcoded `1:10` write ratio with a note that actual cache hit rates depend on sibling agent count. Use `writes = compile_calls.min(compile_calls)` and `reads = 0` as conservative baseline (all cold), then show a "with prefix caching" projection using `writes = unique_sessions` where `unique_sessions = SELECT COUNT(DISTINCT session_id) FROM tool_usage WHERE tool_name = 'compile_context'` (each session writes once, reads N-1 times within the session). Fall back to the old 1:10 ratio if session_id data is unavailable.
4. Update the report header to say "Measured" instead of "Projected" when using real data.

Acceptance criteria:
- No hardcoded `80_000` when telemetry data is available
- `AVG(output_length)` query used for actual prefix size
- Session-based write/read split when session_id available
- Graceful fallback to old behavior when DB has no output_length data
- Report labels distinguish "Measured" vs "Projected (no data)"

### Task 4: Update existing test and add new tests

**Files:** `yolo-mcp-server/src/cli/router.rs` (inline Rust tests), `tests/mcp-integration.bats`

1. Update the existing `test_report_basic` in router.rs (around line 460) to create a table with `output_length` column and insert a realistic row so the measured-data path is exercised.
2. Add a bats test in `tests/mcp-integration.bats` that verifies the CLI `compile-context` output contains the `<!-- STABLE_PREFIX_END -->` sentinel.
3. Add a bats test that verifies `--- COMPILED CONTEXT (role=dev) ---` header does NOT contain `phase=`.

Acceptance criteria:
- `cargo test` passes with updated report test
- Bats test confirms sentinel presence in CLI output
- Bats test confirms phase-free stable prefix header

### Task 5: Commit Rust changes and tests

Stage and commit:
```
feat(07-02): split compile_context stable/volatile and upgrade report to measured telemetry
```
