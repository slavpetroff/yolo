---
phase: 5
plan: 02
title: "Tools.rs: Role-Filtered Context, Async Commands, Dynamic Test Runner"
wave: 1
depends_on: []
must_haves:
  - "compile_context filters files based on role parameter (architect sees all, dev sees subset)"
  - "compile_context filters by phase parameter (only includes phase-relevant planning artifacts)"
  - "All external process calls in tools.rs use tokio::process::Command instead of std::process::Command"
  - "run_test_suite auto-detects test runner from project context (cargo/bats/pytest/npm)"
  - "All existing tools.rs tests pass plus new tests for role filtering and test runner detection"
  - "cargo build succeeds with no warnings"
---

## Tasks

### Task 1: Replace std::process::Command with tokio::process::Command
- **Commit:** `fix(tools): replace blocking std::process::Command with tokio async equivalent`
- **Files:** `yolo-mcp-server/src/mcp/tools.rs`
- **Description:**
  Currently tools.rs:5 imports `std::process::Command` and uses it at line 43 (git diff in compile_context) and line 106 (npm test in run_test_suite). Both block the tokio worker thread. Fix:
  1. Replace `use std::process::Command` with `use tokio::process::Command`.
  2. Update the git diff call in compile_context (line 43) to use `Command::new("git").arg("diff").arg("HEAD").output().await`.
  3. Update the npm test call in run_test_suite (line 106) similarly with `.output().await`.
  4. Ensure error handling matches the existing pattern (Ok/Err match on output).

### Task 2: Add role-based filtering to compile_context
- **Commit:** `feat(tools): filter compile_context output by role parameter`
- **Files:** `yolo-mcp-server/src/mcp/tools.rs`
- **Description:**
  Currently compile_context (tools.rs:22-58) reads `role` from params but ignores it entirely, blindly concatenating 5 files. Implement role-based filtering:
  1. Parse `role` from params (already done at conceptual level, need to actually extract it).
  2. Define a file-inclusion map per role:
     - `architect` / `lead`: all 5 files (ARCHITECTURE.md, STACK.md, CONVENTIONS.md, ROADMAP.md, REQUIREMENTS.md)
     - `senior` / `dev`: CONVENTIONS.md, STACK.md, ROADMAP.md (skip ARCHITECTURE.md full dump and REQUIREMENTS.md)
     - `qa` / `security`: CONVENTIONS.md, REQUIREMENTS.md
     - Default/unknown: CONVENTIONS.md, ROADMAP.md (minimal context)
  3. Only read and concatenate files that match the role's inclusion list.
  4. Add a `# Role: {role}` header in the output so agents can see what context scope they received.

### Task 3: Add phase-based filtering to compile_context
- **Commit:** `feat(tools): filter compile_context by phase parameter for phase-specific artifacts`
- **Files:** `yolo-mcp-server/src/mcp/tools.rs`
- **Description:**
  The `phase` parameter is parsed (tools.rs:22) but never used for filtering. Implement phase-aware context:
  1. When `phase > 0`, look for phase-specific planning directory: `.yolo-planning/phases/{phase:02}/`.
  2. If the phase directory exists, include its `*-PLAN.md` files in the volatile tail section (capped at 2 plan files to limit token bloat).
  3. If no phase directory exists, omit phase-specific content silently.
  4. This gives agents working on a specific phase their relevant plan context without dumping all phases.

### Task 4: Implement dynamic test runner detection in run_test_suite
- **Commit:** `feat(tools): auto-detect test runner from project context`
- **Files:** `yolo-mcp-server/src/mcp/tools.rs`
- **Description:**
  Currently run_test_suite (tools.rs:106-108) hardcodes `Command::new("npm")`. Implement auto-detection:
  1. Check for runner indicator files relative to cwd:
     - `Cargo.toml` exists -> use `cargo test` with `test_path` as `--test` arg or `-- {test_path}` filter
     - `tests/` dir with `.bats` files -> use `bats` with `test_path`
     - `pytest.ini` or `pyproject.toml` with `[tool.pytest]` -> use `pytest` with `test_path`
     - `package.json` exists (fallback) -> use `npm test -- {test_path}`
  2. Check in priority order: Cargo.toml first (since this is a Rust project), then bats, pytest, npm.
  3. Return a clear error message if no test runner is detected.

### Task 5: Add tests for role/phase filtering and test runner detection
- **Commit:** `test(tools): add tests for role filtering, phase context, and dynamic test runner`
- **Files:** `yolo-mcp-server/src/mcp/tools.rs`
- **Description:**
  Add tests in the existing `#[cfg(test)] mod tests` block:
  1. `test_compile_context_role_filtering`: Call compile_context with role=dev and role=architect in a temp dir with all 5 files present. Verify dev output excludes ARCHITECTURE.md while architect includes it.
  2. `test_compile_context_phase_filtering`: Create a temp dir with `.yolo-planning/phases/03/03-01-PLAN.md`, call with phase=3, verify plan content appears in output.
  3. `test_run_test_suite_detects_cargo`: Create temp dir with `Cargo.toml`, call run_test_suite. Verify the command attempted is cargo-based (will fail to run but error message should reference cargo, not npm).
  4. `test_run_test_suite_detects_bats`: Create temp dir with `tests/foo.bats`, verify bats detection.
  5. Update `test_compile_context_returns_content` to pass a role parameter.
