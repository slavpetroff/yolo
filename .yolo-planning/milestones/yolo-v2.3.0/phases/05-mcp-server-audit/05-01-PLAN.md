---
phase: 5
plan: 01
title: "Concurrent Request Handling & Telemetry Capture"
wave: 1
depends_on: []
must_haves:
  - "MCP server spawns each request via tokio::spawn + mpsc channel for ordered response writes"
  - "Telemetry records actual serialized input/output byte lengths instead of hardcoded 0,0"
  - "All existing server.rs tests pass plus new tests for concurrent request handling"
  - "cargo build succeeds with no warnings"
---

## Tasks

### Task 1: Refactor run_server to use tokio::spawn + mpsc for concurrent request handling
- **Commit:** `feat(mcp): add concurrent request handling via tokio::spawn and mpsc channel`
- **Files:** `yolo-mcp-server/src/mcp/server.rs`
- **Description:**
  Currently `run_server` (server.rs:16-50) calls `handle_request` inline in the read loop, blocking the reader until each request completes. Refactor to:
  1. Create a `tokio::sync::mpsc::channel<String>` for serialized responses.
  2. In the read loop, for each `IncomingMessage::Request`, clone the necessary `Arc`s and `tokio::spawn` a task that calls `handle_request`, serializes the `Response`, and sends the string through the mpsc sender.
  3. Spawn a separate writer task that receives from the mpsc receiver and writes + flushes to stdout sequentially (preserving output ordering per-send).
  4. For notifications and parse errors, continue handling them inline (notifications are fire-and-forget; parse errors need immediate response).
  5. Await both the reader loop and the writer task to completion.

### Task 2: Capture real telemetry input/output byte lengths
- **Commit:** `fix(telemetry): record actual request/response byte lengths instead of hardcoded zeros`
- **Files:** `yolo-mcp-server/src/mcp/server.rs`
- **Description:**
  Currently `record_tool_call` at server.rs:173-181 passes `0, 0` for `input_length` and `output_length`. Fix:
  1. Before dispatching, compute `input_length` from the raw JSON line byte length (`line.len()`).
  2. After serializing the response, compute `output_length` from `response_str.len()`.
  3. Pass these through to `record_tool_call` in the spawned task.
  4. For the `method` field in telemetry, when the method is `tools/call`, record the actual tool name (e.g. `compile_context`) instead of just `tools/call`.

### Task 3: Add tests for concurrent request handling and telemetry accuracy
- **Commit:** `test(mcp): add concurrent handling and telemetry byte-length tests`
- **Files:** `yolo-mcp-server/src/mcp/server.rs`
- **Description:**
  Add new tests in the `#[cfg(test)] mod tests` block:
  1. `test_concurrent_requests`: Send multiple slow-ish requests (e.g. multiple `tools/call` for `compile_context`) through `run_server` and verify all responses are received without deadlock or dropped messages.
  2. `test_telemetry_records_byte_lengths`: Send a request through `handle_request`, then query the telemetry DB to verify `input_length > 0` and `output_length > 0` (not the hardcoded 0,0).
  3. Update existing `test_run_server` if the function signature or behavior changes due to the mpsc refactor.
