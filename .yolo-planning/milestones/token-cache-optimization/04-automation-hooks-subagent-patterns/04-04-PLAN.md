---
phase: 4
plan: 04
title: "Test repair batch C: Remaining test files and YOLO_BIN-only tests"
wave: 1
depends_on: []
must_haves:
  - All remaining 16 test files migrated and passing
  - token-baseline, token-economics, phase-detect, metrics-segmentation tests all pass
  - phase0-bugfix-verify.bats updated for current CLI
  - role-isolation-runtime.bats migrated from file-guard.sh to yolo hook PreToolUse
---

# Plan 04: Test Repair Batch C — Remaining Test Files

## Background

This plan covers 16 test files not covered by plans 02 and 03. These include:
- Files that only use `$YOLO_BIN` (undefined until plan 01 adds it): 8 files
- Files that use `$SCRIPTS_DIR` scripts not covered in other plans: 8 files

This plan has NO file overlap with plans 01, 02, or 03.

## Tasks

### Task 1: Fix YOLO_BIN-only test files

**Description:** These 8 test files already use `$YOLO_BIN` (correct pattern) but fail because `YOLO_BIN` was never exported. After plan 01 adds the export, these tests should mostly work. However, some may need cwd fixes (cd to temp dir) or argument adjustments for the Rust CLI.

Review and fix each file:
- `tests/token-baseline.bats` (10 tests): Also copies `$SCRIPTS_DIR/token-baseline.sh` to temp dir (remove this, use `$YOLO_BIN` directly)
- `tests/token-economics.bats` (9 tests): Uses `$YOLO_BIN report-tokens`
- `tests/phase-detect.bats` (9 tests): Uses `$YOLO_BIN phase-detect`
- `tests/metrics-segmentation.bats` (3 tests): Uses `$YOLO_BIN metrics-report`
- `tests/tier-cache.bats` (7 tests): Covered in plan 03, skip here
- `tests/research-persistence.bats` (6 tests): Uses `$YOLO_BIN` for research commands
- `tests/research-warn.bats` (4 tests): Uses `$YOLO_BIN` for research commands
- `tests/list-todos.bats` (5 tests): Covered in plan 02, skip here

For token-baseline.bats specifically: remove the setup lines that copy scripts to temp dir. The `$YOLO_BIN` token-baseline command reads from cwd, so just `cd "$TEST_TEMP_DIR"` before running.

**Files:**
- `tests/token-baseline.bats`
- `tests/token-economics.bats`
- `tests/phase-detect.bats`
- `tests/metrics-segmentation.bats`

**Acceptance criteria:**
- No references to `$SCRIPTS_DIR` in token-baseline.bats
- All 31 tests pass with `$YOLO_BIN` properly defined
- Tests use `cd "$TEST_TEMP_DIR"` for cwd-sensitive commands

### Task 2: Fix phase0-bugfix-verify.bats

**Description:** `tests/phase0-bugfix-verify.bats` (18 tests) references 5 scripts: compile-context.sh, route-monorepo.sh, session-start.sh, task-verify.sh, update-state.sh. Map each:
- `compile-context.sh` -> `"$YOLO_BIN" compile-context`
- `route-monorepo.sh` -> `"$YOLO_BIN" route-monorepo`
- `session-start.sh` -> `"$YOLO_BIN" session-start`
- `task-verify.sh` -> pipe JSON to `yolo hook PostToolUse`
- `update-state.sh` -> `"$YOLO_BIN" update-state`

**Files:**
- `tests/phase0-bugfix-verify.bats`

**Acceptance criteria:**
- 0 references to `$SCRIPTS_DIR`
- All 18 tests pass

### Task 3: Fix role-isolation test files

**Description:** Update these files:
- `tests/role-isolation-runtime.bats` (6 tests): `file-guard.sh` -> `yolo hook PreToolUse` (security_filter handles file access checks). Tests verify that the PreToolUse hook blocks file access outside allowed paths.
- `tests/role-isolation.bats` (11 failing): `file-guard.sh` -> same as above. Also fix agent file references (yolo-qa.md, yolo-scout.md -> current agent files like yolo-reviewer.md).

**Files:**
- `tests/role-isolation-runtime.bats`
- `tests/role-isolation.bats`

**Acceptance criteria:**
- 0 references to `$SCRIPTS_DIR/file-guard.sh`
- All tests use `yolo hook PreToolUse` for file access checks
- All 17 tests pass

### Task 4: Fix remaining edge case test files

**Description:** Update these remaining test files:
- `tests/discovered-issues-surfacing.bats` (45 tests, ~35 failing): Fix agent file references (yolo-qa.md -> yolo-dev.md or yolo-reviewer.md) AND update content assertions to match current agent definitions. This file has no $SCRIPTS_DIR references — all failures are from missing agent files and changed content.
- `tests/mcp-integration.bats` (all passing — verify no regression)

Also create a comprehensive test run script that runs all 53 test files and reports results.

**Files:**
- `tests/discovered-issues-surfacing.bats`

**Acceptance criteria:**
- All content-check tests updated for current agent definitions
- 0 test failures in this file
- No regressions in mcp-integration.bats
