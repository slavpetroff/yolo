---
phase: 4
plan: 02
title: "Test repair batch A: CLI command tests"
wave: 1
depends_on: []
must_haves:
  - All 18 CLI-command test files migrated from $SCRIPTS_DIR/*.sh to yolo <subcommand>
  - Each test file has 0 failures after migration
  - Script-to-CLI mapping documented in test comments
---

# Plan 02: Test Repair Batch A â€” CLI Command Tests

## Background

These 18 test files invoke CLI commands via `bash "$SCRIPTS_DIR/script-name.sh"` that have been migrated to `yolo <subcommand>`. The fix pattern is consistent: replace `bash "$SCRIPTS_DIR/script-name.sh" args...` with `"$YOLO_BIN" subcommand args...` (or `cd "$TEST_TEMP_DIR" && "$YOLO_BIN" subcommand args...` when the command reads from cwd).

### Script-to-CLI Mapping (for this batch):

| Script | CLI Command | Stdin? | CWD-sensitive? |
|--------|------------|--------|----------------|
| update-state.sh | yolo update-state | No | No |
| planning-git.sh | yolo planning-git | No | Yes |
| lock-lite.sh | yolo lock | No | Yes |
| assess-plan-risk.sh | yolo assess-risk | No | Yes |
| resolve-gate-policy.sh | yolo gate-policy | No | Yes |
| generate-contract.sh | yolo generate-contract | No | Yes |
| validate-contract.sh | yolo hook PreToolUse (validate_contract) | Yes | Yes |
| contract-revision.sh | yolo contract-revision | No | Yes |
| log-event.sh | yolo log-event | No | Yes |
| rollout-stage.sh | yolo rollout-stage | No | Yes |
| smart-route.sh | yolo smart-route | No | Yes |
| migrate-config.sh | yolo migrate-config | No | No |
| persist-state-after-ship.sh | yolo persist-state | No | Yes |
| migrate-orphaned-state.sh | yolo migrate-orphaned-state | No | No |
| bootstrap/bootstrap-state.sh | yolo bootstrap state | No | Yes |
| generate-incidents.sh | yolo incidents | No | Yes |
| artifact-registry.sh | yolo artifact | No | Yes |
| two-phase-complete.sh | yolo two-phase-complete | No | Yes |

## Tasks

### Task 1: Migrate state management test files

**Description:** Update these test files to use `yolo` CLI instead of shell scripts:
- `tests/update-state.bats` (5 tests): `$SCRIPTS_DIR/update-state.sh` -> `"$YOLO_BIN" update-state`
- `tests/state-updater.bats` (4 tests): `$SCRIPTS_DIR/state-updater.sh` -> `"$YOLO_BIN" update-state`
- `tests/planning-git.bats` (6 tests): `$SCRIPTS_DIR/planning-git.sh` -> `cd "$TEST_TEMP_DIR" && "$YOLO_BIN" planning-git`
- `tests/persist-state-after-ship.bats` (23 tests): `$SCRIPTS_DIR/persist-state-after-ship.sh` -> `"$YOLO_BIN" persist-state`, `$SCRIPTS_DIR/migrate-orphaned-state.sh` -> `"$YOLO_BIN" migrate-orphaned-state`, `$SCRIPTS_DIR/bootstrap/bootstrap-state.sh` -> `"$YOLO_BIN" bootstrap state`

Key: Many commands are cwd-sensitive (they look for `.yolo-planning/` in cwd). Tests that set up temp dirs must `cd "$TEST_TEMP_DIR"` before running, or pass the planning dir path as an argument.

**Files:**
- `tests/update-state.bats`
- `tests/state-updater.bats`
- `tests/planning-git.bats`
- `tests/persist-state-after-ship.bats`

**Acceptance criteria:**
- 0 references to `$SCRIPTS_DIR` in any of these 4 files
- All 38 tests pass

### Task 2: Migrate contract and gate test files

**Description:** Update these test files:
- `tests/adaptive-governance.bats` (10 tests): `assess-plan-risk.sh` -> `"$YOLO_BIN" assess-risk`, `resolve-gate-policy.sh` -> `"$YOLO_BIN" gate-policy`
- `tests/contract-lite.bats` (10 tests): `generate-contract.sh` -> `"$YOLO_BIN" generate-contract`, `validate-contract.sh` -> `"$YOLO_BIN" hook PreToolUse` (validate_contract handler) or check if yolo has a direct validate-contract subcommand
- `tests/hard-contracts.bats` (12 tests): Same contract commands
- `tests/hard-gates.bats` (15 tests): `hard-gate.sh` -> `"$YOLO_BIN" hard-gate`, `auto-repair.sh` -> `"$YOLO_BIN" auto-repair`
- `tests/autonomy-binding.bats` (4 tests): `hard-gate.sh` -> `"$YOLO_BIN" hard-gate`

**Files:**
- `tests/adaptive-governance.bats`
- `tests/contract-lite.bats`
- `tests/hard-contracts.bats`
- `tests/hard-gates.bats`
- `tests/autonomy-binding.bats`

**Acceptance criteria:**
- 0 references to `$SCRIPTS_DIR` in any of these 5 files
- All 51 tests pass

### Task 3: Migrate event, lock, and routing test files

**Description:** Update these test files:
- `tests/lock-lite.bats` (8 tests): `lock-lite.sh` -> `cd "$TEST_TEMP_DIR" && "$YOLO_BIN" lock`
- `tests/event-id.bats` (4 tests): `log-event.sh` -> `"$YOLO_BIN" log-event`
- `tests/event-type-validation.bats` (5 tests): Same
- `tests/blocker-escalation.bats` (3 tests): `log-event.sh` -> `"$YOLO_BIN" log-event`
- `tests/rollout-stage.bats` (10 tests): `rollout-stage.sh` -> `"$YOLO_BIN" rollout-stage`
- `tests/smart-routing.bats` (5 tests): `smart-route.sh` -> `"$YOLO_BIN" smart-route`
- `tests/incidents-generation.bats` (4 tests): `generate-incidents.sh` -> `"$YOLO_BIN" incidents`
- `tests/two-phase-completion.bats` (15 tests): `two-phase-complete.sh` -> `"$YOLO_BIN" two-phase-complete`, `artifact-registry.sh` -> `"$YOLO_BIN" artifact`

**Files:**
- `tests/lock-lite.bats`
- `tests/event-id.bats`
- `tests/event-type-validation.bats`
- `tests/blocker-escalation.bats`
- `tests/rollout-stage.bats`
- `tests/smart-routing.bats`
- `tests/incidents-generation.bats`
- `tests/two-phase-completion.bats`

**Acceptance criteria:**
- 0 references to `$SCRIPTS_DIR` in any of these 8 files
- All 54 tests pass

### Task 4: Migrate config, resolve, and list test files

**Description:** Update these test files:
- `tests/config-migration.bats` (17 tests): `migrate-config.sh` -> `"$YOLO_BIN" migrate-config`, `session-start.sh` -> `"$YOLO_BIN" session-start`
- `tests/flag-dependency-validation.bats` (6 tests): `session-start.sh` -> `"$YOLO_BIN" session-start`
- `tests/resolve-agent-max-turns.bats` (8 tests): `resolve-agent-max-turns.sh` -> `"$YOLO_BIN" resolve-turns`
- `tests/resolve-agent-model.bats` (7 tests): `resolve-agent-model.sh` -> `"$YOLO_BIN" resolve-model`
- `tests/list-todos.bats` (5 tests): Already uses `$YOLO_BIN` (which will now be defined)

**Files:**
- `tests/config-migration.bats`
- `tests/flag-dependency-validation.bats`
- `tests/resolve-agent-max-turns.bats`
- `tests/resolve-agent-model.bats`
- `tests/list-todos.bats`

**Acceptance criteria:**
- 0 references to `$SCRIPTS_DIR` in these files
- `$YOLO_BIN` resolves correctly (defined in test_helper.bash from plan 04-01)
- All 43 tests pass
