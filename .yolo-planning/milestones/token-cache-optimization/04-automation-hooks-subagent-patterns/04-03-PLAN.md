---
phase: 4
plan: 03
title: "Test repair batch B: Hook handler and context tests"
wave: 1
depends_on: []
must_haves:
  - All 19 hook/context test files migrated from $SCRIPTS_DIR/*.sh to yolo hook or yolo <subcommand>
  - Each test file has 0 failures after migration
  - Hook stdin/stdout contract preserved in tests
---

# Plan 03: Test Repair Batch B â€” Hook Handler and Context Tests

## Background

These 19 test files invoke hook handlers or context-compilation scripts via `bash "$SCRIPTS_DIR/script-name.sh"`. The hooks are now handled by `yolo hook <EventName>` which reads JSON from stdin. Context compilation scripts are now `yolo compile-context`, `yolo cache-context`, etc.

### Script-to-CLI Mapping (for this batch):

| Script | CLI Command | Stdin? |
|--------|------------|--------|
| agent-start.sh | yolo hook SubagentStart | Yes (JSON) |
| agent-stop.sh | yolo hook SubagentStop | Yes (JSON) |
| agent-health.sh | (part of SubagentStart/SubagentStop/TeammateIdle hooks) | Yes |
| session-start.sh | yolo session-start (or yolo hook SessionStart) | Depends |
| session-stop.sh | yolo hook Stop | Yes |
| security-filter.sh | yolo hook PreToolUse | Yes |
| validate-commit.sh | yolo hook PreToolUse (commit validation) | Yes |
| validate-message.sh | yolo hook PostToolUse (validate_message handler) | Yes |
| task-verify.sh | yolo hook PostToolUse | Yes |
| compile-context.sh | yolo compile-context | No (args) |
| delta-files.sh | yolo delta-files | No (args) |
| cache-nuke.sh | yolo cache-nuke | No (args) |
| snapshot-resume.sh | yolo snapshot-resume | No (args) |
| token-budget.sh | yolo token-budget | No (args) |
| validate-schema.sh | (part of hook handlers) | Yes |
| control-plane.sh | yolo hard-gate / generate-contract / lock (composed) | No |
| hook-wrapper.sh | N/A (hooks.json routes to yolo binary directly now) | N/A |
| post-compact.sh | yolo hook SessionStart (with compact=true) | Yes |
| map-staleness.sh | yolo map-staleness | No (args) |
| yolo-statusline.sh | yolo statusline | Yes |

## Tasks

### Task 1: Migrate agent lifecycle test files

**Description:** Update these test files:
- `tests/agent-health.bats` (6 tests): `agent-health.sh start|idle|stop` -> pipe JSON to `yolo hook SubagentStart`, `yolo hook TeammateIdle`, `yolo hook SubagentStop`. The hook handlers read `agent_type` and `pid` from JSON stdin.
- `tests/agent-health-integration.bats` (3 tests): Same pattern, integration scenarios.

Key difference: The old shell scripts accepted subcommands (`agent-health.sh start|idle|stop`), but the Rust handlers are split across hook events. Map:
- `agent-health.sh start` -> `echo '{"agent_type":"yolo-qa","pid":"123"}' | yolo hook SubagentStart`
- `agent-health.sh idle` -> `echo '{"agent_type":"yolo-qa"}' | yolo hook TeammateIdle`
- `agent-health.sh stop` -> `echo '{"agent_type":"yolo-qa"}' | yolo hook SubagentStop`

**Files:**
- `tests/agent-health.bats`
- `tests/agent-health-integration.bats`

**Acceptance criteria:**
- 0 references to `$SCRIPTS_DIR/agent-health.sh`
- All 9 tests pass
- Tests verify hook JSON output format (hookSpecificOutput)

### Task 2: Migrate context compilation and delta test files

**Description:** Update these test files:
- `tests/context-index.bats` (6 tests): `compile-context.sh` -> `cd "$TEST_TEMP_DIR" && "$YOLO_BIN" compile-context`
- `tests/code-slices.bats` (3 tests): Same
- `tests/delta-context.bats` (5 tests): `compile-context.sh` -> `"$YOLO_BIN" compile-context`, `delta-files.sh` -> `"$YOLO_BIN" delta-files`
- `tests/tier-cache.bats` (7 tests): Already uses `$YOLO_BIN` (now defined), just needs cwd fixes
- `tests/statusline-cache-isolation.bats` (10 tests): `yolo-statusline.sh` -> `"$YOLO_BIN" statusline`, `cache-nuke.sh` -> `"$YOLO_BIN" cache-nuke`

**Files:**
- `tests/context-index.bats`
- `tests/code-slices.bats`
- `tests/delta-context.bats`
- `tests/tier-cache.bats`
- `tests/statusline-cache-isolation.bats`

**Acceptance criteria:**
- 0 references to `$SCRIPTS_DIR` in these 5 files
- All 31 tests pass

### Task 3: Migrate validation and protocol test files

**Description:** Update these test files:
- `tests/typed-protocol.bats` (17 tests): `validate-message.sh` -> The Rust handler `validate_message` is invoked via hooks. However, since validate-message is a pure validation function, check if `yolo` has a direct CLI subcommand for it. If not, tests should pipe the message JSON through `yolo hook PostToolUse` with appropriate tool_input wrapping.
- `tests/validate-commit.bats` (4 tests): `validate-commit.sh` -> pipe commit JSON through `echo '...' | yolo hook PreToolUse`
- `tests/shutdown-protocol.bats` (32 tests): Fix BOTH agent-file references (yolo-qa.md, yolo-scout.md -> yolo-reviewer.md) AND `validate-message.sh` -> same as typed-protocol
- `tests/task-verify.bats` (14 tests): `task-verify.sh` -> `echo '...' | yolo hook PostToolUse`

**Files:**
- `tests/typed-protocol.bats`
- `tests/validate-commit.bats`
- `tests/shutdown-protocol.bats`
- `tests/task-verify.bats`

**Acceptance criteria:**
- 0 references to `$SCRIPTS_DIR` in these 4 files
- All tests pass
- Hook JSON input/output contracts preserved

### Task 4: Migrate session, token, and runtime test files

**Description:** Update these test files:
- `tests/sessionstart-compact-hooks.bats` (14 tests): `session-start.sh` -> `"$YOLO_BIN" session-start` or `yolo hook SessionStart`, `hook-wrapper.sh` -> tests are now obsolete (hooks route directly to yolo binary, no shell wrapper). Convert hook-wrapper tests to verify hooks.json dispatches correctly.
- `tests/runtime-foundations.bats` (13 tests): `log-event.sh` -> `"$YOLO_BIN" log-event`, `snapshot-resume.sh` -> `"$YOLO_BIN" snapshot-resume`, `validate-schema.sh` -> covered by hook handlers
- `tests/token-budgets.bats` (18 tests): `token-budget.sh` -> `"$YOLO_BIN" token-budget`

**Files:**
- `tests/sessionstart-compact-hooks.bats`
- `tests/runtime-foundations.bats`
- `tests/token-budgets.bats`

**Acceptance criteria:**
- 0 references to `$SCRIPTS_DIR` in these 3 files
- Obsolete hook-wrapper tests converted to hooks.json structure tests
- All tests pass

### Task 5: Migrate remaining test files

**Description:** Update these test files:
- `tests/control-plane.bats` (18 tests): References 6 scripts (compile-context, control-plane, generate-contract, hard-gate, lease-lock, lock-lite). Map each to its yolo subcommand.
- `tests/advanced-scale.bats` (14 tests): `lease-lock.sh` -> `"$YOLO_BIN" lease-lock`, `recover-state.sh` -> `"$YOLO_BIN" recover-state`, `route-monorepo.sh` -> `"$YOLO_BIN" route-monorepo`
- `tests/resolve-claude-dir.bats` (18 tests): Tests checking scripts for CLAUDE_PLUGIN_ROOT patterns. Many of these are now obsolete since there are no shell scripts. Convert to test the Rust binary's plugin-root resolution behavior.
- `tests/discovery-research.bats` (3 failing): `$CLAUDE_PLUGIN_ROOT/scripts/bootstrap/bootstrap-requirements.sh` -> `"$YOLO_BIN" bootstrap requirements`
- `tests/research-persistence.bats` (6 tests): Uses `$YOLO_BIN` (now defined)
- `tests/research-warn.bats` (4 tests): Uses `$YOLO_BIN` (now defined)

**Files:**
- `tests/control-plane.bats`
- `tests/advanced-scale.bats`
- `tests/resolve-claude-dir.bats`
- `tests/discovery-research.bats`
- `tests/research-persistence.bats`
- `tests/research-warn.bats`

**Acceptance criteria:**
- 0 references to `$SCRIPTS_DIR` or `scripts/` in invocations
- Obsolete shell-script-existence tests converted to CLI behavior tests
- All tests pass
