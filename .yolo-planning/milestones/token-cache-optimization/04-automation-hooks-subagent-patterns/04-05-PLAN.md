---
phase: 4
plan: 05
title: "Automation hooks: post-edit test validation and session-start cache warming"
wave: 2
depends_on: [01, 02, 03, 04]
must_haves:
  - PostToolUse hook runs test validation after Dev agent Write/Edit operations (configurable)
  - SessionStart hook includes cache warming for compile-context tier 1 prefix
  - Both hooks registered in hooks.json
  - New tests for both hook behaviors
  - Feature flag in config.json to enable/disable each hook
---

# Plan 05: Automation Hooks Implementation

## Background

Phase 4 requires at least 2 new automation hooks. The ROADMAP specifies: "lint after edit, test validation, cache warming on session start."

Currently, the hook system in hooks.json routes all events to `yolo hook <EventName>`, which dispatches to Rust handlers in `src/hooks/dispatcher.rs`. Adding new hooks means:
1. Implementing new handler logic in existing or new Rust modules
2. Wiring them into the dispatcher
3. Adding feature flags for configurability
4. Writing bats tests

**Hook 1: Post-Edit Test Validation** — After a Dev agent writes or edits a file, check if corresponding test files exist and surface a reminder. This is advisory (exit 0), not blocking.

**Hook 2: Session-Start Cache Warming** — On session start, pre-compile the tier 1 context prefix so the first compile_context MCP call is fast. Write to `.yolo-planning/.context-cache/tier1.md`.

## Tasks

### Task 1: Implement post-edit test validation hook

**Description:** Add a new handler `test_validation` in `src/hooks/` that:
1. Triggers on PostToolUse events where tool_name is Write or Edit
2. Extracts the file path from tool_input
3. Checks if a corresponding test file exists (e.g., `src/commands/foo.rs` -> `tests/foo.bats`, or by convention)
4. If the file was modified but no test file exists, returns advisory output suggesting test creation
5. If a test file exists, returns advisory output reminding to run tests
6. Gated behind a new feature flag `v4_post_edit_test_check` (default: false)

Wire into `handle_post_tool_use()` in dispatcher.rs (after existing validators).

**Files:**
- `yolo-mcp-server/src/hooks/test_validation.rs` (new)
- `yolo-mcp-server/src/hooks/mod.rs` (add module)
- `yolo-mcp-server/src/hooks/dispatcher.rs` (wire into PostToolUse)
- `config/defaults.json` (add v4_post_edit_test_check flag)

**Acceptance criteria:**
- Handler detects Write/Edit to source files and returns advisory
- Feature flag gates the behavior (disabled by default)
- Non-blocking: always exit 0

### Task 2: Implement session-start cache warming hook

**Description:** Add cache warming logic to the existing `handle_session_start()` in dispatcher.rs:
1. After map_staleness check, if `.yolo-planning/` exists and has config, pre-compute tier 1 prefix
2. Write to `.yolo-planning/.context-cache/tier1.md` with a TTL header
3. Subsequent `compile_context` calls check this cache first
4. Gated behind a new feature flag `v4_session_cache_warm` (default: false)

This leverages the existing `tier_context::build_tiered_context()` infrastructure.

**Files:**
- `yolo-mcp-server/src/hooks/dispatcher.rs` (add warming to handle_session_start)
- `yolo-mcp-server/src/commands/tier_context.rs` (add cache write method if needed)
- `config/defaults.json` (add v4_session_cache_warm flag)

**Acceptance criteria:**
- Cache warming runs on non-compact session starts
- Cache file created at `.yolo-planning/.context-cache/tier1.md`
- Feature flag gates the behavior
- Non-blocking: session-start always succeeds

### Task 3: Add feature flags and update test config

**Description:** Add the two new feature flags to:
- `config/defaults.json`: `v4_post_edit_test_check: false`, `v4_session_cache_warm: false`
- `tests/test_helper.bash` `create_test_config()`: Add both flags to the test config template
- `yolo-mcp-server/src/commands/migrate_config.rs`: Ensure migration picks up new keys

**Files:**
- `config/defaults.json`
- `tests/test_helper.bash` (only the create_test_config function, not YOLO_BIN — that's plan 01)
- `yolo-mcp-server/src/commands/migrate_config.rs`

**Acceptance criteria:**
- Both flags present in defaults.json
- Test config includes both flags
- Config migration adds missing v4 flags automatically

### Task 4: Write tests for new hooks

**Description:** Create `tests/automation-hooks.bats` with tests for both new hooks:

Post-edit test validation tests:
- Advisory output when editing a file with no corresponding test
- Advisory output when editing a file with a corresponding test
- No output when feature flag disabled
- No output for non-Write/Edit PostToolUse events

Session cache warming tests:
- Cache file created on session start when flag enabled
- No cache file when flag disabled
- Cache file contains valid tier 1 content

**Files:**
- `tests/automation-hooks.bats` (new, ~10 tests)

**Acceptance criteria:**
- All new tests pass
- Tests verify both enabled and disabled states
- Tests use proper temp dir isolation
