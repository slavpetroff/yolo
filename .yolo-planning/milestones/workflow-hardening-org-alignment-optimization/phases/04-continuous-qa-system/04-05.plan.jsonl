{"p":"04","n":"05","t":"Config-aware qa-gate.sh and config.md QA settings","w":2,"d":["04-03","04-04"],"mh":{"tr":["qa-gate.sh reads qa_gates config via resolve-qa-config.sh without breaking existing hook interface","Config.md exposes all QA gate settings via interactive and direct modes","Backward compatible: projects without qa_gates config work unchanged"],"ar":[{"p":"commands/config.md","pv":"QA gates section in settings reference","c":"Config.md has QA gate toggle options in interactive mode and settings reference table"}],"kl":[{"fr":"commands/config.md QA settings","to":"config/defaults.json qa_gates","vi":"Every config.md QA option maps to a qa_gates key in defaults.json"},{"fr":"scripts/qa-gate.sh config reading","to":"scripts/resolve-qa-config.sh","vi":"qa-gate.sh uses resolve-qa-config.sh for config resolution"}]}}
{"id":"T1","tp":"auto","a":"Update scripts/qa-gate.sh to read qa_gates config via resolve-qa-config.sh. Do NOT add --level dispatch or change the hook interface (stdin-only). Keep existing structural checks unchanged. Add config awareness: if qa_gates config is disabled, skip structural checks and output {gate:skipped}. Fail-open on config read errors. Per architecture D2/D7: qa-gate.sh stays as Notification hook, workflow-level gates are separate scripts in 04-06/04-07.","f":["scripts/qa-gate.sh"],"v":"qa-gate.sh reads config via resolve-qa-config.sh, existing hook interface unchanged, fail-open preserved","done":"QA gate hook config awareness committed","spec":"FILE: scripts/qa-gate.sh (MODIFY). Architecture D2: do NOT add --level flag, do NOT add dispatch logic, do NOT change the Notification hook stdin-only interface. Architecture D7: qa-gate.sh stays as structural check only (summary gap + commit format). The ONLY change is adding config awareness to conditionally skip checks when disabled. Current script structure (75 lines): reads stdin, counts plans vs summaries, checks commit format, decides block/allow. All of this must remain EXACTLY as-is. Changes to add -- insert AFTER line 8 (INPUT=$(cat 2>/dev/null) || exit 0) and BEFORE line 10 (SUMMARY_OK=false): 1. Resolve script path: SCRIPT_DIR=\"$(cd \"$(dirname \"${BASH_SOURCE[0]}\")\" && pwd)\" and RESOLVE_SCRIPT=\"$SCRIPT_DIR/resolve-qa-config.sh\". 2. Resolve PLUGIN_ROOT: PLUGIN_ROOT=\"${CLAUDE_PLUGIN_ROOT:-$(cd \"$SCRIPT_DIR/..\" && pwd)}\" and CONFIG_PATH=\".yolo-planning/config.json\" and DEFAULTS_PATH=\"$PLUGIN_ROOT/config/defaults.json\". 3. Config-aware skip (fail-open): if [ -x \"$RESOLVE_SCRIPT\" ]; then QA_CONFIG=$(bash \"$RESOLVE_SCRIPT\" \"$CONFIG_PATH\" \"$DEFAULTS_PATH\" 2>/dev/null) || QA_CONFIG='{}'; else QA_CONFIG='{}'; fi. 4. Check post_task enabled: POST_TASK_ENABLED=$(echo \"$QA_CONFIG\" | jq -r '.post_task // true' 2>/dev/null) || POST_TASK_ENABLED='true'. 5. If disabled, exit 0 silently: if [ \"$POST_TASK_ENABLED\" = \"false\" ]; then exit 0; fi. CRITICAL: rest of script (lines 10-75) must remain UNCHANGED. Do NOT output {gate:skipped} to stdout -- Notification hook interface uses only stderr/exit codes, not stdout. Simply exit 0 when disabled. Fail-open chain: resolve-qa-config.sh fails -> QA_CONFIG='{}' -> jq '.post_task // true' -> 'true' -> checks run normally. Triple-fallback: script missing, script errors, jq errors all result in checks running."}
{"id":"T2","tp":"auto","a":"Update commands/config.md: add QA Gates to Step 2 interactive options. Add qa_gates settings to Settings Reference table (qa_gates.post_task, qa_gates.post_plan, qa_gates.post_phase, qa_gates.timeout_seconds, qa_gates.failure_threshold). Add Step 2.7 for QA gate toggle interaction.","f":["commands/config.md"],"td":["T1"],"v":"Config.md has QA gates in interactive flow and settings reference table","done":"Config.md QA gate settings committed","spec":"FILE: commands/config.md (MODIFY). Three insertion points. INSERTION 1: Step 2 AskUserQuestion options list (around line 35-40). Add QA Gates as a 7th option after Departments. INSERTION 2: New Step 2.7 section after Step 2.6 (Departments, around line 139) and before Step 3 (Apply changes, around line 141). Content: If QA Gates selected in Step 2, read current QA gate config via resolve-qa-config.sh. Parse with jq into QA_PT, QA_PP, QA_PH, QA_TO, QA_FT variables (same IFS pipe pattern as existing department config reading in Step 2.6). Display current state with check/circle symbols for each gate, timeout value, threshold value. Use AskUserQuestion multiSelect with 5 options: Post-task gate (toggle), Post-plan gate (toggle), Post-phase gate (toggle), Timeout (enter new value), Failure threshold (choose critical/major/minor). For gate toggles flip boolean. For timeout, if selected, AskUserQuestion for new positive integer. For threshold, AskUserQuestion with 3 options. Apply via jq -- ensure qa_gates object exists first (same pattern as model_overrides init on line 82-85). Then apply each changed field. Display check symbol per changed setting. Pattern reference: Step 2.6 Departments toggle (exact same multiSelect + toggle + jq apply pattern). INSERTION 3: Settings Reference table (around line 192-208). Add 5 new rows after custom_profiles: qa_gates.post_task (boolean, true/false, default true), qa_gates.post_plan (boolean, true/false, default true), qa_gates.post_phase (boolean, true/false, default true), qa_gates.timeout_seconds (number, positive integer, default 300), qa_gates.failure_threshold (string, critical/major/minor, default critical). Also support direct setting mode: /yolo:config qa_gates.post_task false -- parse dotted key path, apply via jq to nested object."}
{"id":"T3","tp":"auto","a":"Write bats tests for updated qa-gate.sh: test config-aware behavior (enabled vs disabled), test backward compatibility (missing qa_gates key = enabled), test fail-open on config read error, test existing structural checks still work. Do NOT test --level dispatch (removed per architecture D7).","f":["tests/qa-gate.bats"],"td":["T1"],"v":"All bats tests pass, covers config-aware behavior, backward compat, and fail-open","done":"Config-aware qa-gate.sh tests committed","spec":"FILE: tests/unit/qa-gate.bats (MODIFY -- file exists at tests/unit/qa-gate.bats with 125 lines). Task description says tests/qa-gate.bats but actual file is tests/unit/qa-gate.bats. MODIFY the existing file -- do NOT create a duplicate. Add new test cases AFTER the existing tests (append after line 125). Keep all existing tests intact. New section header: # --- Config-aware behavior ---. Test cases (4): 1. 'skips checks when post_task is disabled in config' -- Setup: create .yolo-planning/config.json with {\"qa_gates\":{\"post_task\":false}}. Create phase with summary gap (2 plans, 0 summaries) that would normally block. Create a minimal resolve-qa-config.sh alongside qa-gate.sh in a temp dir that echoes the disabled config. Run qa-gate.sh from temp dir. Assert exit 0 (skipped). NOTE: qa-gate.sh uses BASH_SOURCE to find resolve-qa-config.sh so test must ensure the resolve script is findable -- copy qa-gate.sh to TEST_WORKDIR and create resolve-qa-config.sh alongside it. 2. 'runs checks normally when post_task is enabled' -- Config with {\"qa_gates\":{\"post_task\":true}}. Create phase with summary gap > 1 and no conventional commits. Assert exit 2 (blocked -- existing behavior preserved). 3. 'runs checks when config has no qa_gates key (backward compat)' -- Config with {} (no qa_gates). Create phase with summary gap > 1. Assert exit 2 (fail-open means checks run). 4. 'runs checks when resolve-qa-config.sh is missing (fail-open)' -- Ensure no resolve-qa-config.sh exists. Create phase with summary gap > 1. Assert exit 2 (checks still run because fail-open defaults to enabled)."}
