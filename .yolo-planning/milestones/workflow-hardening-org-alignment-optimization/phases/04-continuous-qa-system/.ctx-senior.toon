phase: 04
goal: Transform QA from phase-end-only to continuous â€” add QA gates at post-task, post-plan, and post-phase levels matching real company QA processes

architecture:
  phase: 04
  title: Continuous QA System Architecture
  
  goal: Transform QA from phase-end-only to continuous -- add QA gates at post-task, post-plan, and post-phase levels matching real company QA processes (REQ-07)
  
  tech_decisions:
  
    D1: Config ownership -- 04-03 is sole owner of qa_gates in config/defaults.json
      rationale: Plans 04-03 and 04-10 both write qa_gates to config/defaults.json (C1). 04-03 T1 defines the canonical 5-field schema (post_task, post_plan, post_phase, timeout_seconds, failure_threshold). 04-10 T1 has a simpler 3-field version that would overwrite 04-03's richer schema. Resolution: Remove config/defaults.json write from 04-10 T1 entirely. 04-10 T1 should only modify the three gate scripts to read config toggles. Add 04-03 as dependency of 04-10 (d:["04-03","04-06","04-07","04-08"]). Research R-C1 confirms this approach eliminates schema conflict. References: C1, R-C1.
      alternatives: Let 04-10 merge schemas at runtime; dual-write with reconciliation step
  
    D2: Gate implementation pattern -- three separate scripts, qa-gate.sh unchanged
      rationale: decisions.jsonl D3 explicitly chose separate scripts. 04-05 T1-T3 contradict this by adding --level dispatch to qa-gate.sh (C2). The hook-registered qa-gate.sh receives stdin only via hook-wrapper.sh -- no CLI arguments can pass through the Notification hook system (C6). Resolution: Keep qa-gate.sh as-is (structural summary/commit check via Notification hook). Create three new workflow-level scripts: qa-gate-post-task.sh (04-06), qa-gate-post-plan.sh (04-07 T1), qa-gate-post-phase.sh (04-07 T2). Rescope 04-05 per D7. Research R-C2 confirms separate scripts align with D3. Research R-C6 confirms hook limitation. References: C2, C6, R-C2, R-C6.
      alternatives: Single multi-mode script with --level flag; extend qa-gate.sh through stdin protocol
  
    D3: Gate result storage -- append-mode JSONL with flock serialization
      rationale: No plan defines where gate results persist (C3). QA agents in 04-09 reference "prior post-task gate JSONs" but no file path exists. Resolution: Define {phase-dir}/.qa-gate-results.jsonl as append-mode storage. Each gate invocation appends one JSONL line via format-gate-result.sh. Flock-based serialization for concurrent writes in teammate mode (copy git-commit-serialized.sh pattern per C7 and R-C7). Schema: {gl:post-task|post-plan|post-phase, r:PASS|FAIL|WARN, ...level-specific-fields..., dt:ISO8601}. 04-09 QA agents read this file for incremental verification. Research R-C3 confirms append-mode with defined path. References: C3, C7, R-C3, R-C7.
      alternatives: Per-task result files ({phase-dir}/qa-gate-{plan}-{task}.json); stdout-only with no persistence
  
    D4: Test scoping -- --scope default for post-task, full suite for post-plan/post-phase
      rationale: Full test suite (1919 tests, 99 files) after every task is prohibitively slow (C4). In teammate mode with parallel Devs this serializes execution. Resolution: Post-task gate uses --scope by default -- only tests matching modified file patterns. 30s timeout for post-task. Post-plan and post-phase run full suite with 300s timeout (configurable via qa_gates.timeout_seconds). test-summary.sh needs --filter flag (match test file paths against modified file patterns). 04-06 T2 already adds --scope; 04-08 T1 must specify --scope as default in protocol integration. Research R-C4 confirms timeout and scope strategy. References: C4, R-C4.
      alternatives: Always run full suite with caching; parallel test execution; skip post-task tests entirely
  
    D5: Concurrency -- flock serialization for gate results and test execution
      rationale: Teammate mode enables up to 5 parallel Devs triggering concurrent post-task gates (C7). Concurrent appends to shared .qa-gate-results.jsonl would corrupt data. Concurrent test-summary.sh invocations could interfere. Resolution: Gate result writes use flock on {phase-dir}/.qa-gate-results.lock (copy git-commit-serialized.sh flock+mkdir pattern with 5 retries). Test execution serialized via flock on .git/yolo-test.lock. Per-task result as zero-contention alternative when performance requires it. Research R-C7 confirms flock pattern from git-commit-serialized.sh is proven and suitable. References: C7, R-C7.
      alternatives: Per-task result files only (no shared file); queue-based test execution
  
    D6: validate-config.sh call site -- session-start.sh with fail-soft behavior
      rationale: 04-03 T5 creates validate-config.sh but no code calls it (C9). Without a call site, the script is dead code. Resolution: Wire validate-config.sh into session-start.sh after config parsing (line ~307 area). Behavior: warn-only, non-blocking (echo warning to additionalContext if validation fails, do not exit 1). This matches existing session-start.sh pattern of graceful reporting. Also usable from config.md write path for immediate feedback. Research R-C9 confirms session-start.sh is the appropriate call site with fail-soft pattern. References: C9, R-C9.
      alternatives: Wire into execute-protocol.md Pre-Execution; wire into config.md write path; both call sites
  
    D7: Plan 04-05 rescoping -- remove duplicate gate logic, keep config integration only
      rationale: 04-05 T2 (post-task logic) and T3 (post-phase logic) duplicate work done by 04-06 and 04-07 respectively (C2). 04-05 T1 proposes --level dispatch which contradicts decisions.jsonl D3 (C2) and cannot work through the Notification hook system (C6). Resolution: Remove T2 and T3 from 04-05 entirely. Rescope T1 to: "Update qa-gate.sh to read qa_gates config via resolve-qa-config.sh for its existing structural checks (no --level flag, no dispatch). Add config awareness without changing interface." Keep T4 (config.md update) and T5 (tests for config-aware qa-gate.sh). Add 04-03 as dependency of 04-05 (was already listed). Add 04-05 as dependency of 04-08 (C8 -- both modify execute-protocol.md related concerns). References: C2, C6, C8.
      alternatives: Keep 04-05 as-is and remove 04-06/04-07; merge 04-05 into 04-06
  
  components:
  
    qa-gate-post-task:
      purpose: Post-task QA gate -- runs scoped unit tests after each Dev task completion. Accepts --phase-dir, --plan, --task, --scope, --files flags. Outputs structured JSON result. Fail-open on missing test infrastructure. 30s default timeout.
      files: scripts/qa-gate-post-task.sh, tests/unit/qa-gate-post-task.bats
      deps: test-summary.sh, resolve-qa-config.sh, format-gate-result.sh
      plan: 04-06
  
    qa-gate-post-plan:
      purpose: Post-plan QA gate -- runs full test suite after all tasks in a plan complete. Verifies summary.jsonl exists, checks must_have coverage from plan header. Blocks progression to next plan on failure.
      files: scripts/qa-gate-post-plan.sh, tests/unit/qa-gate-post-plan.bats
      deps: test-summary.sh, resolve-qa-config.sh, format-gate-result.sh, validate-gates.sh
      plan: 04-07
  
    qa-gate-post-phase:
      purpose: Post-phase QA gate -- runs full system verification before QA agent spawn. Calls validate-gates.sh for all steps, runs full test suite, checks all plans complete. Blocks sign-off on failure.
      files: scripts/qa-gate-post-phase.sh, tests/unit/qa-gate-post-phase.bats
      deps: test-summary.sh, validate-gates.sh, resolve-qa-config.sh, format-gate-result.sh
      plan: 04-07
  
    resolve-qa-config:
      purpose: Reads qa_gates from config.json with graceful fallback to defaults.json. Uses jq // operator for backward compatibility. Outputs resolved JSON object with all gate settings.
      files: scripts/resolve-qa-config.sh, tests/resolve-qa-config.bats
      deps: config/defaults.json, .yolo-planning/config.json
      plan: 04-03
  
    format-gate-result:
      purpose: Takes gate level and raw JSON input, outputs properly formatted JSONL line using abbreviated keys per artifact-formats.md schemas. Used by all three gate scripts for consistent output.
      files: scripts/format-gate-result.sh, tests/format-gate-result.bats
      deps: jq
      plan: 04-04
  
    validate-config:
      purpose: Validates qa_gates config fields: booleans for toggles, positive integer for timeout, enum for threshold. Returns structured error JSON on invalid. Called from session-start.sh (fail-soft).
      files: scripts/validate-config.sh
      deps: config/defaults.json
      plan: 04-03
      call_site: scripts/session-start.sh (warn-only, non-blocking)
  
    qa-output-patterns:
      purpose: UX output templates for all three gate levels and all states (pass/fail/partial/warn). Uses brand-essentials symbols and box-drawing. No ANSI codes. Quick-reference matrix.
      files: references/qa-output-patterns.md
      deps: references/yolo-brand-essentials.toon
      plan: 04-01
  
    qa-help-text:
      purpose: Help text for QA config options, error remediation patterns (problem+fix), gate progression messaging, skip/override warnings.
      files: references/qa-help-text.md
      deps: references/qa-output-patterns.md, config/defaults.json
      plan: 04-02
  
    qa-gate-integration:
      purpose: Documents all three gate trigger points, failure handling, remediation flows, skip conditions, team_mode differences, config options. Cross-references output patterns.
      files: references/qa-gate-integration.md
      deps: execute-protocol.md, qa-output-patterns.md, qa-gate-post-task.sh, qa-gate-post-plan.sh, qa-gate-post-phase.sh
      plan: 04-08
  
    artifact-formats-update:
      purpose: Add post-task, post-plan, and post-phase gate result JSONL schemas to artifact-formats.md Key Dictionary section. Add .qa-gate-results.jsonl to Phase Directory Structure. Update naming-conventions.md.
      files: references/artifact-formats.md, references/naming-conventions.md
      deps: format-gate-result.sh schema definitions
      plan: 04-04
  
    execute-protocol-update:
      purpose: Wire post-task gate into Step 7 after each Dev commit (with --scope default). Wire post-plan gate into Step 7 after summary.jsonl. Wire post-phase gate into Step 9 before QA agent spawn. Document both team_mode flows.
      files: references/execute-protocol.md
      deps: qa-gate-post-task.sh, qa-gate-post-plan.sh, qa-gate-post-phase.sh, resolve-qa-config.sh
      plan: 04-08
  
    qa-agent-updates:
      purpose: Update yolo-qa.md with Continuous QA section (gate-aware verification, incremental mode). Update yolo-qa-code.md with gate result consumption (cached pass for Phase 0 TDD compliance, incremental verification). Both agents receive .qa-gate-results.jsonl in context.
      files: agents/yolo-qa.md, agents/yolo-qa-code.md
      deps: .qa-gate-results.jsonl, qa-gate-integration.md
      plan: 04-09
  
    config-schema-update:
      purpose: Add qa_gates object to config/defaults.json (5 fields). Update test fixture configs. Wire config toggles into all three gate scripts (read-only, skip with exit 0 when disabled).
      files: config/defaults.json, tests/fixtures/config/balanced-config.json, tests/fixtures/config/quality-config.json, tests/fixtures/config/budget-config.json
      deps: none (foundation component)
      plan: 04-03
  
    validate-gates-update:
      purpose: Add post_task_qa and post_plan_qa entries to validate-gates.sh case statement for artifact completeness verification of gate results.
      files: scripts/validate-gates.sh, tests/unit/validate-gates.bats
      deps: .qa-gate-results.jsonl schema
      plan: 04-10
  
    integration-tests:
      purpose: End-to-end test of gate cascade: post-task -> post-plan -> post-phase. Verifies cascade stops when early gate fails. Exercises all three gates in sequence with mock phase directory.
      files: tests/integration/qa-gate-cascade.bats
      deps: qa-gate-post-task.sh, qa-gate-post-plan.sh, qa-gate-post-phase.sh
      plan: 04-10
  
    config-md-update:
      purpose: Add QA Gates to config.md interactive options (Step 2.7) and Settings Reference table. Expose all 5 qa_gates fields.
      files: commands/config.md
      deps: resolve-qa-config.sh, config/defaults.json
      plan: 04-05 (rescoped)
  
  integration_points:
  
    - execute-protocol.md Step 7 post-task: After each Dev task commit, before Dev loops to next task. Call qa-gate-post-task.sh --phase-dir {phase-dir} --plan {plan-id} --task {task-id} --scope. On failure: Dev pauses, Senior reviews, Dev fixes and re-commits. Both team_mode=task and team_mode=teammate documented.
  
    - execute-protocol.md Step 7 post-plan: After all tasks in a plan complete and summary.jsonl is written, before proceeding to next plan. Call qa-gate-post-plan.sh --phase-dir {phase-dir} --plan {plan-id}. On failure: block progression to next plan, Senior re-specs failed tasks.
  
    - execute-protocol.md Step 9 post-phase: As first action before spawning QA Lead and QA Code agents. Call qa-gate-post-phase.sh --phase-dir {phase-dir}. On failure: block QA agent spawn, generate remediation plan. This is fast automated pre-check (script-only, no LLM) before deep LLM-powered QA verification (C11).
  
    - session-start.sh config validation: After config parsing (~line 307), call validate-config.sh. Fail-soft: warn in additionalContext if invalid, do not block session. Once-per-version guard like existing migration pattern.
  
    - config.md QA settings: Step 2.7 interactive toggle for qa_gates fields. Settings Reference table documents all 5 fields with defaults and descriptions.
  
    - .qa-gate-results.jsonl consumption by QA agents: yolo-qa.md reads post-plan gate results to inform verification tier. yolo-qa-code.md reads post-task gate results for cached TDD pass (skip re-running unit tests when all gates passed).
  
    - validate-gates.sh extended: New post_task_qa and post_plan_qa step entries verify gate result existence as part of the standard gate validation framework.
  
  risks:
  
    - Test suite performance: Full suite is 1919 tests across 99 files. Post-task running full suite would serialize parallel Dev execution. Mitigation: --scope default limits post-task to relevant tests only (30s timeout). Full suite reserved for post-plan (300s) and post-phase (300s). Configurable via qa_gates.timeout_seconds.
  
    - Concurrent gate execution in teammate mode: Up to 5 parallel Devs trigger post-task gates simultaneously. Mitigation: flock-based serialization on .qa-gate-results.lock for result writes (proven pattern from git-commit-serialized.sh). Test execution serialized via .git/yolo-test.lock. Per-task result files as zero-contention alternative.
  
    - Backward compatibility: Existing projects have no qa_gates config key. Mitigation: resolve-qa-config.sh uses jq // operator for fallback to defaults. Missing key = all gates enabled (fail-open for config, fail-open for missing infrastructure). validate-config.sh is warn-only in session-start.sh.
  
    - Post-plan gate duplicates QA Lead checks (C10): Post-plan gate verifies must_have coverage; QA Lead performs deep verification. Mitigation: Clear separation documented in qa-gate-integration.md and yolo-qa.md. Post-plan gate = fast automated checks (file existence, test execution, <60s). QA Lead = deep LLM-powered analysis (content quality, architecture compliance). Cost optimization, not replacement.
  
    - 04-05 rescoping risk: Removing T2 and T3 reduces 04-05 scope significantly. Mitigation: Remaining T1 (config-aware qa-gate.sh), T4 (config.md), and T5 (tests) are coherent and independently valuable. Gate scripts in 04-06/04-07 are the canonical implementation.
  
    - Hook chain disruption: New gate scripts run during Step 7/9 execution, not through hooks.json. Existing qa-gate.sh Notification hook unchanged. Mitigation: New scripts are workflow-level (called by execute-protocol.md), not hook-level (called by hooks.json). Zero change to hook chain.
  
  critique_disposition:
  
    C1: addressed -- 04-03 is sole owner of qa_gates in config/defaults.json. 04-10 T1 rescoped to only modify gate scripts (read config, not write it). 04-03 added as dependency of 04-10. See D1.
  
    C2: addressed -- 04-05 rescoped per D7. T2 and T3 removed (duplicate gate logic). T1 rescoped to config reading only (no --level dispatch). Three separate scripts from 04-06/04-07 are canonical per decisions.jsonl D3. See D2, D7.
  
    C3: addressed -- Gate result storage defined as {phase-dir}/.qa-gate-results.jsonl (append-mode). Each gate invocation appends one JSONL line via format-gate-result.sh. 04-09 QA agents reference this specific file path. See D3.
  
    C4: addressed -- Post-task gate uses --scope by default (30s timeout). Full suite only for post-plan/post-phase (300s configurable). 04-08 T1 must specify --scope as default in protocol integration. test-summary.sh --filter flag enables scoped execution. See D4.
  
    C5: addressed -- Three explicit scenarios defined: (1) No test infra (bats/test-summary.sh missing) = warn + exit 0, (2) Infra exists but no tests match modified files = pass with "no relevant tests" note in gate result, (3) Tests exist and some fail = fail with details. All three scenarios produce valid gate result JSON with distinct r values (WARN, PASS, FAIL). Documented in qa-gate-integration.md.
  
    C6: addressed -- qa-gate.sh hook interface stays unchanged (stdin-only, no CLI args). New workflow-level gate scripts (04-06/04-07) accept CLI flags and are called by execute-protocol.md, not through hook system. Zero impact on Notification hook chain. See D2.
  
    C7: addressed -- flock-based serialization for gate result writes using git-commit-serialized.sh pattern (flock+mkdir fallback, 5 retries). Test execution serialized via separate lockfile. Per-task result files as zero-contention option. See D5.
  
    C8: addressed -- 04-05 added as dependency of 04-08 (d:["04-05","04-06","04-07"]). 04-05 modifies config-aware qa-gate.sh. 04-08 modifies execute-protocol.md. With dependency ordering, 04-05 runs first ensuring config awareness is in place before protocol integration. See D7.
  
    C9: addressed -- validate-config.sh wired into session-start.sh with fail-soft behavior (warn-only, non-blocking). Called after config parsing, once-per-version guard. See D6.
  
    C10: addressed -- Clear separation documented: post-plan gate = fast automated pre-check (file existence, test execution, <60s script-only). QA Lead = deep LLM-powered verification (content quality, architecture compliance, 5-10min). Cost optimization: gate catches obvious failures before expensive LLM agents spawn. Documented in qa-gate-integration.md and yolo-qa.md.
  
    C11: addressed -- post-phase gate = fast automated pre-check before Step 9 QA agent spawn. QA agents = deep verification. Gate does not replace QA agents; it provides a fast fail-early mechanism. If gate fails, QA agents never spawn (cost savings). If gate passes, QA agents still perform full deep verification. Clarified in 04-08 T4 and qa-gate-integration.md.
  
    C12: deferred -- 10 plans retained. Merging 04-01+04-02 (both wave 1 UX) would save one plan but creates a 9-task plan violating the 5-task target. Config overlap between 04-03/04-10 resolved by rescoping 04-10 (D1) rather than merging. 04-05 rescoped (D7) but kept as separate plan since config.md + qa-gate.sh config awareness is cohesive scope. Plan count reduction can be evaluated during Lead task decomposition if needed.
  
  dependency_corrections:
  
    04-05: d:["04-03","04-04"] (unchanged, already correct)
    04-08: d:["04-05","04-06","04-07"] (added 04-05 per C8)
    04-10: d:["04-03","04-06","04-07","04-08"] (added 04-03 per C1)
  
  plan_rescoping:
  
    04-05: Remove T2 (post-task gate logic) and T3 (post-phase gate logic). Rescope T1 to "config reading for existing qa-gate.sh only (no --level dispatch, no interface change)". Keep T4 (config.md QA settings) and T5 (tests for config-aware qa-gate.sh). Net: 5 tasks -> 3 tasks.
  
    04-10 T1: Remove config/defaults.json from files modified. Rescope to "Update qa-gate-post-task.sh, qa-gate-post-plan.sh, qa-gate-post-phase.sh to read their respective config toggle from resolve-qa-config.sh (skip with exit 0 and JSON {gate:skipped} when disabled)." Net: same task count, narrower scope.
  
  file_storage_schema:
  
    .qa-gate-results.jsonl:
      location: {phase-dir}/.qa-gate-results.jsonl
      mode: append-only
      locking: flock on {phase-dir}/.qa-gate-results.lock (flock+mkdir fallback)
      schema_per_line: {gl:str, r:str, plan:str, task:str(optional), tst:{ps:N,fl:N}, dur:N, dt:str, ...level-specific}
      consumers: yolo-qa.md, yolo-qa-code.md, qa-gate-post-phase.sh (aggregation)
      added_to: references/artifact-formats.md, Phase Directory Structure


patterns: @.yolo-planning/codebase/PATTERNS.md

conventions[15]{category,rule}:
  file-structure
  naming
  naming
  naming
  naming
  style
  style
  style
  tooling
  style
  style
  patterns
  patterns
  tooling
  patterns

dept_conventions:
  conventions:

reference_package: @references/packages/senior.toon
tool_restrictions:
  Do NOT use: EnterPlanMode, ExitPlanMode
