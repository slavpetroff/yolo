phase: 02
goal: Add research phase to the 10-step workflow and create per-agent context filtering scripts that reduce token overhead by delivering only needed fields

tasks[6]{id,action,files,done,spec}:
  T1,Design research step protocol and insert as Step 2 in execute-protocol.md (REQ-03). Add entry gate (critique.jsonl exists OR Step 1 skipped), Scout dispatch logic, research.jsonl output, exit gate. Update step numbering (old steps 2-10 become 3-11). Guard: skip if --effort=turbo OR research.jsonl exists.,references/execute-protocol.md,Research step exists between Critique and Architecture with complete gate protocol,File: references/execute-protocol.md. This task has 7 sub-operations, execute in order.

SUB-OP 1 -- UPDATE HEADER: Change '10-step' to '11-step' on line 5 ('Implements the 10-step company-grade engineering workflow.'). Also change '10-step' to '11-step' on line 116 ('Every step in the 10-step workflow below'). Also on line 631 ('Lead runs full 10-step workflow'). Also on line 698 (two occurrences of '10-step'). Total: 5 occurrences. Per D6.

SUB-OP 2 -- UPDATE PRE-EXECUTION MODEL RESOLUTION LOOP: On line 22, change `for role in critic architect lead senior tester dev qa qa-code security; do` to `for role in critic scout architect lead senior tester dev qa qa-code security; do`. Add 'scout' after 'critic' before 'architect'. Per D5. This ensures SCOUT_MODEL is resolved.

SUB-OP 3 -- INSERT NEW STEP 2 RESEARCH SECTION: Insert between end of Step 1 (line 148) and current Step 2 (line 150). Follow Step 1 formatting template exactly. Content: ### Step 2: Research (Scout Agent) -- Guard: Skip if --effort=turbo. Note: research.jsonl existence does NOT trigger skip (D3 append mode). Skip Output per template. Commit: chore(state): research skipped phase {N}. -- ENTRY GATE: Verify {phase-dir}/critique.jsonl exists OR steps.critique.status is 'skipped' in .execution-state.json. If neither: STOP 'Step 1 artifact missing -- critique.jsonl not found. Run step 1 first.' -- Steps: (1) Compile context: bash ${CLAUDE_PLUGIN_ROOT}/scripts/compile-context.sh {phase} scout {phases_dir}. (2) Spawn yolo-scout with Task tool: model ${SCOUT_MODEL}, provide critique.jsonl findings (critical/major only per D7), reqs.jsonl, codebase/ mapping, compiled context {phase-dir}/.ctx-scout.toon, research directives for each critical/major critique finding. Include Tool permissions block with resolve-tool-permissions.sh --role scout pattern. (3) Display: Spawning Scout (${SCOUT_MODEL})... -> Research complete. (4) Scout returns findings via Task result (or scout_findings schema in teammate mode). (5) Write research.jsonl from Scout findings to phase dir. If research.jsonl already exists (pre-Critic entries), APPEND new entries per D3. Each entry includes mode: post-critic. Per D2: orchestrator writes, Scout is read-only. (6) Commit: docs({phase}): research findings. (7) EXIT GATE: Artifact: research.jsonl (valid JSONL). State: steps.research = complete. Commit: chore(state): research complete phase {N}.

SUB-OP 4 -- RENUMBER ALL SUBSEQUENT STEP HEADERS: '### Step 2: Architecture' -> '### Step 3: Architecture', '### Step 3: Load Plans' -> '### Step 4: Load Plans', '### Step 4: Design Review' -> '### Step 5: Design Review', '### Step 5: Test Authoring' -> '### Step 6: Test Authoring', '### Step 6: Implementation' -> '### Step 7: Implementation', '### Step 7: Code Review' -> '### Step 8: Code Review', '### Step 8: QA' -> '### Step 9: QA', '### Step 9: Security' -> '### Step 10: Security', '### Step 10: Sign-off' -> '### Step 11: Sign-off'. Line numbers shift due to insert.

SUB-OP 5 -- UPDATE CROSS-REFERENCES IN STEP BODIES: Scan each step body for STOP messages referencing step numbers and update. Architecture (now Step 3) entry gate currently says 'Step 1 artifact' -- this stays (critique still step 1), BUT the gate itself changes in sub-op 7. Load Plans (now Step 4) entry gate: 'Step 2 artifact missing' -> 'Step 3 artifact missing -- architecture.toon not found. Run step 3 first.' Design Review (now Step 5): 'Step 3 artifact missing' -> 'Step 4 artifact missing'. Test Authoring (now Step 6): 'Step 4 artifact missing' -> 'Step 5 artifact missing'. Implementation (now Step 7): step 5 refs -> step 6. Code Review (now Step 8): 'Step 6 artifact missing' -> 'Step 7 artifact missing'. QA (now Step 9): 'Step 7 artifact missing' -> 'Step 8 artifact missing'. Security (now Step 10): 'Step 8 artifact missing' -> 'Step 9 artifact missing'. Sign-off (now Step 11): 'Step 9 artifact missing' -> 'Step 10 artifact missing'.

SUB-OP 6 -- UPDATE MANDATORY VS SKIPPABLE (lines 118-122): Replace with state-key-name text per D1. Skippable line becomes: '**Skippable:** critique (turbo or exists), research (turbo), architecture (exists), test_authoring (turbo or no `ts`), qa (--skip-qa or turbo), security (--skip-security or config off).' Mandatory line becomes: '**Mandatory (failure = STOP, no --force):** planning, design_review, implementation, code_review, signoff.' Per D1/D3: research skip is turbo-only.

SUB-OP 7 -- UPDATE ARCHITECTURE ENTRY GATE: Architecture (now Step 3) entry gate currently checks critique.jsonl OR steps.critique skipped. Change to: Verify {phase-dir}/research.jsonl exists OR steps.research.status is 'skipped' in .execution-state.json. If neither: STOP 'Step 2 artifact missing -- research.jsonl not found. Run step 2 first.' This reflects chain: Critique -> Research -> Architecture. Also update Architect Provide list to keep 'critique.jsonl (if exists)' and add 'research.jsonl (if exists)'.
  T2,Update Context Scoping Protocol table in execute-protocol.md to add Scout row for Step 2 (REQ-03). Scout receives: critique.jsonl findings, reqs.jsonl, codebase/ mapping, compiled context .ctx-scout.toon. Scout NEVER receives: plans, architecture, implementation code, QA artifacts.,references/execute-protocol.md,Scout context scoping documented in table,File: references/execute-protocol.md. Modify Context Scoping Protocol table (lines 57-67).

Step 1: RENUMBER EXISTING ROWS. Table currently has Steps 1-9. After T1 renumbering: row '| 2 | Architect |' becomes '| 3 | Architect |', row '| 3 | Lead |' becomes '| 4 | Lead |', etc. Renumber all rows from Architect onward: 2->3, 3->4, 4->5, 5->6, 6->7, 7->8, 8->9, 9->10. Step 1 (Critic) stays as '| 1 |'.

Step 2: INSERT NEW SCOUT ROW after Critic row (Step 1) and before Architect row (now Step 3): '| 2 | Scout | critique.jsonl (critical/major only), reqs.jsonl, codebase/ mapping, .ctx-scout.toon | plans, architecture, implementation code, QA artifacts, department CONTEXT |'. Per D7: Scout receives only critical/major severity findings. NEVER pass column matches architecture.toon Component Design.

Step 3: VERIFY final table has 10 data rows (Steps 1-10). Step 1=Critic, 2=Scout, 3=Architect, 4=Lead, 5=Senior(Review), 6=Tester, 7=Dev, 8=Senior(Review), 9=QA, 10=Security. Sign-off (Step 11) is not in this table (Lead-internal, no scoping restrictions).
  T3,Update Execution State Transitions table in execute-protocol.md to include research step (REQ-03). Add row: Step 2 Research, state.step=research, entry=critique.jsonl OR step 1 skipped, exit=research.jsonl, commit format=docs({phase}): research findings, skip conditions=--effort=turbo or research.jsonl exists.,references/execute-protocol.md,State transition row for research step documented,File: references/execute-protocol.md. Modify Execution State Transitions table (lines 567-578) and .execution-state.json schema.

Step 1: RENUMBER EXISTING ROWS. Current rows numbered 1-10. After T1: '2. Architecture' -> '3. Architecture', '3. Load Plans' -> '4. Load Plans', '4. Design Review' -> '5. Design Review', '5. Test Authoring' -> '6. Test Authoring', '6. Implementation' -> '7. Implementation', '7. Code Review' -> '8. Code Review', '8. QA' -> '9. QA', '9. Security' -> '10. Security', '10. Sign-off' -> '11. Sign-off'. Step 1 (Critique) unchanged.

Step 2: INSERT NEW ROW after Critique (Step 1), before Architecture (now Step 3): '| 2. Research | `research` | `critique.jsonl` OR step 1 skipped | `research.jsonl` | `docs({phase}): research findings` | `--effort=turbo` |'. Per D3: skip is turbo-only. Per D13: state key is 'research'. IMPORTANT: skip column says ONLY --effort=turbo (NOT research.jsonl exists, per D3).

Step 3: UPDATE ARCHITECTURE ROW ENTRY. Currently '`critique.jsonl` OR step 1 skipped'. Change to '`research.jsonl` OR step 2 skipped'. Matches T1 sub-op 7.

Step 4: UPDATE STEP-SKIPPED REFERENCES. Planning row: 'OR step 2 skipped' -> 'OR step 3 skipped'. Security row: 'OR step 8 skipped' -> 'OR step 9 skipped'. Sign-off row: 'OR step 9 skipped' -> 'OR step 10 skipped'.

Step 5: VERIFY final table has 11 data rows, Steps 1-11.

Step 6: UPDATE .execution-state.json SCHEMA. In Step 4 (Load Plans, formerly Step 3) the JSON schema example (currently lines 189-200) lists 10 step entries. Add 'research' entry between 'critique' and 'architecture': "research": {"status": "pending", "started_at": "", "completed_at": "", "artifact": "", "reason": ""}. Per D13. Schema now has 11 entries.
  T4,Update company-hierarchy.md 10-Step Workflow table to include Research step between Critique and Architecture (REQ-03). Add Scout row. Update step numbers for all subsequent rows.,references/company-hierarchy.md,Hierarchy doc reflects 11-step workflow,File: references/company-hierarchy.md. 4 sub-operations.

Sub-op 1: UPDATE SECTION HEADER (line 38). Change '## 10-Step Workflow' to '## 11-Step Workflow'. Per D6.

Sub-op 2: UPDATE TABLE (lines 42-53). Table header row stays unchanged. Step 1 (Critic) row stays. INSERT new Step 2 row after Critic: '| 2 | Scout | critique (critical/major) + reqs + codebase | research.jsonl | `docs({phase}): research findings` | turbo |'. Input matches D7 (filtered). Skip matches D3 (turbo only). RENUMBER subsequent rows: Architect 2->3, Lead 3->4, Senior 4->5, Tester 5->6, Dev 6->7, Senior 7->8, QA 8->9, Security 9->10, Lead 10->11.

Sub-op 3: UPDATE ALL OTHER '10-step' REFERENCES. Line 197: '10-step workflow' -> '11-step workflow'. Line 199: two occurrences '10-step' -> '11-step'. Line 226: '10-Step Workflow' -> '11-Step Workflow'. Per D6. Case-sensitive: '10-step' -> '11-step', '10-Step' -> '11-Step'.

Sub-op 4: VERIFY. Table has 11 data rows. Header says '11-Step'. Zero occurrences of '10-step' remain in file.
  T5,Update compile-context.sh scout case to include critique.jsonl findings as input for research directives (REQ-03). Currently scout case only emits header + requirements. Add: critique findings summary (if critique.jsonl exists), codebase mapping references.,scripts/compile-context.sh,Scout compiled context enriched with critique findings,File: scripts/compile-context.sh. Modify scout case block (lines 657-665). Current content: emit_header, echo, get_requirements, REF_PKG, get_tool_restrictions. Replace entire scout case body with enhanced version that adds 3 new sections between get_requirements and REF_PKG.

New scout case body (inside the { ... } > output redirect): emit_header; echo ""; get_requirements; echo ""; then add critique findings block: if [ -f "$PHASE_DIR/critique.jsonl" ]; then echo "research_directives:"; jq -r 'select(.sev == "critical" or .sev == "major") | "  \(.id // ""): \(.q // .desc // "")"' "$PHASE_DIR/critique.jsonl" 2>/dev/null || true; fi; echo ""; then add codebase block: if [ "$HAS_CODEBASE" = true ]; then echo "codebase:"; for base in INDEX ARCHITECTURE PATTERNS; do if [ -f "$PLANNING_DIR/codebase/${base}.md" ]; then echo "  @$PLANNING_DIR/codebase/${base}.md"; fi; done; fi; then REF_PKG=$(get_reference_package) && { echo ''; echo "reference_package: @${REF_PKG}"; }; get_tool_restrictions.

Key details: Per D7, jq filter uses select(.sev == "critical" or .sev == "major") to exclude minor/nit. Respects Scout 1000-token budget. jq extracts .id and .q // .desc with // fallback. Codebase section references INDEX, ARCHITECTURE, PATTERNS only (not CONCERNS -- too large for 1000-token budget). $HAS_CODEBASE already cached at line 280. Critique guard [ -f ] handles case where Scout runs without prior critique. Do NOT add get_research call -- Scout produces research, does not consume it.

conventions[15]{category,rule}:

dept_conventions:

skills:

reference_package: @references/packages/dev.toon
tool_restrictions:
