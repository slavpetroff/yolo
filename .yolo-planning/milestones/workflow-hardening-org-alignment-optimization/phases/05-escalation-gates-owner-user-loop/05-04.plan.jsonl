{"p": "05", "n": "04", "t": "Escalation round-trip tests and timeout script", "w": 3, "d": ["01", "02", "03"], "mh": {"tr": ["Integration test validates full upward+downward escalation chain in agent files", "Static test validates all agents have correct escalation targets including resolution routing", "Timeout script returns structured JSON with escalation status", "Codebase mapping updated to reflect escalation system additions"], "ar": [{"f": "tests/integration/escalation-round-trip.bats", "contains": "full round-trip"}, {"f": "tests/containment/escalation-chain.bats", "contains": "escalation_resolution"}, {"f": "scripts/check-escalation-timeout.sh", "contains": "escalation_timeout"}], "kl": [{"from": "tests/integration/escalation-round-trip.bats", "to": "references/handoff-schemas.md", "rel": "Tests validate escalation_resolution schema fields"}, {"from": "tests/integration/escalation-round-trip.bats", "to": "references/execute-protocol.md", "rel": "Tests validate protocol escalation handling section exists"}, {"from": "scripts/check-escalation-timeout.sh", "to": "config/defaults.json", "rel": "Script reads escalation.timeout_seconds from config"}]}, "obj": "Create integration tests covering the full escalation round-trip and a timeout checking script that the orchestrator can call to detect stale escalations (REQ-08, REQ-09)", "sk": ["commit"]}
{"id": "T1", "a": "Create scripts/check-escalation-timeout.sh. Takes --phase-dir and --config args. Reads .execution-state.json escalations array, checks each pending escalation against escalation.timeout_seconds from config (or defaults.json fallback). Returns JSON: {timed_out: [{id, task, elapsed_seconds, recommended_action}], active: [{id, task, elapsed_seconds}], resolved: N}. Exit 0 if no timeouts, exit 1 if any timed out. Uses set -euo pipefail, jq for all JSON parsing. REQ-08.", "f": ["scripts/check-escalation-timeout.sh"], "v": "bash scripts/check-escalation-timeout.sh --help 2>&1 | grep -q 'phase-dir' || echo 'help flag not required'", "done": "check-escalation-timeout.sh exists, uses jq, reads config, returns structured JSON with timeout detection", "tp": "feat", "spec": "File: scripts/check-escalation-timeout.sh (NEW FILE -- create from scratch)\n\nFollow the established script pattern from scripts/validate-gates.sh:\n- Shebang: #!/usr/bin/env bash\n- set -euo pipefail\n- jq dependency check (same pattern as validate-gates.sh lines 16-19)\n- Arg parsing with while loop (--phase-dir, --config flags)\n- Structured JSON output\n\nFull implementation spec:\n\n```bash\n#!/usr/bin/env bash\nset -euo pipefail\n\n# check-escalation-timeout.sh -- Detect stale pending escalations\n#\n# Reads .execution-state.json escalations array. Compares each pending\n# escalation's last_escalated_at against escalation.timeout_seconds from config.\n#\n# Usage: check-escalation-timeout.sh --phase-dir <path> [--config <path>]\n# Output: JSON {timed_out:[...], active:[...], resolved:N}\n# Exit codes: 0 = no timeouts, 1 = timed-out escalations found\n```\n\n1. jq dependency check (fail with JSON error on stderr, exit 1)\n2. Parse args: --phase-dir (required), --config (optional, defaults to config/defaults.json)\n3. Validate --phase-dir provided; if missing, print usage to stderr, exit 1\n4. Read STATE_FILE=\"$PHASE_DIR/.execution-state.json\" (under .yolo-planning/ path, the caller provides the full path). If file does not exist or has no 'escalations' key, output `{\"timed_out\":[],\"active\":[],\"resolved\":0}` and exit 0\n5. Read timeout_seconds from config: `TIMEOUT=$(jq -r '.escalation.timeout_seconds // 300' \"$CONFIG_FILE\")` -- fallback to 300 if key missing\n6. Get current timestamp: `NOW=$(date +%s)`\n7. Process each escalation entry with jq:\n   - Filter entries where status==\"pending\"\n   - For each pending entry: compute elapsed = NOW - (parse last_escalated_at as epoch). Use `date -jf` on macOS or `date -d` on Linux; provide a portable helper function that tries both.\n   - If elapsed > TIMEOUT: add to timed_out array with {id, task, elapsed_seconds, recommended_action:\"Auto-escalate to next level\"}\n   - If elapsed <= TIMEOUT: add to active array with {id, task, elapsed_seconds}\n   - Count resolved entries (status==\"resolved\")\n8. Output JSON: `{\"timed_out\":[...],\"active\":[...],\"resolved\":N}`\n9. Exit code: if timed_out array length > 0, exit 1; else exit 0\n\nDate parsing helper function (portable macOS/Linux):\n```bash\nparse_iso_to_epoch() {\n  local iso=\"$1\"\n  # Try GNU date first (Linux)\n  date -d \"$iso\" +%s 2>/dev/null && return 0\n  # Try BSD date (macOS)\n  date -jf \"%Y-%m-%dT%H:%M:%SZ\" \"$iso\" +%s 2>/dev/null && return 0\n  date -jf \"%Y-%m-%dT%H:%M:%S\" \"${iso%%Z}\" +%s 2>/dev/null && return 0\n  # Fallback: return 0 (epoch start -- will always trigger timeout)\n  echo 0\n}\n```\n\nConstruct the final JSON output using jq, NOT string concatenation. Build arrays in bash and pipe to jq for proper formatting.\n\nMake file executable: chmod +x scripts/check-escalation-timeout.sh\n\nDo NOT add any npm/node/python dependencies. Pure bash + jq.", "ts": "Test file: tests/unit/check-escalation-timeout.bats\nFramework: bats (load test_helper/common, test_helper/fixtures)\nSetup: mk_test_workdir, create PHASE_DIR with mock .execution-state.json and config\n\nTest cases:\n1. 'no escalations array returns empty result' -- .execution-state.json without escalations key -> exit 0, empty arrays\n2. 'no pending escalations returns clean result' -- all resolved -> exit 0, resolved count correct\n3. 'pending escalation within timeout returns active' -- last_escalated_at = 60s ago, timeout=300 -> exit 0, active array has entry\n4. 'pending escalation past timeout returns timed_out' -- last_escalated_at = 400s ago, timeout=300 -> exit 1, timed_out array has entry with elapsed_seconds\n5. 'config fallback to 300 when escalation key missing' -- config without escalation key -> uses 300s default\n6. 'missing state file returns empty result' -- no .execution-state.json -> exit 0, empty arrays\n7. 'mixed states: some active, some timed_out, some resolved' -- verify all three arrays populated correctly"}
{"id": "T2", "a": "Create tests/integration/escalation-round-trip.bats. Test cases: (1) All agent files in the escalation chain have the correct escalation targets (Dev->Senior, Senior->Lead, Lead->Architect, Architect->User, Owner->User), (2) escalation_resolution schema exists in handoff-schemas.md with required fields, (3) escalation_timeout_warning schema exists in handoff-schemas.md, (4) execute-protocol.md has Escalation Handling section, (5) go.md has Escalation from Agents section, (6) Lead has Escalation Receipt section, (7) Senior has Resolution Routing section, (8) Dev has Escalation Resolution section, (9) Owner has Resolution Routing section, (10) company-hierarchy.md has Escalation Round-Trip section, (11) config/defaults.json has escalation.timeout_seconds, (12) check-escalation-timeout.sh exists and is executable. REQ-08, REQ-09.", "f": ["tests/integration/escalation-round-trip.bats"], "v": "bats tests/integration/escalation-round-trip.bats --count 2>/dev/null || wc -l < tests/integration/escalation-round-trip.bats", "done": "Integration test file exists with 12+ test cases covering full escalation round-trip", "tp": "test", "spec": "File: tests/integration/escalation-round-trip.bats (NEW FILE -- create from scratch)\n\nFollow the established integration test pattern from tests/integration/qa-gate-cascade.bats and tests/containment/escalation-chain.bats:\n- Shebang: #!/usr/bin/env bats\n- Comment header describing the test file purpose\n- setup() function that loads '../test_helper/common'\n- Tests use assert_success, assert_failure, assert_output from bats-assert\n- Tests use grep to check file content (static tests)\n\nFull test spec:\n\n```bash\n#!/usr/bin/env bats\n# escalation-round-trip.bats -- Integration test: full escalation round-trip\n# Verifies all Phase 5 artifacts exist and are correctly wired\n\nsetup() {\n  load '../test_helper/common'\n}\n```\n\n12 test cases (each as a @test block):\n\n1. `@test \"escalation_resolution schema exists in handoff-schemas.md\"` -- grep -q 'escalation_resolution' \"$PROJECT_ROOT/references/handoff-schemas.md\" -> assert_success\n\n2. `@test \"escalation_resolution schema has required fields\"` -- grep for each required field (original_escalation, decision, rationale, action_items, resolved_by) in the escalation_resolution section of handoff-schemas.md. Use: grep -A 20 'escalation_resolution' file | grep -q 'field_name'\n\n3. `@test \"escalation_timeout_warning schema exists in handoff-schemas.md\"` -- grep -q 'escalation_timeout_warning' \"$PROJECT_ROOT/references/handoff-schemas.md\" -> assert_success\n\n4. `@test \"execute-protocol.md has Escalation Handling section\"` -- grep -q 'Escalation Handling' \"$PROJECT_ROOT/references/execute-protocol.md\" -> assert_success\n\n5. `@test \"go.md has Escalation from Agents section\"` -- grep -q 'Escalation from Agents' \"$PROJECT_ROOT/commands/go.md\" -> assert_success\n\n6. `@test \"yolo-lead.md has Escalation Receipt and Routing section\"` -- grep -q 'Escalation Receipt' \"$AGENTS_DIR/yolo-lead.md\" -> assert_success\n\n7. `@test \"yolo-senior.md has Resolution Routing section\"` -- grep -q 'Resolution Routing' \"$AGENTS_DIR/yolo-senior.md\" -> assert_success\n\n8. `@test \"yolo-dev.md has Escalation Resolution section\"` -- grep -q 'Escalation Resolution' \"$AGENTS_DIR/yolo-dev.md\" -> assert_success\n\n9. `@test \"yolo-owner.md has Resolution Routing section\"` -- grep -q 'Resolution Routing' \"$AGENTS_DIR/yolo-owner.md\" -> assert_success\n\n10. `@test \"company-hierarchy.md has Escalation Round-Trip section\"` -- grep -q 'Escalation Round-Trip' \"$PROJECT_ROOT/references/company-hierarchy.md\" -> assert_success\n\n11. `@test \"defaults.json has escalation.timeout_seconds\"` -- jq -e '.escalation.timeout_seconds' \"$PROJECT_ROOT/config/defaults.json\" -> assert_success. Also verify value: `run jq -r '.escalation.timeout_seconds' ...; [ \"$output\" = \"300\" ]`\n\n12. `@test \"check-escalation-timeout.sh exists and is executable\"` -- [ -x \"$PROJECT_ROOT/scripts/check-escalation-timeout.sh\" ] -> assert\n\n13. `@test \"escalation_resolution schema has direction note\"` -- grep -A 30 'escalation_resolution' \"$PROJECT_ROOT/references/handoff-schemas.md\" | grep -qi 'downward' -> assert_success\n\n14. `@test \"execute-protocol.md Step 7 references escalations array\"` -- grep -q 'escalations' \"$PROJECT_ROOT/references/execute-protocol.md\" -> assert_success\n\nEach test should be a standalone @test block using the run/assert pattern from bats-assert. Use $PROJECT_ROOT, $AGENTS_DIR, $SCRIPTS_DIR from common.bash.", "ts": ""}
{"id": "T3", "a": "Update tests/containment/escalation-chain.bats to add new test cases: (1) yolo-lead.md has 'Escalation Receipt' section, (2) yolo-senior.md has 'Resolution Routing' section, (3) yolo-dev.md has 'Escalation Resolution' section, (4) yolo-owner.md has 'Resolution Routing' section, (5) company-hierarchy.md has 'Escalation Round-Trip' section, (6) yolo-architect.md escalation table mentions 'options array' or 'structured escalation'. These extend existing containment tests with resolution-path verification. REQ-09.", "f": ["tests/containment/escalation-chain.bats"], "v": "grep -c 'Resolution' tests/containment/escalation-chain.bats", "done": "Existing escalation-chain.bats has 6+ new test cases for downward resolution path", "tp": "test", "spec": "File: tests/containment/escalation-chain.bats (EXISTING FILE -- append new tests)\n\nRead the existing file first. Append the following 6 new test blocks AFTER the last existing test (currently `@test \"company-hierarchy.md documents primary chain\"` at approximately line 196). Add a comment separator before the new tests.\n\nContent to append:\n\n```bash\n# --- Resolution routing path (Phase 5: Escalation Round-Trip) ---\n\n@test \"yolo-lead.md has Escalation Receipt section\" {\n  run grep -q 'Escalation Receipt' \"$AGENTS_DIR/yolo-lead.md\"\n  assert_success\n}\n\n@test \"yolo-senior.md has Resolution Routing section\" {\n  run grep -q 'Resolution Routing' \"$AGENTS_DIR/yolo-senior.md\"\n  assert_success\n}\n\n@test \"yolo-dev.md has Escalation Resolution section\" {\n  run grep -q 'Escalation Resolution' \"$AGENTS_DIR/yolo-dev.md\"\n  assert_success\n}\n\n@test \"yolo-owner.md has Resolution Routing section\" {\n  run grep -q 'Resolution Routing' \"$AGENTS_DIR/yolo-owner.md\"\n  assert_success\n}\n\n@test \"company-hierarchy.md has Escalation Round-Trip section\" {\n  local hierarchy=\"$PROJECT_ROOT/references/company-hierarchy.md\"\n  run grep -q 'Escalation Round-Trip' \"$hierarchy\"\n  assert_success\n}\n\n@test \"yolo-architect.md has structured escalation protocol\" {\n  run grep -E 'options array|structured escalation|Structured Escalation' \"$AGENTS_DIR/yolo-architect.md\"\n  assert_success\n}\n```\n\nDo NOT modify existing tests. Only APPEND after line 197 (after the closing brace of the last existing test). Preserve the existing setup() and helper functions.", "ts": ""}
{"id": "T4", "a": "Update .yolo-planning/codebase/ARCHITECTURE.md to add Escalation Round-Trip subsection under ## Hierarchical Agent Architecture. Document: (1) Full bidirectional escalation path, (2) Timeout-based auto-escalation, (3) New schemas (escalation_resolution, escalation_timeout_warning), (4) New config (escalation section in defaults.json), (5) New script (check-escalation-timeout.sh). Update .yolo-planning/codebase/INDEX.md with new file entries and cross-references. REQ-08, REQ-09.", "f": [".yolo-planning/codebase/ARCHITECTURE.md", ".yolo-planning/codebase/INDEX.md", ".yolo-planning/codebase/CONCERNS.md", ".yolo-planning/codebase/PATTERNS.md"], "v": "grep -q 'Escalation Round-Trip' .yolo-planning/codebase/ARCHITECTURE.md && grep -q 'check-escalation-timeout' .yolo-planning/codebase/INDEX.md", "done": "Codebase mapping documents reflect new escalation system with correct cross-references", "tp": "docs", "spec": "This task updates 4 codebase mapping files. Read each file before editing.\n\n--- FILE 1: .yolo-planning/codebase/ARCHITECTURE.md ---\n\nPlacement: Insert a new ### Escalation Round-Trip subsection AFTER the ### Escalation Paths section (approximately line 63-64, after 'No agent talks to the user directly') and BEFORE ## 11-Step Workflow (approximately line 68).\n\nContent:\n\n### Escalation Round-Trip (NEW in Phase 5)\n\nComplete bidirectional escalation path:\n- **Upward:** Dev -> Senior -> Lead -> Architect/Owner -> go.md -> User (via AskUserQuestion)\n- **Downward:** User -> go.md -> Owner/Architect -> Lead -> Senior -> Dev (via code_review_changes)\n\nKey mechanisms:\n- Timeout-based auto-escalation: `escalation.timeout_seconds` (default 300s) per config/defaults.json\n- Level tracking per escalation (id, level, last_escalated_at) prevents duplicate escalations\n- Max round-trips (default 2) caps blocker bounce\n- Escalation state tracked in .execution-state.json `escalations` array, committed immediately on receipt\n- `scripts/check-escalation-timeout.sh` detects stale escalations for auto-escalation\n- Two new schemas: `escalation_resolution` (downward) and `escalation_timeout_warning` (timeout trigger)\n\nTeammate mode: intra-team via SendMessage, cross-team/Owner via file-based artifacts.\n\n--- FILE 2: .yolo-planning/codebase/INDEX.md ---\n\nUpdate 1: In the ## Quick Reference table, change `Handoff schemas` value from `27` to `29`.\n\nUpdate 2: In the ## Key Entry Points table, add two new rows BEFORE the `hooks/hooks.json` row:\n| scripts/check-escalation-timeout.sh | Escalation timeout detection (NEW) |\n| tests/integration/escalation-round-trip.bats | Escalation round-trip integration test (NEW) |\n\nUpdate 3: In the ## What Changed section, add a new row to the delta table:\n| Handoff schemas | 27 | 29 | +2 (escalation_resolution, escalation_timeout_warning) |\n\nUpdate 4: In ## Major additions, add:\n- Escalation Round-Trip (bidirectional Dev<->User path with timeout auto-escalation)\n\n--- FILE 3: .yolo-planning/codebase/CONCERNS.md ---\n\nPlacement: Insert a new ## Escalation Timeout System section AFTER ## Review Ownership Enforcement (ending around line 76) and BEFORE ## Teammate API Stability (approximately line 80).\n\nContent:\n\n## Escalation Timeout System (NEW in Phase 5)\n\n**Severity:** MEDIUM | **Date identified:** 2026-02-18 | **Status:** IMPLEMENTED\n\n**Concern:** Timeout-based auto-escalation (300s default) may produce false positives for complex design decisions or be too lenient for simple clarifications. Unbounded escalation array could grow in long-running phases.\n\n**Implementation:**\n- Configurable timeout via escalation.timeout_seconds in config/defaults.json\n- Per-level tracking prevents premature escalation (level + last_escalated_at fields)\n- max_round_trips (default 2) caps per-escalation bounce\n- check-escalation-timeout.sh reads state and config, returns structured JSON\n- Escalation state committed immediately to .execution-state.json (crash recovery)\n\n**Mitigation:**\n- Timeout configurable per project (300s default, can increase for complex projects)\n- Auto-escalation only fires if current level has NOT already escalated upward\n- Resolved escalations marked (not removed) for audit trail\n- escalations array is per-phase (reset each phase), post-phase cleanup can archive\n- User response to AskUserQuestion has no timeout (blocks until answered)\n\n**Risk:** Short timeout for complex Architect decisions. Mitigated by: timeout triggers escalation to next level (adds context), not auto-resolution. By user level, question should be concrete with options.\n\n--- FILE 4: .yolo-planning/codebase/PATTERNS.md ---\n\nPlacement: Insert a new ### 14. Escalation Round-Trip pattern AFTER ### 13. Hard Enforcement Hooks (ending around line 69) and BEFORE ## Naming Patterns (approximately line 72).\n\nContent:\n\n### 14. Escalation Round-Trip (NEW in Phase 5)\nBidirectional escalation: Dev->Senior->Lead->Architect->User (upward) and User->go.md->Owner->Lead->Senior->Dev (downward). Each level transforms the message. Timeout auto-escalation via check-escalation-timeout.sh (configurable, default 300s). State tracked in .execution-state.json escalations array. Two new schemas (escalation_resolution, escalation_timeout_warning) bring total from 27 to 29.\n\n**Files:** references/execute-protocol.md, commands/go.md, agents/yolo-lead.md, agents/yolo-senior.md, agents/yolo-dev.md, agents/yolo-owner.md, agents/yolo-architect.md, references/company-hierarchy.md, references/handoff-schemas.md, config/defaults.json, scripts/check-escalation-timeout.sh\n\nDo NOT remove existing content in any of these files. Only INSERT/UPDATE at specified locations.", "ts": ""}
