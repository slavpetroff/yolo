phase: 01
goal: Fix CLAUDE.md override bug in bootstrap scripts and standardize all artifact naming conventions to eliminate unnecessary LLM error-recovery calls

architecture:
  # Phase 01 Architecture: Bootstrap & Naming Fixes
  
  scope: REQ-01 (CLAUDE.md bootstrap override), REQ-02 (naming conventions)
  approach: Fix all CLAUDE.md regeneration paths, then build naming validation layer
  risk_profile: medium (touches user-facing CLAUDE.md + retroactive naming enforcement)
  
  
  ## Design Decisions
  
  D1: Section registry pattern for bootstrap-claude.sh — YOLO_SECTIONS array must be auto-verified against generate_yolo_sections() output at script startup. Rationale: Prevents silent drift between declared sections and generated sections (root cause of Department Architecture bug). Alternative considered: generate sections list dynamically from function output. Rejected because ordering matters and explicit is safer.
  
  D2: Single CLAUDE.md regeneration function for all code paths — init.md step 3.5, go.md B6, go.md archive step 8 all call bootstrap-claude.sh. Rationale: 4+ divergent paths caused by each caller implementing its own CLAUDE.md logic. Single entry point eliminates class of bugs. Alternative: shared shell function sourced by all callers. Rejected because bootstrap-claude.sh already exists and is the right abstraction.
  
  D3: validate-naming.sh as complementary script (not merged into validate-plan.sh) — validate-naming.sh validates naming conventions across all artifact types. validate-plan.sh calls it as an additional check for plans. Rationale: Naming validation applies to summaries, decisions, critique, etc. Not all are plans. Alternative: Extend validate-plan.sh directly. Rejected because scope exceeds plan files.
  
  D4: Archive-aware validation with --scope flag — validate-naming.sh defaults to --scope=active (current milestone only). --scope=all includes archived milestones. Rationale: Archived milestones have legacy naming that cannot be retroactively fixed. Mass failures with no remediation path are not useful. Alternative: Exclude archives entirely. Rejected because audit needs to see full picture.
  
  D5: naming-conventions.md as single source of truth with drift-detection test — test script extracts patterns from naming-conventions.md and verifies validate-naming.sh checks each one. Rationale: Two documents (conventions doc + validation script) will inevitably drift without automated verification.
  
  D6: reqs.jsonl uses abbreviated keys matching artifact-formats.md schema — Current reqs.jsonl uses non-canonical keys (p instead of pri, d instead of desc). Fix the current file and add reqs.jsonl to validation scope. Rationale: reqs.jsonl was written before canonical keys were formalized in artifact-formats.md.
  
  D7: Section collision detection in bootstrap-claude.sh — When preserving user content, warn if a user section heading matches a known YOLO section name. Rationale: Silent collision causes content loss. Warning is diagnostic, not blocking.
  
  
  ## Critique Responses
  
  C1: addressed — init.md step 3.5 is a 4th CLAUDE.md code path. Fix: rewrite init.md step 3.5 to call bootstrap-claude.sh with a --minimal flag (generates only YOLO Rules, State, Commands, Plugin Isolation — no Active Context or Key Decisions since no project exists yet). The --minimal flag produces a subset of sections appropriate for pre-bootstrap init. See D2.
  
  C2: addressed — reqs.jsonl at .yolo-planning/reqs.jsonl uses {id,t,p,d} but artifact-formats.md (lines 195-201) specifies {id,t,pri,st,ac}. Fix: (1) Add reqs.jsonl canonical key validation to validate-naming.sh. (2) Fix current reqs.jsonl to use canonical keys. (3) Add reqs.jsonl to plan 01-02 audit scope. See D6.
  
  C3: addressed — validate-naming.sh gets --scope=active|all flag. Default: active (validates only current milestone in .yolo-planning/phases/). --scope=all adds .yolo-planning/milestones/*/. Archived milestones report warnings (non-blocking), not errors. See D4.
  
  C4: addressed — go.md archive mode step 8 (line 411) says "Regenerate CLAUDE.md: update Active Context, remove shipped refs. Preserve non-YOLO content." This is a prose instruction that the executing agent interprets, not a direct call to bootstrap-claude.sh. Fix: Replace line 411 with explicit instruction to call bootstrap-claude.sh with updated project state. The script handles preservation. See D2.
  
  C5: addressed — Expand audit in plan 01-02 to cover all artifact types in .yolo-planning/ phase directories. artifact-formats.md documents 14+ types: plan.jsonl, summary.jsonl, critique.jsonl, code-review.jsonl, qa-code.jsonl, security-audit.jsonl, verification.jsonl, test-plan.jsonl, decisions.jsonl, gaps.jsonl, manual-qa.jsonl, research.jsonl, reqs.jsonl, state.json, .execution-state.json. Audit must catalog actual key usage vs canonical keys for each type found in archives.
  
  C6: addressed — Add collision detection to bootstrap-claude.sh. After extracting preserved user content, scan preserved section headers against YOLO_SECTIONS. If match found, emit warning to stderr: "WARNING: User section '## X' collides with YOLO-managed section. User content under this heading will be replaced." See D7.
  
  C7: addressed — Turbo-mode plans skip Lead and produce lightweight plan.jsonl (go.md line 239). validate-naming.sh must handle turbo plans: (1) header requires minimum {p,n,t,w,d,obj} but NOT mh (turbo skips must_haves). (2) Tasks require {id,a,f,v,done} but NOT tp or spec (turbo skips type classification and spec enrichment). Add --turbo flag to validate-naming.sh or auto-detect turbo plans by checking for eff:"turbo" in header or absence of mh.
  
  C8: addressed — Add drift-detection test in tests/unit/validate-naming.bats. Test extracts all pattern names from naming-conventions.md section headers and verifies validate-naming.sh has a corresponding check function or validation rule for each. See D5.
  
  C9: addressed — Add code-block-awareness to bootstrap-claude.sh parser. Track whether we are inside a fenced code block (``` delimiter). Lines starting with # inside code blocks should not be treated as heading markers. Add IN_CODE_BLOCK state variable that toggles on ``` lines. When IN_CODE_BLOCK=true, skip all heading detection logic.
  
  C10: addressed — Add state.json and .execution-state.json naming patterns to naming-conventions.md. Document: state.json is {phase-dir}/state.json or root .yolo-planning/state.json; .execution-state.json is {phase-dir}/.execution-state.json (dot-prefix = runtime, committed on transitions).
  
  C11: addressed — Add explicit test case in tests/unit/bootstrap-claude.bats: same file for OUTPUT_PATH and EXISTING_PATH (in-place regeneration). Verify content is not corrupted when reading and writing the same file. This is the common case in go.md B6 and archive step 8.
  
  C12: addressed — Wire validate-naming.sh into execute-protocol.md Step 3 (planning validation) as a post-plan check. After Lead produces plan.jsonl and validate-plan.sh passes structural validation, run validate-naming.sh for naming convention compliance. Naming violations are blocking (same as structural violations).
  
  
  ## Component Design
  
  ### bootstrap-claude.sh (scripts/bootstrap/bootstrap-claude.sh)
  
  Current issues:
    Line 23-31: YOLO_SECTIONS array missing "## Department Architecture" — section exists in CLAUDE.md (line 14) but not in YOLO_SECTIONS, causing it to be treated as user content
    Line 49-97: generate_yolo_sections() outputs sections not declared in YOLO_SECTIONS (no auto-verification)
    Line 133-159: Parser does not track code block state — lines with # inside code blocks are misidentified as headings
    Line 146-148: Top-level heading skip does not account for frontmatter or multi-heading documents
    No collision detection between user section names and YOLO section names
  
  Fix approach:
    1. Add "## Department Architecture" to YOLO_SECTIONS (between "## Active Context" and "## YOLO Rules")
    2. Add startup verification: extract ## headers from generate_yolo_sections output, compare against YOLO_SECTIONS, abort if mismatch
    3. Add IN_CODE_BLOCK tracking in the while-read loop (line 133): toggle on lines matching ^```; skip heading detection when true
    4. Add collision warning: after building NON_YOLO_CONTENT, scan for lines matching YOLO_SECTIONS patterns, emit stderr warning
    5. Add --minimal flag: when set, generate_yolo_sections outputs only Rules, State, Commands, Plugin Isolation (for init.md pre-bootstrap)
    6. Self-test: script can be run with --verify to check YOLO_SECTIONS vs generate_yolo_sections() consistency
  
  Interface:
    bootstrap-claude.sh OUTPUT_PATH PROJECT_NAME CORE_VALUE [EXISTING_PATH] [--minimal] [--verify]
    Exit 0: success
    Exit 1: error
    Stderr: warnings (collision, etc.)
  
  ### init.md step 3.5 (commands/init.md lines 219-232)
  
  Current issues:
    Lines 219-232: Constructs CLAUDE.md content inline with custom section list, does NOT call bootstrap-claude.sh
    Section list is a subset (Rules, State, Skills, Conventions, Commands, Plugin Isolation) that diverges from bootstrap-claude.sh generate_yolo_sections()
    No preservation logic — brownfield handling is custom (append after --- separator vs bootstrap-claude.sh's section-aware merge)
  
  Fix approach:
    Replace entire step 3.5 content with call to bootstrap-claude.sh --minimal
    For brownfield (existing CLAUDE.md): pass as 4th arg — bootstrap-claude.sh handles preservation
    For greenfield (no CLAUDE.md): omit 4th arg — bootstrap-claude.sh creates fresh
    --minimal flag ensures only init-appropriate sections generated (no Active Context, no Key Decisions, no Department Architecture)
    Removes ~15 lines of inline CLAUDE.md generation from init.md
  
  ### go.md archive step 8 (commands/go.md line 411)
  
  Current issues:
    Line 411: Prose instruction "Regenerate CLAUDE.md: update Active Context, remove shipped refs" — agent interprets this freely
    No explicit call to bootstrap-claude.sh
    Agent may regenerate with different section set, different ordering, or miss preservation
  
  Fix approach:
    Replace line 411 with explicit instruction:
      "Call bootstrap-claude.sh CLAUDE.md PROJECT_NAME CORE_VALUE CLAUDE.md to regenerate. Script handles section replacement and user content preservation. After regeneration, update Active Context section: set Work to next milestone (if any) or 'No active milestone', set Last shipped to archived milestone metrics."
    The post-script Active Context update is a targeted Edit, not full regeneration
  
  ### go.md bootstrap B6 (commands/go.md line 179)
  
  Current status: Already calls bootstrap-claude.sh correctly. No changes needed.
    Line 179: `bash bootstrap-claude.sh CLAUDE.md "$PROJECT_NAME" "$CORE_VALUE" [CLAUDE.md]`
  
  ### validate-naming.sh (scripts/validate-naming.sh — NEW)
  
  Purpose: Validate artifact naming conventions across all JSONL artifact types
  Scope: plan.jsonl, summary.jsonl, reqs.jsonl, decisions.jsonl, critique.jsonl, code-review.jsonl, qa-code.jsonl, security-audit.jsonl, verification.jsonl, test-plan.jsonl, gaps.jsonl, manual-qa.jsonl, state.json, .execution-state.json
  
  Architecture:
    Input: file path or directory path
    If directory: recursively find all .jsonl and state JSON files, validate each
    If file: validate single file based on detected type (from filename pattern)
    Output: JSON {valid:bool,errors:[],warnings:[]}
    Exit: 0=valid, 1=invalid
  
  Flags:
    --scope=active (default): only .yolo-planning/phases/
    --scope=all: also .yolo-planning/milestones/*/
    --type=plan|summary|reqs|critique|... (override auto-detection)
    --turbo: relax validation for turbo-mode plans (no mh, no tp required)
  
  Validation rules per type:
    plan.jsonl header: p=phase-only string (no compound), n=plan-only number string, required keys {p,n,t,w,d,obj}, mh required unless turbo
    plan.jsonl tasks: required keys {id,tp,a,f,v,done} unless turbo (then {id,a,f,v,done})
    summary.jsonl: required keys {p,n,t,s,dt,tc,tt,ch,fm,dv,built,tst}, no legacy keys (commits,tasks,dev)
    reqs.jsonl: required keys {id,t,pri}, no legacy keys (p for priority, d for description)
    critique.jsonl: required keys {id,cat,sev,st}, valid st values
    decisions.jsonl: required keys {ts,agent,dec,reason}
    All types: no absolute paths in file arrays
  
  Integration points:
    Called by validate-plan.sh after structural validation (for plan files)
    Called in execute-protocol.md Step 3 as post-plan gate
    Called by naming audit (plan 01-02) for retrospective analysis
  
  ### naming-conventions.md (references/naming-conventions.md — NEW)
  
  Purpose: Single source of truth for all artifact naming patterns
  Coverage: All 14+ artifact types from artifact-formats.md, file naming patterns, directory naming patterns, cross-department artifact naming
  
  Structure:
    1. File naming patterns: {NN-MM}.plan.jsonl, {NN-MM}.summary.jsonl, {NN}-{slug}/ directories
    2. Plan header key conventions: canonical keys with valid value formats
    3. Plan task key conventions: canonical keys per artifact-formats.md
    4. Summary key conventions: canonical vs legacy keys
    5. Requirements key conventions: canonical {id,t,pri,st,ac}
    6. Other artifact key conventions: critique, decisions, code-review, qa-code, etc.
    7. Cross-department naming: fe-architecture.toon, ux-architecture.toon, .ctx-{dept}-{role}.toon
    8. State artifact naming: state.json, .execution-state.json
    9. Anti-patterns section: real examples from prior milestone audits
  
  Integration: Referenced by validate-naming.sh, drift-detection test verifies coverage match
  
  
  ## File Impact Map
  
  scripts/bootstrap/bootstrap-claude.sh: modify — add Department Architecture to YOLO_SECTIONS, add section auto-verification, add code block tracking, add collision detection, add --minimal and --verify flags
  commands/init.md: modify — replace step 3.5 inline CLAUDE.md generation with bootstrap-claude.sh --minimal call (lines 219-232)
  commands/go.md: modify — replace archive step 8 line 411 with explicit bootstrap-claude.sh call instruction
  .yolo-planning/reqs.jsonl: modify — fix non-canonical keys (p->pri, d->desc, add st and ac fields)
  scripts/validate-naming.sh: create — naming convention validation script
  references/naming-conventions.md: create — canonical naming patterns documentation
  tests/unit/bootstrap-claude.bats: create — bootstrap-claude.sh unit tests (preservation, duplication, collision, code blocks, same-file, --minimal)
  tests/unit/validate-naming.bats: create — naming validation unit tests (valid/invalid plans, summaries, reqs, turbo mode, archive scope, drift detection)
  scripts/validate-plan.sh: modify — add validate-naming.sh call after structural validation (line ~260, before output)
  
  
  ## Risk Mitigations
  
  R1: bootstrap-claude.sh changes could corrupt existing CLAUDE.md files — Mitigation: Test suite includes same-file in-place regeneration test, code block content preservation test, and brownfield append test. All tests run against real CLAUDE.md content from this project. Rollback: git checkout scripts/bootstrap/bootstrap-claude.sh.
  
  R2: validate-naming.sh false positives on legacy artifacts — Mitigation: --scope=active default only validates current milestone. Archived milestones produce warnings, not errors. Turbo plans detected and validated with relaxed rules.
  
  R3: init.md step 3.5 change breaks init workflow — Mitigation: --minimal flag is additive to bootstrap-claude.sh, does not change default behavior. init.md simply switches from inline generation to calling the script. Test: run /yolo:init in fresh directory, verify CLAUDE.md matches expected output.
  
  R4: go.md archive step 8 change alters archive behavior — Mitigation: bootstrap-claude.sh already handles the preservation logic correctly. Replacing prose with explicit call reduces ambiguity. The only new behavior is consistent section ordering.
  
  R5: reqs.jsonl key rename breaks downstream consumers — Mitigation: Search all consumers of reqs.jsonl (go.md archive audit line 399, compile-context.sh, any scripts using jq on reqs). Update references from .p to .pri, .d to .desc. No code reads reqs.jsonl with the old keys except ad-hoc agent interpretation.
  
  R6: naming-conventions.md and validate-naming.sh drift after initial creation — Mitigation: Drift-detection test in validate-naming.bats. Test extracts documented pattern categories from naming-conventions.md and verifies validate-naming.sh has matching validation. CI-friendly: bats test fails if drift detected.
  
  
  ## Dependency Graph
  
  Plan 01-01 (bootstrap fix) and Plan 01-02 (audit + conventions doc) are wave 1, parallel, no dependencies.
  Plan 01-03 (validation script) is wave 2, depends on 01-02 (needs naming-conventions.md as source of truth for validation rules).
  reqs.jsonl fix is in 01-02 scope (part of the audit deliverables).
  validate-plan.sh integration is in 01-03 scope (after validate-naming.sh exists).
  
  
  ## Open Questions (for Lead)
  
  Q1: Should bootstrap-claude.sh --minimal suppress Department Architecture section? Init runs before departments are configured. Decision: Yes, --minimal omits Active Context, Key Decisions, Department Architecture, Installed Skills.
  
  Q2: Should reqs.jsonl retroactively add st:"open" to all requirements? Current file has no st field. Decision: Yes, add st:"open" to all current requirements since none are completed yet.
  
  Q3: Should validate-naming.sh be wired into git pre-commit hook? Decision: Deferred to future phase. Current scope is script creation + execute-protocol integration only.


patterns: @.yolo-planning/codebase/PATTERNS.md

conventions[15]{category,rule}:
  file-structure
  naming
  naming
  naming
  naming
  style
  style
  style
  tooling
  style
  style
  patterns
  patterns
  tooling
  patterns

dept_conventions:
  conventions:

reference_package: @references/packages/senior.toon
tool_restrictions:
  Do NOT use: EnterPlanMode, ExitPlanMode
