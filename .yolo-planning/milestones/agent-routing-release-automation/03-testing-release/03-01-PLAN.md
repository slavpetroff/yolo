---
phase: "03"
plan: "01"
title: "Bats tests for agent routing and archive release"
wave: 1
depends_on: []
must_haves:
  - "Bats tests verify subagent_type appears in execute-protocol spawn blocks"
  - "Bats tests verify archive.md contains Step 8b release automation"
  - "Bats tests verify --no-release flag in archive args"
  - "All new tests pass"
  - "All existing tests pass"
---

# Plan 03-01: Bats tests for agent routing and archive release

## Goal

Add bats tests validating the Phase 1 (agent routing) and Phase 2 (archive release) changes.

## Tasks

### Task 1: Add agent-routing bats tests

**Files:** `tests/agent-routing.bats` (new)

**Implementation:**
Create `tests/agent-routing.bats` with these tests:

1. `execute-protocol contains subagent_type mapping table` — grep for "Agent routing (subagent_type)" in SKILL.md
2. `execute-protocol Step 3 Dev spawn has subagent_type` — grep for `subagent_type: "yolo:yolo-dev"` in Step 3 context
3. `execute-protocol Step 2b Architect spawn has subagent_type` — grep for `subagent_type: "yolo:yolo-architect"` in SKILL.md
4. `execute-protocol Step 3d QA Dev spawn has subagent_type` — verify 2+ occurrences of `subagent_type: "yolo:yolo-dev"` (Step 3 + Step 3d)
5. `plan.md Lead spawn has subagent_type` — grep for `subagent_type: "yolo:yolo-lead"` in plan.md

Use `bats-assert` for assertions. Follow existing test patterns in `tests/`.

**Verification:** `bats tests/agent-routing.bats` passes with 5 tests, 0 failures.

### Task 2: Add archive-release bats tests

**Files:** `tests/archive-release.bats` (new)

**Implementation:**
Create `tests/archive-release.bats` with these tests:

1. `archive.md contains Step 8b consolidated release` — grep for "8b. **Consolidated release" in archive.md
2. `archive.md contains --no-release flag` — grep for "--no-release" in Step 2 args
3. `archive.md contains version bump logic` — grep for "bump-version" in archive.md
4. `archive.md contains changelog finalization` — grep for "[Unreleased]" replacement logic
5. `archive.md release commit format` — grep for `chore: release v` in archive.md
6. `archive.md push gated by auto_push` — grep for "auto_push" in Step 8b

Use `bats-assert` for assertions.

**Verification:** `bats tests/archive-release.bats` passes with 6 tests, 0 failures.

### Task 3: Run full test suite

**Files:** none (verification only)

**Implementation:**
Run `bats tests/*.bats` and verify new tests pass alongside existing ones.

**Verification:** All new tests pass. No regressions.
