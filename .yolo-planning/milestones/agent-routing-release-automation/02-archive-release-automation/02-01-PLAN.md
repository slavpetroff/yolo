---
phase: "02"
plan: "01"
title: "Add consolidated release step to archive flow"
wave: 1
depends_on: []
must_haves:
  - "--no-release, --major, --minor flags parsed in archive.md Step 2"
  - "Step 8b consolidated release added between milestone tag and ACTIVE update"
  - "Version bump via yolo bump-version with --major/--minor forwarding"
  - "CHANGELOG [Unreleased] finalized with new version and date"
  - "Release commit chore: release v{version}"
  - "Version tag v{version} in addition to milestone tag"
  - "Push gated by auto_push config"
  - "All existing tests pass"
---

# Plan 02-01: Add consolidated release step to archive flow

## Goal

Add a consolidated release automation step to `skills/vibe-modes/archive.md` so that on milestone complete, version is automatically bumped, changelog finalized, release committed, tagged, and optionally pushed — eliminating the need for a manual release phase.

## Tasks

### Task 1: Add release flags to archive args parsing

**Files:** `skills/vibe-modes/archive.md`

**Implementation:**
In Step 2 (line 19), the current args are: `--tag=vN.N.N`, `--no-tag`, `--force`. Add three new flags:

Change line 19 from:
```
2. Parse args: --tag=vN.N.N (custom tag), --no-tag (skip), --force (skip audit).
```
To:
```
2. Parse args: --tag=vN.N.N (custom tag), --no-tag (skip), --force (skip audit), --no-release (skip version bump/release), --major (major version bump), --minor (minor version bump).
```

**Verification:** Read archive.md line 19. All 6 flags listed.

### Task 2: Add Step 8b consolidated release

**Files:** `skills/vibe-modes/archive.md`

**Implementation:**
After Step 8 (Git tag, line 46) and before Step 9 (Update ACTIVE, line 47), insert new Step 8b:

```markdown
8b. **Consolidated release (unless --no-release):**
   Automatically bump version, finalize changelog, commit, tag, and optionally push.

   ```bash
   # Skip if --no-release flag was passed
   AUTO_PUSH=$(jq -r '.auto_push // "never"' .yolo-planning/config.json 2>/dev/null)
   ```

   **Version bump:**
   ```bash
   # Forward --major or --minor if passed, otherwise default patch bump
   if [ "$BUMP_TYPE" = "major" ]; then
     OLD_VERSION=$(cat VERSION)
     # Compute major bump manually: X.Y.Z → (X+1).0.0
     MAJOR=$(echo "$OLD_VERSION" | cut -d. -f1)
     NEW_VERSION="$((MAJOR + 1)).0.0"
     echo "$NEW_VERSION" > VERSION
     # Update all version files
   elif [ "$BUMP_TYPE" = "minor" ]; then
     OLD_VERSION=$(cat VERSION)
     MAJOR=$(echo "$OLD_VERSION" | cut -d. -f1)
     MINOR=$(echo "$OLD_VERSION" | cut -d. -f2)
     NEW_VERSION="${MAJOR}.$((MINOR + 1)).0"
     echo "$NEW_VERSION" > VERSION
   else
     "$HOME/.cargo/bin/yolo" bump-version
   fi
   NEW_VERSION=$(cat VERSION)
   ```
   Display: `◆ Version bump: {OLD_VERSION} → {NEW_VERSION}`

   **Finalize changelog:**
   If CHANGELOG.md contains `## [Unreleased]`: replace with `## [{NEW_VERSION}] - {YYYY-MM-DD}`.
   Display: `✓ CHANGELOG.md finalized` or `○ No [Unreleased] section`

   **Release commit:**
   ```bash
   git add VERSION .claude-plugin/plugin.json .claude-plugin/marketplace.json marketplace.json
   # Add CHANGELOG.md only if modified
   git diff --quiet CHANGELOG.md 2>/dev/null || git add CHANGELOG.md
   git commit -m "chore: release v${NEW_VERSION}"
   ```
   Display: `✓ Release commit: chore: release v{NEW_VERSION}`

   **Version tag:**
   ```bash
   git tag -a "v${NEW_VERSION}" -m "Release v${NEW_VERSION}"
   ```
   Display: `✓ Tagged: v{NEW_VERSION}`

   **Push (gated by auto_push):**
   ```bash
   if [ "$AUTO_PUSH" = "always" ] || [ "$AUTO_PUSH" = "after_phase" ]; then
     git push && git push --tags
   fi
   ```
   - `auto_push=never`: Display `○ Push skipped (auto_push: never). Run git push && git push --tags when ready.`
   - `auto_push=always` or `after_phase`: Display `✓ Pushed with tags`
```

**Verification:** Read archive.md. Step 8b exists between Step 8 and Step 9. Contains version bump, changelog finalization, release commit, version tag, and push logic.

### Task 3: Run tests to verify no regressions

**Files:** none (verification only)

**Implementation:**
- Grep archive.md for key patterns: `--no-release`, `bump-version`, `chore: release`, `v${NEW_VERSION}`
- Run bats tests to confirm no regressions

**Verification:** All key patterns found. All existing tests pass.
