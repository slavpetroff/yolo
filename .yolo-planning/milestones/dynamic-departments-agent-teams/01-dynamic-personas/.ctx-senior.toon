phase: 01
goal: Enhance detect-stack.sh to classify project types and generate department TOON files dynamically based on detected type

architecture:
  phase1_architecture:
    title: Project Type Detection & Persona Templates
    date: 2026-02-16
  
  overview:
    Dynamic department personas require a three-stage pipeline: (1) classify project type from
    filesystem signals, (2) render department TOON conventions from type-specific templates,
    (3) resolve generated TOONs in compile-context.sh with fallback to static defaults. The
    design uses a two-layer TOON model: structural sections (roster, hierarchy, workflow,
    cross_dept, dir_isolation) remain static in references/departments/, while conventions
    sections (language, testing, tooling, focus) are generated per-project-type into
    .yolo-planning/departments/. This preserves backward compatibility (15 agent @-references
    still resolve), avoids agent file changes (Phase 3 scope), and keeps generated output
    ephemeral alongside other .yolo-planning/ artifacts. A 7th "generic" type guarantees
    classification never returns null. Monorepos use dominant sub-type detection. UX department
    adapts fundamentally per type rather than through template substitution.
  
  tech_decisions[8]{id,decision,rationale,alternatives}:
    D1,Two-layer TOON model: static structural + generated conventions,"Static references/departments/*.toon unchanged. Generated .yolo-planning/departments/*.toon contains ONLY conventions/focus sections. compile-context.sh merges both layers. This satisfies C-02 (backward compat) and C-13 (layer split) simultaneously. Agent @-references continue resolving to static files for roster/workflow; generated conventions injected via compile-context.sh.","(a) Overwrite static files in-place — breaks version control and defaults. (b) Update 15 agent references — Phase 3 scope, too invasive for Phase 1. (c) Single generated file replacing static — loses default fallback."
    D2,7th generic type as guaranteed fallback,"config/project-types.json includes a 'generic' type with minimal conventions (no framework assumptions). Classification algorithm returns 'generic' when no other type scores above threshold. Satisfies C-01.","(a) Error on undetectable — breaks downstream pipeline. (b) Prompt user — adds interactive dependency to a script pipeline."
    D3,Priority-ordered classification with scoring,"Each type in project-types.json has 'detect' signals with weights. Score = sum of matched signal weights. Highest score wins. Ties broken by priority order: monorepo > mobile-app > web-app > api-service > cli-tool > library > generic. Satisfies C-04.","(a) First-match — order-dependent, fragile. (b) User prompt for ambiguous — adds interactivity. (c) Return multiple types — downstream scripts expect exactly one."
    D4,Separate project-types.json from stack-mappings.json,"project-types.json maps structural filesystem signals (routes/, src/lib.rs, ios/) to project types. stack-mappings.json maps dependency/config signals to technology skills. Different concerns: type is about what the project IS; stack is about what tools it USES. detect-stack.sh reads both. Satisfies C-07 and C-10.","(a) Merge into stack-mappings.json — conflates type vs technology concerns. (b) Inline in detect-stack.sh — not extensible."
    D5,UX conventions as full replacement blocks per type not template variables,"Each project type defines a complete ux_conventions block in project-types.json. The block includes: focus areas, testing approach, artifact types, and vocabulary. CLI UX (help text, error formatting) shares no structure with web UX (design tokens, wireframes). Template variable substitution cannot handle this structural divergence. Satisfies C-05.","(a) Template variables ({{UX_FOCUS}}) — insufficient for structural differences. (b) Separate UX template per type — 6 template files for one department, maintenance burden."
    D6,Generated TOONs are ephemeral (not committed),"Generated department TOONs in .yolo-planning/departments/ follow the same pattern as .ctx-{role}.toon: regenerated on demand, not committed. Refresh triggered by stack-hash comparison. Consistent with existing artifact-formats.md conventions. Satisfies C-06.","(a) Committed — creates merge conflicts, stale state. (b) Session-start hook — adds latency to every session."
    D7,Monorepo uses dominant sub-type,"For monorepos: detect all workspace types, select dominant (most workspaces of one type). Store full type list in detect-stack.sh output for future use. Phase 1 uses single dominant type for TOON generation. Full per-workspace support deferred. Satisfies C-08.","(a) Per-workspace TOON generation — requires workspace-aware compile-context.sh, too complex for Phase 1. (b) Prompt user — adds interactivity."
    D8,Chain detect-stack.sh output into generate-department-toons.sh,"generate-department-toons.sh calls detect-stack.sh internally (or accepts piped JSON). No duplicated detection logic. detect-stack.sh is the single source of truth for both stack and type. Satisfies C-10.","(a) Independent detection in each script — duplication, drift risk. (b) Shared library sourced by both — over-engineering for 2 consumers."
  
  components[6]{name,path,responsibility,interface,status}:
    project-types-config,"config/project-types.json","Define 7 project types (6 + generic) with detection signals, department convention mappings, and UX focus blocks","JSON read by detect-stack.sh and generate-department-toons.sh",new
    detect-stack-enhanced,"scripts/detect-stack.sh","Add project_type classification to existing output. Read project-types.json, score signals, return best match.","JSON output gains: project_type (string), type_scores (object, optional debug). All existing fields preserved.",modified
    department-templates,"config/department-templates/{backend,frontend,uiux}.toon.tmpl","TOON templates with structural skeleton from static files plus placeholder markers for conventions sections","Read by generate-department-toons.sh. Placeholders: {{CONVENTIONS}}, {{TESTING}}, {{TOOLING}}, {{UX_FOCUS}}",new
    generate-department-toons,"scripts/generate-department-toons.sh","Render department TOON conventions from project type. Read detect-stack.sh output + project-types.json + templates. Write to .yolo-planning/departments/","Input: project-dir (default: .). Output: .yolo-planning/departments/{backend,frontend,uiux}.toon + .stack-hash",new
    compile-context-integration,"scripts/compile-context.sh","Add generated conventions resolution. For roles needing dept context (dev, senior, tester, qa-code), inject conventions from .yolo-planning/departments/ with fallback to references/departments/","Modified case blocks for dev, senior, tester, qa-code. New helper: get_dept_conventions()",modified
    classification-tests,"tests/unit/detect-stack-classify.bats, tests/unit/generate-department-toons.bats, tests/integration/persona-pipeline.bats","Validate classification, generation, and full pipeline","BATS tests with fixture directories",new
  
  data_flow:
    pipeline: detect-stack.sh -> generate-department-toons.sh -> compile-context.sh -> .ctx-{role}.toon
    step1:
      trigger: /yolo:init or /yolo:map or explicit invocation
      input: project filesystem + config/project-types.json + config/stack-mappings.json
      process: detect-stack.sh reads project-types.json, scores each type against filesystem signals, returns highest-scoring type
      output: JSON with existing fields + project_type + type_confidence
    step2:
      trigger: called by /yolo:init after detect-stack.sh, or standalone
      input: detect-stack.sh JSON output + config/department-templates/*.toon.tmpl + config/project-types.json
      process: generate-department-toons.sh looks up type in project-types.json, extracts convention blocks, renders templates
      output: .yolo-planning/departments/{backend,frontend,uiux}.toon + .yolo-planning/departments/.stack-hash
    step3:
      trigger: compile-context.sh invoked per-role before agent spawn
      input: .yolo-planning/departments/*.toon (generated) OR references/departments/*.toon (static fallback)
      process: For dev/senior/tester/qa-code roles, resolve dept TOON (generated > static), extract conventions section, inject into .ctx-{role}.toon within token budget
      output: .ctx-{role}.toon with project-specific conventions
  
    resolution_order:
      1: .yolo-planning/departments/{dept}.toon (generated, project-specific)
      2: references/departments/{dept}.toon (static, default)
      note: Only conventions sections extracted from generated TOONs. Structural sections (roster, workflow) always from static files.
  
    agent_reference_flow:
      current: 15 agent .md files contain "Reference: @references/departments/{dept}.toon"
      unchanged: These references continue to point to static structural files (roster, hierarchy, workflow)
      enhanced: compile-context.sh additionally injects generated conventions into role context
      phase3: Agent references may be updated to point to merged output (deferred)
  
  critique_responses[13]{id,status,response}:
    C-01,addressed,"7th 'generic' type added to project-types.json. Classification guarantees exactly one type: scoring algorithm always falls through to generic (score 0, lowest priority). See D2."
    C-02,addressed,"Two-layer model preserves all 15 agent @-references unchanged. Static files in references/departments/ remain the structural source of truth. Generated conventions injected via compile-context.sh into role context. No agent file modifications needed. See D1."
    C-03,addressed,"Only conventions sections (~100-150 tokens per dept) injected into role context, not full TOON content. Budget impact: dev 2000 -> ~2150 effective (within 10% margin). Structural sections (roster ~200 tokens, workflow ~150 tokens) NOT injected — agents read those via @-reference when needed. See D1."
    C-04,addressed,"Priority-ordered scoring with explicit tie-breaking: monorepo > mobile-app > web-app > api-service > cli-tool > library > generic. Each type has weighted detect signals. Highest total score wins. See D3."
    C-05,addressed,"UX conventions defined as complete replacement blocks per type in project-types.json, not template variables. CLI UX block: help text quality, error output formatting, progress indicators, man page conventions. Web UX block: design tokens, component specs, responsive breakpoints. API UX block: OpenAPI specs, error response design, developer portal. These are structurally different, not parameterized variants. See D5."
    C-06,addressed,"Generated TOONs are ephemeral (not committed). Stored in .yolo-planning/departments/ alongside other generated artifacts. Refresh via stack-hash comparison: detect-stack.sh output hashed, compared to .stack-hash file. Regenerate only when hash differs or --force flag. See D6."
    C-07,addressed,"New config/project-types.json with structural detection signals: bin/ for CLI, src/lib.rs for library, routes/ or app/ for web, ios/ or android/ for mobile. These are filesystem-structural signals distinct from stack-mappings.json dependency signals. detect-stack.sh reads both files. See D4."
    C-08,addressed,"Monorepo detected via: workspaces in package.json, lerna.json, pnpm-workspace.yaml, Cargo workspace, go.work. When detected, sub-workspace types scored, dominant type used for TOON generation. Full per-workspace support deferred to future phase. See D7."
    C-09,addressed,"YOLO project detects as cli-tool: presence of scripts/*.sh, bin/-like patterns, absence of package.json/Cargo.toml/go.mod. cli-tool type includes Bash, BATS, jq, Markdown conventions. Shell-heavy detection patterns added to project-types.json under cli-tool."
    C-10,addressed,"generate-department-toons.sh calls detect-stack.sh internally. Single detection pipeline, no duplication. See D8."
    C-11,addressed,"Generation uses only jq + sed template rendering. No network calls, no LLM. Expected: <50ms for full generation. Stack-hash caching avoids regeneration on subsequent runs. Performance test included in BATS suite (timing assertion)."
    C-12,addressed,"BATS tests validate generated TOONs contain required sections. Tests check: conventions section present, no raw placeholder markers, valid TOON structure (key-value pairs). Full schema validation deferred — TOON format is not formally specified enough for automated schema checking."
    C-13,addressed,"Core architectural decision. Static layer (references/departments/*.toon): roster, structure, workflow, cross_dept, dir_isolation. Generated layer (.yolo-planning/departments/*.toon): conventions, testing, tooling, focus. compile-context.sh merges by reading generated conventions and injecting into role context. See D1."
  
  risks[5]{id,risk,impact,likelihood,mitigation}:
    R1,"Template rendering edge cases: special characters in convention values break sed substitution",medium,medium,"Use jq for value extraction, heredoc for template blocks instead of sed s/// on full template. Test with values containing slashes, quotes, pipes."
    R2,"Token budget creep: adding dept conventions to dev/qa-code roles pushes past 2000/3000 limits",medium,high,"Measure actual sizes during implementation. Convention injection is additive (~100-150 tokens). enforce_budget() already handles overflow via progressive truncation. Add explicit test for budget compliance."
    R3,"Classification accuracy: edge cases where scoring picks wrong type (e.g., Express app detected as library because src/lib.ts exists)",medium,medium,"Weighted signals: framework detection (high weight) overrides structural signals (low weight). Integration test with ambiguous fixtures. Users can override via config.json project_type field."
    R4,"Monorepo dominant-type heuristic picks minority type",low,low,"Phase 1 scope: dominant type = most workspaces of one type. If all equal, fallback to web-app. Future: user override or per-workspace generation."
    R5,"Template drift: static TOON structure changes not reflected in templates",medium,low,"Templates derived from current static files. BATS test compares template structural sections against static file sections to detect drift."
  
  constraints:
    no_agent_modifications: Agent .md files in agents/ are NOT modified in Phase 1. Deferred to Phase 3.
    no_protocol_changes: execute-protocol.md, go.md routing logic unchanged.
    no_teammate_api: Teammate API integration is Phase 2 scope.
    shell_only: All generation done by shell scripts (bash + jq + sed). No LLM, no npm, no external deps.
    backward_compatible: Existing behavior preserved when generated TOONs absent. All existing tests must continue passing.
    single_type: detect-stack.sh returns exactly one project_type. Never null, never array.
    ephemeral_output: Generated TOONs in .yolo-planning/departments/ are not committed to git.
  
  integration_points[4]{from,to,protocol,notes}:
    detect-stack.sh,generate-department-toons.sh,JSON stdout pipe or internal call,"generate-department-toons.sh invokes detect-stack.sh internally, captures JSON output, extracts project_type field"
    generate-department-toons.sh,.yolo-planning/departments/,filesystem write,"Writes {backend,frontend,uiux}.toon + .stack-hash. Creates directory if absent."
    compile-context.sh,.yolo-planning/departments/,filesystem read with fallback,"New helper get_dept_conventions() checks generated path first, falls back to references/departments/. Extracts conventions section only."
    /yolo:init,generate-department-toons.sh,script invocation,"Init flow calls generate-department-toons.sh after detect-stack.sh. Also callable standalone via /yolo:map refresh."


patterns: @.yolo-planning/codebase/PATTERNS.md

conventions[15]{category,rule}:
  file-structure,Commands are kebab-case .md files in commands/
  naming
  naming
  naming
  naming
  style
  style
  style
  tooling
  style
  style
  patterns
  patterns
  tooling
  patterns
