{"p":"01-04","n":"Pipeline Validation & Self-Test","t":3,"w":3,"d":["01-01","01-02","01-03"],"mh":["REQ-01","REQ-02","REQ-07"],"obj":"Validate the full detect-classify-generate-compile pipeline end-to-end. Verify YOLO project itself gets correct shell-project personas (Bash, BATS, Markdown/prompt engineering). Add refresh mechanism.","sk":["commit"],"fm":["scripts/generate-department-toons.sh","tests/integration/persona-pipeline.bats"]}
{"id":"01-04-01","n":"Add TOON refresh mechanism","f":["scripts/generate-department-toons.sh"],"d":[],"ac":["generate-department-toons.sh stores a hash of detect-stack.sh output alongside generated TOONs in .yolo-planning/departments/.stack-hash","On subsequent runs, compares current detect-stack.sh output hash with stored hash","If hash matches, skips regeneration (prints 'TOONs up to date')","If hash differs, regenerates all department TOONs (prints 'Stack changed, regenerating TOONs')","Force regeneration available via --force flag","Hash computed via sha256sum or shasum (macOS compatible)"],"spec":"Modify scripts/generate-department-toons.sh to finalize the refresh mechanism. Note: the basic hash check skeleton was already added in task 01-02-02. This task completes and hardens it. (1) Ensure the --force flag parsing handles all argument positions. Current approach from 01-02-02: iterate all args, set FORCE=true if any arg is '--force'. Robust implementation: FORCE=false; for arg in \"$@\"; do if [ \"$arg\" = \"--force\" ]; then FORCE=true; fi; done. Then strip --force from positional args: PROJECT_DIR=\"${1:-.}\"; if [ \"$1\" = \"--force\" ]; then PROJECT_DIR=\"${2:-.}\"; fi. Or simpler: accept PROJECT_DIR as first non-flag arg. (2) Hash computation must be cross-platform. macOS has 'shasum -a 256', Linux has both 'sha256sum' and 'shasum'. Use: compute_hash() { if command -v shasum &>/dev/null; then shasum -a 256 | cut -d' ' -f1; elif command -v sha256sum &>/dev/null; then sha256sum | cut -d' ' -f1; else # fallback: use cksum if neither available; cksum | cut -d' ' -f1; fi; }. Then: CURRENT_HASH=$(echo \"$DETECT_OUTPUT\" | compute_hash). (3) Hash check logic (placed AFTER detect-stack.sh call, BEFORE template rendering): HASH_FILE=\"$OUTPUT_DIR/.stack-hash\". if [ -f \"$HASH_FILE\" ] && [ \"$FORCE\" != true ]; then STORED_HASH=$(cat \"$HASH_FILE\"); if [ \"$STORED_HASH\" = \"$CURRENT_HASH\" ]; then echo 'TOONs up to date'; exit 0; else echo 'Stack changed, regenerating TOONs'; fi; fi. (4) After successful template rendering, write hash: echo \"$CURRENT_HASH\" > \"$HASH_FILE\". (5) When --force flag is set, skip hash check entirely and always regenerate. Print 'Force regeneration requested' to stdout. (6) Stdout messages must be simple strings, not JSON (this is a human-facing script, not piped). Messages: 'TOONs up to date' (skip), 'Stack changed, regenerating TOONs' (hash mismatch), 'Force regeneration requested' (--force), 'Generated department TOONs for project_type=X in Y' (success). (7) Edge case: first run (no .stack-hash exists) -- always generate, write hash. Edge case: .yolo-planning/departments/ dir does not exist yet -- create it (mkdir -p), then generate. Edge case: detect-stack.sh output changes but project_type stays same -- still regenerate because conventions may differ based on stack detection changes.","ts":"Covered by tests/integration/persona-pipeline.bats in task 01-04-02. Specific refresh tests: (a) first run generates and creates .stack-hash. (b) second run with same project prints 'TOONs up to date'. (c) --force flag causes regeneration even when hash matches. (d) adding a new file to project changes hash, triggers regeneration."}
{"id":"01-04-02","n":"End-to-end pipeline integration test","f":["tests/integration/persona-pipeline.bats"],"d":["01-04-01"],"ac":["Integration test runs full pipeline: detect-stack.sh > project type classification > generate-department-toons.sh > compile-context.sh","Test creates a mock web-app project fixture (package.json with react, tsconfig.json)","Verifies detect-stack.sh outputs project_type: web-app","Verifies generated backend.toon references TypeScript/JavaScript conventions","Verifies generated uiux.toon references UI design, component specs, design tokens","Verifies compile-context.sh output .ctx-dev.toon contains project-specific content","Test creates a mock shell-project fixture (only .sh files, no package.json)","Verifies shell-project gets Bash/BATS/jq conventions in department TOONs"],"spec":"Create tests/integration/persona-pipeline.bats. Header: #!/usr/bin/env bats with comment block describing full pipeline integration tests. setup(): load '../test_helper/common', '../test_helper/fixtures', '../test_helper/mock_stdin', mk_test_workdir, mk_planning_dir, mk_roadmap. Export CLAUDE_CONFIG_DIR=\"$TEST_WORKDIR/mock-claude\", mkdir -p \"$CLAUDE_CONFIG_DIR/skills\". Set script paths: DETECT=\"$SCRIPTS_DIR/detect-stack.sh\", GENERATE=\"$SCRIPTS_DIR/generate-department-toons.sh\", COMPILE=\"$SCRIPTS_DIR/compile-context.sh\". Create phase dir: PHASE_DIR=$(mk_phase 1 pipeline 1 0). Helpers: mk_webapp_project() { cat > \"$TEST_WORKDIR/package.json\" <<'EOF'\\n{\"dependencies\":{\"react\":\"^18\",\"react-dom\":\"^18\"}}\\nEOF\\ntouch \"$TEST_WORKDIR/tsconfig.json\"; }. mk_shell_project() { mkdir -p \"$TEST_WORKDIR/scripts\" \"$TEST_WORKDIR/bin\"; echo '#!/bin/bash' > \"$TEST_WORKDIR/scripts/run.sh\"; chmod +x \"$TEST_WORKDIR/scripts/run.sh\"; }. run_detect() { run bash -c \"cd '$TEST_WORKDIR' && CLAUDE_CONFIG_DIR='$CLAUDE_CONFIG_DIR' bash '$DETECT' '$TEST_WORKDIR'\"; }. run_generate() { run bash -c \"cd '$TEST_WORKDIR' && CLAUDE_CONFIG_DIR='$CLAUDE_CONFIG_DIR' bash '$GENERATE' '$TEST_WORKDIR'\"; }. run_compile(role) { run bash -c \"cd '$TEST_WORKDIR' && bash '$COMPILE' 01 '$role' '$TEST_WORKDIR/.yolo-planning/phases'\"; }. Tests (minimum 12): (1) '@test \"pipeline: web-app detect -> classify\"' -- mk_webapp_project, run_detect, assert_success, echo \"$output\" | jq -e '.project_type == \"web-app\"'. (2) '@test \"pipeline: web-app generate -> backend.toon\"' -- mk_webapp_project, run_generate, assert_success, assert_file_contains \"$TEST_WORKDIR/.yolo-planning/departments/backend.toon\" 'TypeScript'. (3) '@test \"pipeline: web-app generate -> uiux.toon\"' -- mk_webapp_project, run_generate, assert_file_contains ...uiux.toon 'design tokens'. (4) '@test \"pipeline: web-app compile -> dev context\"' -- mk_webapp_project, run_generate (no assert, just execute to create files), run_compile dev, assert_success, assert_file_contains \"$PHASE_DIR/.ctx-dev.toon\" 'dept_conventions'. (5) '@test \"pipeline: web-app compile -> dev has TypeScript\"' -- mk_webapp_project, bash \"$GENERATE\" \"$TEST_WORKDIR\" (direct call), run_compile dev, assert_file_contains .ctx-dev.toon 'TypeScript'. (6) '@test \"pipeline: shell-project detect -> cli-tool\"' -- mk_shell_project, run_detect, assert_success, echo \"$output\" | jq -e '.project_type == \"cli-tool\"'. (7) '@test \"pipeline: shell-project generate -> Bash conventions\"' -- mk_shell_project, run_generate, assert_success, assert_file_contains ...backend.toon 'Bash'. (8) '@test \"pipeline: shell-project generate -> CLI UX focus\"' -- mk_shell_project, run_generate, assert_file_contains ...uiux.toon 'help text'. (9) '@test \"pipeline: shell-project compile -> dev has Bash\"' -- mk_shell_project, bash \"$GENERATE\" \"$TEST_WORKDIR\", run_compile dev, assert_file_contains .ctx-dev.toon 'Bash'. (10) '@test \"refresh: first run creates .stack-hash\"' -- mk_webapp_project, run_generate, assert_file_exists \"$TEST_WORKDIR/.yolo-planning/departments/.stack-hash\". (11) '@test \"refresh: second run skips regeneration\"' -- mk_webapp_project, run_generate, run_generate, assert_output --partial 'TOONs up to date'. (12) '@test \"refresh: --force flag regenerates\"' -- mk_webapp_project, run bash -c \"cd '$TEST_WORKDIR' && CLAUDE_CONFIG_DIR='$CLAUDE_CONFIG_DIR' bash '$GENERATE' '$TEST_WORKDIR' --force\", assert_output --partial 'Force regeneration' or 'Generated department TOONs'. (13) '@test \"refresh: project change triggers regeneration\"' -- mk_webapp_project, run_generate (creates hash), add express to package.json, run_generate, assert_output --partial 'Stack changed'. Note: For tests that call generate before compile, use direct bash invocation (not 'run') so the files are actually written to disk before compile-context.sh reads them.","ts":"This IS the test task (partially -- it is the main deliverable). Verify by running: bats tests/integration/persona-pipeline.bats -- all tests should pass. Minimum 12 tests covering: web-app full pipeline (detect->generate->compile), shell-project full pipeline, refresh mechanism (hash create, skip, force, change detection)."}
{"id":"01-04-03","n":"Validate YOLO project self-detection","f":["tests/integration/persona-pipeline.bats"],"d":["01-04-02"],"ac":["Integration test runs detect-stack.sh on actual YOLO project root","Verifies project_type is cli-tool (bash scripts, no package.json, CLI interface)","Verifies generated backend.toon contains: Bash language, BATS testing, jq tooling, kebab-case scripts","Verifies generated uiux.toon contains: help text quality, error output formatting, progress indicators (CLI ux_focus)","Verifies generated frontend.toon is appropriate for CLI (minimal or disabled per config)","Verifies no reference to TypeScript, React, or web-specific conventions in generated TOONs"],"spec":"Append additional tests to tests/integration/persona-pipeline.bats (same file as 01-04-02). These tests run against the ACTUAL YOLO project root ($PROJECT_ROOT from common.bash), not mock fixtures. This is the self-test: YOLO detecting its own type. Tests (minimum 6, appended after the fixture-based tests): (1) '@test \"self-test: YOLO project detects as cli-tool\"' -- run bash -c \"CLAUDE_CONFIG_DIR='$CLAUDE_CONFIG_DIR' bash '$DETECT' '$PROJECT_ROOT'\", assert_success, echo \"$output\" | jq -e '.project_type == \"cli-tool\"'. This validates C-09 (YOLO project self-detection). (2) '@test \"self-test: YOLO project generates Bash backend conventions\"' -- Create temp output dir to avoid polluting actual project: export YOLO_OUTPUT=\"$TEST_WORKDIR/yolo-self-test\"; mkdir -p \"$YOLO_OUTPUT/.yolo-planning\"; run bash -c \"CLAUDE_CONFIG_DIR='$CLAUDE_CONFIG_DIR' bash '$GENERATE' '$PROJECT_ROOT'\". BUT this writes to $PROJECT_ROOT/.yolo-planning/departments which we may not want. Better approach: copy YOLO project signature files to TEST_WORKDIR to simulate. Create a YOLO-like fixture: mk_yolo_fixture() { mkdir -p \"$TEST_WORKDIR/scripts\" \"$TEST_WORKDIR/agents\" \"$TEST_WORKDIR/commands\" \"$TEST_WORKDIR/hooks\" \"$TEST_WORKDIR/config\" \"$TEST_WORKDIR/references/departments\" \"$TEST_WORKDIR/tests\"; touch \"$TEST_WORKDIR/scripts/detect-stack.sh\" \"$TEST_WORKDIR/scripts/compile-context.sh\"; touch \"$TEST_WORKDIR/VERSION\"; }. This mimics the YOLO project structure (bash scripts, no package.json, CLI tool pattern). Run detect -> verify cli-tool, run generate -> verify Bash conventions. (3) '@test \"self-test: YOLO-like project backend.toon has Bash\"' -- mk_yolo_fixture, run_generate, assert_file_contains ...backend.toon 'Bash'. (4) '@test \"self-test: YOLO-like project backend.toon has BATS testing\"' -- mk_yolo_fixture, run_generate, assert_file_contains ...backend.toon 'BATS' or 'bats'. (5) '@test \"self-test: YOLO-like project uiux.toon has CLI UX focus\"' -- mk_yolo_fixture, run_generate, assert_file_contains ...uiux.toon 'help text'. (6) '@test \"self-test: YOLO-like project has no TypeScript references\"' -- mk_yolo_fixture, run_generate, assert_file_not_contains ...backend.toon 'TypeScript'. assert_file_not_contains ...backend.toon 'React'. (7) '@test \"self-test: YOLO-like project uiux.toon has error output formatting\"' -- mk_yolo_fixture, run_generate, assert_file_contains ...uiux.toon 'error output formatting'. Add the mk_yolo_fixture helper function alongside the other helpers at the top of the test file (or in setup if shared). The key insight: we use a YOLO-like fixture (scripts/, agents/, config/, no package.json) rather than running against the actual project root, to keep tests isolated and not write to the real .yolo-planning/departments/ directory.","ts":"This IS the test task (appended to the same file). Verify by running: bats tests/integration/persona-pipeline.bats -- all tests should pass, including the self-test section. Minimum 6 self-test cases validating YOLO-like project gets cli-tool classification with Bash/BATS/jq conventions and CLI UX focus."}
