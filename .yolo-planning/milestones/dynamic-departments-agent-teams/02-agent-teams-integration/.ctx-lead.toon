phase: 02
goal: Replace Task-only spawning with Teammate API for multi-dept mode — one team per department with parallel execution

architecture:
  phase: 02
  title: Agent Teams Integration Architecture
  decision: Option B — File-Based Coordination with Background Subagents (No Teammate API)
  
  rationale: The Teammate API (spawnTeam, SendMessage) is experimental with critical


decisions:
  lead: Split phase into 4 plans across 3 waves: lifecycle scripts + hook adaptations (W1 parallel), protocol updates (W2), go.md integration (W3) (Wave 1 plans have zero file overlap so can execute in parallel. Protocol updates depend on both lifecycle scripts and hooks being in place. Go.md integration is final because it wires everything together.)
  lead: Placed hooks adaptations (02-02) in wave 1 alongside lifecycle scripts (02-01) instead of wave 2 (Hooks modify existing files only (agent-start.sh, validate-send-message.sh) with no file overlap with 02-01 (which creates new files). Parallel execution saves one wave of execution time.)
  lead: Every plan explicitly preserves Task tool fallback when agent_teams=false (Config has agent_teams:true but single-dept projects or users who disable it must work identically to current behavior. Zero regression is a hard requirement per 02-CONTEXT.md constraints.)
  lead: Created config/team-profiles.json as new file rather than extending defaults.json (Team composition data is complex (26 agents across 4 departments with roles, models, tools). Embedding in defaults.json would bloat it. Separate file follows existing pattern (project-types.json, stack-mappings.json, model-profiles.json are all separate config files).)
  architect: Option B: File-based coordination with background Task subagents. No Teammate API. (Teammate API is experimental with critical reliability issues: SendMessage delivery failures (GitHub #23415, #24108), delegate mode strips file tools (#25037), no nested teams, one team per session. User directive: prefer file-based with locks if unreliable. Background Task subagents are stable, support 10 concurrent, and proven in existing architecture.)
  architect: Sentinel files with flock locking for handoff gates (File existence checks are deterministic and instant. flock provides POSIX-compatible atomic writes. Sentinel files survive crashes and session restarts. No polling of async message queues. Debuggable — ls the phase directory to see gate state.)
  architect: Orchestration logic in execute-protocol.md, not go.md. Addresses C-09. (go.md is already 300+ lines and focused on mode detection/dispatch. Multi-dept orchestration (polling loops, gate checks, cleanup) belongs in the execution protocol that go.md references. go.md calls dept-orchestrate.sh for spawn plan then follows execute-protocol.md instructions.)
  architect: Separate .dept-status-{dept}.json per department + .phase-orchestration.json for master state. Addresses C-15. (Per-department files enable atomic writes without contention (each dept writes its own file). Master orchestration file aggregates gate state and timing. .execution-state.json gets minimal departments extension for resume support. No team_id or agents array duplication.)
  architect: Eliminate spawn-team.sh, shutdown-team.sh, team-profiles.json. Create 4 focused scripts instead. Addresses C-04, C-05, C-06, C-11. (No Teammate API means no team lifecycle scripts needed. New scripts (dept-orchestrate.sh, dept-status.sh, dept-gate.sh, dept-cleanup.sh) are focused, testable, and follow existing patterns. Scope drops from 18 tasks to ~10-12.)

success_criteria: Not available
