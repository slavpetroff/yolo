---
phase: "01"
plan: "01"
title: "Add loop config keys and enhance review_plan.rs with actionable feedback"
wave: 1
depends_on: []
must_haves:
  - "review_max_cycles and qa_max_cycles config keys in config.json and defaults.json"
  - "review_plan.rs findings include suggested_fix and auto_fixable fields"
  - "New event types in log_event.rs ALLOWED_EVENT_TYPES"
  - "Unit tests for enhanced review_plan.rs output"
---

# Plan 01: Add Loop Config Keys and Enhance review_plan.rs

## Goal

Add configurable loop limits to config, enhance the review_plan Rust command with actionable feedback fields (suggested_fix, auto_fixable) so the Architect can programmatically address findings, and add event types for loop tracking.

## Tasks

### Task 1: Add loop config keys to config.json and defaults.json

**Files:** `.yolo-planning/config.json`, `config/defaults.json`

**Read both files first.** Add after the existing `qa_gate` key:

```json
"review_max_cycles": 3,
"qa_max_cycles": 3
```

These control the maximum number of revision iterations before hard-stopping:
- `review_max_cycles`: Max Architect ↔ Reviewer loops (range 1-5, default 3)
- `qa_max_cycles`: Max Dev ↔ QA loops (range 1-5, default 3)

**Verification:** `jq '.review_max_cycles' .yolo-planning/config.json` returns `3`.

### Task 2: Enhance review_plan.rs findings with suggested_fix and auto_fixable

**Files:** `yolo-mcp-server/src/commands/review_plan.rs`

**Read the full file first.** For each `findings.push(json!({...}))` call, add two new fields:

1. **Frontmatter check** (around line 62-66): Missing required fields
   - `suggested_fix`: "Add missing frontmatter fields: {missing_fields}"
   - `auto_fixable`: true

2. **Task count check** (around line 75-79): Too many tasks
   - `suggested_fix`: "Split plan into multiple plans with ≤5 tasks each"
   - `auto_fixable`: true

3. **Must-haves check** (around line 89-93): Empty must_haves
   - `suggested_fix`: "Add specific, testable must_haves to plan frontmatter"
   - `auto_fixable`: true

4. **Wave validity check** (around line 116-120): Invalid wave number
   - `suggested_fix`: "Set wave to a positive integer (1 for independent plans)"
   - `auto_fixable`: true

5. **File paths check** (around line 157-161): Missing file paths
   - `suggested_fix`: "Verify file paths exist in codebase or update references"
   - `auto_fixable`: false (requires human judgment)

**Updated finding JSON structure:**
```rust
findings.push(json!({
    "severity": "high",
    "check": "frontmatter",
    "issue": format!("Missing fields: {}", missing.join(", ")),
    "suggested_fix": "Add missing frontmatter fields to plan YAML header",
    "auto_fixable": true
}));
```

**Verification:** `cargo build` succeeds. Unit tests pass.

### Task 3: Add loop event types to log_event.rs

**Files:** `yolo-mcp-server/src/commands/log_event.rs`

**Read the file first.** Add new event types to the `ALLOWED_EVENT_TYPES` array (around line 16-31):

```rust
// Feedback loop events
"review_loop_start", "review_loop_cycle", "review_loop_end",
"qa_loop_start", "qa_loop_cycle", "qa_loop_end",
```

**Verification:** `cargo build` succeeds.

### Task 4: Update unit tests for enhanced review_plan output

**Files:** `yolo-mcp-server/src/commands/review_plan.rs` (inline tests)

**Read the existing tests.** Add/update tests to verify:
1. Each finding in the output has `suggested_fix` and `auto_fixable` fields
2. The `suggested_fix` is a non-empty string
3. The `auto_fixable` is a boolean
4. Test for both auto_fixable=true (frontmatter) and auto_fixable=false (file paths)

**Verification:** `cargo test -p yolo-mcp-server` passes.

### Task 5: Build, install binary, and commit all changes

**Actions:**
1. Run `cargo build --release` from `yolo-mcp-server/` directory
2. Install: `cp target/release/yolo "$HOME/.cargo/bin/yolo"`
3. Verify: `yolo review-plan --help` or smoke test

**Commits (one per logical group):**
- `feat(01-01): add review_max_cycles and qa_max_cycles config keys`
- `feat(01-01): enhance review_plan findings with suggested_fix and auto_fixable`
- `feat(01-01): add feedback loop event types to log_event`
- `test(01-01): update review_plan tests for enhanced finding fields`
