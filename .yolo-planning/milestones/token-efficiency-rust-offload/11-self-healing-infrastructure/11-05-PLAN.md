---
phase: 11
plan: 5
title: Enable Recovery Feature Flags and Integration Verification
wave: 2
depends_on: [1, 2, 3, 4]
must_haves:
  - v3_event_recovery default changed to true in defaults.json
  - v3_snapshot_resume default changed to true in defaults.json
  - v3_lease_locks default changed to true in defaults.json
  - Integration tests verify end-to-end recovery flow with all flags enabled
  - All existing tests pass with new defaults
---

# Plan 11-05: Enable Recovery Feature Flags and Integration Verification

## Context

Phase 11 Plans 1-4 added retry logic, atomic writes, timeouts, and task lease TTL. The feature flags `v3_event_recovery`, `v3_snapshot_resume`, and `v3_lease_locks` currently default to `false` in `config/defaults.json`. This plan flips them to `true` and adds integration tests verifying the complete self-healing pipeline works end-to-end.

This plan depends on all wave-1 plans completing first. It modifies `config/defaults.json` (shared, but wave-2 so no conflict) and adds new test files.

## Files to Modify

| File | Action | What Changes |
|------|--------|-------------|
| `config/defaults.json` | EDIT | Flip v3_event_recovery, v3_snapshot_resume, v3_lease_locks to true |
| `yolo-mcp-server/src/commands/feature_flags.rs` | EDIT | Add test verifying the three flags default to true |
| `yolo-mcp-server/src/commands/recover_state.rs` | EDIT | Add integration test with all recovery features enabled |
| `yolo-mcp-server/src/commands/snapshot_resume.rs` | EDIT | Add integration test verifying snapshot works with flag enabled by default |

## Tasks

### Task 1: Flip feature flags to true in defaults.json

In `config/defaults.json`:
- Change `"v3_event_recovery": false` to `"v3_event_recovery": true`
- Change `"v3_snapshot_resume": false` to `"v3_snapshot_resume": true`
- Change `"v3_lease_locks": false` to `"v3_lease_locks": true`
- Run existing test suite to verify no regressions (tests that create their own config.json are isolated)

**Commit:** `feat(config): enable v3_event_recovery, v3_snapshot_resume, v3_lease_locks by default`

### Task 2: Add feature flag default verification tests

In `feature_flags.rs` tests:
- Add test `test_recovery_flags_default_true`: read `defaults.json`, verify `v3_event_recovery`, `v3_snapshot_resume`, `v3_lease_locks` are all `true`
- This acts as a contract test preventing accidental flag regression

**Commit:** `test(commands): add contract tests for recovery feature flag defaults`

### Task 3: Add recovery integration test

In `recover_state.rs` tests:
- Add `test_recover_with_all_features_enabled`: set up environment with `v3_event_recovery: true`, create plans with SUMMARY files and event log entries, verify full recovery pipeline works
- Verify recovered state includes wave tracking, plan statuses from both SUMMARY files and event log

**Commit:** `test(commands): add integration test for full recovery pipeline`

### Task 4: Add snapshot integration test

In `snapshot_resume.rs` tests:
- Add `test_snapshot_save_restore_with_default_config`: use a config that only has the new defaults (flags enabled), verify save creates snapshot and restore finds it
- Verify snapshot contains execution state, git log, and agent role

**Commit:** `test(commands): add integration test for snapshot resume with default flags`

### Task 5: Add telemetry recovery event tracking test

Add a test (in `recover_state.rs` or a new section) that verifies:
- When recovery detects a stale lease (from Plan 4), the recovery event is properly structured
- When atomic read detects checksum mismatch (from Plan 2), the fallback works within the recovery context
- This is a cross-cutting integration test validating Plans 2 + 4 work together under the new flag defaults

**Commit:** `test(commands): add cross-cutting recovery integration test`
