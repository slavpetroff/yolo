---
phase: 11
plan: 4
title: Task Lease TTL with Auto-Reassignment
wave: 1
depends_on: []
must_haves:
  - Tasks auto-released after 5min idle (configurable task_lease_ttl_secs)
  - Expired task leases re-queued as pending for reassignment
  - cleanup_expired enhanced to log reassignment events
  - recover_state.rs checks lease staleness when determining plan status
  - All existing lease_lock and recover_state tests pass
---

# Plan 11-04: Task Lease TTL with Auto-Reassignment

## Context

The existing `lease_lock.rs` has TTL-based expiration (300s default) and a `cleanup_expired()` function, but there is no mechanism to automatically re-queue tasks held by crashed agents. When an agent crashes, its task stays "in_progress" forever in the planning state. This plan enhances the lease system to detect stale task leases and mark them for reassignment, and teaches `recover_state.rs` to factor lease staleness into plan status.

This plan only modifies `src/commands/lease_lock.rs` and `src/commands/recover_state.rs`. These files are not touched by Plans 1, 2, or 3.

## Files to Modify

| File | Action | What Changes |
|------|--------|-------------|
| `yolo-mcp-server/src/commands/lease_lock.rs` | EDIT | Add task_lease_ttl_secs config, enhance cleanup_expired with reassignment logging, add reassign_expired_tasks() |
| `yolo-mcp-server/src/commands/recover_state.rs` | EDIT | Check lease staleness when determining plan/task status |
| `config/defaults.json` | EDIT | Add `task_lease_ttl_secs` key (default 300) |

## Tasks

### Task 1: Add task_lease_ttl_secs config key and reading

In `lease_lock.rs`:
- Add `fn read_task_lease_ttl(cwd: &Path) -> u64` that reads `.yolo-planning/config.json` `task_lease_ttl_secs`, defaults to 300
- In `config/defaults.json`, add `"task_lease_ttl_secs": 300`
- Update `acquire()` to use config TTL as default when caller passes 0 or DEFAULT_TTL_SECS
- Unit test: verify config reading with custom and default values

**Commit:** `feat(commands): add task_lease_ttl_secs config key for lease TTL`

### Task 2: Add reassign_expired_tasks function

In `lease_lock.rs`, add:
- `pub fn reassign_expired_tasks(cwd: &Path) -> Value`: scans `.locks/` directory for expired leases, removes them, and returns a JSON report listing each reassigned resource with previous owner
- Each reassigned lease gets logged to `.events/event-log.jsonl` as `"task_reassigned"` event (if v3_event_log is enabled)
- Returns `{"action": "reassign", "reassigned": [...], "count": N}`
- Unit tests: create expired leases, call reassign, verify they are removed and report is correct

**Commit:** `feat(commands): add reassign_expired_tasks for crashed agent recovery`

### Task 3: Wire reassignment into CLI and enhance cleanup_expired

In `lease_lock.rs`:
- Add `"reassign"` action to the `execute()` CLI handler
- Enhance `cleanup_expired()` to optionally call `reassign_expired_tasks` and include reassignment info in its return value
- CLI: `yolo lease-lock reassign` triggers the new function
- Unit test: verify CLI routing for reassign action

**Commit:** `feat(commands): wire task reassignment into lease-lock CLI`

### Task 4: Teach recover_state.rs to check lease staleness

In `recover_state.rs`:
- After collecting plan status from SUMMARY.md and event log, also check if any plan's associated lease is expired (if a `.locks/{plan_id}.lease` file exists and is expired)
- If a plan shows as "running" but its lease is expired, mark it as "stale" in the recovered state
- Add "stale" as a recognized status that triggers re-queuing by the orchestrator
- Unit tests: create a plan with an expired lease, verify recover_state reports it as stale

**Commit:** `feat(commands): detect stale task leases in recover_state`

### Task 5: Integration tests for lease TTL and reassignment flow

Add integration tests:
- End-to-end: acquire lease, artificially expire it (write old timestamp), call reassign_expired_tasks, verify lease removed and event logged
- Verify recover_state marks expired-lease plans as stale
- Verify fresh leases are NOT reassigned
- Verify reassignment report includes previous owner info

**Commit:** `test(commands): add integration tests for task lease TTL and reassignment`
