---
phase: "03"
plan: "02"
title: "Wire review gate into execute-protocol, config, hooks, and tests"
wave: 1
depends_on: []
must_haves:
  - "review_gate config key in config.json and defaults.json"
  - "model-profiles.json has reviewer entries in all 3 profiles"
  - "hooks.json has yolo-reviewer in all 4 agent matchers"
  - "execute-protocol SKILL.md has review gate section between Step 2 and Step 3"
  - "Bats tests for review-plan command"
---

# Plan 02: Wire Review Gate into Execute-Protocol, Config, Hooks, and Tests

## Goal

Add the review_gate config setting, wire the reviewer into model-profiles.json and hooks.json, insert the review gate into the execute-protocol, and add bats integration tests.

## Tasks

### Task 1: Add review_gate config and reviewer entries

**Files:** `.yolo-planning/config.json`, `config/defaults.json`, `yolo-mcp-server/src/commands/resolve_model.rs`

**Changes to config.json:** Add after the last line before the closing `}`:
```json
"review_gate": "on_request"
```

**Changes to defaults.json:** Add after `"v4_session_cache_warm": false`:
```json
"review_gate": "on_request"
```

Valid values: `"always"` (run review on every phase), `"on_request"` (run when user explicitly requests), `"never"` (skip review gate entirely). Default: `"on_request"`.

**Changes to resolve_model.rs:** Add `"reviewer"` to the VALID_AGENTS array (same as "researcher" was added in Phase 2). Search for the VALID_AGENTS constant and append "reviewer".

**Also add reviewer to agent_max_turns in both config.json and defaults.json:**
```json
"agent_max_turns": {
    ...existing entries...,
    "reviewer": 15
}
```

**Verification:** `jq '.review_gate' .yolo-planning/config.json` returns `"on_request"`. `jq '.review_gate' config/defaults.json` returns `"on_request"`.

### Task 2: Add reviewer to model-profiles.json and hooks.json

**Files:** `config/model-profiles.json`, `hooks/hooks.json`

**model-profiles.json:** Add reviewer to all 3 profiles:
- quality: `"reviewer": "opus"` (architectural critique needs strongest reasoning)
- balanced: `"reviewer": "sonnet"`
- budget: `"reviewer": "sonnet"`

**hooks.json:** Append to ALL 4 matcher strings (SubagentStart line 31, SubagentStop line 43, TeammateIdle line 55, TaskCompleted line 67):
```
|yolo-reviewer|yolo:yolo-reviewer|reviewer|team-reviewer
```

**Verification:** `jq '.quality.reviewer' config/model-profiles.json` returns `"opus"`. `grep -c "yolo-reviewer" hooks/hooks.json` returns `4`.

### Task 3: Add review gate to execute-protocol SKILL.md

**Files:** `skills/execute-protocol/SKILL.md`

**Insertion point:** Between Step 2 (line 59, after cross-phase deps) and Step 3 (line 61, `### Step 3: Create Agent Team and execute`).

**Insert a new section:**

```markdown
### Step 2b: Review gate (optional)

**Activation:** Read `review_gate` from config:
```bash
REVIEW_GATE=$(jq -r '.review_gate // "on_request"' .yolo-planning/config.json 2>/dev/null)
```

| review_gate | Behavior |
|-------------|----------|
| always | Run automated review on every plan before execution |
| on_request | Skip unless user passes `--review` flag |
| never | Skip entirely |

**When active:**

1. For each plan in the phase, run automated checks:
```bash
REVIEW_RESULT=$("$HOME/.cargo/bin/yolo" review-plan {plan_path} {phase_dir})
```

2. Parse verdict from JSON output:
   - `verdict: "approve"` → Display `✓ Plan {NN-MM} review: approved` and proceed
   - `verdict: "conditional"` → Display `⚠ Plan {NN-MM} review: conditional` with findings. Attach findings to Dev context as warnings. Proceed.
   - `verdict: "reject"` → Display `✗ Plan {NN-MM} review: rejected` with findings. STOP execution. Return findings to user with suggestion: "Fix issues and re-run `/yolo:vibe --execute {N}`"

3. If ALL plans approve or conditional: proceed to Step 3
4. If ANY plan rejected: STOP. Do not create Dev team.

**When inactive:** Display `○ Review gate skipped (review_gate: {value})` and proceed to Step 3.
```

**Verification:** Read SKILL.md. Section `### Step 2b: Review gate` exists between Step 2 and Step 3.

### Task 4: Add bats tests for review-plan command

**Files:** `tests/review-plan.bats` (new)

**Create a new bats test file following the tier-cache.bats pattern.**

**Setup:** Create temp dir with a valid plan file and phase directory.

```bash
setup() {
    TEST_TEMP_DIR=$(mktemp -d)
    YOLO_BIN="${YOLO_BIN:-$HOME/.cargo/bin/yolo}"

    # Create a valid plan file
    mkdir -p "$TEST_TEMP_DIR/phases/01-test"
    cat > "$TEST_TEMP_DIR/phases/01-test/01-01-PLAN.md" << 'PLAN'
---
phase: "01"
plan: "01"
title: "Test plan"
wave: 1
depends_on: []
must_haves:
  - "thing works"
---
# Test Plan
## Tasks
### Task 1: Do thing
**Files:** `README.md`
Content here.
PLAN

    # Create referenced file
    touch "$TEST_TEMP_DIR/README.md"
}

teardown() {
    rm -rf "$TEST_TEMP_DIR"
}
```

**Tests:**

1. `@test "review-plan approves valid plan"` — Run review-plan on valid plan. Verify exit 0, output contains `"verdict":"approve"`.

2. `@test "review-plan rejects plan without frontmatter"` — Create plan without `---`. Verify exit 1, output contains `"verdict":"reject"`.

3. `@test "review-plan warns about missing must_haves"` — Create plan with empty must_haves. Verify finding in output.

4. `@test "review-plan checks task count"` — Create plan with 7 tasks. Verify warning finding.

5. `@test "review-plan validates file paths"` — Create plan referencing non-existent file. Verify file_paths check in output.

**Verification:** `bats tests/review-plan.bats` passes with all tests green.
