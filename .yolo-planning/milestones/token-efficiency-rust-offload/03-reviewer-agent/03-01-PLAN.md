---
phase: "03"
plan: "01"
title: "Create reviewer agent, review-plan Rust command, and tier_context update"
wave: 1
depends_on: []
must_haves:
  - "agents/yolo-reviewer.md exists with Read, Glob, Grep, Bash tools"
  - "role_family('reviewer') returns 'planning' in tier_context.rs"
  - "yolo review-plan <plan_path> produces structured JSON verdict"
  - "Unit tests pass for review-plan and role_family"
---

# Plan 01: Create Reviewer Agent, review-plan Rust Command, and tier_context Update

## Goal

Create the adversarial reviewer agent definition, build the `yolo review-plan` Rust CLI command for automated plan quality checks, and add the reviewer to the planning role family.

## Tasks

### Task 1: Create agents/yolo-reviewer.md

**Files:** `agents/yolo-reviewer.md` (new)

**Create the reviewer agent file following the yolo-researcher.md pattern.**

Frontmatter:
```yaml
---
name: yolo-reviewer
description: Adversarial reviewer agent that critiques architectural designs and validates plan quality before execution.
tools: Read, Glob, Grep, Bash
disallowedTools: Edit, Write, WebFetch, WebSearch
model: inherit
maxTurns: 15
permissionMode: default
---
```

Note: Reviewer has READ-ONLY access (no Write/Edit) — it produces its verdict via the return message to the orchestrator, not by writing files. This is intentional: the reviewer should never modify plans, only critique them.

Body sections (keep concise, follow yolo-researcher.md structure):

1. **Header:** "YOLO Reviewer" — Adversarial review agent. Critiques architectural designs, validates code quality patterns, and serves as a quality gate between plan creation and execution.

2. **Core Protocol:**
   - Read the plan file(s) from task description
   - Read relevant codebase files referenced in the plan (use Glob/Grep to verify file paths exist)
   - Run `yolo review-plan <plan_path>` for automated checks
   - Apply adversarial analysis: identify design risks, anti-patterns, missing edge cases, naming violations, file conflicts
   - Produce structured verdict

3. **Verdict Format:**
   Return verdict as structured text in your completion message:
   ```
   VERDICT: approve|reject|conditional
   FINDINGS:
   - [severity:high|medium|low] [file:path] issue: description | suggestion: fix
   ```
   - **approve**: No blocking issues found. Proceed with execution.
   - **reject**: Critical issues found. Execution must NOT proceed. List all findings.
   - **conditional**: Non-critical issues found. Execution may proceed with warnings attached to Dev context.

4. **Review Checklist:**
   - Frontmatter completeness (phase, plan, title, wave, depends_on, must_haves)
   - Task count reasonable (1-5 per plan)
   - File paths in plan exist in codebase (Glob check)
   - Same-wave plans don't modify overlapping files
   - Naming conventions followed (commit format, file naming per CONVENTIONS.md)
   - Must-haves are testable/verifiable
   - No obvious security anti-patterns (command injection, path traversal)

5. **Subagent Usage:** Reviewer does NOT spawn subagents. Conducts all review inline.

6. **Circuit Breaker:** Same error 3 times → STOP, report blocker. No 4th retry.

7. **Constraints:**
   - Review only — never modify code or plans
   - No internet access needed (codebase analysis only)
   - Be adversarial but constructive — every rejection must include actionable suggestions

**Verification:** File exists at `agents/yolo-reviewer.md`. Has valid frontmatter.

### Task 2: Add reviewer to role_family in tier_context.rs

**Files:** `yolo-mcp-server/src/commands/tier_context.rs`

**Current state (line 69):**
```rust
"architect" | "lead" | "researcher" => "planning",
```

**Change:** Add `"reviewer"` to the planning family:
```rust
"architect" | "lead" | "researcher" | "reviewer" => "planning",
```

**Also add unit test:**
```rust
#[test]
fn test_reviewer_is_planning_family() {
    assert_eq!(role_family("reviewer"), "planning");
}
```

**Verification:** `cargo test -p yolo-mcp-server -- role_family` passes.

### Task 3: Create review_plan.rs Rust command

**Files:** `yolo-mcp-server/src/commands/review_plan.rs` (new), `yolo-mcp-server/src/commands/mod.rs`, `yolo-mcp-server/src/cli/router.rs`

**Usage:** `yolo review-plan <plan_path> [<phase_dir>]`

**Follow the validate_plan.rs pattern (same file structure, JSON output, exit codes).**

**Checks to implement:**

1. **Frontmatter completeness:** Verify plan has: phase, plan, title, wave, depends_on, must_haves fields
2. **Task count:** Count `### Task N:` headers. Warn if >5 (max_tasks_per_plan default)
3. **Must-haves present:** Verify must_haves array is non-empty
4. **Wave validity:** wave must be a positive integer
5. **File paths check:** If phase_dir provided, extract file paths mentioned in plan tasks (lines starting with `**Files:**`), check they exist on disk (skip `(new)` files)

**Output:** JSON structured return:
```json
{
  "ok": true,
  "cmd": "review-plan",
  "verdict": "approve",
  "checks": [
    {"name": "frontmatter", "status": "pass"},
    {"name": "task_count", "status": "pass", "count": 4},
    {"name": "must_haves", "status": "pass", "count": 3},
    {"name": "wave_valid", "status": "pass"},
    {"name": "file_paths", "status": "pass", "checked": 5, "missing": 0}
  ],
  "findings": []
}
```

On failure:
```json
{
  "ok": false,
  "cmd": "review-plan",
  "verdict": "reject",
  "checks": [...],
  "findings": [
    {"severity": "high", "check": "frontmatter", "issue": "Missing must_haves field"}
  ]
}
```

**Exit codes:** 0=approve, 1=reject (critical findings), 2=conditional (warnings only)

**Route in router.rs:** Add `"review-plan"` route.

**Verification:** `cargo build` succeeds. `cargo test -p yolo-mcp-server -- review_plan` passes.

### Task 4: Add unit tests for review_plan

**Files:** `yolo-mcp-server/src/commands/review_plan.rs`

**Add inline tests (same pattern as validate_plan.rs):**

1. `test_review_plan_valid` — Create a temp plan file with valid frontmatter and tasks. Verify exit 0, verdict "approve".

2. `test_review_plan_missing_frontmatter` — Plan file without `---` frontmatter. Verify exit 1, verdict "reject", finding mentions "frontmatter".

3. `test_review_plan_missing_must_haves` — Valid frontmatter but empty must_haves. Verify finding about must_haves.

4. `test_review_plan_too_many_tasks` — Plan with 7 tasks (>5). Verify warning finding about task count.

5. `test_review_plan_file_paths_check` — Plan references existing and non-existing files. Verify file_paths check reports missing count.

**Verification:** `cargo test -p yolo-mcp-server -- review_plan` passes with all tests green.
