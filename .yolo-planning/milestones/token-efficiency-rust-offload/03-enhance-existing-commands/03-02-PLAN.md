---
phase: "03"
plan: "02"
title: "session-start --with-progress --with-git and detect-stack --brownfield"
wave: 1
depends_on: []
must_haves:
  - "session-start accepts args via updated router dispatch and function signature"
  - "--with-progress injects compile-progress data into structuredResult"
  - "--with-git injects git-state data into structuredResult"
  - "session-start without flags is identical to current behavior"
  - "detect-stack --brownfield adds brownfield boolean to JSON output"
  - "All existing session-start and detect-stack bats tests still pass"
  - "New bats tests for each flag"
---

# Plan 03-02: session-start --with-progress --with-git and detect-stack --brownfield

## Summary

Enhance session-start to optionally include progress and git state in its JSON output (eliminating separate LLM-side calls), and add `--brownfield` to detect-stack to include brownfield detection inline.

## Task 1: Update session-start signature and router dispatch

**File:** `yolo-mcp-server/src/commands/session_start.rs`

**Changes:**
1. Change function signature at line 17 from:
   ```rust
   pub fn execute_session_start(cwd: &Path) -> Result<(String, i32), String> {
   ```
   to:
   ```rust
   pub fn execute_session_start(args: &[String], cwd: &Path) -> Result<(String, i32), String> {
   ```
2. At the top of the function (after line 18), add flag detection:
   ```rust
   let with_progress = args.iter().any(|a| a == "--with-progress");
   let with_git = args.iter().any(|a| a == "--with-git");
   ```

**File:** `yolo-mcp-server/src/cli/router.rs`

**Changes:**
1. At lines 413-416, change the SessionStart dispatch from:
   ```rust
   Some(Command::SessionStart) => {
       let cwd = std::env::current_dir().unwrap_or_else(|_| PathBuf::from("."));
       session_start::execute_session_start(&cwd)
   }
   ```
   to:
   ```rust
   Some(Command::SessionStart) => {
       let cwd = std::env::current_dir().unwrap_or_else(|_| PathBuf::from("."));
       session_start::execute_session_start(&args, &cwd)
   }
   ```

**Note:** The SessionStart hook event goes through `hooks/dispatcher.rs` which does NOT call `execute_session_start` -- it has its own handler. Only `router.rs:415` needs updating.

## Task 2: Add --with-progress injection to session-start

**File:** `yolo-mcp-server/src/commands/session_start.rs`

**Changes:**
After step 15 (build_context, around line 192), conditionally invoke compile_progress:

```rust
// 16. Optional: compile progress data
let progress_data = if with_progress {
    step_start = Instant::now();
    match super::compile_progress::execute(
        &vec!["yolo".into(), "compile-progress".into()],
        cwd,
    ) {
        Ok((output, 0)) => {
            steps.push(StepResult {
                name: "compile_progress",
                status: "ok",
                ms: step_start.elapsed().as_millis() as u64,
            });
            serde_json::from_str::<Value>(&output).ok()
        }
        _ => {
            steps.push(StepResult {
                name: "compile_progress",
                status: "error",
                ms: step_start.elapsed().as_millis() as u64,
            });
            None
        }
    }
} else {
    None
};
```

Then in the `structured` JSON object (around line 200), add:
```rust
"progress": progress_data,
```

This adds the full compile-progress JSON as a nested field. When `--with-progress` is not passed, it's `null` (no extra work).

## Task 3: Add --with-git injection to session-start

**File:** `yolo-mcp-server/src/commands/session_start.rs`

**Changes:**
After the progress step, conditionally invoke git_state:

```rust
// 17. Optional: git state
let git_data = if with_git {
    step_start = Instant::now();
    match super::git_state::execute(
        &vec!["yolo".into(), "git-state".into()],
        cwd,
    ) {
        Ok((output, 0)) => {
            steps.push(StepResult {
                name: "git_state",
                status: "ok",
                ms: step_start.elapsed().as_millis() as u64,
            });
            serde_json::from_str::<Value>(&output).ok()
        }
        _ => {
            steps.push(StepResult {
                name: "git_state",
                status: "error",
                ms: step_start.elapsed().as_millis() as u64,
            });
            None
        }
    }
} else {
    None
};
```

Then in the `structured` JSON object, add:
```rust
"git": git_data,
```

## Task 4: Add --brownfield to detect-stack

**File:** `yolo-mcp-server/src/commands/detect_stack.rs`

**Changes:**
1. After line 5 (arg parsing for project_dir), add flag detection:
   ```rust
   let include_brownfield = args.iter().any(|a| a == "--brownfield");
   ```
2. Before the final JSON output (line 297), conditionally add brownfield detection:
   ```rust
   let brownfield = if include_brownfield {
       let git_output = std::process::Command::new("git")
           .args(["ls-files", "."])
           .current_dir(project_dir)
           .output();
       match git_output {
           Ok(output) => {
               let stdout = String::from_utf8_lossy(&output.stdout);
               !stdout.trim().is_empty()
           }
           Err(_) => false,
       }
   } else {
       false
   };
   ```
3. In the output JSON object, add the field conditionally:
   ```rust
   // Only include brownfield key when flag is passed
   if include_brownfield {
       out["brownfield"] = json!(brownfield);
   }
   ```

   Or simpler: always include it when flag is passed. Modify the `json!()` macro call to use a mutable Value and insert conditionally, or use `serde_json::Map` manipulation.

   Cleanest approach: build the JSON with `serde_json::to_value` then `as_object_mut().insert()`:
   ```rust
   let mut out = json!({...existing fields...});
   if include_brownfield {
       out.as_object_mut().unwrap().insert("brownfield".to_string(), json!(brownfield));
   }
   ```

**Exit codes:** Unchanged (0 success, 1 error).

## Task 5: Add bats tests for new flags

**File:** `tests/sessionstart-compact-hooks.bats` (append)

Add tests:
```bash
@test "session-start --with-progress includes progress data" {
  cd "$TEST_TEMP_DIR"
  # Create a phase with plans for progress data
  mkdir -p .yolo-planning/phases/01-setup
  touch .yolo-planning/phases/01-setup/01-01-PLAN.md
  echo "## Task 1: work" > .yolo-planning/phases/01-setup/01-01-PLAN.md
  run "$YOLO_BIN" session-start --with-progress
  [ "$status" -eq 0 ]
  echo "$output" | jq -e '.structuredResult.progress' >/dev/null
  echo "$output" | jq -e '.structuredResult.progress.tasks.total' >/dev/null
}

@test "session-start --with-git includes git state" {
  cd "$TEST_TEMP_DIR"
  run "$YOLO_BIN" session-start --with-git
  [ "$status" -eq 0 ]
  echo "$output" | jq -e '.structuredResult.git' >/dev/null
  echo "$output" | jq -e '.structuredResult.git.branch' >/dev/null
}

@test "session-start without flags has no progress/git" {
  cd "$TEST_TEMP_DIR"
  run "$YOLO_BIN" session-start
  [ "$status" -eq 0 ]
  # Output should NOT have progress or git keys in structuredResult
  # (they will be null or absent)
  local has_progress=$(echo "$output" | jq '.structuredResult.progress // empty')
  [ -z "$has_progress" ]
}
```

**New file:** `tests/detect-stack.bats`

```bash
#!/usr/bin/env bats

load test_helper

setup() {
  setup_temp_dir
  create_test_config
  cd "$TEST_TEMP_DIR"
  git init --quiet
  git config user.email "test@test.com"
  git config user.name "Test"
  touch dummy && git add dummy && git commit -m "init" --quiet

  # Copy stack-mappings.json for detect-stack
  mkdir -p "$TEST_TEMP_DIR/config"
  cp "$CONFIG_DIR/stack-mappings.json" "$TEST_TEMP_DIR/config/"
}

teardown() {
  cd "$PROJECT_ROOT"
  teardown_temp_dir
}

@test "detect-stack --brownfield: true in git repo with files" {
  run "$YOLO_BIN" detect-stack "$TEST_TEMP_DIR" --brownfield
  [ "$status" -eq 0 ]
  echo "$output" | jq -e '.brownfield == true' >/dev/null
}

@test "detect-stack without --brownfield: no brownfield key" {
  run "$YOLO_BIN" detect-stack "$TEST_TEMP_DIR"
  [ "$status" -eq 0 ]
  # brownfield key should not be present
  local bf=$(echo "$output" | jq 'has("brownfield")')
  [ "$bf" = "false" ]
}
```

**Rust unit tests** to add in `session_start.rs` `mod tests`:
1. `test_session_start_accepts_args` — verify the function compiles and returns Ok with empty args
2. `test_with_progress_flag_recognized` — verify the flag parsing logic (can be a simple unit test on the flag pattern)

**Rust unit tests** to add in `detect_stack.rs` `mod tests`:
1. `test_detect_stack_brownfield_flag` — git repo with tracked files, `--brownfield` returns `brownfield: true`
2. `test_detect_stack_no_brownfield_flag` — without flag, output has no `brownfield` key

## Verification

1. `cargo test -p yolo --release` passes all existing + new unit tests
2. `bats tests/sessionstart-compact-hooks.bats` passes all existing + new tests
3. `bats tests/detect-stack.bats` passes all new tests
4. `yolo session-start` without flags produces identical output to current
5. `yolo detect-stack` without `--brownfield` produces identical output to current
