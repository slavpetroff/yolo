---
phase: "04"
plan: "02"
title: "Bats tests for feedback loop infrastructure"
wave: 1
depends_on: []
must_haves:
  - "Bats tests verify review_plan outputs suggested_fix and auto_fixable fields"
  - "Bats tests verify all QA commands output fixable_by field"
  - "Bats tests verify loop event types are accepted by log-event"
  - "Bats tests verify config keys review_max_cycles and qa_max_cycles"
  - "All new and existing tests pass"
---
# Plan 04-02: Bats tests for feedback loop infrastructure

## Context
Phases 1-3 added feedback loop support to the Rust commands and protocol. The loops themselves
are orchestrated by the execute-protocol (markdown protocol), but the underlying Rust infrastructure
(review_plan.rs enhanced output, QA commands with fixable_by, log_event.rs with loop events) can
be tested via bats. This plan adds tests covering the testable infrastructure.

Note: The loop orchestration logic lives in execute-protocol SKILL.md (a markdown protocol followed
by agents) and cannot be directly tested via bats. We test the CLI commands that the loops depend on.

## Tasks

### Task 1: Add review loop infrastructure tests
Create a new test file `tests/review-loop.bats` with tests covering the review_plan.rs
enhanced output fields that the review loop depends on:

1. `test review-plan reject verdict includes suggested_fix on findings` — Create a plan with
   missing must_haves (triggers high severity). Run `yolo review-plan`. Verify exit code 1,
   verdict "reject", and each finding has `suggested_fix` string and `auto_fixable` boolean.

2. `test review-plan conditional verdict has findings with auto_fixable` — Create a plan with
   >5 tasks (triggers medium severity). Run `yolo review-plan`. Verify exit code 2,
   verdict "conditional", findings have `auto_fixable` field.

3. `test review-plan approve verdict has no findings` — Create a valid plan. Run `yolo review-plan`.
   Verify exit code 0, verdict "approve", findings array empty.

4. `test review loop events accepted by log-event` — Run `yolo log-event review_loop_start 1`,
   `yolo log-event review_loop_cycle 1 cycle=1 verdict=reject`, `yolo log-event review_loop_end 1`.
   Verify all three return exit code 0.

Use the existing `tests/review-plan.bats` setup pattern as a template. Reuse the test_helper setup.

**File:** `tests/review-loop.bats`
**Commit:** `test(04-02): add review loop infrastructure bats tests`

### Task 2: Add QA loop infrastructure tests
Create a new test file `tests/qa-loop.bats` with tests covering QA command fixable_by fields
that the QA loop depends on:

1. `test verify-plan-completion failure has fixable_by dev` — Create invalid SUMMARY (missing fields).
   Run `yolo verify-plan-completion`. Verify failed checks have `fixable_by` != "none".

2. `test commit-lint violations have fixable_by dev and suggested_fix` — Create repo with bad
   commit messages. Run `yolo commit-lint`. Verify violations have `fixable_by: "dev"` and
   `suggested_fix` string.

3. `test check-regression always has fixable_by manual` — Run `yolo check-regression`.
   Verify output has `fixable_by: "manual"`.

4. `test QA loop events accepted by log-event` — Run `yolo log-event qa_loop_start 1`,
   `yolo log-event qa_loop_cycle 1 cycle=1 failed_count=2`, `yolo log-event qa_loop_end 1`.
   Verify all three return exit code 0.

5. `test validate-requirements has per-requirement fixable_by` — Run `yolo validate-requirements`.
   Verify each requirement in output has a `fixable_by` field.

Use the existing `tests/qa-commands.bats` setup pattern as a template.

**File:** `tests/qa-loop.bats`
**Commit:** `test(04-02): add QA loop infrastructure bats tests`

### Task 3: Add config validation tests
Add tests to verify the feedback loop config keys exist and have correct defaults:

1. `test config has review_max_cycles with default 3` — Read `.yolo-planning/config.json`.
   Verify `review_max_cycles` exists and equals 3.

2. `test config has qa_max_cycles with default 3` — Read `.yolo-planning/config.json`.
   Verify `qa_max_cycles` exists and equals 3.

3. `test defaults has review_max_cycles and qa_max_cycles` — Read `config/defaults.json`.
   Verify both keys exist.

Add these to the existing config test file if one exists, or create `tests/loop-config.bats`.

**File:** `tests/loop-config.bats` (or append to existing config tests)
**Commit:** `test(04-02): add feedback loop config validation tests`

### Task 4: Run full test suite
Run all bats tests and Rust tests to verify everything passes:

```bash
cd yolo-mcp-server && cargo test 2>&1 | tail -10
bats tests/qa-commands.bats tests/review-plan.bats tests/review-loop.bats tests/qa-loop.bats tests/loop-config.bats
```

Fix any failures. If all pass, no commit needed.

**File:** verification only
**Commit:** `fix(04-02): resolve test failures` (only if fixes needed)
