---
phase: "04"
plan: "02"
title: "Wire QA gate into execute-protocol, config, hooks, and tests"
wave: 1
depends_on: []
must_haves:
  - "qa_gate config key in config.json and defaults.json"
  - "model-profiles.json has qa entries in all 3 profiles"
  - "hooks.json has yolo-qa in all 4 agent matchers"
  - "execute-protocol SKILL.md has QA gate section (Step 3d)"
  - "Bats tests for QA commands"
---

# Plan 02: Wire QA Gate into Execute-Protocol, Config, Hooks, and Tests

## Goal

Add the qa_gate config setting, wire the QA agent into model-profiles.json and hooks.json, insert the QA gate into the execute-protocol, and add bats integration tests.

## Tasks

### Task 1: Add qa_gate config and QA entries to profiles/hooks

**Files:** `.yolo-planning/config.json`, `config/defaults.json`, `config/model-profiles.json`, `hooks/hooks.json`, `yolo-mcp-server/src/commands/resolve_model.rs`

**config.json and defaults.json:** Add after `"review_gate": "on_request"`:
```json
"qa_gate": "on_request"
```
Valid values: `"always"` | `"on_request"` | `"never"`. Default: `"on_request"`.

Also add `"qa": 25` to agent_max_turns in both files (if not already present — check first, it may already be there from defaults).

**model-profiles.json:** Add qa entries to all 3 profiles:
- quality: `"qa": "opus"`
- balanced: `"qa": "sonnet"`
- budget: `"qa": "sonnet"`

**hooks.json:** Append to ALL 4 matcher strings (SubagentStart, SubagentStop, TeammateIdle, TaskCompleted):
```
|yolo-qa|yolo:yolo-qa|qa|team-qa
```

**resolve_model.rs:** Add `"qa"` to the VALID_AGENTS array.

**Verification:** `jq '.qa_gate' .yolo-planning/config.json` returns `"on_request"`. `jq '.quality.qa' config/model-profiles.json` returns `"opus"`. `grep -c "yolo-qa" hooks/hooks.json` returns `4`.

### Task 2: Add QA gate (Step 3d) to execute-protocol SKILL.md

**Files:** `skills/execute-protocol/SKILL.md`

**Insertion point:** After Step 3c SUMMARY.md verification gate (around line 391) and before Step 4 Verification (around line 393).

**Insert a new section:**

```markdown
### Step 3d: QA gate verification (optional)

**Activation:** Read `qa_gate` from config:
```bash
QA_GATE=$(jq -r '.qa_gate // "on_request"' .yolo-planning/config.json 2>/dev/null)
```

| qa_gate | Behavior |
|---------|----------|
| always | Run QA verification on every phase after all Dev tasks complete |
| on_request | Skip unless user passes `--qa` flag |
| never | Skip entirely |

**When active:**

For each completed plan in the phase, run the following verification commands:

1. **Verify plan completion:**
```bash
"$HOME/.cargo/bin/yolo" verify-plan-completion {summary_path} {plan_path}
```
Check: SUMMARY.md has all required fields, task counts match plan, commit hashes present.

2. **Commit lint:**
```bash
"$HOME/.cargo/bin/yolo" commit-lint {commit_range}
```
Where `{commit_range}` is derived from the first commit before the phase to HEAD. Check: all commits follow `{type}({scope}): {description}` format.

3. **Diff against plan:**
```bash
"$HOME/.cargo/bin/yolo" diff-against-plan {summary_path}
```
Check: files modified in git match files declared in SUMMARY.md.

4. **Validate requirements:**
```bash
"$HOME/.cargo/bin/yolo" validate-requirements {plan_path} {phase_dir}
```
Check: must_haves from plan have evidence in SUMMARY/code.

5. **Check regression:**
```bash
"$HOME/.cargo/bin/yolo" check-regression {phase_dir}
```
Check: test count hasn't decreased.

**Aggregate results:**
- If ALL checks pass (exit 0): Display `✓ QA verification passed` and proceed to Step 4
- If ANY check fails (exit 1): Display `✗ QA verification failed` with findings. STOP execution.
- Produce structured report: `{passed: bool, checks: [{name, status, evidence}], regressions: N}`

**When inactive:** Display `○ QA gate skipped (qa_gate: {value})` and proceed to Step 4.
```

**Verification:** Read SKILL.md. Section `### Step 3d: QA gate verification` exists between Step 3c and Step 4.

### Task 3: Add bats tests for QA commands

**Files:** `tests/qa-commands.bats` (new)

**Create a new bats test file. Read `tests/review-plan.bats` first for the setup pattern.**

**Setup:**
```bash
setup() {
    TEST_TEMP_DIR=$(mktemp -d)
    YOLO_BIN="${YOLO_BIN:-$HOME/.cargo/bin/yolo}"

    # Create a valid SUMMARY.md
    mkdir -p "$TEST_TEMP_DIR/phases/01-test"
    cat > "$TEST_TEMP_DIR/phases/01-test/01-01-SUMMARY.md" << 'SUMMARY'
---
phase: "01"
plan: "01"
title: "Test plan"
status: complete
tasks_completed: 2
tasks_total: 2
commit_hashes:
  - "abc1234"
  - "def5678"
files_modified:
  - "README.md"
---
## What Was Built
- Thing 1
## Files Modified
- `README.md` -- updated
## Deviations
None
SUMMARY

    # Create matching PLAN.md
    cat > "$TEST_TEMP_DIR/phases/01-test/01-01-PLAN.md" << 'PLAN'
---
phase: "01"
plan: "01"
title: "Test plan"
wave: 1
depends_on: []
must_haves:
  - "thing works"
---
# Test Plan
## Tasks
### Task 1: Do first thing
Content.
### Task 2: Do second thing
Content.
PLAN
}

teardown() {
    rm -rf "$TEST_TEMP_DIR"
}
```

**Tests:**

1. `@test "verify-plan-completion passes for valid summary"` — Run verify-plan-completion with valid SUMMARY + PLAN. Verify exit 0.

2. `@test "verify-plan-completion fails for missing fields"` — Create SUMMARY without commit_hashes. Verify exit 1.

3. `@test "commit-lint passes for valid commits"` — This test needs git. Skip if not in a git repo, or create a temp git repo with valid commits.

4. `@test "validate-requirements checks must_haves"` — Run validate-requirements with plan + phase dir. Verify JSON output has requirements array.

5. `@test "check-regression reports test counts"` — Run check-regression. Verify JSON output has rust_tests and bats_files fields.

**Verification:** `bats tests/qa-commands.bats` passes with all tests green.
