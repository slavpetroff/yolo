---
phase: "04"
plan: "01"
title: "Create QA agent and 5 Rust verification commands"
wave: 1
depends_on: []
must_haves:
  - "agents/yolo-qa.md exists with Read, Glob, Grep, Bash tools"
  - "5 new Rust commands: verify-plan-completion, check-regression, diff-against-plan, validate-requirements, commit-lint"
  - "All 5 commands produce structured JSON output with ok, cmd, and checks fields"
  - "Unit tests pass for all 5 commands"
---

# Plan 01: Create QA Agent and 5 Rust Verification Commands

## Goal

Create the QA agent definition and implement 5 Rust CLI commands for automated delivery verification: verify-plan-completion, check-regression, diff-against-plan, validate-requirements, and commit-lint.

## Tasks

### Task 1: Create agents/yolo-qa.md

**Files:** `agents/yolo-qa.md` (new)

**Create the QA agent file following the yolo-reviewer.md pattern.**

Frontmatter:
```yaml
---
name: yolo-qa
description: QA agent that verifies code delivery against plans using Rust-backed verification commands.
tools: Read, Glob, Grep, Bash
disallowedTools: Edit, Write, WebFetch, WebSearch
model: inherit
maxTurns: 25
permissionMode: default
---
```

Note: QA has READ-ONLY access like the reviewer. It produces its report via the return message. It can run Bash commands (git, test runners) but not modify files.

Body sections:
1. **Header:** QA agent. Verifies code delivery against plans using automated Rust commands and codebase analysis.
2. **Core Protocol:** Read SUMMARY.md files, run 5 verification commands, produce structured report
3. **Verification Commands:** List all 5 commands with usage
4. **Report Format:** `{passed: bool, checks: [{name, status, evidence}], regressions: N}`
5. **Subagent Usage:** QA does NOT spawn subagents
6. **Circuit Breaker:** Standard 3-retry pattern
7. **Constraints:** Verification only â€” never modify code or plans. QA is "execution" family.

**Verification:** File exists at `agents/yolo-qa.md`.

### Task 2: Create verify-plan-completion and commit-lint commands

**Files:** `yolo-mcp-server/src/commands/verify_plan_completion.rs` (new), `yolo-mcp-server/src/commands/commit_lint.rs` (new)

**verify-plan-completion:** `yolo verify-plan-completion <summary_path> <plan_path>`
- Read SUMMARY.md YAML frontmatter: check phase, plan, title, status, tasks_completed, tasks_total, commit_hashes
- Read PLAN.md: count `### Task N:` headers
- Cross-reference: tasks_completed should equal plan task count when status=complete
- Check commit_hashes is non-empty and each hash is 7+ hex chars
- Check required body sections exist: `## What Was Built`, `## Files Modified`
- **Output:** `{"ok": bool, "cmd": "verify-plan-completion", "checks": [{name, status, detail}]}`
- **Exit codes:** 0=pass, 1=fail

**commit-lint:** `yolo commit-lint <commit_range>`
- Run `git log --pretty=format:"%H %s" {commit_range}` to get commit subjects
- Validate each against pattern: `^(feat|fix|test|refactor|perf|docs|style|chore)\([a-z0-9._-]+\): .+`
- Report violations with commit hash and actual subject
- **Output:** `{"ok": bool, "cmd": "commit-lint", "total": N, "valid": N, "violations": [{hash, subject, issue}]}`
- **Exit codes:** 0=all valid, 1=violations found

Use `std::process::Command::new("git")` for git operations (see `planning_git.rs` for pattern).

**Verification:** `cargo build` succeeds.

### Task 3: Create check-regression and diff-against-plan commands

**Files:** `yolo-mcp-server/src/commands/check_regression.rs` (new), `yolo-mcp-server/src/commands/diff_against_plan.rs` (new)

**check-regression:** `yolo check-regression <phase_dir>`
- Find all SUMMARY.md files in phase_dir
- Extract commit_hashes from each
- For the earliest commit, get test count BEFORE: `git stash list` is unreliable, so count test files in repo at HEAD
- Count current test files: `find tests/ -name '*.bats' | wc -l` + `grep -r '#\[test\]' yolo-mcp-server/src/ | wc -l`
- Alternative simpler approach: just count current tests and report. The comparison baseline can be from the ROADMAP progress table or a stored value.
- **Simplified approach:** Count current Rust tests (`cargo test -p yolo-mcp-server -- --list 2>/dev/null | grep ':: test' | wc -l`) and bats test files. Report counts. Flag if test count decreased from previous phase.
- **Output:** `{"ok": bool, "cmd": "check-regression", "rust_tests": N, "bats_files": N, "regressions": N}`
- **Exit codes:** 0=no regressions, 1=regressions found

**diff-against-plan:** `yolo diff-against-plan <summary_path>`
- Read SUMMARY.md `files_modified` from YAML frontmatter (list of file paths)
- Read SUMMARY.md body `## Files Modified` section for listed files
- Get actual git diff files: extract commit_hashes from SUMMARY, run `git show --stat {hash}` for each
- Cross-reference: are all files in git commits also declared in SUMMARY? Are there undeclared files?
- **Output:** `{"ok": bool, "cmd": "diff-against-plan", "declared": N, "actual": N, "undeclared": [files], "missing": [files]}`
- **Exit codes:** 0=match, 1=mismatch

**Verification:** `cargo build` succeeds.

### Task 4: Create validate-requirements command

**Files:** `yolo-mcp-server/src/commands/validate_requirements.rs` (new)

**validate-requirements:** `yolo validate-requirements <plan_path> <phase_dir>`
- Read PLAN.md YAML frontmatter: extract `must_haves` array
- For each must_have string:
  - Search for evidence in SUMMARY.md files (grep for key terms)
  - Search in committed code (use `git log --all --oneline --grep="{keyword}"`)
  - Mark as "verified" if evidence found, "unverified" if not
- **Output:** `{"ok": bool, "cmd": "validate-requirements", "total": N, "verified": N, "unverified": N, "requirements": [{requirement, status, evidence}]}`
- **Exit codes:** 0=all verified, 1=some unverified, 2=partial

**Verification:** `cargo build` succeeds.

### Task 5: Add routes, module declarations, and unit tests

**Files:** `yolo-mcp-server/src/commands/mod.rs`, `yolo-mcp-server/src/cli/router.rs`, plus inline tests in each new command file

**Module declarations in mod.rs:** Add:
```rust
pub mod check_regression;
pub mod commit_lint;
pub mod diff_against_plan;
pub mod validate_requirements;
pub mod verify_plan_completion;
```

**Routes in router.rs:** Add these routes in the match block:
```rust
"check-regression" => commands::check_regression::execute(args, &cwd),
"commit-lint" => commands::commit_lint::execute(args, &cwd),
"diff-against-plan" => commands::diff_against_plan::execute(args, &cwd),
"validate-requirements" => commands::validate_requirements::execute(args, &cwd),
"verify-plan-completion" => commands::verify_plan_completion::execute(args, &cwd),
```

**Unit tests (inline in each command file, minimum 2 per command):**
- verify_plan_completion: test valid summary passes, test missing fields fails
- commit_lint: test valid commits pass, test invalid format fails
- check_regression: test with test files present reports count
- diff_against_plan: test matching files pass, test undeclared files detected
- validate_requirements: test found requirements verified, test missing requirement unverified

**Verification:** `cargo test -p yolo-mcp-server` passes. `cargo build` succeeds. Run from project root: `/Users/slavpetroff/Projects/vibe-better-with-claude-code-vbw`
