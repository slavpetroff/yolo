---
phase: "08"
plan: "01"
title: "Filter completed phases from Tier 2 ROADMAP context"
wave: 1
depends_on: []
must_haves:
  - "build_tier2_uncached filters completed phase sections from ROADMAP.md"
  - "Progress table and header preserved, only ## Phase N sections for Complete phases removed"
  - "Rust unit tests verify filtering behavior"
  - "cargo build and cargo test pass"
---

# Plan 01: Filter Completed Phases from Tier 2 ROADMAP Context

## Goal

Reduce Tier 2 token count by filtering completed phase detail sections from ROADMAP.md before including in compiled context. Current + future phase sections are preserved. The progress table (summary) is always kept.

## Tasks

### Task 1: Add filter_completed_phases function to tier_context.rs

**Files:** `yolo-mcp-server/src/commands/tier_context.rs`

**Current behavior:** `build_tier2_uncached()` (lines 123-137) reads ROADMAP.md and includes it verbatim in Tier 2 content.

**Fix:** Add a `filter_completed_phases(text: &str) -> String` function that:
1. Parses the ROADMAP.md progress table to find phase numbers with status "Complete" (lines matching `| N | Complete |`)
2. Removes `## Phase N: ...` sections for those completed phases (from the `## Phase N:` header to the next `---` separator or `## Phase` header)
3. Preserves: file header, goal, scope, progress table, phase list checkboxes, and non-complete phase sections

Call this function in `build_tier2_uncached()` when the file being included is `ROADMAP.md`:

```rust
if let Ok(text) = text {
    let filtered = if basename == "ROADMAP.md" {
        filter_completed_phases(&text)
    } else {
        text
    };
    content.push_str(&format!("\n# {}\n{}\n", basename, filtered));
}
```

**Parsing approach:** Use line-by-line iteration:
1. Scan for table rows matching regex `^\|\s*\d+\s*\|\s*Complete\s*\|` to collect completed phase numbers
2. Then iterate lines again, tracking whether we're inside a completed phase section (between `## Phase {N}:` and the next `---` or `## Phase`)
3. Skip lines inside completed sections, keep everything else

**Verification:** `cargo build` succeeds. `cargo test` passes.

### Task 2: Add Rust unit tests for ROADMAP filtering

**Files:** `yolo-mcp-server/src/commands/tier_context.rs`

**Tests to add in `mod tests`:**

1. `test_filter_completed_phases_basic` — Create a ROADMAP with 3 phases (1 Complete, 2 Pending). Verify Phase 1 section is removed, Phases 2-3 sections preserved, progress table preserved, header preserved.

2. `test_filter_completed_phases_all_complete` — All phases Complete. Only progress table and header remain, all `## Phase` sections removed.

3. `test_filter_completed_phases_none_complete` — No phases Complete. Output equals input (no filtering).

4. `test_tier2_roadmap_filtered` — Integration test: set up planning dir with a ROADMAP.md containing completed phases, call `build_tier2`, verify the output doesn't contain completed phase detail sections but does contain non-complete ones.

**Verification:** `cargo test -- tier_context` passes with all new tests green.

### Task 3: Invalidate tier cache after ROADMAP filter change

**Files:** `yolo-mcp-server/src/commands/tier_context.rs`

Since the Tier 2 content format has changed (filtered vs unfiltered ROADMAP), cached Tier 2 entries are now stale. The mtime-based cache will naturally invalidate when ROADMAP.md is modified, but the content hash check means old cache entries will pass validation with the old content.

**Fix:** No code change needed — the cache invalidation already works correctly:
- Cache validates by mtime + content hash
- When `build_tier2_uncached` produces different content (due to filtering), the hash won't match old cache
- New content gets cached on next build

However, verify this by adding a comment to `filter_completed_phases` documenting that cache invalidation happens naturally via content hash mismatch.

**Verification:** Run `cargo test -- tier_context` to confirm cache tests still pass.
