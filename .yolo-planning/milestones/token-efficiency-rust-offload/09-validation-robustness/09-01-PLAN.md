---
phase: "09"
plan: "01"
title: "Upgrade validate_summary and add validate-plan command"
wave: 1
depends_on: []
must_haves:
  - "validate_summary.rs checks YAML frontmatter fields: phase, plan, status, tasks_completed, tasks_total, commit_hashes"
  - "validate-plan CLI command validates depends_on references against plan files"
  - "Cross-phase dependency validation implemented in Rust"
  - "SKILL.md updated to use Rust command for cross-phase deps"
  - "cargo build and cargo test pass"
---

# Plan 01: Upgrade validate_summary and Add validate-plan Command

## Goal

Close the gap between declared protocol and enforced protocol by upgrading validate_summary.rs with YAML frontmatter field checks (not just section headers), adding a `validate-plan` CLI command that cross-references depends_on against actual plan files, and moving the cross-phase dependency check from SKILL.md LLM instructions to a Rust command.

## Tasks

### Task 1: Upgrade validate_summary.rs with YAML frontmatter validation

**Files:** `yolo-mcp-server/src/hooks/validate_summary.rs`

**Current behavior:** `check_summary_structure()` (lines 57-73) only checks:
- Starts with `---` (frontmatter exists)
- Contains `## What Was Built`
- Contains `## Files Modified`

**Upgrade:** Add YAML frontmatter field validation. After the `starts_with("---")` check, extract frontmatter (content between first `---` and second `---`), then check for required fields:

Required fields (from execute-protocol SKILL.md Step 3c):
- `phase:` — must exist
- `plan:` — must exist
- `status:` — must exist, value must be one of: complete, partial, failed
- `tasks_completed:` — must exist
- `tasks_total:` — must exist
- `commit_hashes:` — must exist (can use `frontmatter_has_field` pattern from validate_schema.rs)

Also add check for `## Deviations` section header.

**Note:** This is a PostToolUse hook — it's advisory-only (exit code 0 always). The upgrade adds better diagnostic messages, not blocking behavior.

**Verification:** `cargo build` succeeds. `cargo test -- validate_summary` passes.

### Task 2: Add validate-plan CLI command with depends_on validation

**Files:** `yolo-mcp-server/src/cli/router.rs`, new file `yolo-mcp-server/src/commands/validate_plan.rs`, `yolo-mcp-server/src/commands/mod.rs`

**New command:** `yolo validate-plan <plan_path> <phase_dir>`

Validates:
1. Plan file exists and has valid YAML frontmatter
2. `depends_on` field (if present) references plan IDs that exist as files in `<phase_dir>`:
   - For each ID in `depends_on: ["01", "02"]`, check that `{phase_dir}/{NN}-{ID}-PLAN.md` or `{phase_dir}/{ID}-PLAN.md` exists
   - Report missing dependencies

3. Cross-phase deps: If `cross_phase_deps` field exists in frontmatter, validate each entry:
   - Parse phase number and plan ID from each dep
   - Check that `phases/{phase_num}-*/{plan_id}-SUMMARY.md` exists
   - Check that SUMMARY.md frontmatter contains `status: complete`
   - Report unsatisfied dependencies

**Output:** JSON structured return:
```json
{"ok": true, "cmd": "validate-plan", "depends_on": {"valid": true, "checked": 2}, "cross_phase": {"valid": true, "checked": 0}}
```

Or on failure:
```json
{"ok": false, "cmd": "validate-plan", "errors": ["depends_on: plan 03 not found in phase dir", "cross_phase: Phase 2 Plan 01 SUMMARY.md missing"]}
```

**Exit codes:** 0=valid, 1=invalid, 2=partial (some deps satisfied)

**Verification:** `cargo build` succeeds.

### Task 3: Update SKILL.md to use Rust validate-plan command

**Files:** `skills/execute-protocol/SKILL.md`

**Current behavior (lines 50-56):** Cross-phase dependency check is an LLM instruction:
```
1. **Cross-phase deps (PWR-04):** For each plan with `cross_phase_deps`:
- Verify referenced plan's SUMMARY.md exists with `status: complete`
```

**Fix:** Replace the LLM instruction with a Rust command call:
```
1. **Cross-phase deps (PWR-04):** Run plan validation for each plan:
"$HOME/.cargo/bin/yolo" validate-plan {plan_path} {phase_dir}
- Exit 0: all deps satisfied → proceed
- Exit 1: deps unsatisfied → STOP with error from JSON output
- Exit 2: partial → STOP with details
```

Keep the error message format and stop behavior, but source it from the Rust command's JSON output instead of inline LLM logic.

**Verification:** Read SKILL.md and confirm the Rust command call replaces the manual LLM check.

### Task 4: Add Rust unit tests

**Files:** `yolo-mcp-server/src/hooks/validate_summary.rs`, `yolo-mcp-server/src/commands/validate_plan.rs`

**Tests for validate_summary:**
1. `test_check_summary_frontmatter_all_fields` — SUMMARY with all required frontmatter fields → no missing
2. `test_check_summary_frontmatter_missing_fields` — SUMMARY missing `status` and `commit_hashes` → reports both missing
3. `test_check_summary_deviations_section` — SUMMARY without `## Deviations` → reports missing

**Tests for validate_plan:**
1. `test_validate_plan_depends_on_satisfied` — Plan with `depends_on: ["01"]` where 01-PLAN.md exists → valid
2. `test_validate_plan_depends_on_missing` — Plan with `depends_on: ["03"]` where 03-PLAN.md doesn't exist → invalid
3. `test_validate_plan_no_depends_on` — Plan without depends_on → valid (skip)

**Verification:** `cargo test` passes with all new tests green.
