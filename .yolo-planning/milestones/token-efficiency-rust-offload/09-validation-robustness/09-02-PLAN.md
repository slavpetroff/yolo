---
phase: "09"
plan: "02"
title: "Add feature flag integration tests for gated code paths"
wave: 1
depends_on: []
must_haves:
  - "At least 1 bats test per flag exercising the actual gated code path"
  - "Tests cover v2_hard_gates and v3_schema_validation"
  - "All new tests pass"
---

# Plan 02: Add Feature Flag Integration Tests

## Goal

Add bats integration tests that exercise actual gated code paths behind v2/v3 feature flags. Currently, `flag-dependency-validation.bats` only tests flag dependencies (e.g., "v2_hard_gates requires v2_hard_contracts"), not whether the gated behavior actually works when the flag is enabled.

## Tasks

### Task 1: Add v2_hard_gates integration test

**Files:** `tests/flag-gated-code-paths.bats` (new file)

**Setup:** Create a test fixture with:
- A `.yolo-planning/config.json` with `v2_hard_gates: true` and `v2_hard_contracts: true`
- A minimal planning directory

**Test cases:**
1. `test v2_hard_gates enabled changes hard-gate exit behavior` — When `v2_hard_gates=true`, run `yolo hard-gate` with a conflict scenario. Verify it exits 2 (not 0). Compare with `v2_hard_gates=false` which should exit 0 or 1.

2. `test v2_hard_gates disabled allows soft failure` — Same scenario but with flag disabled. Verify behavior differs.

**Note:** Read the actual `hard_gate.rs` implementation first to understand what the flag gates. The test must exercise the actual gated code path, not just check config reading.

### Task 2: Add v3_schema_validation integration test

**Files:** `tests/flag-gated-code-paths.bats` (same file)

**Setup:** Create a test fixture with:
- A `.yolo-planning/config.json` with `v3_schema_validation: true`
- A valid PLAN.md file with proper frontmatter
- An invalid PLAN.md file with missing required fields

**Test cases:**
1. `test v3_schema_validation enabled validates plan frontmatter` — With flag enabled, write a plan missing required fields. Check that the validation hook reports missing fields. Read `validate_schema.rs` to understand what gets validated.

2. `test v3_schema_validation disabled skips validation` — Same scenario with flag disabled. Verify no validation occurs.

**Note:** Read `validate_schema.rs` and the hook that calls it to understand the exact gated behavior. The test must trigger the hook and verify the flag-dependent behavior.

**Verification:** Run `bats tests/flag-gated-code-paths.bats` — all tests pass.
