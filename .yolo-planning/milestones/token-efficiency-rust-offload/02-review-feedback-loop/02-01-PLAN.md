---
phase: "02"
plan: "01"
title: "Implement review loop orchestration in execute-protocol Step 2b"
wave: 1
depends_on: []
must_haves:
  - "Step 2b contains full loop logic: reject → spawn Architect → revise → re-review → repeat"
  - "Loop reads review_max_cycles from config with default 3"
  - "execution-state.json updated with review_loop block during loop"
  - "Event logging: review_loop_start, review_loop_cycle, review_loop_end"
  - "Max cycles exceeded produces HARD STOP with accumulated findings"
  - "Final-cycle conditional verdict attaches warnings to Dev context and proceeds"
---
# Plan 02-01: Execute-protocol review loop orchestration

## Context
Step 2b in `skills/execute-protocol/SKILL.md` currently stops on reject and returns findings to the user.
Phase 2 replaces this with an automated feedback loop: on reject, spawn the Architect to revise the plan,
then re-run the Reviewer. Loop until approve/conditional or review_max_cycles exceeded.

## Tasks

### Task 1: Replace Step 2b reject path with loop logic
Read `skills/execute-protocol/SKILL.md`. Replace the current Step 2b section (lines ~61-89) with full loop logic:

1. Read `review_max_cycles` from config: `jq -r '.review_max_cycles // 3' .yolo-planning/config.json`
2. On `verdict: "reject"`:
   - Initialize `REVIEW_CYCLE=1`
   - Log `review_loop_start` event
   - **Loop:** While verdict == "reject" AND REVIEW_CYCLE < REVIEW_MAX_CYCLES:
     a. Increment REVIEW_CYCLE
     b. Spawn Architect subagent (Task tool, model from resolve-model, subagent_type "yolo:yolo-architect") with:
        - Original plan path
        - Reviewer findings JSON (only high+medium severity, not full context recompile)
        - Instruction: "Revise plan to address these findings. Overwrite the original PLAN.md."
     c. Log `review_loop_cycle` event with cycle number and finding count
     d. Re-run `yolo review-plan {plan_path} {phase_dir}` on revised plan
     e. Parse new verdict
   - On `verdict: "approve"` or `verdict: "conditional"`: exit loop, log `review_loop_end` with verdict
   - On max_cycles exceeded: HARD STOP with all accumulated findings across cycles

3. On `verdict: "conditional"` (whether first pass or final loop cycle):
   - Attach findings as warnings to Dev context (append to DEV_CONTEXT variable)
   - Display `⚠ Plan {NN-MM} review: conditional (cycle {N}/{max})`
   - Proceed to Step 3

4. On max_cycles exceeded:
   - Display `✗ Plan {NN-MM} review: REJECTED after {max} cycles`
   - Display accumulated findings summary
   - STOP execution — do not create Dev team

Keep approve path unchanged (exit 0, no loop needed).

**File:** `skills/execute-protocol/SKILL.md`
**Commit:** `feat(02-01): implement review loop orchestration in Step 2b`

### Task 2: Add execution-state.json review_loop tracking
In the same Step 2b section, add jq commands to track loop state in execution-state.json:

- On loop start: `jq '.review_loop = {"cycle": 1, "max": '$MAX', "status": "running", "findings_per_cycle": []}' .yolo-planning/.execution-state.json > tmp && mv tmp .yolo-planning/.execution-state.json`
- On each cycle: append findings summary to `findings_per_cycle` array
- On loop end: set `review_loop.status` to "passed" (approve/conditional) or "failed" (max_cycles exceeded)

**File:** `skills/execute-protocol/SKILL.md` (same file, within Step 2b loop logic)
**Commit:** `feat(02-01): add review_loop tracking to execution-state.json`

### Task 3: Wire event logging calls
Add `yolo log-event` calls at each loop boundary:

```bash
yolo log-event review_loop_start {phase} plan={plan_id} max_cycles={max} 2>/dev/null || true
yolo log-event review_loop_cycle {phase} plan={plan_id} cycle={N} verdict={verdict} high_count={N} 2>/dev/null || true
yolo log-event review_loop_end {phase} plan={plan_id} cycles_used={N} final_verdict={verdict} 2>/dev/null || true
```

**File:** `skills/execute-protocol/SKILL.md` (same file, within Step 2b loop logic)
**Commit:** `feat(02-01): wire review loop event logging`

### Task 4: Add delta-findings extraction for token efficiency
Between loop iterations, extract only NEW or CHANGED findings to pass to the Architect (not the full context):

- Compare current cycle findings with previous cycle findings
- Pass only: new high-severity findings + findings that changed severity
- Skip findings that were already addressed (no longer present)
- Note in protocol: "Architect and Reviewer share 'planning' Tier 2 cache — only Tier 3 changes between iterations"

**File:** `skills/execute-protocol/SKILL.md`
**Commit:** `feat(02-01): add delta-findings extraction for token-efficient loop`

### Task 5: Handle edge cases and per-plan loop independence
Document per-plan behavior:
- Each plan in the phase gets its OWN review loop (not shared)
- If plan A passes review but plan B gets rejected, plan A proceeds while plan B loops
- If ANY plan hits max_cycles with reject: STOP entire phase (all plans)
- Track per-plan review_loop in execution-state.json under each plan's entry

**File:** `skills/execute-protocol/SKILL.md`
**Commit:** `feat(02-01): handle per-plan review loop independence and edge cases`
