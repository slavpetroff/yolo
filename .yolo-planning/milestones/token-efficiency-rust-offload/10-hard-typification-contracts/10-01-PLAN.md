---
phase: 10
plan: 1
title: Config JSON Schema and Startup Validation
wave: 1
depends_on: []
must_haves:
  - config/config.schema.json with full JSON Schema for all 57 config keys
  - migrate_config.rs validates merged config against schema, hard error on violation
  - Startup validation logs warning if v2_typed_protocol or v3_schema_validation is disabled
  - All existing tests pass + new tests for schema validation
---

# Plan 10-01: Config JSON Schema and Startup Validation

## Context

`config/defaults.json` has 57 keys with zero validation. `migrate_config.rs` merges
defaults into user config but never checks types, ranges, or allowed values. A string
`"true"` silently becomes a non-boolean. This is the highest-risk gap in the system.

## Files to Modify

- `config/config.schema.json` (NEW) — JSON Schema for all 57 config keys
- `yolo-mcp-server/src/commands/migrate_config.rs` — Add schema validation after merge
- `yolo-mcp-server/Cargo.toml` — Add `jsonschema` crate dependency

## Tasks

### Task 1: Create config.schema.json

Create `config/config.schema.json` as a JSON Schema (draft 2020-12) covering all 57 keys
from `config/defaults.json`:

- `effort`: enum `["minimal", "balanced", "thorough"]`
- `autonomy`: enum `["minimal", "standard", "full"]`
- `auto_commit`: boolean
- `planning_tracking`: enum `["manual", "auto"]`
- `auto_push`: enum `["never", "after_phase", "always"]`
- `verification_tier`: enum `["skip", "quick", "standard", "thorough"]`
- `skill_suggestions`, `auto_install_skills`, `discovery_questions`, `context_compiler`, `plain_summary`, `branch_per_milestone`: boolean
- `visual_format`: enum `["unicode", "ascii", "plain"]`
- `max_tasks_per_plan`: integer, minimum 1, maximum 10
- `prefer_teams`: enum `["never", "auto", "always"]`
- `active_profile`: string
- `custom_profiles`: object (additionalProperties: object)
- `model_profile`: enum `["quality", "balanced", "speed"]`
- `model_overrides`: object (additionalProperties: string)
- `agent_max_turns`: object with known agent keys, each integer min 1
- `qa_skip_agents`: array of strings
- All `v2_*`, `v3_*`, `v4_*` flags: boolean (22 keys)
- `review_gate`, `qa_gate`: enum `["off", "on_request", "always"]`
- `review_max_cycles`, `qa_max_cycles`: integer, minimum 1, maximum 10

Set `additionalProperties: false` at root to catch typos.

### Task 2: Add jsonschema crate to Cargo.toml

Add `jsonschema = "0.29"` (or latest compatible) to `[dependencies]` in
`yolo-mcp-server/Cargo.toml`. This crate validates `serde_json::Value` against a
JSON Schema.

### Task 3: Implement schema validation in migrate_config.rs

After the merge step in `migrate_config()`, add validation:

1. Load `config.schema.json` from the same directory as `defaults.json` (sibling file)
2. Parse schema as `serde_json::Value`
3. Compile schema with `jsonschema::validator_for(&schema_value)`
4. Validate the merged config against it
5. On validation errors: collect all error messages into a single `String`
6. Return `Err(format!("Config validation failed: {}", errors))` — hard error

Handle missing schema file gracefully: if `config.schema.json` doesn't exist beside
defaults.json, skip validation with an eprintln warning (backward compat during rollout).

### Task 4: Add startup enforcement flag warnings

In `migrate_config()`, after successful validation, check if key enforcement flags
are disabled and log warnings:

```rust
let enforcement_flags = ["v2_typed_protocol", "v3_schema_validation", "v2_hard_gates", "v2_hard_contracts"];
for flag in &enforcement_flags {
    let enabled = merged.get(*flag).and_then(|v| v.as_bool()).unwrap_or(false);
    if !enabled {
        eprintln!("WARNING: enforcement flag '{}' is disabled", flag);
    }
}
```

### Task 5: Write tests for schema validation

Add tests to `migrate_config.rs`:

1. `test_schema_validation_rejects_invalid_type` — config with `effort: 123` (not string) should error
2. `test_schema_validation_rejects_unknown_key` — config with `bogus_key: true` should error
3. `test_schema_validation_accepts_valid_config` — defaults.json itself must validate cleanly
4. `test_schema_missing_degrades_gracefully` — when schema file absent, validation is skipped
5. `test_enforcement_flag_warnings` — verify eprintln output when flags are disabled (capture stderr or test the logic directly)
