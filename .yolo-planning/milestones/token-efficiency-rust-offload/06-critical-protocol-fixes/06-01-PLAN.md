---
phase: "06"
plan: "01"
title: "Fix token-budget pipeline and SUMMARY.md ownership spec"
wave: 1
depends_on: []
must_haves:
  - "Token-budget pipeline in SKILL.md no longer overwrites context with JSON metadata"
  - "Step 3c in SKILL.md contains complete SUMMARY.md verification gate instructions"
  - "yolo-dev.md explicitly instructs Dev to write SUMMARY.md after completing a plan"
---

# Plan 01: Fix Token-Budget Pipeline and SUMMARY.md Ownership Spec

## Goal

Fix two protocol bugs in the execution pipeline: (C1) the token-budget stdout redirect that overwrites context files with JSON metadata when within budget, and (C2) the empty Step 3c that leaves SUMMARY.md writing unspecified.

## Tasks

### Task 1: Guard token-budget pipeline in SKILL.md

**Files:** `skills/execute-protocol/SKILL.md`

The pipeline at ~line 164-166 currently reads:

```bash
"$HOME/.cargo/bin/yolo" token-budget dev {phase-dir}/.context-dev.md {contract_path} {task_number} > {phase-dir}/.context-dev.md.tmp && mv {phase-dir}/.context-dev.md.tmp {phase-dir}/.context-dev.md
```

When within budget, `token-budget` emits JSON metadata `{"result":"within_budget",...}` to stdout, which this pipeline redirects over the context file — destroying it.

**Fix:** Replace the pipeline with a guarded version that only redirects when truncation occurs. Use exit code to distinguish: run token-budget, capture exit code. If truncated (exit 0 with non-JSON stdout), apply the redirect. If within budget, skip the redirect. The simplest correct approach:

```bash
BUDGET_OUT=$("$HOME/.cargo/bin/yolo" token-budget dev {phase-dir}/.context-dev.md {contract_path} {task_number})
if echo "$BUDGET_OUT" | head -c 1 | grep -qv '{'; then
  echo "$BUDGET_OUT" > {phase-dir}/.context-dev.md
fi
```

Or alternatively, check if the output starts with `{` (JSON metadata = within budget, skip redirect). Only write when the output is actual truncated context.

**Verification:** Read the updated SKILL.md and confirm the pipeline no longer uses bare `> file.tmp && mv` without a guard.

### Task 2: Fill Step 3c SUMMARY.md verification gate

**Files:** `skills/execute-protocol/SKILL.md`

Step 3c at ~line 320 has a header but zero content:

```
### Step 3c: SUMMARY.md verification gate (mandatory)

### Step 4: Verification (Native Testing)
```

**Fix:** Fill Step 3c with the following content between the header and Step 4:

After all tasks in a plan complete, the Dev agent MUST write `{phase-dir}/{NN-MM}-SUMMARY.md` using the template at `templates/SUMMARY.md`. The SUMMARY.md must include:

- YAML frontmatter: `phase`, `plan`, `title`, `status` (complete/partial/failed), `completed` (date), `tasks_completed`, `tasks_total`, `commit_hashes` (list), `deviations` (list)
- `## What Was Built` — bullet list of deliverables
- `## Files Modified` — each file with action and purpose
- `## Deviations` — any deviations from plan, or "None"

The verification gate checks:
1. SUMMARY.md exists at the expected path
2. YAML frontmatter parses and contains all required fields
3. `tasks_completed` equals `tasks_total` (or `status` is not `complete`)
4. At least one `commit_hashes` entry exists

If SUMMARY.md is missing or invalid, the plan is not considered complete.

**Verification:** Read Step 3c and confirm it contains SUMMARY.md writing instructions, template reference, required fields, and gate checks.

### Task 3: Add SUMMARY.md writing instruction to yolo-dev.md

**Files:** `agents/yolo-dev.md`

The Dev agent definition mentions SUMMARY.md only in the DEVN-02 deviation row ("Fix + log SUMMARY.md") but never instructs the Dev to write it as a standard completion artifact.

**Fix:** Add a new `### Stage 5: Write SUMMARY.md` section after Stage 4 (Atomic Commit), before Deviation Handling:

```markdown
### Stage 5: Write SUMMARY.md

After completing ALL tasks in the current plan, write `{phase-dir}/{NN-MM}-SUMMARY.md` using the template at `templates/SUMMARY.md`. Include YAML frontmatter with phase, plan, title, status, completed date, tasks_completed, tasks_total, commit_hashes, and deviations. Fill ## What Was Built, ## Files Modified, and ## Deviations sections.

This is mandatory. A plan without a SUMMARY.md is not considered complete.
```

**Verification:** Read yolo-dev.md and confirm Stage 5 exists with SUMMARY.md writing instructions.
