---
phase: 3
plan: 3
title: "Test coverage gap analysis and defaults audit"
wave: 1
depends_on: []
must_haves:
  - REQ-10
  - Test coverage gap report identifying untested commands
  - Defaults.json aggressive flag audit with recommendations
  - Stale test identification
---

# Plan 03-03: Test Coverage Gap Analysis and Defaults Audit

## Scope

Produce audit reports covering: (1) test coverage gaps — which commands and hooks lack dedicated tests, (2) stale or redundant tests, (3) aggressive default flag settings in defaults.json, and (4) schema validation test adequacy. This plan produces findings reports only — no config changes.

**Files modified:** None (read-only audit)
**Files produced:** `.yolo-planning/phases/03-config-test-audit/03-03-FINDINGS.md`

## Tasks

### Task 1: Map command coverage gaps

**Description:** Cross-reference the 23 command markdown files against the 72 bats test files to identify which commands have no dedicated test file. Known untested commands from research: pause, resume, teach, whats-new, uninstall, doctor. Verify by checking if any of these commands are exercised indirectly in other test files (grep test files for command names). Produce a coverage matrix.

**Files read:** `commands/*.md`, `tests/*.bats`
**Files produced:** Section in `03-03-FINDINGS.md`

**Commit:** `docs(audit): test coverage gap analysis — command coverage matrix`

**Verification:**
- Findings report lists each of 23 commands with test status (dedicated, indirect, none)
- At least 6 commands identified as having no dedicated test file
- Each gap entry includes the command name and recommendation

### Task 2: Map Rust command test coverage

**Description:** Cross-reference the ~79 Rust command modules in `yolo-mcp-server/src/commands/` against bats tests that invoke `$YOLO_BIN <command>`. Identify Rust commands with no test exercising them. Focus on the CLI-facing commands (not internal helpers).

**Files read:** `yolo-mcp-server/src/commands/*.rs`, `tests/*.bats`
**Files produced:** Section in `03-03-FINDINGS.md`

**Commit:** `docs(audit): test coverage gap analysis — Rust command coverage`

**Verification:**
- Findings list Rust commands that are never invoked in any bats test
- Each gap includes the module name and a brief description of what it does
- Count of tested vs untested Rust commands documented

### Task 3: Identify stale or redundant tests

**Description:** Review test files for staleness indicators: tests that reference removed features (e.g., scout agent which was removed), tests that skip unconditionally, tests that test the same thing as another file. Check for tests referencing old config keys or removed agent roles.

**Files read:** `tests/*.bats`
**Files produced:** Section in `03-03-FINDINGS.md`

**Commit:** `docs(audit): stale test identification`

**Verification:**
- Any test referencing removed roles or deprecated features is flagged
- Tests with unconditional `skip` statements are listed
- Duplicate test coverage across files is noted

### Task 4: Audit defaults.json aggressive flags

**Description:** Review the defaults.json feature flags that are set to `true` by default and assess whether they are appropriate for new projects. Specifically audit: `v3_schema_validation: true`, `v3_snapshot_resume: true`, `v3_lease_locks: true`, `v3_event_recovery: true`, `v2_typed_protocol: true`, `v2_token_budgets: true`. For each flag, check the Rust code to understand what it enables and whether it has user-visible side effects. Produce recommendations (keep or change to false).

**Files read:** `config/defaults.json`, Rust source files referencing these flags
**Files produced:** Section in `03-03-FINDINGS.md`

**Commit:** `docs(audit): defaults.json feature flag review with recommendations`

**Verification:**
- Each of the 6 flags has a documented assessment
- Assessment includes: what the flag enables, side effects, recommendation
- No changes made to defaults.json (report only, product decision deferred)

### Task 5: Assess schema validation test adequacy

**Description:** Review the existing `schema-validation.bats` (4 tests) and determine if it adequately exercises the schema. Currently it tests: invalid type, valid config, unknown keys, defaults self-validation. Missing: tests for each enum field with valid and invalid values, tests for boundary conditions on integer fields. Produce a list of recommended additional test cases.

**Files read:** `tests/schema-validation.bats`, `config/config.schema.json`
**Files produced:** Section in `03-03-FINDINGS.md`

**Commit:** `docs(audit): schema validation test adequacy assessment`

**Verification:**
- Current 4 tests documented with what they cover
- At least 8 recommended additional test cases listed
- Recommendations prioritized by impact (enum fields first, then boundaries)
