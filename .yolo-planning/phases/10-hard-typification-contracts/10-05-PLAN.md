---
phase: 10
plan: 5
title: Enable Default Flags and Integration Tests
wave: 2
depends_on: [1, 2]
must_haves:
  - v2_typed_protocol default changed to true in defaults.json
  - v3_schema_validation default changed to true in defaults.json
  - Integration bats tests verifying schema validation rejects bad config
  - All existing tests pass
---

# Plan 10-05: Enable Default Flags and Integration Tests

## Context

With config schema validation (Plan 01) and typed feature flags (Plan 02) in place,
the final step is to flip the two key enforcement flags to `true` by default and
add integration tests that verify the end-to-end behavior. This plan runs in
wave 2 because it depends on Plans 01 and 02 being complete.

## Files to Modify

- `config/defaults.json` — Change 2 flag defaults
- `tests/unit/config-defaults.bats` — Add/update tests for new defaults
- `tests/integration/schema-validation.bats` (NEW) — Integration tests

## Tasks

### Task 1: Enable v2_typed_protocol and v3_schema_validation defaults

In `config/defaults.json`, change:

```diff
-  "v3_schema_validation": false,
+  "v3_schema_validation": true,
...
-  "v2_typed_protocol": false,
+  "v2_typed_protocol": true,
```

This makes these features opt-out rather than opt-in. Users who want the old
behavior can set them to `false` in their project config.json.

### Task 2: Update config-defaults.bats

Find the existing test in `tests/unit/config-defaults.bats` that checks these
flag values and update expectations from `false` to `true`. If no specific test
exists for these flags, add:

```bash
@test "v2_typed_protocol defaults to true" {
  run jq -r '.v2_typed_protocol' config/defaults.json
  assert_output "true"
}

@test "v3_schema_validation defaults to true" {
  run jq -r '.v3_schema_validation' config/defaults.json
  assert_output "true"
}
```

### Task 3: Create integration test for schema validation

Create `tests/integration/schema-validation.bats`:

```bash
#!/usr/bin/env bats

setup() {
  load '../test_helper/bats-support/load'
  load '../test_helper/bats-assert/load'
  export YOLO_BIN="$BATS_TEST_DIRNAME/../../yolo-mcp-server/target/debug/yolo-mcp-server"
}

@test "migrate-config rejects config with invalid effort type" {
  local tmp
  tmp="$(mktemp -d)"
  echo '{"effort": 123}' > "$tmp/config.json"
  cp config/defaults.json "$tmp/defaults.json"
  cp config/config.schema.json "$tmp/config.schema.json"
  run "$YOLO_BIN" migrate-config "$tmp/config.json" "$tmp/defaults.json"
  assert_failure
  assert_output --partial "validation failed"
  rm -rf "$tmp"
}

@test "migrate-config accepts valid config" {
  local tmp
  tmp="$(mktemp -d)"
  echo '{"effort": "balanced"}' > "$tmp/config.json"
  cp config/defaults.json "$tmp/defaults.json"
  cp config/config.schema.json "$tmp/config.schema.json"
  run "$YOLO_BIN" migrate-config "$tmp/config.json" "$tmp/defaults.json"
  assert_success
  rm -rf "$tmp"
}

@test "migrate-config rejects unknown keys" {
  local tmp
  tmp="$(mktemp -d)"
  echo '{"effort": "balanced", "bogus_key": true}' > "$tmp/config.json"
  cp config/defaults.json "$tmp/defaults.json"
  cp config/config.schema.json "$tmp/config.schema.json"
  run "$YOLO_BIN" migrate-config "$tmp/config.json" "$tmp/defaults.json"
  assert_failure
  assert_output --partial "validation failed"
  rm -rf "$tmp"
}
```

Note: These tests require the binary to be built. If the test environment does
not have the binary, skip gracefully.

### Task 4: Verify defaults.json validates against schema

Add a static test that runs the schema validation on the defaults.json itself:

```bash
@test "defaults.json validates against config.schema.json" {
  # Use jsonschema-cli or a simple jq-based check
  # If jsonschema-cli is not available, use the Rust binary
  run "$YOLO_BIN" migrate-config config/defaults.json config/defaults.json
  # When config == defaults, merge is identity; should validate cleanly
  assert_success
}
```

Also add a test in the Rust code (in `migrate_config.rs`) that loads the real
`config/defaults.json` and `config/config.schema.json` from the repo and
validates — this serves as a CI guardrail that the schema stays in sync with
the defaults.

### Task 5: Run full test suite and fix any regressions

Run the full bats test suite:
```bash
bats tests/unit/ tests/static/ tests/containment/ tests/integration/ tests/perf/
```

And the Rust tests:
```bash
cargo test --manifest-path yolo-mcp-server/Cargo.toml
```

Fix any regressions caused by:
- The new default flag values (v2_typed_protocol=true, v3_schema_validation=true)
- Tests that assumed these flags were false
- Any test that creates config.json without all required keys (schema validation
  will now reject it unless the test config is valid)

Document any test changes needed in the task summary.
