---
phase: "02"
plan: "01"
title: "Create researcher agent and Rust tier_context infrastructure"
wave: 1
depends_on: []
must_haves:
  - "agents/yolo-researcher.md exists with WebSearch, WebFetch, Read, Glob, Grep, Bash, Write tools"
  - "role_family('researcher') returns 'planning' in tier_context.rs"
  - "build_tier3_volatile injects RESEARCH.md files from phase directory"
  - "Unit tests pass for role_family and Tier 3 research injection"
---

# Plan 01: Create Researcher Agent and Rust tier_context Infrastructure

## Goal

Create the researcher agent definition file and extend the Rust tier_context module to support the researcher role family and inject research findings into Tier 3 volatile context.

## Tasks

### Task 1: Create agents/yolo-researcher.md

**Files:** `agents/yolo-researcher.md` (new)

**Create the researcher agent file following the existing agent pattern (see yolo-architect.md for structure).**

Frontmatter:
```yaml
---
name: yolo-researcher
description: Research agent with internet access for best practices, standards, and up-to-date documentation lookups.
tools: Read, Glob, Grep, Bash, Write, WebFetch, WebSearch
disallowedTools: Edit
model: inherit
maxTurns: 15
permissionMode: acceptEdits
---
```

Body sections (keep concise, follow existing agent patterns):

1. **Header:** "YOLO Researcher" — Research agent. Searches internet and codebase for best practices, standards, frameworks, and up-to-date documentation. Produces structured findings for consumption by Architect and Dev agents.

2. **Core Protocol:**
   - Parse research topic from task description
   - Scope: identify 3-5 key facets of the research question
   - Execute: use WebSearch for broad discovery, WebFetch for specific URLs, codebase search (Read/Glob/Grep) for internal patterns
   - Synthesize: structured findings with source attribution and confidence levels

3. **Output Format:**
   - Write findings to `{phase-dir}/RESEARCH.md` using the template structure (Findings, Relevant Patterns, Risks, Recommendations)
   - Each finding should include: source URL or file path, key insight, confidence (high/medium/low)
   - Cap output at 200 lines to control token usage

4. **Subagent Usage:**
   - Researcher does NOT spawn subagents — conducts all research inline
   - This is a leaf agent (no children)

5. **Circuit Breaker:** Same error 3 times → STOP, try ONE alternative. Still fails → report blocker. No 4th retry.

6. **Constraints:**
   - Research only — never modify product code
   - Write only to `.yolo-planning/` paths (research artifacts)
   - Do not fabricate URLs or findings — only report what was actually found

**Verification:** File exists at `agents/yolo-researcher.md`. Has valid frontmatter with name, tools, model, maxTurns.

### Task 2: Add researcher to role_family in tier_context.rs

**Files:** `yolo-mcp-server/src/commands/tier_context.rs`

**Current state (line 67-73):**
```rust
pub fn role_family(role: &str) -> &'static str {
    match role {
        "architect" | "lead" => "planning",
        "dev" | "senior" | "qa" | "security" | "debugger" => "execution",
        _ => "default",
    }
}
```

**Change:** Add `"researcher"` to the planning family match arm:
```rust
"architect" | "lead" | "researcher" => "planning",
```

This ensures the researcher gets the same Tier 2 content as Architect/Lead (ARCHITECTURE.md, ROADMAP.md, REQUIREMENTS.md), enabling cache prefix sharing.

**Verification:** `cargo build` succeeds. `cargo test -- role_family` passes.

### Task 3: Extend build_tier3_volatile to inject RESEARCH.md

**Files:** `yolo-mcp-server/src/commands/tier_context.rs`

**Current state (lines 245-289):** `build_tier3_volatile()` reads only `*-PLAN.md` and `*.plan.jsonl` files from the phase directory.

**Change:** After injecting plan files (around line 284), add a second pass that looks for `RESEARCH.md` or `*-RESEARCH.md` files in the phase directory and injects them:

```rust
// After the plan file loop, before the function returns:
// Also inject research findings if present
if let Some(pd) = phases_dir {
    let phase_dir = pd.join(format!("{:02}", phase));
    if phase_dir.is_dir() {
        let mut research_entries: Vec<_> = std::fs::read_dir(&phase_dir)
            .into_iter()
            .flatten()
            .flatten()
            .filter(|e| {
                let name = e.file_name();
                let name_str = name.to_string_lossy();
                name_str == "RESEARCH.md" || name_str.ends_with("-RESEARCH.md")
            })
            .collect();
        research_entries.sort_by_key(|e| e.file_name());
        for entry in research_entries {
            if let Ok(text) = std::fs::read_to_string(entry.path()) {
                let name = entry.file_name().to_string_lossy().to_string();
                content.push_str(&format!("\n# Research: {}\n{}\n", name, text));
            }
        }
    }
}
```

**Important:** The research injection must happen inside the `if phase > 0` block, after plan injection but before the function returns. Do NOT duplicate the `phases_dir` + `phase_dir` resolution — restructure to share it.

**Verification:** `cargo build` succeeds. `cargo test -- tier_context` passes.

### Task 4: Add Rust unit tests

**Files:** `yolo-mcp-server/src/commands/tier_context.rs`

**Add these tests to the existing `mod tests` block:**

1. `test_researcher_is_planning_family` — verify `role_family("researcher")` returns `"planning"`

2. `test_tier3_includes_research_md` — create a temp phase dir with both a `01-PLAN.md` and a `RESEARCH.md`, call `build_tier3_volatile()`, assert the output contains `# Research: RESEARCH.md` and the research content

3. `test_tier3_without_research` — create a temp phase dir with only plan files, call `build_tier3_volatile()`, assert it does NOT contain "# Research:"

4. `test_tier3_research_sorted` — create a temp phase dir with `01-RESEARCH.md` and `02-RESEARCH.md`, verify they appear in sorted order

**Verification:** `cargo test` passes with all new tests green.
