---
phase: "02"
plan: "02"
title: "Wire researcher into commands, config, hooks, and tests"
wave: 1
depends_on: []
must_haves:
  - "commands/research.md spawns researcher as subagent instead of inline"
  - "model-profiles.json has researcher entries in all 3 profiles"
  - "hooks.json has yolo-researcher in all 4 agent matchers"
  - "agents/yolo-architect.md documents optional researcher spawning"
  - "Bats tests verify researcher context injection"
---

# Plan 02: Wire Researcher into Commands, Config, Hooks, and Tests

## Goal

Update the /yolo:research command to spawn the researcher as a subagent, add the researcher to model-profiles.json and hooks.json, update the architect agent to reference the researcher, and add bats integration tests.

## Tasks

### Task 1: Update commands/research.md to spawn researcher subagent

**Files:** `commands/research.md`

**Current state (lines 1-44):** Inline research with `Do NOT spawn any subagents` directive.

**Changes:**

1. Update frontmatter `allowed-tools` to include Task tool:
```yaml
allowed-tools: Read, Write, Bash, Glob, Grep, WebFetch, Task
```

2. Replace Step 3 (Research) content. Remove the "Do NOT spawn any subagents" line. Replace with:
```markdown
3. **Research:**
   - Resolve researcher model: `"$HOME/.cargo/bin/yolo" resolve-model researcher .yolo-planning/config.json ${CLAUDE_PLUGIN_ROOT}/config/model-profiles.json`
   - Spawn yolo-researcher as subagent via Task tool with `subagent_type: "general-purpose"`, `name: "researcher"`:
     - Task prompt: "Research topic: {topic}\n\nScope: {facets}\n\nWrite findings to {phase-dir}/RESEARCH.md"
     - Pass `model: "{resolved_model}"` parameter
   - If --parallel flag: split topic into sub-topics, spawn one researcher per sub-topic
   - Collect findings from researcher agent(s)
```

3. Update Step 5 (Persist): Remove the "Ask save?" prompt. Researcher agent writes directly to RESEARCH.md — the orchestrator just confirms the file exists.

**Verification:** Read commands/research.md. Step 3 mentions spawning researcher subagent. No "Do NOT spawn" directive remains.

### Task 2: Add researcher to model-profiles.json

**Files:** `config/model-profiles.json`

**Current state:** 5 entries per profile (lead, dev, debugger, architect, docs).

**Add researcher entries:**
```json
{
  "quality": {
    "lead": "opus",
    "dev": "opus",
    "debugger": "opus",
    "architect": "opus",
    "docs": "sonnet",
    "researcher": "sonnet"
  },
  "balanced": {
    "lead": "sonnet",
    "dev": "sonnet",
    "debugger": "sonnet",
    "architect": "sonnet",
    "docs": "sonnet",
    "researcher": "haiku"
  },
  "budget": {
    "lead": "sonnet",
    "dev": "sonnet",
    "debugger": "sonnet",
    "architect": "sonnet",
    "docs": "sonnet",
    "researcher": "haiku"
  }
}
```

Rationale: researcher needs reasoning for synthesis (sonnet in quality), but web search + synthesis is lighter work (haiku in balanced/budget).

**Verification:** `jq '.quality.researcher' config/model-profiles.json` returns `"sonnet"`. `jq '.budget.researcher' config/model-profiles.json` returns `"haiku"`.

### Task 3: Add researcher to hooks.json matchers

**Files:** `hooks/hooks.json`

**Current state:** 4 agent matchers (SubagentStart line 31, SubagentStop line 43, TeammateIdle line 55, TaskCompleted line 67) all have identical pattern:
```
yolo-lead|yolo-dev|yolo-debugger|yolo-architect|yolo-docs|yolo:yolo-lead|yolo:yolo-dev|yolo:yolo-debugger|yolo:yolo-architect|yolo:yolo-docs|lead|dev|debugger|architect|docs|team-lead|team-dev|team-debugger|team-architect|team-docs
```

**Change:** Append to ALL 4 matcher strings:
```
|yolo-researcher|yolo:yolo-researcher|researcher|team-researcher
```

This adds the researcher in all 4 naming patterns (prefixed, MCP-prefixed, bare, team-prefixed) to match how the Task tool names agents.

**Verification:** `grep -c "yolo-researcher" hooks/hooks.json` returns `4`.

### Task 4: Update architect agent to reference researcher

**Files:** `agents/yolo-architect.md`

**Current state:** Subagent Usage section (lines 34-44) only mentions Explore subagent.

**Add after the existing Subagent Usage section, a new entry:**
```markdown
**Optional research delegation:**
- When scoping a new milestone that involves unfamiliar technologies or external standards, you may spawn a Researcher agent (Task tool with name "researcher") to gather best practices and up-to-date documentation.
- Researcher returns structured findings in RESEARCH.md. Consume findings directly — do not re-research the same topics.
- This is optional — only use when the scope involves external knowledge beyond the codebase.
```

**Verification:** Read agents/yolo-architect.md. "Researcher" mention exists in Subagent Usage section.

### Task 5: Add bats tests for researcher context injection

**Files:** `tests/tier-cache.bats`

**Add tests at the end of the existing file:**

1. `test researcher role gets planning family tier 2` — Run `yolo compile-context 1 researcher {test_phases_dir}`. Verify output contains `TIER 2: ROLE FAMILY (planning)` and `ARCHITECTURE.md` content.

2. `test tier 3 includes RESEARCH.md when present` — Create `{test_phases_dir}/03/RESEARCH.md` with known content. Run `yolo compile-context 3 dev {test_phases_dir}`. Verify output contains `# Research: RESEARCH.md` and the research content.

3. `test tier 3 excludes research when no RESEARCH.md` — Ensure standard compile-context without RESEARCH.md does NOT contain "# Research:".

4. `test researcher model resolves from profiles` — Run `yolo resolve-model researcher {test_config} {profiles_path}`. Verify output is "sonnet" or "haiku" (depending on profile).

**Test setup:** Reuse the existing `setup()` function. Add RESEARCH.md creation where needed within individual tests.

**Verification:** `bats tests/tier-cache.bats` passes with all new + existing tests green.
