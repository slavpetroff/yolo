{"plan":"04","r":"changes_requested","cycle":1,"dt":"2026-02-17"}
{"sev":"critical","cat":"error_handling","file":"scripts/qa-gate-post-task.sh","line":264,"finding":"|| true swallows exit code, making TAP_EXIT always 0. Timeout check (line 269, -eq 124) is unreachable. Same bug on line 288-289 (full test path). Pattern: `OUTPUT=$(...) || true; EXIT=$?` -- $? captures exit code of `true` (always 0), not the command substitution.","fix":"Remove `|| true` from lines 264 and 288. Script uses `set -u` not `set -e`, so non-zero exit from command substitution won't abort the script. The correct pattern is: `TAP_OUTPUT=$(run_with_timeout ... 2>&1); TAP_EXIT=$?`"}
{"sev":"critical","cat":"error_handling","file":"scripts/qa-gate-post-plan.sh","line":177,"finding":"Same || true exit code swallowing bug as qa-gate-post-task.sh. TEST_EXIT is always 0, timeout detection (line 180, -eq 124) is dead code.","fix":"Change line 177 to: `TEST_OUTPUT=$(run_with_timeout \"$TIMEOUT\" bash \"$TEST_SUMMARY_PATH\" 2>&1); TEST_EXIT=$?` (remove `|| true`)"}
{"sev":"critical","cat":"error_handling","file":"scripts/qa-gate-post-phase.sh","line":223,"finding":"Same || true exit code swallowing bug. TEST_EXIT always 0, timeout check on line 226 unreachable.","fix":"Change line 223 to: `TEST_OUTPUT=$(run_with_timeout \"$TIMEOUT\" bash \"$TEST_SUMMARY_PATH\" 2>&1); TEST_EXIT=$?` (remove `|| true`)"}
{"sev":"major","cat":"consistency","file":"scripts/qa-gate-post-task.sh","line":112,"finding":"Gate scripts call resolve-qa-config.sh with zero arguments (`\"$QA_CONFIG_SCRIPT\" 2>/dev/null`), but resolve-qa-config.sh requires exactly 2 positional arguments (config-path, defaults-path) and exits 1 on `[ $# -ne 2 ]`. The `|| QA_CONFIG_JSON='{}'` fallback catches this, so config resolution always falls through to empty object -- config toggles are never actually read from disk in production. Works by coincidence (fail-open to enabled), but config disabling via qa_gates.post_task=false in config.json has no effect outside tests.","fix":"Pass required arguments: `QA_CONFIG_JSON=$(\"$QA_CONFIG_SCRIPT\" \"$CONFIG_PATH\" \"$DEFAULTS_PATH\" 2>/dev/null) || QA_CONFIG_JSON='{}'` where CONFIG_PATH and DEFAULTS_PATH are resolved like qa-gate.sh does (line 14-15). All three gate scripts need this fix."}
{"sev":"major","cat":"consistency","file":"scripts/validate-gates.sh","line":276,"finding":"validate-gates.sh has no `research` case in its step dispatch (line 92 case statement). qa-gate-post-phase.sh line 187 includes `research` in its STEPS array. When post-phase iterates steps and calls validate-gates.sh --step research, it hits the `*) echo ERROR: Unknown step; exit 1` branch, counting research as a failed gate. This means post-phase gate will always report at least 1 step failure in any phase that ran the research step.","fix":"Add a `research)` case to validate-gates.sh that checks for research.jsonl OR step 2 skipped, matching execute-protocol.md Step 2 entry gate: `research) if ! check_artifact_exists \"$PHASE_DIR/research.jsonl\" && ! check_step_skipped \"research\"; then MISSING+=(\"research.jsonl\"); GATE_RESULT=\"fail\"; fi ;;`"}
{"sev":"major","cat":"consistency","file":"scripts/qa-gate-post-task.sh","line":165,"finding":"Gate scripts output `level` key (e.g., `\"level\":\"post-task\"`) but artifact-formats.md schema specifies `gl` (gate_level). format-gate-result.sh transforms to `gl` but is never called by any gate script -- scripts write raw JSON directly to .qa-gate-results.jsonl. Consumers (yolo-qa.md, yolo-qa-code.md, validate-gates.sh) filter on `gl` field. Integration test (line 75) papers over this with `.level // .gl` fallback.","fix":"Either: (a) rename `level` to `gl` in all three gate scripts' jq output templates (lines 165, 283, 257), or (b) pipe output through format-gate-result.sh before writing to .qa-gate-results.jsonl. Option (a) is simpler and matches D3 (append-mode JSONL with abbreviated keys)."}
{"sev":"major","cat":"doc","file":"scripts/qa-gate-post-plan.sh","line":8,"finding":"Header comment says 'Exit: 0 on pass/partial/warn, 1 on fail' but actual code (lines 335-338) exits 1 for both FAIL and PARTIAL results. PARTIAL is treated as a blocking failure, contradicting the documented behavior.","fix":"Either update header to 'Exit: 0 on pass/warn, 1 on fail/partial' (matching actual behavior), or change PARTIAL to exit 0 if the intent is non-blocking partial results."}
{"sev":"minor","cat":"consistency","file":"scripts/format-gate-result.sh","line":1,"finding":"format-gate-result.sh is never called by any gate script. Gate scripts do their own inline JSON construction. The script is dead code unless called externally by agents or other consumers.","fix":"Either integrate format-gate-result.sh into the gate scripts' output path (pipe through it before writing to .qa-gate-results.jsonl), or document in qa-gate-integration.md that it is for external/agent use only. Currently no caller exists."}
{"sev":"minor","cat":"convention","file":"scripts/qa-gate-post-task.sh","line":250,"finding":"Line 250 uses `find` to map source files to test files: `test_file=$(find \"$TESTS_DIR\" -name \"${base_name}.bats\" 2>/dev/null | head -1)`. Project convention says 'Use jq for all JSON parsing, never grep/sed on JSON' but does not prohibit find. However, the pattern could be fragile if base_name contains glob characters.","fix":"Quote the -name pattern or use a more defensive approach. Low severity since base_name comes from plan.jsonl file paths which are controlled inputs."}
{"sev":"minor","cat":"consistency","file":"scripts/qa-gate-post-task.sh","line":50,"finding":"Lock helpers (has_flock, acquire_lock_flock, acquire_lock_mkdir, release_lock_mkdir, sleep_ms) are duplicated verbatim across all three gate scripts (~30 lines each, ~90 lines total). Comment says 'copied from git-commit-serialized.sh'. Four copies of the same code increases maintenance burden.","fix":"Extract lock helpers into a shared library (e.g., scripts/lib/lock-helpers.sh) and source it. This is a minor DRY improvement, not blocking. Per D5 (flock serialization), the behavior is correct in all copies."}
{"sev":"info","cat":"architecture","file":"scripts/qa-gate-post-phase.sh","line":187,"finding":"STEPS array includes 11 workflow steps matching execute-protocol.md. The ordering is correct (critique, research, architecture, planning, design_review, test_authoring, implementation, code_review, qa, security, signoff). Architecture D7 (separate scripts not dispatch) is followed.","fix":"No fix needed. Positive observation."}
{"sev":"info","cat":"test","file":"tests/integration/qa-gate-cascade.bats","line":1,"finding":"Integration test covers the full cascade: post-task -> post-plan -> post-phase, failure propagation, and config toggle skip. 6 tests covering the primary cascade paths. Unit tests: 13 post-task, 11 post-plan, 11 post-phase, 14 qa-gate.sh = 49 unit tests + 6 integration = 55 total for the QA gate system.","fix":"No fix needed. Coverage is adequate for the gate system."}
{"sev":"info","cat":"doc","file":"references/qa-gate-integration.md","line":74,"finding":"Config docs say failure_threshold default is 'critical' (enum: critical/major/minor), qa-help-text.md says default is 'strict' (enum: strict/lenient/off). Two different naming schemes for the same concept across docs. defaults.json uses 'critical'. validate-config.sh validates against critical/major/minor.","fix":"Align qa-help-text.md to use 'critical/major/minor' terminology matching defaults.json and validate-config.sh, or document the mapping between the two schemes."}
