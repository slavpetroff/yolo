{"p":"04","n":"05","t":"Config-aware qa-gate.sh and config.md QA settings","w":2,"d":["04-03","04-04"],"mh":{"tr":["qa-gate.sh reads qa_gates config via resolve-qa-config.sh without breaking existing hook interface","Config.md exposes all QA gate settings via interactive and direct modes","Backward compatible: projects without qa_gates config work unchanged"],"ar":[{"p":"commands/config.md","pv":"QA gates section in settings reference","c":"Config.md has QA gate toggle options in interactive mode and settings reference table"}],"kl":[{"fr":"commands/config.md QA settings","to":"config/defaults.json qa_gates","vi":"Every config.md QA option maps to a qa_gates key in defaults.json"},{"fr":"scripts/qa-gate.sh config reading","to":"scripts/resolve-qa-config.sh","vi":"qa-gate.sh uses resolve-qa-config.sh for config resolution"}]}}
{"id":"T1","tp":"auto","a":"Update scripts/qa-gate.sh to read qa_gates config via resolve-qa-config.sh. Do NOT add --level dispatch or change the hook interface (stdin-only). Keep existing structural checks unchanged. Add config awareness: if qa_gates config is disabled, skip structural checks and output {gate:skipped}. Fail-open on config read errors. Per architecture D2/D7: qa-gate.sh stays as Notification hook, workflow-level gates are separate scripts in 04-06/04-07.","f":["scripts/qa-gate.sh"],"v":"qa-gate.sh reads config via resolve-qa-config.sh, existing hook interface unchanged, fail-open preserved","done":"QA gate hook config awareness committed","spec":"FILE: scripts/qa-gate.sh (MODIFY). Architecture D2: do NOT add --level flag, do NOT add dispatch logic, do NOT change the Notification hook stdin-only interface. Architecture D7: qa-gate.sh stays as structural check only (summary gap + commit format). The ONLY change is adding config awareness to conditionally skip checks when disabled.\n\nCurrent script structure (75 lines): reads stdin, counts plans vs summaries, checks commit format, decides block/allow. All of this must remain EXACTLY as-is.\n\nChanges to add (insert AFTER line 8 'INPUT=$(cat 2>/dev/null) || exit 0' and BEFORE line 10 'SUMMARY_OK=false'):\n\n1. Resolve script path relative to this script:\n   SCRIPT_DIR=\"$(cd \"$(dirname \"${BASH_SOURCE[0]}\")\" && pwd)\"\n   RESOLVE_SCRIPT=\"$SCRIPT_DIR/resolve-qa-config.sh\"\n\n2. Resolve PLUGIN_ROOT for config/defaults.json path:\n   PLUGIN_ROOT=\"${CLAUDE_PLUGIN_ROOT:-$(cd \"$SCRIPT_DIR/..\" && pwd)}\"\n   CONFIG_PATH=\".yolo-planning/config.json\"\n   DEFAULTS_PATH=\"$PLUGIN_ROOT/config/defaults.json\"\n\n3. Config-aware skip logic (fail-open on ALL errors):\n   if [ -x \"$RESOLVE_SCRIPT\" ]; then\n     QA_CONFIG=$(bash \"$RESOLVE_SCRIPT\" \"$CONFIG_PATH\" \"$DEFAULTS_PATH\" 2>/dev/null) || QA_CONFIG='{}'\n   else\n     QA_CONFIG='{}'\n   fi\n\n4. Check if post_task gate is enabled (qa-gate.sh is the Notification hook, which fires at task-level):\n   POST_TASK_ENABLED=$(echo \"$QA_CONFIG\" | jq -r '.post_task // true' 2>/dev/null) || POST_TASK_ENABLED='true'\n\n5. If disabled, skip all checks and exit 0:\n   if [ \"$POST_TASK_ENABLED\" = \"false\" ]; then\n     exit 0\n   fi\n\nCRITICAL: The rest of the script (lines 10-75: SUMMARY_OK, PLANS_TOTAL, SUMMARIES_TOTAL, commit format check, decision logic) must remain UNCHANGED. Zero modification to existing behavior when config is enabled or missing.\n\nDo NOT output {gate:skipped} to stdout (the Notification hook interface does not use stdout for structured output -- only stderr for messages and exit codes for decisions). Simply exit 0 silently when disabled.\n\nFail-open chain: resolve-qa-config.sh fails -> QA_CONFIG='{}' -> jq '.post_task // true' -> 'true' -> checks run normally. This is triple-fallback: script missing, script errors, jq errors all result in checks running (fail-open)."}
{"id":"T2","tp":"auto","a":"Update commands/config.md: add QA Gates to Step 2 interactive options. Add qa_gates settings to Settings Reference table (qa_gates.post_task, qa_gates.post_plan, qa_gates.post_phase, qa_gates.timeout_seconds, qa_gates.failure_threshold). Add Step 2.7 for QA gate toggle interaction.","f":["commands/config.md"],"td":["T1"],"v":"Config.md has QA gates in interactive flow and settings reference table","done":"Config.md QA gate settings committed","spec":"FILE: commands/config.md (MODIFY). Three insertion points.\n\nINSERTION 1: Step 2 AskUserQuestion options list (around line 35-40). Add 'QA Gates' as a 7th option after 'Departments':\n- QA Gates\n\nINSERTION 2: New Step 2.7 section. Insert AFTER Step 2.6 (Departments, around line 139) and BEFORE Step 3 (Apply changes, around line 141). Exact content:\n\n**Step 2.7:** If \"QA Gates\" was selected in Step 2, show current QA gate state and allow toggling.\n\nRead current QA gate config via resolve-qa-config.sh:\n```bash\nQA_CONFIG=$(bash ${CLAUDE_PLUGIN_ROOT}/scripts/resolve-qa-config.sh .yolo-planning/config.json ${CLAUDE_PLUGIN_ROOT}/config/defaults.json 2>/dev/null)\nIFS='|' read -r QA_PT QA_PP QA_PH QA_TO QA_FT <<< \"$(echo \"$QA_CONFIG\" | jq -r '[\n  (.post_task | tostring),\n  (.post_plan | tostring),\n  (.post_phase | tostring),\n  (.timeout_seconds | tostring),\n  (.failure_threshold)\n] | join(\"|\")' 2>/dev/null)\"\n```\n\nDisplay current state:\n```\nQA Gates:\n  Post-task:  {check_or_circle based on QA_PT}\n  Post-plan:  {check_or_circle based on QA_PP}\n  Post-phase: {check_or_circle based on QA_PH}\n  Timeout:    {QA_TO}s\n  Threshold:  {QA_FT}\n```\n\nUse AskUserQuestion multiSelect: \"Toggle QA gates:\"\n- **\"Post-task gate\"** -- description: \"Currently: {enabled|disabled}. Runs scoped tests after each task.\"\n- **\"Post-plan gate\"** -- description: \"Currently: {enabled|disabled}. Runs full suite after plan completion.\"\n- **\"Post-phase gate\"** -- description: \"Currently: {enabled|disabled}. Full verification before QA agents.\"\n- **\"Timeout\"** -- description: \"Currently: {QA_TO}s. Enter new value.\"\n- **\"Failure threshold\"** -- description: \"Currently: {QA_FT}. Choose: critical/major/minor.\"\n\nFor gate toggles: flip boolean (if true->false, if false->true).\nFor timeout: if selected, AskUserQuestion for new positive integer value.\nFor threshold: if selected, AskUserQuestion with options: critical | major | minor.\n\nApply via jq -- ensure qa_gates object exists first (same pattern as model_overrides init):\n```bash\nif ! jq -e '.qa_gates' .yolo-planning/config.json >/dev/null 2>&1; then\n  jq '.qa_gates = {}' .yolo-planning/config.json > .yolo-planning/config.json.tmp && mv .yolo-planning/config.json.tmp .yolo-planning/config.json\nfi\n```\nThen apply each changed field:\n```bash\njq \".qa_gates.post_task = $NEW_PT\" .yolo-planning/config.json > .yolo-planning/config.json.tmp && mv .yolo-planning/config.json.tmp .yolo-planning/config.json\n```\n\nDisplay: per changed setting with check symbol.\n\nINSERTION 3: Settings Reference table (around line 192-208). Add these rows AFTER the existing last row (custom_profiles):\n| qa_gates.post_task | boolean | true/false | true |\n| qa_gates.post_plan | boolean | true/false | true |\n| qa_gates.post_phase | boolean | true/false | true |\n| qa_gates.timeout_seconds | number | positive integer | 300 |\n| qa_gates.failure_threshold | string | critical/major/minor | critical |\n\nAlso add support for direct setting mode (### With arguments section). Example: /yolo:config qa_gates.post_task false -- parse dotted key path, apply via jq to nested object.\n\nPattern reference: Step 2.6 Departments toggle (exact same multiSelect + toggle + jq apply pattern). Settings Reference table format matches existing rows."}
{"id":"T3","tp":"auto","a":"Write bats tests for updated qa-gate.sh: test config-aware behavior (enabled vs disabled), test backward compatibility (missing qa_gates key = enabled), test fail-open on config read error, test existing structural checks still work. Do NOT test --level dispatch (removed per architecture D7).","f":["tests/qa-gate.bats"],"td":["T1"],"v":"All bats tests pass, covers config-aware behavior, backward compat, and fail-open","done":"Config-aware qa-gate.sh tests committed","spec":"FILE: tests/qa-gate.bats (MODIFY -- file already exists at tests/unit/qa-gate.bats with 125 lines of existing tests). The task description says tests/qa-gate.bats but the existing file is at tests/unit/qa-gate.bats. MODIFY the existing file at tests/unit/qa-gate.bats -- do NOT create a duplicate.\n\nAdd new test cases AFTER the existing tests (append after line 125). Keep all existing tests intact -- they validate the structural checks which must still work.\n\nNew test cases to add (4 minimum):\n\n1. '# --- Config-aware behavior ---' section header comment.\n\n2. 'skips checks when post_task is disabled in config' -- Setup: create .yolo-planning/config.json with {\"qa_gates\":{\"post_task\":false}}. Create a phase with summary gap (2 plans, 0 summaries) that would normally block. Create a mock resolve-qa-config.sh in SCRIPTS_DIR that echoes the config. Run qa-gate.sh. Assert exit 0 (skipped, not blocked). NOTE: qa-gate.sh calls resolve-qa-config.sh relative to its own directory, so the test must ensure the resolve script is findable. Create a minimal resolve-qa-config.sh in TEST_WORKDIR that outputs the disabled config.\n\n3. 'runs checks normally when post_task is enabled' -- Setup: create config with {\"qa_gates\":{\"post_task\":true}}. Create phase with summary gap > 1 and no conventional commits. Assert exit 2 (blocked -- existing behavior preserved).\n\n4. 'runs checks when config has no qa_gates key (backward compat)' -- Setup: create config with {} (no qa_gates). Create phase with summary gap > 1. Assert exit 2 (fail-open means checks run, and gap causes block).\n\n5. 'runs checks when resolve-qa-config.sh is missing (fail-open)' -- Setup: ensure no resolve-qa-config.sh exists in script directory. Create phase with summary gap > 1. Assert exit 2 (checks still run because fail-open defaults to enabled).\n\nIMPORTANT: The test setup needs to handle the SCRIPT_DIR resolution in qa-gate.sh. Since qa-gate.sh uses BASH_SOURCE to find resolve-qa-config.sh, tests must either: (a) create a wrapper resolve-qa-config.sh alongside qa-gate.sh in a temp dir, or (b) use a symlink. The simplest approach: copy qa-gate.sh to TEST_WORKDIR, create resolve-qa-config.sh alongside it, and run from there.","ts":"NOTE: T3 creates tests for T1. The spec field above IS the test spec. The ts field is intentionally empty because the test file IS the deliverable of this task."}
