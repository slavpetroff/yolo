---
phase: 2
plan: 03
title: "Command File Dedup & Reference Compression"
wave: 1
depends_on: []
must_haves:
  - REQ-03
  - REQ-07
  - REQ-08
---

# Plan 03: Command File Dedup & Reference Compression

Extract shared protocols from command files into references, consolidate repeated tables in reference files, and compress verbose sections in commands.

## Task 1: Extract Discovered Issues protocol to shared reference

**Description:** The "Discovered Issues" display protocol is duplicated verbatim in 4 files: `commands/verify.md` (L136-143), `commands/fix.md` (L56-74), `commands/debug.md` (L98-105), and `skills/execute-protocol/SKILL.md` (L925-934). Extract the canonical version to a new file `references/discovered-issues-protocol.md`. In each of the 4 source files, replace the inline copy with: `Follow discovered issues display protocol: @references/discovered-issues-protocol.md`.

NOTE: This task touches `skills/execute-protocol/SKILL.md` which is also modified by Plan 02. However, Plan 02 modifies different sections (v3 comments, tier block, Step 4, jq markers) while this task modifies only the Discovered Issues block in Step 5. These are disjoint edits within the same file. The Dev agent for this plan MUST acquire a lock on SKILL.md before editing.

**Files:** `references/discovered-issues-protocol.md` (NEW), `commands/verify.md`, `commands/fix.md`, `commands/debug.md`, `skills/execute-protocol/SKILL.md`

**Commit:** `refactor(2-03): extract Discovered Issues protocol to shared reference`

**Verification:** New file exists at `references/discovered-issues-protocol.md`. Each of the 4 source files contains the reference line. Inline "Discovered Issues" block text (cap at 20, de-duplicate, display-only) removed from all 4.

## Task 2: Deduplicate debug.md model resolution (Path A/B)

**Description:** In `commands/debug.md`, the model resolution block (`resolve-model debugger` + `resolve-turns debugger`) appears twice -- once in Path A (L49-54) and once in Path B (L65-70). Extract the resolution to a single block before the routing decision (after Step 3), then reference the resolved variables `DEBUGGER_MODEL` and `DEBUGGER_MAX_TURNS` in both paths.

**Files:** `commands/debug.md`

**Commit:** `refactor(2-03): deduplicate model resolution in debug.md`

**Verification:** `grep -c 'resolve-model debugger' commands/debug.md` returns 1 (not 2). Both paths still use `${DEBUGGER_MODEL}` and `${DEBUGGER_MAX_TURNS}`.

## Task 3: Compress init.md verbose sections

**Description:** In `commands/init.md`:
- Remove Step 0.5 timing rationale comment block (L97-103, 7 lines) -- the ordering is self-evident from the step numbers
- Remove INDEX.json field descriptions in Step 0.5 (L104-112, 9 lines) -- these belong in `docs/migration-gsd-to-yolo.md` which is already referenced at L113
- Remove inline comments in Step 5 scenario detection (L331-333, L335, L337) -- the code block at L347-352 is self-documenting
- Remove inline comments in Step 6 (L365-368) -- the inference script descriptions are in the display format below

Total: ~25 lines removed. No behavioral change.

**Files:** `commands/init.md`

**Commit:** `refactor(2-03): compress verbose comments in init.md`

**Verification:** Line count reduced by ~25. All steps still present and functional. Step 0.5 still references `docs/migration-gsd-to-yolo.md` for INDEX.json details.

## Task 4: Consolidate effort-profiles.md repeated tables

**Description:** In `references/effort-profiles.md`, each of the 4 profiles (Thorough, Balanced, Fast, Turbo) has:
- An Agent Matrix table (4 tables total, structurally identical columns)
- A Plan Approval table (4 tables, 2-3 rows each)
- An Effort Parameter Mapping table (4 tables, 2 rows each)

The Plan Approval tables and Effort Parameter Mapping tables are small and repetitive. Consolidate them into two unified tables at the top of the file:
- One "Plan Approval by Profile" table (4 rows: one per profile, columns for each autonomy level)
- One "Effort Parameter Mapping" table (5 rows: max, high, medium, low, skip with behavior description)

Remove the per-profile Plan Approval and Effort Parameter Mapping sections. Keep the per-profile Agent Matrix tables (they have unique content per profile).

**Files:** `references/effort-profiles.md`

**Commit:** `refactor(2-03): consolidate repeated tables in effort-profiles.md`

**Verification:** File has exactly 1 "Plan Approval" table and 1 "Effort Parameter Mapping" table (consolidated). Still has 4 Agent Matrix tables (one per profile). All information preserved.

## Task 5: Consolidate model-profiles.md agent tables

**Description:** In `references/model-profiles.md`, there are 3 separate agent tables (Quality L15-24, Balanced L31-39, Budget L47-55) plus a Cost Comparison table (L88-93) that repeats some of the same data. Merge the 3 profile tables into a single unified table with columns: Agent | Quality | Balanced | Budget. Remove the 3 individual tables. Keep the Cost Comparison table (it has unique cost estimate data).

**Files:** `references/model-profiles.md`

**Commit:** `refactor(2-03): consolidate 3 agent tables into 1 in model-profiles.md`

**Verification:** Single "Model Assignment" table with all 3 profiles as columns. 3 individual profile tables removed. Cost Comparison table preserved.
