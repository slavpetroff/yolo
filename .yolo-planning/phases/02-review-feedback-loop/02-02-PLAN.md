---
phase: "02"
plan: "02"
title: "Update Architect and Reviewer agent protocols for feedback loop"
wave: 1
depends_on: []
must_haves:
  - "Architect agent has Revision Protocol section accepting reviewer findings"
  - "Reviewer agent has Delta-Aware Review section comparing against previous findings"
  - "Reviewer escalates persistent high-severity findings across 2+ cycles"
  - "Both agents document cache efficiency (planning Tier 2 stays warm)"
---
# Plan 02-02: Agent protocol updates for review feedback loop

## Context
The Architect (`agents/yolo-architect.md`) and Reviewer (`agents/yolo-reviewer.md`) agents need
protocol additions to participate in the automated feedback loop. The Architect needs a revision
mode (accept findings, revise plan). The Reviewer needs delta-aware comparison and escalation logic.

## Tasks

### Task 1: Add Revision Protocol to Architect agent
Read `agents/yolo-architect.md`. Add a new `## Revision Protocol` section after the existing Core Protocol:

```markdown
## Revision Protocol

When spawned for plan revision (feedback loop context):

1. **Read** the original PLAN.md and reviewer findings from task description
2. **Classify** each finding:
   - `auto_fixable: true` → apply suggested_fix directly
   - `auto_fixable: false, severity: high` → redesign the affected section
   - `auto_fixable: false, severity: medium` → address if straightforward, document rationale if deferred
3. **Revise** the PLAN.md:
   - Overwrite the original file (same path)
   - Preserve frontmatter structure (phase, plan, title, wave, depends_on, must_haves)
   - Update must_haves if findings revealed missing requirements
   - Keep task count within max_tasks_per_plan config limit
4. **Report** which findings were addressed:
   - List addressed findings with brief rationale
   - List deferred findings with justification (medium-only, must explain why)
   - Never defer high-severity findings

**Cache note:** You share "planning" Tier 2 cache with the Reviewer. Between revision cycles,
only your Tier 3 volatile context changes (the updated plan). Avoid re-reading unchanged files.
```

**File:** `agents/yolo-architect.md`
**Commit:** `feat(02-02): add Revision Protocol to Architect agent`

### Task 2: Add Delta-Aware Review to Reviewer agent
Read `agents/yolo-reviewer.md`. Add a new `## Delta-Aware Review` section:

```markdown
## Delta-Aware Review

When re-reviewing a revised plan (feedback loop cycle > 1):

1. **Compare** current findings against previous cycle findings from task description
2. **Classify** each finding:
   - **Resolved:** was in previous cycle, no longer present → note as fixed
   - **Persistent:** same finding across 2+ cycles → escalate (see Escalation)
   - **New:** not in previous cycle → treat as normal finding
   - **Changed severity:** same issue but different severity → note the change
3. **Output** structured delta:
   ```
   VERDICT: approve|reject|conditional
   CYCLE: {N}/{max}
   RESOLVED: {count}
   PERSISTENT: {count}
   NEW: {count}
   FINDINGS:
   - [severity:high] [status:persistent|new] [file:path] issue: description | suggestion: fix
   ```

## Escalation Protocol

- If same high-severity finding persists across 2+ cycles: mark as ESCALATED
- Escalated findings get special handling in the HARD STOP message
- Escalated findings suggest the plan may need manual intervention
- NEVER approve a plan with escalated high-severity findings
```

**File:** `agents/yolo-reviewer.md`
**Commit:** `feat(02-02): add Delta-Aware Review and Escalation Protocol to Reviewer agent`

### Task 3: Add cache efficiency documentation to both agents
Add brief cache notes to both agents explaining the Tier 2 sharing:

For Architect: note in Revision Protocol (already in Task 1)
For Reviewer: add under Delta-Aware Review:

```markdown
**Cache note:** You share "planning" Tier 2 cache with the Architect. Between review cycles,
only Tier 3 volatile context changes. Re-read only the revised plan file, not the full codebase.
```

Also verify both agents are in the "planning" role family in `config/model-profiles.json`.

**File:** `agents/yolo-reviewer.md`, `config/model-profiles.json` (verify only)
**Commit:** `feat(02-02): add cache efficiency notes to review loop agents`

### Task 4: Verify protocol consistency and cross-references
Review both updated agents against the execute-protocol Step 2b:
- Architect output format matches what Step 2b expects
- Reviewer verdict format matches Step 2b parsing
- Finding severity levels consistent (high/medium/low)
- Escalation flow referenced in both Reviewer and Step 2b
- model-profiles.json confirms both agents in "planning" family

No file changes expected — verification only. If inconsistencies found, fix them.

**File:** cross-reference verification (agents/*.md, skills/execute-protocol/SKILL.md)
**Commit:** `fix(02-02): resolve protocol consistency issues` (only if fixes needed)
