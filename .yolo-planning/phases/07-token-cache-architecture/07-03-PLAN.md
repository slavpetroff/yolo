---
phase: 7
plan: 3
title: "Enable config flags and verify end-to-end"
wave: 2
depends_on: [1, 2]
must_haves:
  - "v2_token_budgets=true in config, token truncation enforced and logged"
  - "v3_metrics=true and v3_event_log=true enabled for observability"
  - "All existing tests pass + new tests for stable/volatile split"
allowed_paths:
  - ".yolo-planning/config.json"
  - "tests/token-budgets.bats"
  - "tests/feature-flags.bats"
---

# Plan 07-03: Enable Config Flags and Verify End-to-End

## Context

The token budget enforcement machinery exists in Rust (`yolo token-budget`) and is documented in execute-protocol.md (REQ-12), but `v2_token_budgets` is set to `false` in config.json. Similarly, `v3_metrics` and `v3_event_log` are disabled, preventing observability of the new cache behavior.

This plan activates these flags and runs the full test suite to verify nothing breaks. It depends on Plans 01 and 02 because the protocol changes and Rust changes must land first — enabling token budgets with the old file-path-reference pattern would be confusing, and the report upgrade needs to be in place before metrics are enabled.

## Tasks

### Task 1: Enable v2_token_budgets in config.json

**Files:** `.yolo-planning/config.json`

Set `"v2_token_budgets": true` in config.json.

Verify that the token-budget enforcement path in execute-protocol.md (REQ-12, lines 156-172) is consistent with the current `yolo token-budget` CLI command. The command already exists and handles truncation + overage logging — this flag simply activates the path.

Acceptance criteria:
- `v2_token_budgets` is `true` in config.json
- No other config values changed in this task

### Task 2: Enable v3_metrics and v3_event_log in config.json

**Files:** `.yolo-planning/config.json`

Set `"v3_metrics": true` and `"v3_event_log": true` in config.json.

These flags enable:
- `v3_metrics`: Structured metrics collection via `yolo collect-metrics`
- `v3_event_log`: Event logging via `yolo log-event` for tool calls, phase transitions, and token budget events

Acceptance criteria:
- `v3_metrics` is `true` in config.json
- `v3_event_log` is `true` in config.json
- No other config values changed in this task

### Task 3: Run full test suite and fix any failures

**Files:** `tests/token-budgets.bats`, `tests/feature-flags.bats` (if fixes needed)

Run the full bats test suite:
```bash
bats tests/token-budgets.bats tests/feature-flags.bats
```

If any tests fail due to the flag changes (e.g., tests that assert `v2_token_budgets=false`), update them to reflect the new config state.

Also run `cargo test` in `yolo-mcp-server/` to verify Rust tests pass with the changes from Plan 02.

Acceptance criteria:
- `bats tests/token-budgets.bats` passes
- `bats tests/feature-flags.bats` passes
- `cargo test` passes
- Any test assertions updated to match new flag values

### Task 4: Commit config activation

Stage and commit:
```
chore(07-03): enable v2_token_budgets, v3_metrics, and v3_event_log
```
