{"p":"03","n":"04","t":"Context Compiler & Protocol Integration","w":2,"d":["03-01","03-02"],"xd":[],"mh":{"tr":["compile-context.sh includes per-role reference packages instead of @-referencing full files","execute-protocol.md references validate-gates.sh and generate-execution-state.sh for Steps 3 and 6-10","Agent spawn in execute-protocol.md passes resolved tool permissions","Token budget enforcement accounts for reference package size","All 606 existing regression tests still pass after integration"],"ar":[{"p":"scripts/compile-context.sh","pv":"file modified to reference packages/","c":"includes per-role reference package path in compiled context instead of full reference tree"},{"p":"references/execute-protocol.md","pv":"file modified to reference new scripts","c":"Steps 3, 6-10 reference validate-gates.sh; Step 3 references generate-execution-state.sh"}],"kl":[{"fr":"scripts/compile-context.sh","to":"references/packages/dev.toon","vi":"dev context includes reference to packages/dev.toon instead of full execute-protocol.md"},{"fr":"references/execute-protocol.md","to":"scripts/validate-gates.sh","vi":"entry gate checks delegate to validate-gates.sh"},{"fr":"references/execute-protocol.md","to":"scripts/generate-execution-state.sh","vi":"Step 3 uses generate-execution-state.sh instead of inline JSON construction"},{"fr":"references/execute-protocol.md","to":"scripts/resolve-tool-permissions.sh","vi":"agent spawn includes resolved tool permissions from project type"}]},"obj":"Integrate all Phase 3 scripts and packages into the existing workflow: update compile-context.sh to use reference packages, update execute-protocol.md to call new validation/generation scripts, wire tool permission resolution into agent spawning. REQ-04, REQ-05, REQ-06.","sk":["commit"],"fm":["scripts/compile-context.sh","references/execute-protocol.md","tests/unit/compile-context-packages.bats","tests/integration/token-optimization.bats"],"auto":true}
{"id":"T1","tp":"auto","a":"Update scripts/compile-context.sh: for each role's context generation, add a reference to the role's package file (references/packages/{base_role}.toon) instead of @-referencing full execute-protocol.md or company-hierarchy.md. Add a new helper get_reference_package() that resolves the package path and includes it in compiled output. Ensure token budget enforcement accounts for package content size. Preserve all existing functionality (backward compatible if packages/ dir missing). REQ-04, REQ-05.","f":["scripts/compile-context.sh"],"v":"Compiled context for dev role references packages/dev.toon, not execute-protocol.md; compiled context for senior references packages/senior.toon; context size is smaller than before","done":"compile-context.sh includes per-role reference packages with backward-compatible fallback"}
{"id":"T2","tp":"auto","a":"Update references/execute-protocol.md: (1) In Verification Gate Protocol section, add instruction to run validate-gates.sh for entry gate checks instead of inline file existence checks. (2) In Step 3 Load Plans, reference generate-execution-state.sh for building .execution-state.json instead of inline JSON schema. (3) In agent spawn sections (Steps 1,2,4,5,6,7,8,9), add note about passing resolved tool permissions via resolve-tool-permissions.sh. (4) Add note in Pre-Execution about running validate-plan.sh on all plan.jsonl files before execution. Keep all existing content -- these are additive references. REQ-04, REQ-06.","f":["references/execute-protocol.md"],"v":"Protocol references all 4 new scripts (validate-plan.sh, validate-gates.sh, generate-execution-state.sh, resolve-tool-permissions.sh); no existing protocol steps removed","done":"execute-protocol.md updated with script references for validation and generation"}
{"id":"T3","tp":"auto","a":"Create tests/unit/compile-context-packages.bats: test that compile-context.sh correctly includes reference packages. Tests: dev context includes packages/dev.toon reference, senior context includes packages/senior.toon reference, qa context includes packages/qa.toon reference, fallback works when packages/ dir missing, context with packages is smaller than without, all existing compile-context tests still pass. 8+ tests.","f":["tests/unit/compile-context-packages.bats"],"v":"bats tests/unit/compile-context-packages.bats passes all tests","done":"8+ BATS tests verifying reference package integration in compile-context.sh"}
{"id":"T4","tp":"auto","a":"Create tests/integration/token-optimization.bats: end-to-end integration tests measuring token optimization. Tests: validate-plan.sh catches invalid plan and accepts valid plan, validate-gates.sh reports correct gate status for each step, generate-execution-state.sh produces valid state from real phase dir, compile-context.sh with packages produces smaller output than without, resolve-tool-permissions.sh returns correct tools for YOLO's own cli-tool type, full pipeline (detect-stack -> resolve-permissions -> compile-context) works. 6+ integration tests. Verify 606 regression baseline with dedicated test. REQ-04, REQ-05, REQ-06.","f":["tests/integration/token-optimization.bats"],"v":"bats tests/integration/token-optimization.bats passes all tests","done":"6+ integration tests verifying full token optimization pipeline"}
