---
phase: "01"
plan: "01"
title: "Add markdown minification and compression CLI commands"
wave: 1
depends_on: []
must_haves:
  - "minify_markdown function in tier_context.rs reduces empty lines and separators"
  - "compress-context CLI command reports per-tier token breakdown and applies minification"
  - "prune-completed CLI command strips completed plan details from phase directories"
  - "All existing 20 tier_context tests + 13 MCP tests pass"
---

# Plan 01: Add Markdown Minification and Compression CLI Commands

## Goal

Add a minification pass to the compiled context pipeline that removes excessive whitespace, collapse empty lines, and strip decorative separators. Also create two new CLI commands: `compress-context` for analysis/minification and `prune-completed` for phase artifact cleanup.

## Tasks

### Task 1: Add minify_markdown to tier_context.rs

**Files:** `yolo-mcp-server/src/commands/tier_context.rs`

**Implementation:** Add a `pub fn minify_markdown(text: &str) -> String` function that:
1. Collapses 2+ consecutive empty lines into exactly 1 empty line
2. Removes lines that are only `---` (horizontal separators, NOT tier headers like `--- TIER 1: ---`)
3. Trims trailing whitespace from every line
4. Preserves all meaningful content (headers, code blocks, tables, lists)

Apply minification in `build_tiered_context()` after combining all 3 tiers, before returning the `combined` field:
```rust
let combined = format!("{}\n{}\n{}", tier1, tier2, tier3);
let combined = minify_markdown(&combined);
```

**Expected savings:** ~11% reduction (78 empty lines, 10 separators → ~1,380 bytes from a 12.2KB context).

**Verification:** `cargo build` succeeds. `cargo test -- tier_context` passes. Manually check that tier headers (`--- TIER 1: SHARED BASE ---`) are preserved.

### Task 2: Add compress-context CLI command

**Files:** `yolo-mcp-server/src/commands/compress_context.rs` (new), `yolo-mcp-server/src/commands/mod.rs`, `yolo-mcp-server/src/cli/router.rs`

**Usage:** `yolo compress-context [--analyze-only] [--phase-dir <path>]`

**Behavior:**
1. Find all `.context-*.md` files in the specified phase-dir (or `.yolo-planning/phases/`)
2. For each file:
   - Read content, compute original size (bytes + estimated tokens at 4 chars/token)
   - Apply `minify_markdown()` to produce minified version
   - Report: `{file, original_bytes, minified_bytes, savings_bytes, savings_pct}`
3. If `--analyze-only`: print report only, don't modify files
4. Otherwise: write minified content back to the files

**Output:** JSON structured return:
```json
{"ok": true, "cmd": "compress-context", "files": [...], "total_savings_bytes": N, "total_savings_pct": "X.Y%"}
```

**Route in router.rs:** Add `"compress-context"` route near the existing `"compile-context"` route.

**Verification:** `cargo build` succeeds. Run `yolo compress-context --analyze-only` and verify JSON output.

### Task 3: Add prune-completed CLI command

**Files:** `yolo-mcp-server/src/commands/prune_completed.rs` (new), `yolo-mcp-server/src/commands/mod.rs`, `yolo-mcp-server/src/cli/router.rs`

**Usage:** `yolo prune-completed <phase-dir>`

**Behavior:**
1. Scan the phase directory for completed phases (directories matching `NN-*`)
2. For each phase directory, check if ALL plans have SUMMARY.md files (= phase complete)
3. For completed phases: keep SUMMARY.md files, delete PLAN.md files (the SUMMARYs capture what was done)
4. Report what was pruned

**Output:** JSON structured return:
```json
{"ok": true, "cmd": "prune-completed", "pruned_phases": N, "files_removed": N, "bytes_freed": N}
```

**Exit codes:** 0=success, 1=error

**Route in router.rs:** Add `"prune-completed"` route.

**Verification:** `cargo build` succeeds. Create a test phase dir with PLAN.md + SUMMARY.md, run prune, verify PLAN.md removed and SUMMARY.md preserved.

### Task 4: Add Rust unit tests

**Files:** `yolo-mcp-server/src/commands/tier_context.rs`, `yolo-mcp-server/src/commands/compress_context.rs`, `yolo-mcp-server/src/commands/prune_completed.rs`

**Tests for minify_markdown:**
1. `test_minify_collapses_empty_lines` — 3+ consecutive empties → 1
2. `test_minify_removes_bare_separators` — `---` lines removed, tier headers preserved
3. `test_minify_trims_trailing_whitespace` — trailing spaces/tabs removed
4. `test_minify_preserves_code_blocks` — content in ``` blocks unchanged
5. `test_minified_context_smaller` — build_tiered_context produces smaller output than raw concatenation

**Tests for compress_context:**
1. `test_compress_context_analyze_only` — reports but doesn't modify files

**Tests for prune_completed:**
1. `test_prune_removes_plans_keeps_summaries` — PLAN.md deleted, SUMMARY.md preserved
2. `test_prune_skips_incomplete_phases` — phases without all SUMMARYs untouched

**Verification:** `cargo test` passes with all new tests green.
