---
phase: "01"
plan: "02"
title: "Document MCP hybrid pattern and wire archive pruning"
wave: 1
depends_on: []
must_haves:
  - "ARCHITECTURE.md documents MCP/CLI hybrid pattern with tool ownership"
  - "plugin.json has MCP server declaration or documented decision not to add one"
  - "archive.md calls prune-completed after phase archival"
  - "Token reduction measured and documented"
---

# Plan 02: Document MCP Hybrid Pattern and Wire Archive Pruning

## Goal

Document the MCP/CLI hybrid architecture pattern, update plugin.json, wire the prune-completed command into the archive workflow, and measure overall token reduction.

## Tasks

### Task 1: Update ARCHITECTURE.md with MCP hybrid documentation

**Files:** `.yolo-planning/codebase/ARCHITECTURE.md`

**Current state:** Line 14 mentions "MCP Server" with a one-line tool list. No protocol or pattern documentation.

**Add a new section after "### 1. Rust Binary" describing the MCP/CLI hybrid pattern:**

```markdown
### MCP/CLI Hybrid Pattern

The binary operates in two modes:
- **CLI mode** (`yolo <command>`): Used by skills, hooks, and orchestrator scripts. Synchronous, file-based output. All 60+ commands available.
- **MCP mode** (`yolo` with no args, reads stdin): JSON-RPC 2.0 server for agent-initiated actions. 5 tools: compile_context, acquire_lock, release_lock, run_test_suite, request_human_approval.

**Tool ownership:**
| Tool | Mode | Why |
|------|------|-----|
| compile_context | Both (CLI primary) | CLI called by SKILL.md scripts; MCP version adds cache tracking + tier hashing |
| acquire_lock / release_lock | MCP | Agent-initiated concurrent file locking (22+ calls per phase) |
| run_test_suite | MCP | Agent-initiated test execution with auto-detection |
| request_human_approval | MCP | HITL workflow trigger |

**Cache prefix optimization:** The MCP compile_context computes SHA-256 hashes of Tier 1 and Tier 2 content. When a second agent requests context and the hash matches, it reports a cache hit. This enables Anthropic API prompt prefix caching — identical prefixes across agents are served from cache.
```

Also update:
- Agent count from "5 specialized agents" to match current roster (5: architect, debugger, dev, docs, lead)
- Description should be factual about current state
- Command count if changed

**Verification:** Read ARCHITECTURE.md. MCP section is present with tool ownership table and cache explanation.

### Task 2: Update plugin.json with MCP server declaration

**Files:** `.claude-plugin/plugin.json`

**Current state:** Only metadata (name, version, description, author, license). No MCP server config.

**Decision:** Add MCP server declaration so Claude Code CAN invoke MCP tools natively. The binary already handles both modes (args → CLI, no args → MCP server via stdin).

**Add:**
```json
{
  "name": "yolo",
  "version": "2.5.0",
  "description": "YOLO — development lifecycle plugin for Claude Code. 23 commands, 5 agents, continuous verification.",
  "author": {
    "name": "Stanislav Petrov",
    "url": "https://github.com/slavpetroff"
  },
  "license": "MIT",
  "mcp_server": {
    "command": "yolo-mcp-server",
    "args": []
  }
}
```

**Note:** Also update description to match actual counts (23 commands, 5 agents per Phase 7 cleanup).

**Verification:** Read plugin.json. `mcp_server` block exists. `jq .mcp_server plugin.json` returns valid JSON.

### Task 3: Wire prune-completed into archive.md

**Files:** `skills/vibe-modes/archive.md`

**Current archive flow:** Steps 1-11 with no pruning.

**Insertion point:** After step 6 (Archive — move phases to milestones), before step 7 (Persist project state).

**Add:**
```markdown
6b. **Prune completed artifacts:**
Run `"$HOME/.cargo/bin/yolo" prune-completed {milestone_dir}` to strip PLAN.md files from completed phases (SUMMARYs are preserved as the authoritative record). This reduces archived milestone size and keeps only the outcome artifacts.
If prune fails, log warning and continue (fail-open).
```

**Verification:** Read archive.md. Step 6b exists between Archive and Persist.

### Task 4: Measure and document token reduction

**Files:** This is a verification task, no file changes.

**Steps:**
1. Run `yolo compile-context 1 dev` to produce current context
2. Note the file size before minification (if minification from Plan 01-01 is applied)
3. Run `yolo compress-context --analyze-only` to see the breakdown
4. Run `yolo report-tokens` (if metrics data available) for current token statistics
5. Document findings in the SUMMARY.md

**Expected result:** 5-10% reduction from minification on compiled context files.

**Verification:** compress-context --analyze-only shows measurable savings.
