{"p":"01-03","n":"Context Compiler Integration","t":3,"w":2,"d":["01-01","01-02"],"mh":["REQ-01"],"obj":"Wire compile-context.sh to read generated department TOONs from .yolo-planning/departments/ instead of static references/departments/*.toon, with fallback to static files when generated ones do not exist.","sk":["commit"],"fm":["scripts/compile-context.sh"]}
{"id":"01-03-01","n":"Add generated TOON resolution to compile-context.sh","f":["scripts/compile-context.sh"],"d":[],"ac":["compile-context.sh checks .yolo-planning/departments/{dept}.toon first before falling back to references/departments/{dept}.toon","Resolution order: generated (project-specific) > static (default)","Department mapping: DEPT=backend reads backend.toon, DEPT=fe reads frontend.toon, DEPT=ux reads uiux.toon","When generated TOONs exist, agent context includes project-specific conventions (e.g. Bash/BATS for shell project, not TypeScript/React)","Existing compile-context.sh behavior unchanged when no generated TOONs exist (backward compatible)"],"spec":"Modify scripts/compile-context.sh to add generated TOON resolution. All changes are ADDITIVE -- existing behavior must remain identical when generated TOONs do not exist. (1) Add a new helper function get_dept_conventions() after the existing get_decisions() function (after line 114). Function signature: get_dept_conventions(). It uses the already-set DEPT variable (line 25-29: backend, fe, ux, shared). Logic: First, map DEPT to the generated TOON filename: case $DEPT in backend) DEPT_TOON_FILE='backend.toon';; fe) DEPT_TOON_FILE='frontend.toon';; ux) DEPT_TOON_FILE='uiux.toon';; shared) return 0;; esac. (shared department has no generated conventions -- return early). Then resolve path: GENERATED_DEPT_TOON=\"$PLANNING_DIR/departments/$DEPT_TOON_FILE\". If [ -f \"$GENERATED_DEPT_TOON\" ]; then echo the conventions content from the generated file (cat \"$GENERATED_DEPT_TOON\"). Else, fall back: map to static file: case $DEPT in backend) STATIC_DEPT_TOON='references/departments/backend.toon';; fe) STATIC_DEPT_TOON='references/departments/frontend.toon';; ux) STATIC_DEPT_TOON='references/departments/uiux.toon';; esac. If [ -f \"$STATIC_DEPT_TOON\" ]; then extract ONLY the conventions section from the static file using awk: awk '/^conventions:/,/^[a-z_]+:/{if(/^[a-z_]+:/ && !/^conventions:/) exit; print}' \"$STATIC_DEPT_TOON\". This extracts from 'conventions:' to the next top-level key. If neither file exists, return 0 (silently, backward compatible). (2) Add a dept context cache flag near the other cache flags (line 214-216): DEPT_CONVENTIONS_AVAILABLE=false; if [ -f \"$PLANNING_DIR/departments/${DEPT_TOON_FILE:-}\" ] || [ \"$DEPT\" != \"shared\" ]; then DEPT_CONVENTIONS_AVAILABLE=true; fi. This is for performance -- avoid repeated stat calls. (3) This task only adds the helper function and resolution logic. Task 01-03-02 wires it into the role-specific case blocks. The function must handle edge cases: (a) .yolo-planning/departments/ directory does not exist (no error, fall back silently). (b) Generated TOON file is empty (output nothing). (c) DEPT is 'shared' (no conventions to inject). (d) Static fallback file missing too (no output, no error).","ts":"Tests in task 01-03-03 cover this. Key verification: (a) with generated TOON present, get_dept_conventions outputs its content. (b) without generated TOON, falls back to static conventions section. (c) with neither, outputs nothing and returns 0."}
{"id":"01-03-02","n":"Add department protocol reference to role context","f":["scripts/compile-context.sh"],"d":["01-03-01"],"ac":["For roles that need department conventions (dev, senior, tester, qa-code), inject relevant sections from the resolved department TOON into .ctx-{role}.toon","Injected sections: conventions, testing, tooling from department protocol","Budget-aware: department context counts toward role token budget","No duplicate conventions: if department TOON has same convention as conventions.json, department TOON takes precedence for that category"],"spec":"Modify scripts/compile-context.sh to inject department conventions into role-specific context for 4 roles: dev, senior, tester, qa-code. (1) In the 'dev)' case block (line 329-367): After the conventions section (after line 352, before the skills section), add department conventions injection. Insert: DEPT_CONV=$(get_dept_conventions); if [ -n \"$DEPT_CONV\" ]; then echo ''; echo 'dept_conventions:'; echo \"$DEPT_CONV\" | sed 's/^/  /'; fi. This adds dept_conventions as a new section with indented content. Place it AFTER the generic conventions but BEFORE skills, so the Dev sees project-specific conventions alongside generic ones. (2) In the 'senior)' case block (line 293-326): After the conventions section (after line 325), add same injection pattern: DEPT_CONV=$(get_dept_conventions); if [ -n \"$DEPT_CONV\" ]; then echo ''; echo 'dept_conventions:'; echo \"$DEPT_CONV\" | sed 's/^/  /'; fi. (3) In the 'tester)' case block (line 420-443): After the conventions section (after line 442), add same injection. (4) In the 'qa-code)' case block (line 395-417): After the conventions section (after line 415), add same injection. (5) Budget consideration (per architecture C-03 response): The conventions section from generated TOONs is ~100-150 tokens (~400-600 chars). Dev budget is 2000 tokens (8000 chars). Adding ~500 chars keeps well within budget. The existing enforce_budget() function (line 163-208) handles overflow automatically via progressive truncation. No budget changes needed. (6) Deduplication: The get_dept_conventions() helper returns the full generated conventions block. The get_conventions() helper returns project-wide conventions from conventions.json. These are different scopes: conventions.json has structural project conventions (commit format, file naming), dept_conventions has technology-specific conventions (language, testing framework). They are complementary, not duplicates. If a category overlaps (e.g. both say 'testing'), the dept_conventions section appears AFTER generic conventions, so the agent reads the project-specific one last (most recent context wins). No code dedup logic needed. (7) Do NOT inject into architect, lead, qa, security, debugger, critic, scout, owner roles. These roles either (a) already get dept context via @-reference to static files, (b) operate at a higher abstraction level, or (c) have tight budgets. Only dev/senior/tester/qa-code need project-specific conventions for implementation/review work.","ts":"Tests in task 01-03-03 cover this. Key verification: (a) compile-context.sh for dev role with generated TOON present outputs dept_conventions section. (b) For architect role, no dept_conventions section appears. (c) Budget is not exceeded (output file size / 4 <= role budget)."}
{"id":"01-03-03","n":"Add compile-context integration tests","f":["tests/unit/compile-context-dept.bats"],"d":["01-03-01","01-03-02"],"ac":["BATS test creates mock generated TOON in .yolo-planning/departments/","Runs compile-context.sh for dev role and verifies output .ctx-dev.toon references project-specific conventions","Tests fallback: when generated TOON absent, output matches original static behavior","Tests budget enforcement: injected department context does not exceed role token budget","Tests all three department resolution paths: backend, frontend (fe-), uiux (ux-)"],"spec":"Create tests/unit/compile-context-dept.bats. Follow patterns from existing tests. Header: #!/usr/bin/env bats. setup(): load '../test_helper/common', '../test_helper/fixtures', '../test_helper/mock_stdin', mk_test_workdir, mk_planning_dir. SUT=\"$SCRIPTS_DIR/compile-context.sh\". Create phase dir: PHASE_DIR=$(mk_phase 1 setup 1 0). Create a minimal ROADMAP: mk_roadmap. Create generated dept TOON dir: mkdir -p \"$TEST_WORKDIR/.yolo-planning/departments\". Create mock generated backend.toon: cat > \"$TEST_WORKDIR/.yolo-planning/departments/backend.toon\" <<'EOF'\\nbackend_conventions:\\n  desc: Project-specific backend conventions (generated)\\n\\n  language: Bash\\n  testing: bats-core\\n  tooling: jq, shell scripting\\nEOF. Create mock generated frontend.toon and uiux.toon similarly. Helper: run_compile(role) { run bash -c \"cd '$TEST_WORKDIR' && bash '$SUT' 01 '$role' '$TEST_WORKDIR/.yolo-planning/phases'\"; }. Tests (minimum 10): (1) '@test \"dev context includes dept_conventions when generated TOON exists\"' -- run_compile dev, assert_success, read output file path from $output, assert_file_contains .ctx-dev.toon 'dept_conventions'. (2) '@test \"dev context includes Bash language from generated TOON\"' -- run_compile dev, assert_file_contains .ctx-dev.toon 'Bash'. (3) '@test \"senior context includes dept_conventions\"' -- run_compile senior, assert_file_contains .ctx-senior.toon 'dept_conventions'. (4) '@test \"tester context includes dept_conventions\"' -- run_compile tester, assert_file_contains .ctx-tester.toon 'dept_conventions'. (5) '@test \"qa-code context includes dept_conventions\"' -- run_compile qa-code, assert_file_contains .ctx-qa-code.toon 'dept_conventions'. (6) '@test \"architect context does NOT include dept_conventions\"' -- run_compile architect, assert_file_not_contains .ctx-architect.toon 'dept_conventions'. (7) '@test \"fallback: dev context works without generated TOON\"' -- rm -rf \"$TEST_WORKDIR/.yolo-planning/departments\", run_compile dev, assert_success (no crash, backward compatible). (8) '@test \"fe-dev resolves frontend.toon\"' -- create mock frontend.toon with 'React' content, run_compile fe-dev, assert_file_contains .ctx-fe-dev.toon 'React' or 'dept_conventions'. (9) '@test \"ux-dev resolves uiux.toon\"' -- create mock uiux.toon, run_compile ux-dev, assert_file_contains .ctx-ux-dev.toon 'dept_conventions'. (10) '@test \"budget not exceeded for dev role\"' -- run_compile dev, get file size of .ctx-dev.toon, compute tokens (chars/4), assert tokens <= 2000. Use: local chars=$(wc -c < \"$PHASE_DIR/.ctx-dev.toon\"); local tokens=$((chars / 4)); [ \"$tokens\" -le 2000 ]. (11) '@test \"lead context does NOT include dept_conventions\"' -- run_compile lead, assert_file_not_contains .ctx-lead.toon 'dept_conventions'. Note: compile-context.sh requires a phase directory with at least the phase number matching. The mk_phase helper creates this. The script outputs the path to the generated .ctx file, which we use to locate and verify the output.","ts":"This IS the test task. The test file itself is the deliverable. Verify by running: bats tests/unit/compile-context-dept.bats -- all tests should pass. Minimum 10 tests covering: 4 roles with injection (dev, senior, tester, qa-code), 2 roles without injection (architect, lead), fallback behavior, department resolution (backend, fe, ux), budget compliance."}
