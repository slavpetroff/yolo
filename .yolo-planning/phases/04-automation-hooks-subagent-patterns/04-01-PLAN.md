---
phase: 4
plan: 01
title: Test infrastructure and helper modernization
wave: 1
depends_on: []
must_haves:
  - test_helper.bash exports YOLO_BIN pointing to yolo binary
  - All 53 test files can resolve YOLO_BIN correctly
  - agent-shutdown-integration.bats migrated from scripts to yolo hook CLI
  - hooks-isolation-lifecycle.bats migrated from scripts to yolo hook CLI
---

# Plan 01: Test Infrastructure and Helper Modernization

## Background

All 569 bats test failures share common root causes:
1. `$SCRIPTS_DIR` points to `scripts/` which no longer exists (migrated to Rust CLI `yolo <subcommand>`)
2. `$YOLO_BIN` is referenced by 12 test files but never defined in `test_helper.bash`
3. Some tests reference agent files `yolo-qa.md` and `yolo-scout.md` that were removed during agent consolidation

This plan fixes the shared test infrastructure that all other test repair plans depend on. Note: while this is wave 1, other wave 1 plans will also update individual test files. This plan ONLY touches `test_helper.bash`, `agent-shutdown-integration.bats`, and `hooks-isolation-lifecycle.bats`. Files with overlapping concerns (discovered-issues-surfacing.bats, shutdown-protocol.bats, role-isolation.bats) are handled in plans 03 and 04 to avoid parallel file conflicts.

## Tasks

### Task 1: Add YOLO_BIN to test_helper.bash

**Description:** Add `export YOLO_BIN="${HOME}/.cargo/bin/yolo"` to `tests/test_helper.bash`. This variable is already referenced by 12 test files (token-baseline.bats, tier-cache.bats, phase-detect.bats, token-economics.bats, etc.) but was never defined.

Also add a helper function `yolo_cmd()` that wraps the yolo binary with proper cwd handling for tests that need to run yolo from a temp directory.

**Files:**
- `tests/test_helper.bash`

**Acceptance criteria:**
- `YOLO_BIN` exported and resolves to a valid yolo binary path
- Helper function `yolo_cmd()` exists for tests that need cwd-aware CLI invocation
- Existing helper functions (setup_temp_dir, teardown_temp_dir, create_test_config) unchanged

### Task 2: Fix agent-shutdown-integration.bats references

**Description:** `agent-shutdown-integration.bats` references `$SCRIPTS_DIR/agent-start.sh`, `$SCRIPTS_DIR/agent-stop.sh`, `$SCRIPTS_DIR/session-stop.sh`, and `$SCRIPTS_DIR/task-verify.sh`. These are all now handled by `yolo hook SubagentStart`, `yolo hook SubagentStop`, `yolo hook Stop`, and `yolo hook PostToolUse` (task-verify is part of PostToolUse). Update all 16 test invocations to pipe JSON to `yolo hook <EventName>` instead of calling shell scripts.

Also fix the `simulate_agent_start` and other helper functions in this file to use the Rust CLI.

**Files:**
- `tests/agent-shutdown-integration.bats`

**Acceptance criteria:**
- All 16 tests use `yolo hook` instead of `$SCRIPTS_DIR/*.sh`
- All `simulate_agent_start`/`simulate_agent_stop` helpers use Rust CLI
- All 16 tests pass

### Task 3: Fix hooks-isolation-lifecycle.bats

**Description:** `hooks-isolation-lifecycle.bats` has 41 tests, 41 failing. It references 9 different scripts: agent-start.sh, agent-stop.sh, file-guard.sh, prompt-preflight.sh, security-filter.sh, session-start.sh, session-stop.sh, task-verify.sh, validate-commit.sh. All are now Rust hook handlers or CLI commands.

Mapping:
- `agent-start.sh` -> `yolo hook SubagentStart` (pipe JSON to stdin)
- `agent-stop.sh` -> `yolo hook SubagentStop`
- `file-guard.sh` -> `yolo hook PreToolUse` (security_filter handles file-guard)
- `prompt-preflight.sh` -> `yolo hook UserPromptSubmit`
- `security-filter.sh` -> `yolo hook PreToolUse`
- `session-start.sh` -> `yolo hook SessionStart` or `yolo session-start`
- `session-stop.sh` -> `yolo hook Stop`
- `task-verify.sh` -> `yolo hook PostToolUse` (validate_summary)
- `validate-commit.sh` -> `yolo hook PreToolUse` (validates commit in Bash tool_input)

Also update the 3 tests that use `$YOLO_BIN` to use the newly defined variable.

**Files:**
- `tests/hooks-isolation-lifecycle.bats`

**Acceptance criteria:**
- All 41+ tests updated to use `yolo hook <Event>` or `yolo <subcommand>`
- No references to `$SCRIPTS_DIR`
- All tests pass
