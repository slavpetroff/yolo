---
phase: 4
plan: 2
title: "Context compilation and step ordering integration tests"
wave: 1
depends_on: []
must_haves:
  - Tests verify ARCHITECTURE.md appears in dev compiled context output
  - Tests verify ARCHITECTURE.md appears in qa compiled context output
  - Tests verify steps_completed tracking text in SKILL.md
  - Tests verify Step 5 validation gate text in SKILL.md
  - All existing tests still pass
---

### Task 1: Add context compilation tests for ARCHITECTURE.md in execution family

**Files:** `tests/workflow-integrity-context.bats`

Create a new bats test file with CLI-based tests (Pattern B):

**ARCHITECTURE.md in execution family context:**
- Use `setup_temp_dir` + `create_test_config` + create codebase fixtures
- Create `$TEST_TEMP_DIR/.yolo-planning/codebase/ARCHITECTURE.md` with "Architecture overview" content
- Create `$TEST_TEMP_DIR/.yolo-planning/codebase/ROADMAP.md` and other required files
- Run `$YOLO_BIN compile-context 1 dev "$TEST_TEMP_DIR/phases"` and verify output contains "Architecture overview"
- Run `$YOLO_BIN compile-context 1 qa "$TEST_TEMP_DIR/phases"` and verify output contains "Architecture overview"
- Run `$YOLO_BIN compile-context 1 debugger "$TEST_TEMP_DIR/phases"` and verify output contains "Architecture overview"
- Negative test: verify "default" family does NOT get ARCHITECTURE.md

**Commit:** `test(integration): add context compilation tests for execution family`

### Task 2: Add step ordering integration tests

**Files:** `tests/workflow-integrity-context.bats`

Add static grep tests for step ordering in the same file:

**Step tracking in SKILL.md:**
- `steps_completed` appears in execution-state.json schema (initial `[]`)
- Each step tracking block exists: grep for `steps_completed += ["step_2"]`, `["step_2b"]`, `["step_3"]`, `["step_3c"]`, `["step_3d"]`
- Step 4 conditional tracking exists

**Step 5 validation gate:**
- `REQUIRED_STEPS=` exists in SKILL.md
- `Step ordering violation` error message exists
- `Step ordering verified` success message exists
- The jq subtraction formula exists

**Lead anti-takeover protocol:**
- `agents/yolo-lead.md` contains "Anti-Takeover Protocol" section header
- Lead agent contains "NEVER Write/Edit" rule
- Lead agent contains "create a NEW Dev agent" recovery instruction

**Commit:** `test(integration): add step ordering and anti-takeover tests`
