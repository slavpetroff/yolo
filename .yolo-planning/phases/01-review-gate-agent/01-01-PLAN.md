---
phase: "01"
plan: "01"
title: "Two-stage review gate in execute protocol"
wave: 1
depends_on: []
must_haves:
  - "Step 2b spawns yolo-reviewer agent after CLI pre-check passes"
  - "CLI structural check remains as fail-fast pre-filter"
  - "Agent VERDICT replaces CLI exit code as the gate verdict"
  - "Feedback loop wires to agent verdict for re-review cycles"
  - "Fallback to CLI-only verdict if agent spawn fails"
  - "Step 2b heading removes misleading (optional) label"
---

## Tasks

### Task 1: Rewrite Step 2b with two-stage review and fix heading

**Files:** `skills/execute-protocol/SKILL.md`

Rewrite the Step 2b section (lines 55-274) to implement two-stage review. Also fix the heading per REQ-04.

**Heading fix (REQ-04):**
Change `### Step 2b: Review gate (optional)` to `### Step 2b: Review gate`. The "(optional)" label is misleading when `review_gate="always"`. The activation logic and "When inactive" display already handle skip behavior.

**Two-stage review structure:**

After reading `review_gate` config and determining the gate is active, add model resolution for the reviewer agent before the per-plan review loop:

```bash
REVIEWER_MODEL=$("$HOME/.cargo/bin/yolo" resolve-model reviewer .yolo-planning/config.json ${CLAUDE_PLUGIN_ROOT}/config/model-profiles.json)
if [ $? -ne 0 ]; then echo "$REVIEWER_MODEL" >&2; REVIEWER_MODEL=""; fi
REVIEWER_MAX_TURNS=$("$HOME/.cargo/bin/yolo" resolve-turns reviewer .yolo-planning/config.json "{effort}")
if [ $? -ne 0 ]; then REVIEWER_MAX_TURNS=15; fi
```

**Stage 1 — CLI pre-check (existing, unchanged purpose):**
- Keep the existing `yolo review-plan` CLI call as a fast structural pre-check
- If CLI returns `verdict: "reject"` (exit 1): fast-fail immediately, display structural errors, skip agent spawn. This saves tokens on malformed plans.
- If CLI returns `verdict: "approve"` or `verdict: "conditional"`: proceed to Stage 2

**Stage 2 — Reviewer agent spawn (new):**
- Spawn `yolo-reviewer` agent via Task tool with `subagent_type: "yolo:yolo-reviewer"`
- Pass the plan path, phase directory, and CLI pre-check findings (if conditional) as context
- Parse the agent's completion message for the structured `VERDICT: approve|reject|conditional` and `FINDINGS:` block
- The agent's VERDICT becomes the gate verdict (not the CLI exit code)

**Agent spawn template (initial review):**
```
subject: "Review plan {NN-MM}"
description: |
  {PLANNING_CONTEXT}

  Review this plan adversarially.

  **Plan path:** {plan_path}
  **Phase directory:** {phase_dir}
  {If CLI had conditional findings: "**CLI pre-check findings (structural):** {CLI_FINDINGS}"}

  Follow your Core Protocol:
  1. Read the plan file
  2. Verify referenced codebase files exist
  3. Run `yolo review-plan` for automated checks
  4. Analyze adversarially
  5. Produce structured VERDICT

activeForm: "Reviewing plan {NN-MM}"
model: "${REVIEWER_MODEL}"
maxTurns: ${REVIEWER_MAX_TURNS}
subagent_type: "yolo:yolo-reviewer"
```

**Verdict parsing from agent output:**
- Extract `VERDICT:` line from agent completion message
- Extract `FINDINGS:` block (everything after FINDINGS: until end of structured block)
- Parse each finding line: `[id:X] [severity:Y] [file:Z] issue: DESC | suggestion: FIX` into JSON
- Convert to JSON array: `{"id": "X", "severity": "Y", "file": "Z", "title": "DESC", "description": "DESC", "suggestion": "FIX"}`
- If parsing fails (agent didn't follow format): treat as `conditional` with a warning finding about unparseable verdict

**Fallback behavior:**
- If agent spawn fails (Task tool error, timeout, no completion): fall back to CLI-only verdict
- Display: `⚠ Reviewer agent unavailable — falling back to CLI review for plan {NN-MM}`
- Log: `yolo log-event review_agent_fallback {phase} plan={NN-MM} reason={error}`
- Use the CLI verdict from Stage 1 as the gate verdict

**Acceptance criteria:**
- Step 2b heading reads `### Step 2b: Review gate` (no parenthetical)
- When `review_gate="always"`, every plan triggers Stage 1 (CLI) then Stage 2 (agent)
- CLI reject short-circuits without agent spawn
- Agent VERDICT drives the approve/reject/conditional logic
- Agent spawn failure degrades to CLI-only (never breaks the gate)

### Task 2: Wire agent review into the feedback loop re-review step

**Files:** `skills/execute-protocol/SKILL.md`

Update the feedback loop (reject path, re-review cycles) so re-reviews also use two-stage review:

**In step e of the reject feedback loop:**
After the Architect revises the plan, the re-review currently runs only the CLI command. Change it to:

1. Run CLI pre-check on revised plan (same as initial)
2. If CLI passes, spawn reviewer agent with delta context
3. Agent's VERDICT drives the loop continue/exit logic

**Re-review agent spawn (cycle > 1) template:**
```
subject: "Re-review plan {NN-MM} (cycle {REVIEW_CYCLE})"
description: |
  {PLANNING_CONTEXT}

  Re-review this revised plan (feedback loop cycle {REVIEW_CYCLE}/{REVIEW_MAX_CYCLES}).

  **Plan path:** {plan_path}
  **Phase directory:** {phase_dir}
  **Review cycle:** {REVIEW_CYCLE} of {REVIEW_MAX_CYCLES}
  **Previous cycle findings:**
  {PREVIOUS_FINDINGS_SUMMARY}

  Follow Delta-Aware Review protocol:
  1. Read the revised plan
  2. Compare against previous findings
  3. Classify: resolved, persistent, new, changed severity
  4. Produce structured VERDICT with delta annotations

activeForm: "Re-reviewing plan {NN-MM} (cycle {REVIEW_CYCLE})"
model: "${REVIEWER_MODEL}"
maxTurns: ${REVIEWER_MAX_TURNS}
subagent_type: "yolo:yolo-reviewer"
```

**Parsing re-review output:**
- Same verdict parsing as initial review
- Map agent findings to JSON array for `CURRENT_FINDINGS`
- Existing delta extraction (step c) and accumulated findings logic works unchanged
- Execution-state tracking (cycle summary, findings_per_cycle) uses agent findings

**Fallback on re-review:**
- Same fallback pattern: if agent spawn fails during a re-review cycle, fall back to CLI verdict
- Log: `yolo log-event review_agent_fallback {phase} plan={NN-MM} cycle={REVIEW_CYCLE} reason={error}`

**Acceptance criteria:**
- Re-review cycles spawn the reviewer agent (not just CLI)
- Delta findings from previous cycles are passed to the reviewer agent
- Agent VERDICT drives the loop continue/exit logic
- Execution-state tracking uses agent findings
- Fallback to CLI works on re-review cycles too
- All existing loop infrastructure (cycle counting, max cycles, accumulated findings) works unchanged
