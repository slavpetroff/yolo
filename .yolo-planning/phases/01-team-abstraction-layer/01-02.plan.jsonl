{"p":"01","n":"02","t":"Agent prompt templates with conditional Teammate API instructions","w":1,"d":[],"mh":{"tr":["Agent prompts include Teammate API sections only activated when team_mode=teammate","Existing agent behavior unchanged when team_mode=task","Communication section documents SendMessage patterns per role","No agent references Teammate API tools without the conditional guard"],"ar":[{"p":"agents/yolo-dev.md","pv":"contains conditional Teammate API communication section","c":"grep -q team_mode agents/yolo-dev.md"},{"p":"agents/yolo-lead.md","pv":"contains team lifecycle management section","c":"grep -q spawnTeam agents/yolo-lead.md"},{"p":"references/teammate-api-patterns.md","pv":"file exists with spawnTeam, SendMessage, shutdown patterns","c":"test -f references/teammate-api-patterns.md"}],"kl":[{"fr":"references/teammate-api-patterns.md","to":"agents/yolo-lead.md","vi":"Lead references teammate-api-patterns.md for lifecycle operations"},{"fr":"references/teammate-api-patterns.md","to":"agents/yolo-dev.md","vi":"Dev references patterns for SendMessage communication"}]},"obj":"Add conditional Teammate API instruction blocks to agent prompts so agents know how to use spawnTeam and SendMessage when team_mode=teammate, and document prompt patterns in a reference file","fm":["agents/yolo-dev.md","agents/yolo-lead.md","agents/yolo-senior.md","agents/yolo-architect.md","references/teammate-api-patterns.md"]}
{"id":"T1","tp":"auto","a":"Create references/teammate-api-patterns.md documenting prompt patterns for: (1) spawnTeam with team name and description, (2) SendMessage for intra-team communication (dev-to-senior escalation, progress reports), (3) SendMessage for cross-team communication (lead-to-lead), (4) shutdown protocol (shutdown_request/shutdown_response), (5) team cleanup. Include when-to-use guard: only when team_mode=teammate. REQ-03.","f":["references/teammate-api-patterns.md"],"v":"File exists with sections for each pattern, each guarded by team_mode condition","done":"Reference file covers all 5 lifecycle patterns with conditional guards","spec":"Create NEW file: references/teammate-api-patterns.md\n\nFollow existing reference doc conventions (see references/execute-protocol.md, references/cross-team-protocol.md for style). Use H1 title, description paragraph, then H2 sections. No YAML frontmatter (reference files do not use frontmatter, only agent files do).\n\nFile structure (exact H2 headings):\n\n# Teammate API Patterns\n\nSingle-paragraph intro: This file documents all Teammate API tool patterns used by agents when team_mode=teammate. Referenced by agent prompt files via @references/teammate-api-patterns.md inside conditional blocks. When team_mode=task, these patterns are ignored and agents use the Task tool instead.\n\n## Activation Guard\n\nExplain the conditional: team_mode=teammate is set by resolve-team-mode.sh (reads config, validates agent_teams=true, checks CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS env var). When team_mode=task (default), all patterns in this file are inactive. Agents use Task tool for spawning and file-based communication for coordination.\n\nInclude the relationship: agent_teams=true (feature flag) + team_mode=teammate (spawn strategy) = Teammate API active. resolve-team-mode.sh validates this combination per C2 resolution.\n\n## Team Lifecycle (Lead only)\n\nThis section is for Lead agents ONLY (yolo-lead, yolo-fe-lead, yolo-ux-lead in Phase 2).\n\n### Creating a Team (spawnTeam)\n\nPattern: Lead calls spawnTeam with team name following convention: `yolo-{dept}` (e.g., yolo-backend, yolo-frontend, yolo-uiux). Description: `{Dept} engineering team for phase {N}: {phase-name}`.\n\nProvide code block example:\n```\nspawnTeam:\n  name: \"yolo-backend\"\n  description: \"Backend engineering team for phase 01: team-abstraction-layer\"\n```\n\nNote: One team per department. No nested teams (API constraint). Lead is automatically the team lead.\n\n### Registering Teammates\n\nAfter team creation, Lead registers teammates by role. Phase 1 roles: senior, dev, architect. Phase 2 adds: tester, qa, qa-code, security.\n\nProvide registration order: architect first (receives design context), then senior (receives specs), then dev (receives implementation tasks). Order matters because earlier teammates may need context before later ones begin.\n\n### Shutdown Protocol\n\nTwo-phase shutdown:\n1. Lead sends `shutdown_request` message to all teammates via SendMessage.\n2. Each teammate completes current work, commits artifacts, sends `shutdown_response` with status.\n3. Lead verifies all teammates responded, then terminates team.\n\nProvide shutdown_request schema:\n```json\n{\n  \"type\": \"shutdown_request\",\n  \"reason\": \"phase_complete | timeout | error\",\n  \"deadline_seconds\": 30\n}\n```\n\nProvide shutdown_response schema:\n```json\n{\n  \"type\": \"shutdown_response\",\n  \"status\": \"clean | in_progress | error\",\n  \"pending_work\": [],\n  \"artifacts_committed\": true\n}\n```\n\n### Team Cleanup\n\nAfter all teammates respond to shutdown OR after timeout:\n- Lead verifies all artifacts are committed (git status clean for team files)\n- Lead writes final summary artifacts\n- Team is automatically cleaned up when Lead's session ends\n- If timeout: Lead logs incomplete work in summary.jsonl `dv` (deviations) field\n\n## Intra-Team Communication (SendMessage)\n\nPatterns for communication WITHIN a department team. All use SendMessage tool.\n\n### Dev -> Senior (Progress)\n\nWhen: After completing each task in a plan.\nSchema: Use existing `dev_progress` schema from references/handoff-schemas.md.\nExample:\n```json\n{\n  \"type\": \"dev_progress\",\n  \"task\": \"01-01/T3\",\n  \"plan_id\": \"01-01\",\n  \"commit\": \"abc1234\",\n  \"status\": \"complete\",\n  \"concerns\": []\n}\n```\nNote: In task mode, Dev returns this via Task tool result. In teammate mode, Dev sends via SendMessage to Senior's teammate ID.\n\n### Dev -> Senior (Blocker/Escalation)\n\nWhen: Dev is blocked by spec ambiguity, missing dependency, or architectural issue.\nSchema: Use existing `dev_blocker` schema from references/handoff-schemas.md.\nExample:\n```json\n{\n  \"type\": \"dev_blocker\",\n  \"task\": \"01-02/T1\",\n  \"plan_id\": \"01-02\",\n  \"blocker\": \"Dependency module from plan 01-01 not yet committed\",\n  \"needs\": \"01-01 to complete first\",\n  \"attempted\": [\"Checked git log for 01-01 commits\"]\n}\n```\nCritical: Dev sends to Senior ONLY. Never to Lead or Architect (unchanged from task mode).\n\n### Senior -> Lead (Review Result)\n\nWhen: After completing design review or code review.\nSchema: Use existing `senior_spec` (design review) or `code_review_result` (code review) from references/handoff-schemas.md.\n\n### Senior -> Dev (Review Changes)\n\nWhen: Code review requests changes.\nSchema: Use existing `code_review_changes` from references/handoff-schemas.md.\nNote: In teammate mode, Senior sends directly to Dev's teammate ID instead of spawning a new Task.\n\n### Architect -> Lead (Design)\n\nWhen: After completing architecture design.\nSchema: Use existing `architecture_design` from references/handoff-schemas.md.\n\n## Cross-Team Communication (Lead-to-Lead)\n\nPatterns for communication BETWEEN department teams. Only Leads communicate cross-team.\n\n### Lead -> Lead (API Contract)\n\nWhen: Frontend needs to negotiate API contract with Backend.\nSchema: Use existing `api_contract` from references/handoff-schemas.md.\nNote: In teammate mode, cross-team communication still uses file-based handoff artifacts (api-contracts.jsonl, design-handoff.jsonl) because Leads are in DIFFERENT teams. SendMessage only works within a team. Cross-team coordination remains file-based even in teammate mode.\n\n### Lead -> Owner (Department Result)\n\nWhen: Department completes its 10-step workflow.\nSchema: Use existing `department_result` from references/handoff-schemas.md.\nNote: Owner is in the shared department, not in any team. Communication uses file-based handoff (.dept-status-{dept}.json) regardless of team_mode.\n\n## Task Mode Fallback\n\nWhen team_mode=task (default), all patterns above are replaced by:\n- spawnTeam -> Task tool with agent file reference\n- SendMessage -> Task tool result return + file-based artifacts\n- shutdown -> Task tool session ends naturally\n- cleanup -> No additional cleanup needed (Task tool handles)\n\nThe escalation chains, schemas, and artifact formats remain identical between modes. Only the transport mechanism changes.\n\nEnd of file.","ts":""}
{"id":"T2","tp":"auto","a":"Add conditional Teammate API section to agents/yolo-lead.md: team lifecycle (create team via spawnTeam, register teammates, shutdown, cleanup). Guarded by: When team_mode=teammate. Include reference to teammate-api-patterns.md. Do NOT change existing Task tool instructions.","f":["agents/yolo-lead.md"],"v":"grep finds spawnTeam in yolo-lead.md; existing Task tool section unchanged","done":"Lead agent has team lifecycle instructions conditional on team_mode=teammate","spec":"Modify EXISTING file: agents/yolo-lead.md\n\nAdd a NEW section between the existing '## Constraints & Effort' section (line 83-85) and '## Context' section (line 87-93). Insert the new section at line 86 (the blank line between Constraints and Context).\n\nExact markdown block to add:\n\n---\n\n## Teammate API (when team_mode=teammate)\n\n> This section is active ONLY when team_mode=teammate. When team_mode=task (default), ignore this section entirely and use Task tool for all agent spawning.\n\nFull patterns: @references/teammate-api-patterns.md\n\n### Team Lifecycle\n\n1. **Create team:** Call spawnTeam with name `yolo-{dept}` (e.g., yolo-backend) and description `{Dept} engineering team for phase {N}: {phase-name}`.\n2. **Register teammates:** Register in order: architect (if Step 2), senior (Step 4/7), dev (Step 6). Each teammate receives only their scoped context (see Context Scoping Protocol in execute-protocol.md).\n3. **Coordinate via SendMessage:** Replace Task tool spawn+wait with SendMessage to registered teammates. Receive results via SendMessage responses. Schemas: see references/handoff-schemas.md.\n4. **Shutdown:** When phase completes (Step 10) or on error, send `shutdown_request` to all teammates. Wait for `shutdown_response` from each (30s timeout). Verify all artifacts committed.\n5. **Cleanup:** After shutdown responses received, verify git status clean for team files. Log any incomplete work in deviations.\n\n### Unchanged Behavior\n\n- Escalation chain: Dev -> Senior -> Lead -> Architect (unchanged)\n- Artifact formats: All JSONL schemas remain identical\n- Context isolation: Each teammate receives only their scoped context\n- Commit protocol: One commit per task, one commit per artifact (unchanged)\n\n---\n\nDo NOT modify any existing section. The existing Planning Protocol, Escalation Table, Output Format, Decision Logging, Constraints & Effort, and Context sections remain exactly as they are. The new section is purely additive.\n\nVerification after implementation:\n1. `grep -q 'team_mode=teammate' agents/yolo-lead.md` must return 0\n2. `grep -q 'spawnTeam' agents/yolo-lead.md` must return 0\n3. `grep -q 'shutdown_request' agents/yolo-lead.md` must return 0\n4. Existing text at line 31 ('NEVER write the spec field') must still be present unchanged\n5. Existing Escalation Table must still be present unchanged","ts":""}
{"id":"T3","tp":"auto","a":"Add conditional Teammate API section to agents/yolo-dev.md: SendMessage for progress reporting (dev_progress schema) and escalation (dev_blocker schema) to Senior. Guarded by: When team_mode=teammate. Do NOT change existing escalation table.","f":["agents/yolo-dev.md"],"v":"grep finds team_mode=teammate in yolo-dev.md; existing escalation section unchanged","done":"Dev agent has SendMessage instructions conditional on team_mode=teammate","spec":"Modify EXISTING file: agents/yolo-dev.md\n\nAdd a NEW section between the existing '## Communication' section (lines 77-79) and '## Constraints & Effort' section (lines 81-83). Insert after line 79 (end of current Communication section, before the blank line at line 80).\n\nExact markdown block to add:\n\n---\n\n## Teammate API (when team_mode=teammate)\n\n> This section is active ONLY when team_mode=teammate. When team_mode=task (default), ignore this section entirely. Use Task tool result returns and file-based artifacts instead.\n\nFull patterns: @references/teammate-api-patterns.md\n\n### Communication via SendMessage\n\nReplace Task tool result returns with direct SendMessage to Senior's teammate ID:\n\n**Progress reporting (per task):** Send `dev_progress` schema to Senior after each task commit:\n```json\n{\n  \"type\": \"dev_progress\",\n  \"task\": \"{plan_id}/T{N}\",\n  \"plan_id\": \"{plan_id}\",\n  \"commit\": \"{hash}\",\n  \"status\": \"complete\",\n  \"concerns\": []\n}\n```\n\n**Blocker escalation:** Send `dev_blocker` schema to Senior when blocked:\n```json\n{\n  \"type\": \"dev_blocker\",\n  \"task\": \"{plan_id}/T{N}\",\n  \"plan_id\": \"{plan_id}\",\n  \"blocker\": \"{description}\",\n  \"needs\": \"{what is needed}\",\n  \"attempted\": [\"{what was tried}\"]\n}\n```\n\n**Receive instructions:** Listen for `code_review_changes` from Senior with exact fix instructions. Follow precisely (unchanged from task mode behavior).\n\n### Unchanged Behavior\n\n- Escalation target: Senior ONLY (never Lead or Architect)\n- One commit per task, stage files individually\n- TDD RED/GREEN protocol unchanged\n- Summary.jsonl production unchanged\n\n---\n\nDo NOT modify any existing section. The existing Execution Protocol, Escalation Table, Communication, Constraints & Effort, and Context sections remain exactly as they are. The new section is purely additive.\n\nVerification after implementation:\n1. `grep -q 'team_mode=teammate' agents/yolo-dev.md` must return 0\n2. `grep -q 'SendMessage' agents/yolo-dev.md` must return 0 (note: already present at line 69/79, but the NEW grep target is the team_mode guard)\n3. `grep -c 'team_mode' agents/yolo-dev.md` must return at least 1 (from the new section only)\n4. Existing Escalation Table (lines 65-72) must still be present unchanged\n5. Existing Communication section (lines 77-79) must still be present unchanged\n6. Line 79 text 'As teammate: SendMessage to Senior' must remain as-is","ts":""}
{"id":"T4","tp":"auto","a":"Add conditional Teammate API section to agents/yolo-senior.md and agents/yolo-architect.md: SendMessage for receiving escalations and sending review results. Guarded by team_mode condition. Do NOT change existing behavior.","f":["agents/yolo-senior.md","agents/yolo-architect.md"],"v":"grep finds team_mode=teammate in both agent files","done":"Senior and Architect agents have SendMessage instructions conditional on team_mode=teammate","spec":"Modify TWO EXISTING files. Handle each separately.\n\n--- FILE 1: agents/yolo-senior.md ---\n\nAdd a NEW section between '## Constraints & Effort' (lines 79-81) and '## Context' (lines 83-89). Insert at the blank line between them (line 82).\n\nExact markdown block to add:\n\n---\n\n## Teammate API (when team_mode=teammate)\n\n> This section is active ONLY when team_mode=teammate. When team_mode=task (default), ignore this section entirely.\n\nFull patterns: @references/teammate-api-patterns.md\n\n### Communication via SendMessage\n\n**Receive from Dev:** Listen for `dev_progress` (task completion) and `dev_blocker` (escalation) messages from Dev teammates. Respond to blockers with clarification or `code_review_changes` instructions.\n\n**Send to Lead (Design Review):** After enriching plan specs, send `senior_spec` schema to Lead:\n```json\n{\n  \"type\": \"senior_spec\",\n  \"plan_id\": \"{plan_id}\",\n  \"tasks_enriched\": 3,\n  \"concerns\": [],\n  \"committed\": true\n}\n```\n\n**Send to Lead (Code Review):** After reviewing code, send `code_review_result` schema to Lead:\n```json\n{\n  \"type\": \"code_review_result\",\n  \"plan_id\": \"{plan_id}\",\n  \"result\": \"approve\",\n  \"cycle\": 1,\n  \"findings_count\": 0,\n  \"critical\": 0,\n  \"artifact\": \"phases/{phase}/code-review.jsonl\",\n  \"committed\": true\n}\n```\n\n**Send to Dev (Changes Requested):** When code review requests changes, send `code_review_changes` directly to Dev's teammate ID instead of spawning a new Task.\n\n### Unchanged Behavior\n\n- Escalation target: Lead (unchanged)\n- Design review and code review protocols unchanged\n- Artifact formats (enriched plan.jsonl, code-review.jsonl) unchanged\n- Decision logging unchanged\n\n---\n\nVerification for yolo-senior.md:\n1. `grep -q 'team_mode=teammate' agents/yolo-senior.md` must return 0\n2. `grep -q 'SendMessage' agents/yolo-senior.md` must return 0\n3. `grep -q 'senior_spec' agents/yolo-senior.md` must return 0\n4. Existing Escalation Table (lines 60-67) must still be present unchanged\n5. Existing Decision Logging section (lines 71-77) must still be present unchanged\n\n--- FILE 2: agents/yolo-architect.md ---\n\nAdd a NEW section between '## Constraints & Effort' (lines 67-69) and '## Context' (lines 71-77). Insert at the blank line between them (line 70).\n\nExact markdown block to add:\n\n---\n\n## Teammate API (when team_mode=teammate)\n\n> This section is active ONLY when team_mode=teammate. When team_mode=task (default), ignore this section entirely.\n\nFull patterns: @references/teammate-api-patterns.md\n\n### Communication via SendMessage\n\n**Send to Lead (Architecture):** After completing architecture design, send `architecture_design` schema to Lead:\n```json\n{\n  \"type\": \"architecture_design\",\n  \"phase\": \"{N}\",\n  \"artifact\": \"phases/{phase}/architecture.toon\",\n  \"decisions\": [{\"decision\": \"...\", \"rationale\": \"...\", \"alternatives\": []}],\n  \"risks\": [{\"risk\": \"...\", \"impact\": \"high\", \"mitigation\": \"...\"}],\n  \"committed\": true\n}\n```\n\n**Receive from Lead:** Listen for escalation messages from Lead when Senior or Dev encounter design-level issues. Respond with architecture decisions via SendMessage.\n\n### Unchanged Behavior\n\n- Escalation target: User via Lead orchestration (unchanged)\n- Architecture.toon format unchanged\n- Decision logging unchanged\n- Read-only constraints unchanged (no Edit tool, no Bash)\n\n---\n\nVerification for yolo-architect.md:\n1. `grep -q 'team_mode=teammate' agents/yolo-architect.md` must return 0\n2. `grep -q 'SendMessage' agents/yolo-architect.md` must return 0\n3. `grep -q 'architecture_design' agents/yolo-architect.md` must return 0\n4. Existing Escalation Table (lines 59-65) must still be present unchanged\n5. Existing Constraints section (lines 67-69) must still be present unchanged","ts":""}
