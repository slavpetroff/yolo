{"p":"01","n":"03","t":"Spawn routing integration in execute-protocol and go.md","w":2,"d":["01-01","01-02"],"mh":{"tr":["go.md calls resolve-team-mode.sh and passes result to execute-protocol","execute-protocol.md spawn steps check team_mode before choosing Task tool or Teammate API","Fallback notice displayed when teammate mode falls back to task","When team_mode=task all spawn behavior identical to current behavior"],"ar":[{"p":"commands/go.md","pv":"calls resolve-team-mode.sh in Context section","c":"grep -q resolve-team-mode commands/go.md"},{"p":"references/execute-protocol.md","pv":"Step 6 Implementation references team_mode for spawn strategy","c":"grep -q team_mode references/execute-protocol.md"}],"kl":[{"fr":"scripts/resolve-team-mode.sh","to":"commands/go.md","vi":"go.md calls resolve-team-mode.sh alongside resolve-departments.sh"},{"fr":"commands/go.md","to":"references/execute-protocol.md","vi":"go.md passes team_mode to execute protocol for spawn decisions"}]},"obj":"Wire team_mode resolution into go.md context gathering and execute-protocol.md agent spawning so the routing abstraction is complete end-to-end, even though teammate mode is not yet functional","fm":["commands/go.md","references/execute-protocol.md","references/cross-team-protocol.md"]}
{"id":"T1","tp":"auto","a":"Add resolve-team-mode.sh call to go.md Context section, alongside existing resolve-departments.sh. Parse team_mode and fallback_notice from output. Add team_mode to key variables list.","f":["commands/go.md"],"v":"go.md Context section calls resolve-team-mode.sh and documents team_mode variable","done":"go.md gathers team_mode on every invocation","spec":"FILE: commands/go.md (MODIFY). Two insertion points in the Context section.\n\nINSERTION 1 -- Team mode resolution block. Insert AFTER the Department routing block (after line 40, which is the closing ``` of the resolve-departments.sh code block) and BEFORE the 'Key variables' line (current line 42). Add a blank line, then the new block:\n\nTeam mode (via resolve-team-mode.sh):\n\n```\n!`bash ${CLAUDE_PLUGIN_ROOT}/scripts/resolve-team-mode.sh .yolo-planning/config.json 2>/dev/null || echo \"team_mode=task\"`\n```\n\nThis follows the EXACT same pattern as the resolve-departments.sh block above it (lines 36-40): descriptive label, blank line, fenced code block with !` shell execution, 2>/dev/null error suppression, || echo fallback. The fallback echoes team_mode=task (safe default, matches resolve-team-mode.sh behavior when config is missing).\n\nINSERTION 2 -- Key variables documentation. In the 'Key variables from above' bullet list (currently lines 42-49), add two new bullets AFTER the last existing bullet (line 49: `fe_active` / `ux_active`). The new bullets are:\n\n- `team_mode`: task = spawn agents via Task tool (default), teammate = spawn agents via Teammate API (experimental)\n- `fallback_notice`: true if team_mode was downgraded from teammate to task (display notice to user)\n\nThese follow the exact same format as existing bullets: backtick-wrapped variable name, colon, description with possible values.\n\nFINAL STATE after modifications: The Context section (lines 20-49+) will have this order:\n1. Working directory (line 22-23)\n2. Pre-computed state / phase-detect.sh (lines 24-28)\n3. Config (lines 30-34)\n4. Department routing / resolve-departments.sh (lines 36-40)\n5. Team mode / resolve-team-mode.sh (NEW, ~lines 42-46)\n6. Key variables (shifted to ~line 48+) with 8 bullets total (6 existing + 2 new)\n\nVERIFICATION:\n- grep -q 'resolve-team-mode.sh' commands/go.md -> exits 0\n- grep -q 'team_mode' commands/go.md -> exits 0 (in key variables)\n- grep -q 'fallback_notice' commands/go.md -> exits 0 (in key variables)\n- The resolve-departments.sh block (lines 36-40) must remain UNCHANGED\n- The Phase-detect block (lines 24-28) must remain UNCHANGED\n\nCRITICAL: Do NOT modify any other section of go.md. Only the Context section (between '## Context' and '## Input Parsing') is touched.","ts":""}
{"id":"T2","tp":"auto","a":"Update go.md Plan Mode (step 5/6) and Execute Mode to pass team_mode to spawned agents. When team_mode=teammate, include Teammate API context in agent spawn instructions. When team_mode=task, no change to current behavior. Display fallback notice if fallback_notice=true.","f":["commands/go.md"],"v":"go.md Plan and Execute modes reference team_mode; fallback notice shown when applicable","done":"go.md routes team_mode to all agent spawn paths","spec":"FILE: commands/go.md (MODIFY). Three modification zones inside go.md. All changes are ADDITIVE -- no existing text is removed or reworded.\n\n--- ZONE 1: Plan Mode Step 5 (single-department, current line 231-236) ---\n\nAfter the existing step 5 content (line 236: 'Display Spawning Lead agent... -> Lead agent complete'), add a new sub-bullet indented at the same level as the existing sub-bullets:\n\n   - **Team mode context:** If `team_mode=teammate`, include in the Lead spawn prompt: 'team_mode=teammate. Use Teammate API (spawnTeam) to create your department team instead of spawning agents via Task tool. See @references/teammate-api-patterns.md for lifecycle patterns.' If `team_mode=task`, do not add any team mode context (current behavior preserved).\n\nThis goes AFTER the Display line (line 236) and BEFORE the blank line preceding step 6.\n\n--- ZONE 2: Plan Mode Step 6d (multi-department lead spawning, current line 252-264) ---\n\nAfter the existing step 6d content (line 264: 'Display per lead: Spawning {Dept} Lead ({model})... -> {Dept} Lead complete'), add a new sub-paragraph at the same indentation level:\n\n      **Team mode routing:** When `team_mode=teammate`, replace Task tool calls with Teammate API team creation. Each department Lead is spawned as a Teammate API team lead via spawnTeam (team name: `yolo-{dept}`, description: `{Dept} engineering team for phase {N}: {phase-name}`). The Lead then registers its specialists (architect, senior, dev) as teammates within the team. When `team_mode=task`, spawn Leads via Task tool as currently documented (no change). Include `team_mode={value}` in every Lead's spawn context so the Lead knows which mode to operate in.\n\nThis goes AFTER line 264 and BEFORE the blank line preceding step 6e (line 265-266).\n\n--- ZONE 3: Execute Mode routing section (current lines 299-311) ---\n\nAfter the Execute Mode routing intro line (line 299: 'Routing (based on multi_dept from resolve-departments.sh above):'), add a new paragraph BEFORE the single-department bullet (line 301):\n\n**Team mode:** `team_mode` from resolve-team-mode.sh determines agent spawn mechanism. Pass `team_mode` value to execute-protocol.md. When `team_mode=teammate`, top-level agent spawning (go.md -> department Leads) uses Teammate API instead of Task tool. Within-team spawning (Lead -> Senior, Lead -> Dev) is handled by agent prompt conditionals per references/teammate-api-patterns.md. When `team_mode=task`, all spawn behavior is unchanged (Task tool throughout).\n\nThen, within the multi-department bullet (current line 304-311), after the last sentence of that block (line 311: 'Compile context per dept via compile-context.sh.'), add:\n\n  When `team_mode=teammate`: department Leads are created as Teammate API team leads (replacing background Task subagents). Each Lead creates a team via spawnTeam, registers teammates, and coordinates via SendMessage instead of file-based sentinel polling. Gate satisfaction shifts from file polling (dept-gate.sh) to SendMessage-based status reporting. When `team_mode=task`: all multi-department coordination uses file-based gates and Task tool as currently documented.\n\n--- ZONE 4: Fallback notice display (NEW -- after Plan Mode step 1, current line 227) ---\n\nAfter step 1 'Parse args' (line 227) and BEFORE step 2 'Phase Discovery' (line 228), insert a new step 1.5:\n\n1.5. **Fallback notice:** If `fallback_notice=true` from resolve-team-mode.sh, display: `[notice] Teammate API requested but unavailable (CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS not set). Using Task tool spawn instead.` This is informational only -- execution proceeds with team_mode=task.\n\nALSO add the same fallback notice check in Execute Mode, after step 3 (line 297) and before the Routing section (line 299):\n\n4. **Fallback notice:** If `fallback_notice=true` from resolve-team-mode.sh, display: `[notice] Teammate API requested but unavailable. Using Task tool spawn instead.` Informational only.\n\n(This shifts the existing Routing section numbering, but the Routing section uses a bold header not a number, so no conflict.)\n\nVERIFICATION:\n- grep -q 'team_mode=teammate' commands/go.md -> exits 0 (in Plan step 5, step 6d, Execute routing)\n- grep -q 'spawnTeam' commands/go.md -> exits 0 (in step 6d team mode routing)\n- grep -q 'fallback_notice=true' commands/go.md -> exits 0 (in fallback notice steps)\n- grep -q 'teammate-api-patterns.md' commands/go.md -> exits 0 (in step 5 and Execute routing)\n- Existing Plan Mode steps 2-8 text must remain UNCHANGED (only additions between/after existing lines)\n- Existing Execute Mode guards (steps 1-3) must remain UNCHANGED\n\nCRITICAL: The existing Task tool spawn instructions in steps 5 and 6d MUST remain as-is. The team_mode=teammate instructions are ADDITIONS, not replacements. Both code paths must be documented side by side.","ts":""}
{"id":"T3","tp":"auto","a":"Update references/execute-protocol.md Step 6 (Implementation) and Multi-Department Execution section to document team_mode-conditional spawn strategy: when team_mode=teammate, use Teammate API patterns from teammate-api-patterns.md; when team_mode=task, use existing Task tool pattern unchanged.","f":["references/execute-protocol.md"],"v":"execute-protocol.md Step 6 and Multi-Dept section reference team_mode conditional","done":"Execute protocol documents both spawn paths with clear team_mode conditional","spec":"FILE: references/execute-protocol.md (MODIFY). Three modification zones. All changes ADDITIVE.\n\n--- ZONE 1: Introduction paragraph (after line 5) ---\n\nAfter the existing intro line (line 5: 'Implements the 10-step company-grade engineering workflow...'), add a new paragraph:\n\n**Spawn strategy:** Agent spawning is controlled by `team_mode` from resolve-team-mode.sh (passed by go.md). When `team_mode=task` (default): all agents are spawned via Task tool as documented below. When `team_mode=teammate`: top-level agent spawning from go.md uses Teammate API (spawnTeam for department Leads); within-team spawning (Steps 1-9) is handled by agent prompt conditionals using SendMessage. See `references/teammate-api-patterns.md` for Teammate API patterns.\n\nThis goes on line 6 (currently blank), becoming a new paragraph between the intro and the Owner-First Communication Rule section (line 7).\n\n--- ZONE 2: Context Scoping Protocol note (after line 39) ---\n\nAfter the existing intro sentence of Context Scoping Protocol (line 39: 'Each agent receives ONLY what it needs... When spawning via Task tool, include ONLY listed inputs. No extra context for reference.'), append to the same paragraph:\n\n When `team_mode=teammate`, the same scoping rules apply -- agents receive identical context regardless of spawn mechanism. The transport changes (SendMessage vs Task tool), but the content isolation does not.\n\nThis is appended to the END of line 39, same paragraph. No new line needed.\n\n--- ZONE 3: Multi-Department Execution section, item 3 (current lines 529-540) ---\n\nThe current item 3 (line 529-540) documents spawning department Leads as 'background Task subagents'. Add a team_mode conditional AFTER line 540 (closing of the current code block) and BEFORE item 4 (line 542):\n\n   **Team mode conditional (spawn strategy):**\n   - **When `team_mode=task` (default):** Spawn department Leads as background Task subagents exactly as documented above. File-based coordination via dept-gate.sh, dept-status.sh, and handoff sentinels.\n   - **When `team_mode=teammate`:** Replace Task subagent spawning with Teammate API team creation:\n     ```\n     For each dept in wave.depts:\n       Create team via spawnTeam:\n         - name: \"yolo-{dept}\" (e.g., yolo-backend, yolo-frontend, yolo-uiux)\n         - description: \"{Dept} engineering team for phase {N}: {phase-name}\"\n       Register Lead as team lead (automatic with spawnTeam)\n       Lead registers specialists (architect, senior, dev) as teammates\n       Lead coordinates via SendMessage instead of file-based artifacts\n       On completion: Lead sends department_result via SendMessage to go.md\n     ```\n     Cross-team coordination between departments still uses file-based handoff artifacts (api-contracts.jsonl, design-handoff.jsonl) because Leads are in DIFFERENT teams. SendMessage only works within a team. See `references/teammate-api-patterns.md` ## Cross-Team Communication.\n\nThis text goes between lines 540 and 542 (before item 4 'Poll for gate satisfaction').\n\n--- ZONE 4: Polling section team_mode note (after line 560) ---\n\nAfter the polling loop documentation (line 560: 'Interval: 500ms...'), add:\n\n   **Teammate mode note:** When `team_mode=teammate`, gate satisfaction shifts from file polling to SendMessage-based status reporting. Department Leads send completion signals via SendMessage to go.md instead of writing sentinel files. The polling loop above applies only to `team_mode=task`. In teammate mode, go.md receives department completion asynchronously via teammate message delivery.\n\nVERIFICATION:\n- grep -q 'team_mode' references/execute-protocol.md -> exits 0\n- grep -q 'teammate-api-patterns.md' references/execute-protocol.md -> exits 0\n- grep -q 'spawnTeam' references/execute-protocol.md -> exits 0 (in multi-dept team creation)\n- The existing Task tool spawn documentation (lines 529-540) must remain UNCHANGED\n- The existing polling loop code block (lines 544-559) must remain UNCHANGED\n- All 10 step headers (Step 1-10) must remain UNCHANGED\n- The Execution State Transitions table (lines 471-486) must remain UNCHANGED\n\nCRITICAL: This is ADDITIVE documentation only. No existing text is modified or removed. The team_mode=task path IS the current documentation. The team_mode=teammate path is added alongside it.","ts":""}
{"id":"T4","tp":"auto","a":"Update references/cross-team-protocol.md to document that when team_mode=teammate, inter-department communication uses SendMessage between team Leads instead of file-based sentinel polling. Keep file-based protocol as team_mode=task path. Add conditional sections.","f":["references/cross-team-protocol.md"],"v":"cross-team-protocol.md documents SendMessage alternative for teammate mode","done":"Cross-team protocol covers both communication modes","spec":"FILE: references/cross-team-protocol.md (MODIFY). Four modification zones. All changes ADDITIVE.\n\n--- ZONE 1: Introduction paragraph (after line 3) ---\n\nAfter the existing intro (line 3: 'Cross-department workflow, communication rules, handoff gates, and conflict resolution. Read by all Leads and Owner.'), add a new paragraph:\n\n**Spawn mode awareness:** This protocol has two transport modes controlled by `team_mode` from resolve-team-mode.sh. When `team_mode=task` (default): all cross-department coordination uses file-based artifacts and sentinel polling as documented below. When `team_mode=teammate`: intra-department communication shifts to SendMessage (within a team), but cross-department communication REMAINS file-based because Leads are in separate Teammate API teams. SendMessage does not cross team boundaries.\n\nThis becomes a new paragraph on line 4 (currently blank line), before the Department Execution Order heading (line 5).\n\n--- ZONE 2: Communication Rules section (after line 69, end of rule 4) ---\n\nAfter rule 4 (line 70: 'Owner communicates only with Leads. Strategic decisions, not technical details.'), add a new subsection:\n\n### Team Mode Transport Differences\n\n| Communication Path | team_mode=task | team_mode=teammate |\n|---|---|---|\n| Within department (Dev->Senior, Senior->Lead) | Task tool result return | SendMessage within team |\n| Cross department (Lead->Lead) | File-based artifacts (api-contracts.jsonl, design-handoff.jsonl) | File-based artifacts (UNCHANGED -- different teams) |\n| Lead->Owner | File-based (.dept-status-{dept}.json) | File-based (UNCHANGED -- Owner is not in any department team) |\n| Owner->User | go.md proxy (AskUserQuestion) | go.md proxy (UNCHANGED) |\n\n**Key insight:** Cross-team communication is ALWAYS file-based regardless of team_mode. The Teammate API SendMessage only works within a single team. Since each department is its own team, inter-department coordination cannot use SendMessage. This is by design -- it enforces the same strict context isolation that file-based gates provide.\n\nThis goes after line 70 and before the Context Isolation Rules heading (line 72).\n\n--- ZONE 3: Handoff Gates section, Gate 1 (after line 105) ---\n\nAfter the Gate 1 timeout documentation (line 105: 'Timeout: 30 minutes (configurable)...'), add:\n\n**Teammate mode:** When `team_mode=teammate`, the UX Lead signals completion via file-based handoff artifacts (same as task mode). The handoff sentinel (.handoff-ux-complete) and artifact validation (design-handoff.jsonl, design-tokens.jsonl, component-specs.jsonl) are identical. The only difference is that WITHIN the UX department, agents communicated via SendMessage instead of Task tool. The handoff gate itself is transport-agnostic.\n\n--- ZONE 4: Handoff Gates section, Gate 3 (after line 140) ---\n\nAfter the Gate 3 timeout documentation (line 140: 'Timeout: 60 minutes (configurable)...'), add:\n\n**Teammate mode:** When `team_mode=teammate`, each department Lead signals completion by writing .dept-status-{dept}.json (same as task mode). The integration gate check via dept-gate.sh is identical. Within each department, agents used SendMessage for coordination, but the cross-department gate is file-based. dept-gate.sh does not need modification for teammate mode.\n\nVERIFICATION:\n- grep -q 'team_mode' references/cross-team-protocol.md -> exits 0\n- grep -q 'SendMessage' references/cross-team-protocol.md -> exits 0 (appears in new transport table and notes)\n- grep -q 'teammate' references/cross-team-protocol.md -> exits 0\n- The existing Communication Rules (rules 1-4, lines 67-70) must remain UNCHANGED\n- The existing Handoff Gate validation code blocks must remain UNCHANGED\n- The existing Department Execution Order diagram (lines 7-46) must remain UNCHANGED\n- The existing Conflict Resolution section must remain UNCHANGED\n\nCRITICAL: Cross-team communication remains file-based in BOTH modes. This is the key design decision. The spec must NOT document SendMessage as a cross-team transport -- it only works within a team. The additions clarify this explicitly to prevent confusion.","ts":""}
