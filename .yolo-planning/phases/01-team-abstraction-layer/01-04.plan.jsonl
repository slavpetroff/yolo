{"p":"01","n":"04","t":"Testing: resolve-team-mode, config migration, and regression","w":2,"d":["01-01"],"mh":{"tr":["All 872+ existing tests pass unchanged with team_mode=task","resolve-team-mode.sh has unit tests covering: missing config, task mode, teammate mode, fallback notice","session-start.sh config migration tested for team_mode addition","No test depends on Teammate API availability"],"ar":[{"p":"tests/unit/resolve-team-mode.bats","pv":"test file exists with 10+ test cases","c":"bats tests/unit/resolve-team-mode.bats passes"},{"p":"tests/run-all.sh","pv":"full suite passes","c":"bash tests/run-all.sh exits 0"}],"kl":[{"fr":"tests/unit/resolve-team-mode.bats","to":"scripts/resolve-team-mode.sh","vi":"test file validates all resolve-team-mode.sh behaviors"},{"fr":"tests/unit/session-start.bats","to":"scripts/session-start.sh","vi":"existing session-start tests still pass after migration addition"}]},"obj":"Ensure all existing tests pass and add comprehensive tests for the new resolve-team-mode.sh script and config migration, validating the zero-regression guarantee for team_mode=task","fm":["tests/unit/resolve-team-mode.bats","tests/run-all.sh"],"sk":["commit"]}
{"id":"T1","tp":"auto","a":"Create tests/unit/resolve-team-mode.bats with test cases covering all resolve-team-mode.sh scenarios: no config, task mode, teammate mode with/without env var, agent_teams validation, fallback notice, output format.","f":["tests/unit/resolve-team-mode.bats"],"v":"bats tests/unit/resolve-team-mode.bats passes all 10 cases","done":"Test file has 10+ passing test cases covering all resolve-team-mode.sh scenarios","spec":"FILE: tests/unit/resolve-team-mode.bats (CREATE). Create a new BATS test file following the exact pattern from tests/unit/resolve-agent-model.bats and tests/unit/phase-detect.bats. COMPLETE FILE CONTENT BELOW:\n\n```bash\n#!/usr/bin/env bats\n# resolve-team-mode.bats â€” Unit tests for scripts/resolve-team-mode.sh\n# Team mode resolution: config reading, fallback logic, env var validation.\n# Usage: resolve-team-mode.sh [config_path]\n# Returns key=value pairs: team_mode=task|teammate, fallback_notice=true|false\n\nsetup() {\n  load '../test_helper/common'\n  load '../test_helper/fixtures'\n  load '../test_helper/mock_stdin'\n  mk_test_workdir\n  SUT=\"$SCRIPTS_DIR/resolve-team-mode.sh\"\n}\n\n# Helper: extract a key from output (same pattern as phase-detect.bats)\nget_val() {\n  local key=\"$1\"\n  echo \"$output\" | grep \"^${key}=\" | head -1 | sed \"s/^${key}=//\"\n}\n\n# --- 1. No config file ---\n\n@test \"no config file outputs team_mode=task\" {\n  run bash \"$SUT\" \"$TEST_WORKDIR/nonexistent.json\"\n  assert_success\n  assert_line 'team_mode=task'\n  assert_line 'fallback_notice=false'\n}\n\n# --- 2. Config with team_mode=task ---\n\n@test \"config with team_mode=task outputs task\" {\n  echo '{\"team_mode\":\"task\",\"agent_teams\":true}' > \"$TEST_WORKDIR/cfg.json\"\n  run bash \"$SUT\" \"$TEST_WORKDIR/cfg.json\"\n  assert_success\n  assert_line 'team_mode=task'\n  assert_line 'fallback_notice=false'\n}\n\n# --- 3. Config with team_mode=teammate and env var set ---\n\n@test \"teammate mode with env var set outputs teammate\" {\n  export CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS=1\n  echo '{\"team_mode\":\"teammate\",\"agent_teams\":true}' > \"$TEST_WORKDIR/cfg.json\"\n  run bash \"$SUT\" \"$TEST_WORKDIR/cfg.json\"\n  assert_success\n  assert_line 'team_mode=teammate'\n  assert_line 'fallback_notice=false'\n}\n\n# --- 4. Config missing team_mode field defaults to task ---\n\n@test \"config missing team_mode field defaults to task\" {\n  echo '{\"agent_teams\":true}' > \"$TEST_WORKDIR/cfg.json\"\n  run bash \"$SUT\" \"$TEST_WORKDIR/cfg.json\"\n  assert_success\n  assert_line 'team_mode=task'\n  assert_line 'fallback_notice=false'\n}\n\n# --- 5. Teammate mode with agent_teams=false downgrades ---\n\n@test \"teammate mode with agent_teams=false downgrades to task\" {\n  export CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS=1\n  echo '{\"team_mode\":\"teammate\",\"agent_teams\":false}' > \"$TEST_WORKDIR/cfg.json\"\n  run bash \"$SUT\" \"$TEST_WORKDIR/cfg.json\"\n  assert_success\n  assert_line 'team_mode=task'\n  assert_line 'fallback_notice=true'\n}\n\n# --- 6. Teammate mode without env var downgrades ---\n\n@test \"teammate mode without env var downgrades to task\" {\n  unset CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS 2>/dev/null || true\n  echo '{\"team_mode\":\"teammate\",\"agent_teams\":true}' > \"$TEST_WORKDIR/cfg.json\"\n  run bash \"$SUT\" \"$TEST_WORKDIR/cfg.json\"\n  assert_success\n  assert_line 'team_mode=task'\n  assert_line 'fallback_notice=true'\n}\n\n# --- 7. Teammate with agent_teams=false AND no env var downgrades ---\n\n@test \"teammate with agent_teams=false and no env var downgrades to task\" {\n  unset CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS 2>/dev/null || true\n  echo '{\"team_mode\":\"teammate\",\"agent_teams\":false}' > \"$TEST_WORKDIR/cfg.json\"\n  run bash \"$SUT\" \"$TEST_WORKDIR/cfg.json\"\n  assert_success\n  assert_line 'team_mode=task'\n  assert_line 'fallback_notice=true'\n}\n\n# --- 8. Task mode unaffected by missing env var ---\n\n@test \"task mode is never downgraded regardless of env var\" {\n  unset CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS 2>/dev/null || true\n  echo '{\"team_mode\":\"task\",\"agent_teams\":true}' > \"$TEST_WORKDIR/cfg.json\"\n  run bash \"$SUT\" \"$TEST_WORKDIR/cfg.json\"\n  assert_success\n  assert_line 'team_mode=task'\n  assert_line 'fallback_notice=false'\n}\n\n# --- 9. Output format: exactly 2 lines ---\n\n@test \"outputs exactly 2 lines\" {\n  run bash \"$SUT\" \"$TEST_WORKDIR/nonexistent.json\"\n  assert_success\n  local line_count\n  line_count=$(echo \"$output\" | wc -l | tr -d ' ')\n  [ \"$line_count\" -eq 2 ]\n}\n\n# --- 10. Default config path when no argument ---\n\n@test \"default config path resolves .yolo-planning/config.json\" {\n  mkdir -p \"$TEST_WORKDIR/.yolo-planning\"\n  echo '{\"team_mode\":\"task\",\"agent_teams\":true}' > \"$TEST_WORKDIR/.yolo-planning/config.json\"\n  run bash -c \"cd '$TEST_WORKDIR' && bash '$SUT'\"\n  assert_success\n  assert_line 'team_mode=task'\n  assert_line 'fallback_notice=false'\n}\n```\n\nIMPLEMENTATION NOTES:\n- File path: tests/unit/resolve-team-mode.bats\n- Load chain: common.bash -> bats-support + bats-assert + bats-file, fixtures.bash -> mk_test_workdir, mock_stdin.bash (loaded for consistency even if not used)\n- SUT resolves via $SCRIPTS_DIR which is set in common.bash to PROJECT_ROOT/scripts\n- Each test creates inline JSON config in TEST_WORKDIR (no fixture files needed -- configs are trivial 1-line JSON, following resolve-agent-model.bats pattern for inline test configs on lines 77-88)\n- get_val() helper follows phase-detect.bats lines 34-37 exactly\n- Tests 5-7 verify fallback_notice=true (the downgrade scenarios from C3/C4/C9 critique resolutions)\n- Test 10 verifies default path using cd + no-arg invocation (same pattern as phase-detect.bats run_detect helper)\n- IMPORTANT: Test 3 exports CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS=1 which is required for teammate to NOT downgrade. Tests 6-8 explicitly unset it. BATS runs each test in a subshell so env var state does not leak between tests.\n- No fixture files need to be created -- all test configs are inline.\n- chmod +x is NOT needed for .bats files (bats runner handles execution).","ts":"FILE: tests/unit/resolve-team-mode.bats. FRAMEWORK: BATS (bats-core + bats-support + bats-assert + bats-file via test_helper/common.bash). 10 TEST CASES:\n\n(1) 'no config file outputs team_mode=task': INPUT: nonexistent config path. EXPECTED: exit 0, output contains 'team_mode=task' and 'fallback_notice=false'. VERIFIES: missing config fallback (architecture spec: no config -> task default).\n\n(2) 'config with team_mode=task outputs task': INPUT: config JSON with team_mode=task, agent_teams=true. EXPECTED: exit 0, team_mode=task, fallback_notice=false. VERIFIES: explicit task mode pass-through.\n\n(3) 'teammate mode with env var set outputs teammate': INPUT: config with team_mode=teammate, agent_teams=true, env var CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS=1 set. EXPECTED: exit 0, team_mode=teammate, fallback_notice=false. VERIFIES: happy path for teammate mode (all prerequisites met).\n\n(4) 'config missing team_mode field defaults to task': INPUT: config with agent_teams only (no team_mode key). EXPECTED: exit 0, team_mode=task. VERIFIES: jq fallback default (// \"task\") works for missing field.\n\n(5) 'teammate mode with agent_teams=false downgrades to task': INPUT: config with team_mode=teammate, agent_teams=false, env var set. EXPECTED: exit 0, team_mode=task, fallback_notice=true. VERIFIES: agent_teams prerequisite check (critique C2 resolution).\n\n(6) 'teammate mode without env var downgrades to task': INPUT: config with team_mode=teammate, agent_teams=true, env var unset. EXPECTED: exit 0, team_mode=task, fallback_notice=true. VERIFIES: env var prerequisite check (critique C3 resolution).\n\n(7) 'teammate with agent_teams=false and no env var downgrades': INPUT: config with team_mode=teammate, agent_teams=false, env var unset. EXPECTED: exit 0, team_mode=task, fallback_notice=true. VERIFIES: both prerequisites failing simultaneously still produces clean output.\n\n(8) 'task mode is never downgraded regardless of env var': INPUT: config with team_mode=task, agent_teams=true, env var unset. EXPECTED: exit 0, team_mode=task, fallback_notice=false. VERIFIES: downgrade logic only applies to teammate mode, not task mode.\n\n(9) 'outputs exactly 2 lines': INPUT: nonexistent config. EXPECTED: exit 0, output line count == 2. VERIFIES: output contract (exactly team_mode= and fallback_notice= lines, no extra output).\n\n(10) 'default config path resolves .yolo-planning/config.json': INPUT: .yolo-planning/config.json in TEST_WORKDIR, no argument to script. EXPECTED: exit 0, team_mode=task. VERIFIES: default CONFIG path variable works correctly."}
{"id":"T2","tp":"auto","a":"Add test case to tests/unit/session-start.bats for team_mode migration: config.json without team_mode gets team_mode=task added after session-start.sh runs. Follow existing model_profile migration test pattern (test 8).","f":["tests/unit/session-start.bats"],"v":"New test case passes in session-start.bats","done":"session-start.bats includes team_mode migration test","spec":"FILE: tests/unit/session-start.bats (MODIFY). Add ONE new test case after the existing test 8 ('auto-migrates config.json to add model_profile' on lines 126-136). Insert it BEFORE test 9 ('suggests /yolo:init when PROJECT.md is missing' on line 140). The new test follows the EXACT same pattern as test 8.\n\nINSERT AFTER line 136 (the closing '}' of test 8), BEFORE the blank line and '# --- 9.' comment:\n\n```bash\n# --- 8b. Auto-migrates config when team_mode missing ---\n\n@test \"auto-migrates config.json to add team_mode\" {\n  setup_stub_bin\n  mk_planning_dir\n  touch \"$CLAUDE_CONFIG_DIR/.yolo-welcomed\"\n  # Overwrite config with one that has model_profile but lacks team_mode\n  echo '{\"effort\":\"balanced\",\"autonomy\":\"standard\",\"model_profile\":\"balanced\"}' > \"$TEST_WORKDIR/.yolo-planning/config.json\"\n  run_session_start\n  assert_success\n  run jq -r '.team_mode' \"$TEST_WORKDIR/.yolo-planning/config.json\"\n  assert_output \"task\"\n}\n```\n\nIMPLEMENTATION NOTES:\n- Pattern is identical to test 8 (line 126-136): setup stubs, mk_planning_dir, overwrite config, run session_start, assert jq output.\n- Config intentionally includes model_profile (so model_profile migration is a no-op) but omits team_mode (so team_mode migration triggers).\n- The test verifies that after session-start.sh runs, jq -r '.team_mode' returns 'task'.\n- Uses run_session_start helper (defined at line 23-26) which cd's to TEST_WORKDIR and runs session-start.sh.\n- VERSION file is needed for the migration marker. mk_planning_dir creates .yolo-planning/ but not VERSION. The session-start.sh script reads VERSION from ../VERSION relative to its own SCRIPT_DIR, which resolves to the real PROJECT_ROOT/VERSION (not TEST_WORKDIR). This is fine because the real VERSION file exists at /Users/slavpetroff/Projects/yolo/VERSION.\n- The migration marker path includes the version number, so the test will not be affected by stale markers from other tests (each test gets fresh TEST_WORKDIR via mktemp).\n- Do NOT renumber existing tests. The new test is 8b (between 8 and 9), not a replacement.\n- Do NOT modify any existing test cases.","ts":"FILE: tests/unit/session-start.bats. FRAMEWORK: BATS. 1 NEW TEST CASE (added to existing file, total becomes 11 tests):\n\n(1) 'auto-migrates config.json to add team_mode': SETUP: setup_stub_bin + mk_planning_dir + touch welcomed marker + overwrite config with JSON containing model_profile but NOT team_mode. RUN: run_session_start. ASSERT: assert_success, then run jq -r '.team_mode' on config.json and assert_output 'task'. VERIFIES: session-start.sh migration block adds team_mode=task to configs that lack it (plan 01-01 T3 implementation). Follows exact pattern of existing test 8 which tests model_profile migration."}
{"id":"T3","tp":"auto","a":"Run full test suite (bash tests/run-all.sh) to verify all 872+ existing tests pass unchanged. No test should reference team_mode=teammate as required behavior. Document pass count.","f":["tests/run-all.sh"],"v":"All existing tests pass, zero failures","done":"Full test suite green, pass count documented in summary","spec":"TASK TYPE: Verification only -- no file modifications.\n\nSTEPS:\n1. Run the full test suite: bash tests/run-all.sh\n   - This executes all 5 categories in order: static (96), unit (577 + new tests), containment (134), integration (65)\n   - Performance tests (perf/baselines.bats) run last and are optional (script uses || echo)\n   - Expected total: 872+ existing tests PLUS the new tests from T1 (10 tests) and T2 (1 test) = 883+ total\n\n2. Verify zero failures:\n   - Exit code of run-all.sh must be 0\n   - No 'not ok' lines in output\n   - All categories show only 'ok' results\n\n3. Check for teammate-as-required references:\n   - Run: grep -r 'team_mode=teammate' tests/ to see if any test REQUIRES teammate mode as a passing condition\n   - There should be ZERO tests that require team_mode=teammate to pass (our new tests check teammate mode outputs but they work without Teammate API being available)\n   - Tests that SET team_mode=teammate in config and verify the resolve script's output are fine (these test the resolution logic, not the API itself)\n\n4. Document results in the plan summary:\n   - Total test count per category\n   - Overall pass count\n   - Any new tests added (list resolve-team-mode.bats and session-start.bats addition)\n   - Confirm zero regressions from team_mode changes\n\nVERIFICATION COMMANDS:\n  bash tests/run-all.sh                                    # Must exit 0\n  bats --count tests/unit/                                  # Should be 588+ (577 + 10 + 1)\n  bats --count tests/unit/ tests/static/ tests/containment/ tests/integration/  # Should be 883+\n  grep -r 'team_mode=teammate' tests/ | grep -v '.bats:'    # Should be empty (no non-test references)\n\nNOTE: This task produces no file changes. It is a verification gate. The 'done' state is confirmed by the test runner output. If any tests fail, this task BLOCKS and the failure must be investigated before the plan can be marked complete.","ts":""}
