---
phase: 3
plan: 04
title: Wire skills into compile-context and measure savings
wave: 2
depends_on: [03-01, 03-02, 03-03]
must_haves:
  - compile-context resolves project-local skills from skills/ directory
  - Measured context window savings documented (before/after token counts)
  - No behavioral regression verified via bats test suite
  - CLAUDE.md confirmed under 45 lines post-integration
---

# Plan 04: Wire Skills into Compile-Context and Measure Savings

## Background

After Plans 01-03, three protocols have been migrated to skills/ and CLAUDE.md has been pruned. This plan integrates the changes: ensures compile-context can bundle project-local skills, measures the token savings, and validates no regression.

## Tasks

### Task 1: Update compile-context CLI to resolve project-local skills

**Description:** The compile-context system (Rust binary at `yolo-mcp-server/src/commands/`) currently resolves skills from `~/.claude/skills/{name}/SKILL.md`. Add a resolution path that checks `${CLAUDE_PLUGIN_ROOT}/skills/{name}/SKILL.md` first (project-local), falling back to the global path. This ensures `skills_used: [execute-protocol]` in a plan resolves to the project-local skill.

Search the Rust source for the skill resolution logic in compile-context and add the project-local path. If the Rust binary does not contain skill resolution (it was in the old shell script), document this as a known gap and update the execute-protocol SKILL.md to note that project-local skills are loaded via direct `Read` by the command, not via compile-context bundling.

**Files:**
- `yolo-mcp-server/src/commands/compile_context.rs` or equivalent (modify if skill resolution exists)
- If no Rust skill resolution: `skills/execute-protocol/SKILL.md` (add resolution note)

**Acceptance criteria:**
- Project-local skill resolution path exists OR is documented as manual Read
- A plan with `skills_used: [execute-protocol]` either bundles or documents how the skill loads

### Task 2: Run bats test suite and fix any regressions

**Description:** Run the full bats test suite to verify no behavioral regressions from the protocol migrations and CLAUDE.md pruning. The test suite has 692+ tests. Fix any failures caused by the changes (e.g., tests that grep for content in references/ that was moved to skills/).

**Files:**
- Any test files that reference moved protocols (update paths)

**Acceptance criteria:**
- Full bats test suite passes (0 failures)
- Any path references in tests updated to match new skill locations

### Task 3: Measure and document context window savings

**Description:** Measure the token savings from the changes:
1. Count characters in CLAUDE.md before (67 lines) vs after (<45 lines) -- calculate reduction
2. Count characters in protocols that are no longer always-loaded (execute-protocol 547 lines, discussion-engine 176 lines, verification-protocol 165 lines = 888 lines moved to on-demand)
3. Document savings in a brief section added to the phase's SUMMARY notes

Use `wc -c` for character counts. Estimate tokens as chars/4 (rough approximation).

**Files:**
- None modified (measurement only, results go in SUMMARY.md)

**Acceptance criteria:**
- CLAUDE.md reduction measured (lines and estimated tokens)
- Protocol migration savings measured (lines moved to on-demand loading)
- Total estimated context window savings documented

### Task 4: Verify CLAUDE.md under 45 lines and all skills load correctly

**Description:** Final verification:
1. `wc -l CLAUDE.md` confirms under 45 lines
2. Read each skill SKILL.md to verify content integrity
3. Read each redirect stub in references/ to verify it points to the correct skill
4. Verify commands that load protocols can still find them at the new paths

**Files:**
- None modified (verification only)

**Acceptance criteria:**
- CLAUDE.md confirmed under 45 lines
- All 3 skills have complete content in SKILL.md
- All 3 redirect stubs point to correct skill paths
- Command references resolve to valid files
