---
phase: 5
plan: 03
title: "Optimizations: Delta Files Fallback, Phase Parse Cache, HashSet Dedup"
wave: 1
depends_on: []
must_haves:
  - "delta_files caps tag-based and HEAD~N fallback to max 50 files"
  - "delta_files skips tag-based fallback entirely when tag diff exceeds cap"
  - "token_baseline caches phase.parse::<i64>() result outside inner loops"
  - "bootstrap_claude uses HashSet for O(N+M) deduplication instead of O(N*M) nested loop"
  - "All existing tests pass in delta_files.rs, token_baseline.rs, and bootstrap_claude.rs"
  - "cargo build succeeds with no warnings"
---

## Tasks

### Task 1: Cap delta_files fallback scope
- **Commit:** `fix(delta-files): cap tag and HEAD~N fallback to max 50 files`
- **Files:** `yolo-mcp-server/src/commands/delta_files.rs`
- **Description:**
  Currently `git_strategy` (delta_files.rs:60-80) falls back to diff since last tag, then HEAD~5..HEAD, potentially returning hundreds of files. Fix:
  1. Add a constant `const MAX_FALLBACK_FILES: usize = 50;`.
  2. After the tag-based diff (line 65-69), if the result exceeds MAX_FALLBACK_FILES, skip this fallback entirely (return None from that branch) since a massive diff is not useful context.
  3. After the HEAD~5 fallback (line 75-79), truncate the result to MAX_FALLBACK_FILES with a trailing `"... (truncated, showing first 50 of N files)"` line.
  4. The primary strategy (uncommitted changes at lines 42-57) remains uncapped since those are directly relevant.

### Task 2: Add tests for delta_files fallback cap
- **Commit:** `test(delta-files): verify fallback file count capping`
- **Files:** `yolo-mcp-server/src/commands/delta_files.rs`
- **Description:**
  Add tests in the existing `#[cfg(test)] mod tests` block:
  1. `test_max_fallback_constant`: Verify `MAX_FALLBACK_FILES == 50` (compile-time assertion or simple assert).
  2. `test_summary_strategy_large_file_list`: Create a SUMMARY.md with 100+ files, verify summary_strategy still returns all of them (summary strategy is not capped, only git fallbacks).
  3. Existing tests should continue passing since they don't exercise the fallback paths with large file counts.

### Task 3: Cache phase parsing in token_baseline
- **Commit:** `perf(token-baseline): cache phase.parse outside inner event/metric loops`
- **Files:** `yolo-mcp-server/src/commands/token_baseline.rs`
- **Description:**
  In `build_measurement` (token_baseline.rs:53-97), the expression `phase.parse::<i64>().ok()` is called inside both the events loop (line 60) and the metrics loop (line 68) for every iteration. Since `phase` doesn't change within the outer loop body, cache it:
  1. At the start of the `for phase in target_phases` loop body (line 53), add: `let phase_as_i64 = phase.parse::<i64>().ok();`
  2. Replace both occurrences of `phase.parse::<i64>().ok()` (lines 60, 68) with `phase_as_i64`.
  3. This eliminates redundant string parsing on every event/metric iteration.

### Task 4: Replace O(N*M) dedup with HashSet in bootstrap_claude
- **Commit:** `perf(bootstrap): use HashSet for O(N+M) Key Decisions deduplication`
- **Files:** `yolo-mcp-server/src/commands/bootstrap_claude.rs`
- **Description:**
  In `migrate_key_decisions` (bootstrap_claude.rs:84-98), deduplication uses a nested loop: for each `drow` in `data_rows`, it iterates all lines in `state_content` comparing normalized strings. This is O(N*M). Replace with HashSet:
  1. Add `use std::collections::HashSet;` at the top of the file (or in the function scope).
  2. Before the dedup loop, build a `HashSet<String>` of normalized lines from `state_content`: `let existing: HashSet<String> = state_content.lines().map(|l| l.split_whitespace().collect::<Vec<_>>().join(" ")).collect();`
  3. Replace the inner loop with a HashSet lookup: `if !existing.contains(&normalized_drow)`.
  4. This changes complexity from O(N*M) to O(N+M).

### Task 5: Verify all optimizations compile and pass tests
- **Commit:** `chore(mcp): verify all optimization changes compile cleanly`
- **Files:** (no new files -- verification only)
- **Description:**
  Run `cargo build` and `cargo test` in the `yolo-mcp-server/` directory. Verify:
  1. No compiler warnings.
  2. All existing tests pass (delta_files, token_baseline, bootstrap_claude modules).
  3. No regressions in other modules (server.rs, tools.rs tests).
  This task is a verification gate -- if any test fails, fix it before committing.
