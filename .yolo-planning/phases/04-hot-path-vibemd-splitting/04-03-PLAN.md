---
phase: 4
plan: 3
title: "Enable v2_token_budgets by default + session-start step-level reporting"
wave: 1
depends_on: []
must_haves:
  - v2_token_budgets defaults to true in config/defaults.json
  - session-start reports per-step status (ok/warn/skip) instead of flat array
  - Config migration handles existing projects (false stays false)
  - No regression in existing session-start tests
---

# Plan 04-03: Enable v2_token_budgets by default + session-start step-level reporting

## Goal
Two independent improvements to the config and session-start systems:
1. Enable `v2_token_budgets=true` by default so new projects get token budget enforcement out of the box
2. Enhance session-start to report per-step status (ok/warn/skip/error) instead of a flat list of completed step names

## Context
**v2_token_budgets**: Currently defaults to `false` in `config/defaults.json` (line 49). The token budget system is stable and production-tested. Enabling by default gives new projects automatic token governance. Existing projects keep their current setting via config migration (which preserves user-set values).

**session-start step reporting**: Currently `session_start.rs` collects steps as `Vec<&str>` (line 16) and reports them as `"steps_completed": ["step1", "step2", ...]` (line 143). The ROADMAP requires "step-level success/failure for all 15 init steps." The fix: change from a flat string array to an array of `{"step": name, "status": "ok"|"warn"|"skip"|"error", "ms": elapsed}` objects.

## Files Modified
- `config/defaults.json` — change `v2_token_budgets` from false to true
- `yolo-mcp-server/src/commands/session_start.rs` — enhance step reporting with per-step status and timing
- `tests/config-migration.bats` — add test for v2_token_budgets default migration

## Tasks

### Task 1: Enable v2_token_budgets by default
In `config/defaults.json`, change line 49 from:
```json
"v2_token_budgets": false,
```
to:
```json
"v2_token_budgets": true,
```

Verify that `config-migration` handles this correctly: when an existing project has `"v2_token_budgets": false` explicitly set, migration preserves the user's choice (it does — `migrate_config.rs` only adds missing keys, never overwrites existing ones). Add a test in `tests/config-migration.bats` that confirms:
1. New config gets `v2_token_budgets=true` from defaults
2. Existing config with `v2_token_budgets=false` keeps false after migration

### Task 2: Enhance session-start step reporting
Modify `session_start.rs` to track per-step status:

1. Replace `let mut steps: Vec<&str> = Vec::new()` with a struct-based tracker:
```rust
struct StepResult {
    name: &'static str,
    status: &'static str,  // "ok", "warn", "skip", "error"
    ms: u64,
}
let mut steps: Vec<StepResult> = Vec::new();
let mut step_start: Instant;
```

2. For each of the 15 steps, wrap the operation:
```rust
step_start = Instant::now();
// ... existing step logic ...
steps.push(StepResult {
    name: "step_name",
    status: "ok",  // or "warn" if warnings generated, "skip" if condition not met
    ms: step_start.elapsed().as_millis() as u64,
});
```

3. Steps that may generate warnings (config_cache, update_check) should report "warn" when they produce warning text.

4. Steps that are conditionally skipped (e.g., compaction_check returns early, config_migration skips when no config exists) should report "skip".

5. Update the structured JSON output to use the new format:
```json
"steps": [
  {"step": "dependency_check", "status": "ok", "ms": 2},
  {"step": "compaction_check", "status": "skip", "ms": 0},
  ...
]
```

### Task 3: Update session-start Rust tests
Update the existing tests in `session_start.rs` `mod tests` to validate:
1. `test_build_context_no_project` — steps field is array of objects with step/status/ms
2. Add `test_step_status_reporting` — verify steps include status field for each step
3. Ensure backward-compatible: the JSON key changes from `steps_completed` to `steps` — update any tests that check for `steps_completed`
4. Check that warning steps report status="warn"
