---
phase: 4
plan: 1
title: "Split vibe.md into router + mode-specific skill files"
wave: 1
depends_on: []
must_haves:
  - vibe.md reduced to router-only (~90 lines, ~500 tokens)
  - 7 new skill files in skills/vibe-modes/ for on-demand loading
  - Each /yolo:vibe invocation loads only router + active mode (~1,500 tokens)
  - No behavioral regression across all workflow paths
---

# Plan 04-01: Split vibe.md into router + mode-specific skill files

## Goal
Reduce vibe.md from ~7,220 tokens (426 lines) to ~500 tokens router by extracting each mode into a separate skill file loaded on demand. This is the highest-impact item in Phase 4.

## Context
Currently `commands/vibe.md` contains ALL 11 modes inline. Every `/yolo:vibe` invocation loads the entire file regardless of which mode is used. The existing codebase already has 3 modes that delegate to external skill files:
- Execute mode (line 278): `Read ${CLAUDE_PLUGIN_ROOT}/skills/execute-protocol/SKILL.md`
- Discuss mode (line 131): `Read ${CLAUDE_PLUGIN_ROOT}/skills/discussion-engine/SKILL.md`
- Verify mode (line 301): `Read ${CLAUDE_PLUGIN_ROOT}/commands/verify.md`

The pattern is proven. We extend it to the remaining modes.

## Files Modified
- `commands/vibe.md` — rewrite to router-only (~90 lines)
- `skills/vibe-modes/bootstrap.md` — NEW: Bootstrap mode content (lines 95-166)
- `skills/vibe-modes/scope.md` — NEW: Scope mode content (lines 167-178)
- `skills/vibe-modes/plan.md` — NEW: Plan mode content (lines 202-275)
- `skills/vibe-modes/phase-mutation.md` — NEW: Add/Insert/Remove Phase modes (lines 304-357)
- `skills/vibe-modes/archive.md` — NEW: Archive mode content (lines 358-403)
- `skills/vibe-modes/assumptions.md` — NEW: Assumptions mode content (lines 193-201)

## Tasks

### Task 1: Create mode skill files
Extract each mode from vibe.md into its own file under `skills/vibe-modes/`:

1. `skills/vibe-modes/bootstrap.md` — Mode: Bootstrap (lines 95-166 of current vibe.md). Include the Guard, Critical Rules, Constraints, and all B1-B8 steps.
2. `skills/vibe-modes/scope.md` — Mode: Scope (lines 167-178). Include Guard and Steps 1-6.
3. `skills/vibe-modes/plan.md` — Mode: Plan (lines 202-275). Include Guard, Phase auto-detection, and Steps 1-11. This is the largest extracted mode.
4. `skills/vibe-modes/phase-mutation.md` — Mode: Add Phase + Insert Phase + Remove Phase (lines 304-357). All three phase mutation modes in one file since they share context and are mutually exclusive.
5. `skills/vibe-modes/archive.md` — Mode: Archive (lines 358-403). Include Guard, Pre-gate audit, and Steps 1-11.
6. `skills/vibe-modes/assumptions.md` — Mode: Assumptions (lines 193-201). Include Guard, Phase auto-detection, and Steps 1-4.

Each file should be self-contained: include its Guard, Steps, and any mode-specific output format notes. Do NOT include YAML frontmatter in the skill files (they are not slash commands).

### Task 2: Rewrite vibe.md as router-only
Rewrite `commands/vibe.md` to contain only:
- Existing frontmatter (lines 1-8)
- Context section (lines 10-26)
- Input Parsing (lines 27-88) with all three paths (flags, NL intent, state detection)
- Confirmation Gate (lines 83-88)
- Mode dispatch table that uses `Read ${CLAUDE_PLUGIN_ROOT}/skills/vibe-modes/{mode}.md` for each mode:
  - Init Redirect: inline (3 lines, too small to extract)
  - Bootstrap: `Read ${CLAUDE_PLUGIN_ROOT}/skills/vibe-modes/bootstrap.md`
  - Scope: `Read ${CLAUDE_PLUGIN_ROOT}/skills/vibe-modes/scope.md`
  - Discuss: existing `Read ${CLAUDE_PLUGIN_ROOT}/skills/discussion-engine/SKILL.md` (unchanged)
  - Assumptions: `Read ${CLAUDE_PLUGIN_ROOT}/skills/vibe-modes/assumptions.md`
  - Plan: `Read ${CLAUDE_PLUGIN_ROOT}/skills/vibe-modes/plan.md`
  - Execute: existing `Read ${CLAUDE_PLUGIN_ROOT}/skills/execute-protocol/SKILL.md` (unchanged)
  - Verify: existing `Read ${CLAUDE_PLUGIN_ROOT}/commands/verify.md` (unchanged)
  - Add/Insert/Remove Phase: `Read ${CLAUDE_PLUGIN_ROOT}/skills/vibe-modes/phase-mutation.md`
  - Archive: `Read ${CLAUDE_PLUGIN_ROOT}/skills/vibe-modes/archive.md`
- Pure-Vibe Phase Loop reference (lines 404-408) — keep inline (5 lines)
- Output Format section (lines 410-427) — keep inline (18 lines, needed for all modes)

Target: ~90 lines, ~500 tokens for the router.

### Task 3: Verify content completeness
After the split, verify that:
1. Every line of the original vibe.md is accounted for in either the router or a mode file
2. No mode-specific content remains in the router (except Init Redirect which is 3 lines)
3. All `${CLAUDE_PLUGIN_ROOT}` references resolve correctly
4. The `$ARGUMENTS` variable is available in mode files (it is — Claude Code expands commands before execution, so the Read-injected content inherits the context)
5. Cross-references between modes work (e.g., Bootstrap's B8 says "Re-evaluate state, route to next match" — this still works because the router handles re-routing)

### Task 4: Write tests for the split
Create `tests/vibe-mode-split.bats` with tests:
1. All 7 new mode files exist under `skills/vibe-modes/`
2. Router vibe.md is under 120 lines
3. Router contains Read references for all mode files
4. Each mode file contains its Guard section
5. No mode file contains frontmatter (they are not slash commands)
6. Router still contains frontmatter with `name: yolo:vibe`
7. All mode files are non-empty and contain at least one "Steps" or "Step" header
