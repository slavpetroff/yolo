---
phase: 4
plan: 4
title: "Integration tests + token measurement"
wave: 2
depends_on: [1, 2, 3]
must_haves:
  - All existing tests pass after plans 01-03
  - Token measurement via yolo report-tokens shows improvement
  - vibe.md split verified end-to-end
  - Tier cache verified via CLI
  - ROADMAP.md updated with Phase 4 completion metrics
---

# Plan 04-04: Integration tests + token measurement

## Goal
Verify all Phase 4 changes work together, measure token improvement, and update project state.

## Context
Plans 01-03 modified independent file sets:
- Plan 01: commands/vibe.md + skills/vibe-modes/*.md + tests/vibe-mode-split.bats
- Plan 02: tier_context.rs + router.rs
- Plan 03: defaults.json + session_start.rs + config-migration.bats

This plan verifies integration, measures results, and updates state.

## Files Modified
- `.yolo-planning/ROADMAP.md` — update Phase 4 progress row
- `.yolo-planning/STATE.md` — update phase status
- `tests/integration/phase4-integration.bats` — NEW: integration test file (if tests/integration/ exists, else tests/phase4-integration.bats)

## Tasks

### Task 1: Run full test suite and fix regressions
Run the full bats test suite:
```bash
bats tests/unit/ tests/static/ tests/containment/ tests/integration/ tests/perf/ 2>/dev/null; bats tests/*.bats
```
Also run Rust tests:
```bash
cd yolo-mcp-server && cargo test
```
Fix any failures introduced by Plans 01-03. Common issues to watch for:
- Tests that grep vibe.md for mode content that is now in skill files
- Tests that check `steps_completed` JSON key (now `steps`)
- Tests that assert `v2_token_budgets` is false (now true by default)

### Task 2: Write integration tests
Create integration test file with:
1. `vibe.md router + mode file integration` — verify `Read` references in router resolve to existing mode files
2. `tier cache + compile-context integration` — run compile-context twice, verify second run uses cache (check /tmp/yolo-tier-cache-{uid}/ exists with cache files)
3. `session-start structured steps` — run session-start binary, parse JSON, verify steps array has objects with step/status/ms keys
4. `v2_token_budgets default enabled` — verify defaults.json has v2_token_budgets=true

### Task 3: Measure token improvement
Run `yolo token-baseline report` or manually measure:
1. Count tokens in new router-only vibe.md (target: <600 tokens, ~100 lines)
2. Count tokens in largest mode file (plan.md, target: <1500 tokens)
3. Compare: old 7220 tokens (full vibe.md) vs new ~500 (router) + ~1000 (mode avg) = ~1500 per invocation
4. Document the savings in a brief summary

### Task 4: Update ROADMAP.md and STATE.md
Update `.yolo-planning/ROADMAP.md`:
- Phase 4 row: status=Complete, plans=4, tasks=count, commits=count
- Mark Phase 4 checkbox as [x]

Update `.yolo-planning/STATE.md`:
- Phase position: 4 of 4
- Status: Complete
- Progress: 100%
