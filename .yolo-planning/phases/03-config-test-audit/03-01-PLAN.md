---
phase: 3
plan: 1
title: "Schema enum and key corrections"
wave: 1
depends_on: []
must_haves:
  - REQ-09
  - All 6 P0 enum mismatches fixed in config.schema.json
  - Missing compaction_threshold key added to schema
  - defaults.json still validates against corrected schema
---

# Plan 03-01: Schema Enum and Key Corrections

## Scope

Fix all enum mismatches and missing keys in `config/config.schema.json` so the schema accurately reflects the values used by Rust code, defaults.json, and runtime configs.

**Files modified:** `config/config.schema.json` (single file)

## Tasks

### Task 1: Fix effort and autonomy enums

**Description:** Update the `effort` enum from `["minimal", "balanced", "thorough"]` to `["thorough", "balanced", "fast", "turbo"]`. Update the `autonomy` enum from `["minimal", "standard", "full"]` to `["cautious", "standard", "confident", "pure-vibe"]`. These are the values actually used by effort-profiles, execute-protocol, and runtime code.

**Files:** `config/config.schema.json`

**Commit:** `fix(config): correct effort and autonomy enum values in schema`

**Verification:**
- Schema effort enum contains exactly: thorough, balanced, fast, turbo
- Schema autonomy enum contains exactly: cautious, standard, confident, pure-vibe
- `jq '.properties.effort.enum' config/config.schema.json` returns the corrected array
- `jq '.properties.autonomy.enum' config/config.schema.json` returns the corrected array

### Task 2: Fix planning_tracking, review_gate, and qa_gate enums

**Description:** Update `planning_tracking` enum from `["manual", "auto"]` to `["commit", "manual", "ignore"]` — these are the three values referenced in code. Update `review_gate` and `qa_gate` enums from `["off", "on_request", "always"]` to `["never", "on_request", "always"]` — code uses `"never"` not `"off"`.

**Files:** `config/config.schema.json`

**Commit:** `fix(config): correct planning_tracking, review_gate, and qa_gate enums`

**Verification:**
- planning_tracking enum: commit, manual, ignore
- review_gate enum: never, on_request, always
- qa_gate enum: never, on_request, always
- defaults.json `review_gate: "on_request"` is still valid against corrected schema

### Task 3: Fix model_profile and prefer_teams enums

**Description:** Update `model_profile` enum from `["quality", "balanced", "speed"]` to `["quality", "balanced", "budget"]` — model-profiles.json uses `"budget"` not `"speed"`. Update `prefer_teams` enum from `["never", "auto", "always"]` to `["never", "auto", "always", "when_parallel"]` — code uses `"when_parallel"` as an additional option.

**Files:** `config/config.schema.json`

**Commit:** `fix(config): correct model_profile and prefer_teams enums`

**Verification:**
- model_profile enum: quality, balanced, budget
- prefer_teams enum: never, auto, always, when_parallel
- `jq '.properties.model_profile.enum' config/config.schema.json` returns corrected array

### Task 4: Add missing compaction_threshold key to schema

**Description:** Add `compaction_threshold` as an integer property to the schema. The Rust code in `phase_detect.rs` reads this key from config via `.get("compaction_threshold")`. Since `additionalProperties: false` is set, any config using this key would currently fail validation. Add it as: `"compaction_threshold": { "type": "integer", "minimum": 1 }`.

**Files:** `config/config.schema.json`

**Commit:** `fix(config): add compaction_threshold to schema properties`

**Verification:**
- `jq '.properties.compaction_threshold' config/config.schema.json` returns a type definition
- A config with `{"compaction_threshold": 50}` would pass schema validation
- Schema still has `additionalProperties: false` (no regression)

### Task 5: Validate defaults.json against corrected schema

**Description:** Run the existing bats test `schema-validation.bats` (specifically the "defaults.json validates against config.schema.json" test) to confirm the corrected schema does not break the defaults file. If the defaults.json `review_gate` value `"on_request"` is valid in the new schema, and `effort: "balanced"` is valid, this should pass. Document the validation result.

**Files:** `config/config.schema.json` (read-only verification, no changes)

**Commit:** `test(config): verify defaults.json validates against corrected schema`

**Verification:**
- `yolo migrate-config` with defaults.json succeeds (exit 0)
- All 4 existing schema-validation.bats tests pass
- No regression in existing test suite
