---
phase: 02
plan: 01
title: "Rewrite statusline to match VBW functionality"
wave: 1
depends_on: []
must_haves:
  - Statusline reads stdin JSON for context_window, cost, model data
  - STATE.md parsed with correct Markdown bold patterns
  - Execution-state.json read for build progress
  - Config.json read for effort/model_profile
  - Git branch and file change indicators displayed
  - OAuth usage via credential store and /api/oauth/usage endpoint
  - File-based caching (5s fast, 60s slow)
  - Update checking against remote VERSION
  - No hardcoded model names
  - All API call logic removed (reqwest dependency removed)
---

## Tasks

### Task 1: Rewrite statusline.rs — full implementation
**Files:** yolo-mcp-server/src/commands/statusline.rs
**Action:** Complete rewrite of statusline.rs to match VBW statusline functionality:
1. **Stdin JSON parsing**: Read stdin and parse with serde_json. Extract: context_window (used_percentage, remaining_percentage, current_usage.input_tokens/output_tokens/cache_creation_input_tokens/cache_read_input_tokens, context_window_size), cost (total_cost_usd, total_duration_ms, total_api_duration_ms, total_lines_added, total_lines_removed), model (display_name), version.
2. **Fast cache (5s TTL)**: Read .yolo-planning/STATE.md with correct patterns (`**Current Phase:**`, `**Status:**`, `**Progress:**`). Read .yolo-planning/.execution-state.json for build progress. Read .yolo-planning/config.json for effort/model_profile. Git branch via `git branch --show-current`, staged/modified counts via `git diff`. Cache results to temp file.
3. **Slow cache (60s TTL)**: OAuth credential reading (macOS Keychain via `security find-generic-password`, credential files, env var). Call `https://api.anthropic.com/api/oauth/usage` with Bearer token via `curl`. Parse five_hour/seven_day usage. Update check against GitHub remote VERSION file via `curl`.
4. **Output formatting**: 4 lines matching VBW format:
   - L1: `[YOLO] Phase X/Y | Plans: done/total | Effort: balanced | Model: quality | repo:branch +staged ~modified`
   - L2: `Context: [▓▓▓░░░░░░░] XX% used/total | Tokens: Xin Yout | Prompt Cache: XX% hit`
   - L3: `Session: [progress] XX% ~Xh | Weekly: [progress] XX%` (from OAuth) or fallback
   - L4: `Model: name | Time: Xm Xs | YOLO version | CC version`
5. **Remove**: All reqwest usage, execute_fetch_limits, trigger_background_fetch. Use std::process::Command for curl calls instead. Remove rusqlite usage for cache_hits (use execution state instead).
6. **Change function signature**: `render_statusline(stdin_json: &str)` instead of `render_statusline(db_path: &PathBuf)`.
**Acceptance:** `echo '{"context_window":{"used_percentage":45},"model":{"display_name":"Claude"},"version":"1.0"}' | yolo statusline` produces a 4-line status display with correct data.

### Task 2: Update router.rs — pipe stdin and remove fetch-limits
**Files:** yolo-mcp-server/src/cli/router.rs
**Action:**
1. In the `"statusline"` match arm: read stdin to a String (same pattern as "hook" arm), pass to `statusline::render_statusline(&stdin_json)` instead of `render_statusline(&db_path)`.
2. Remove the `"fetch-limits"` match arm entirely (no longer needed).
3. Remove `statusline::execute_fetch_limits` and `statusline::trigger_background_fetch` from any imports if they existed.
**Acceptance:** `echo '{}' | yolo statusline` works. `yolo fetch-limits` returns "Unknown command".

### Task 3: Remove reqwest from Cargo.toml
**Files:** yolo-mcp-server/Cargo.toml
**Action:** Remove the `reqwest = { version = "0.13.2", features = ["blocking", "json"] }` line. Run `cargo build` to verify no other code depends on it.
**Acceptance:** `cargo build` succeeds without reqwest in dependencies.

### Task 4: Rewrite tests for new statusline
**Files:** yolo-mcp-server/src/commands/statusline.rs
**Action:** Replace all existing tests with new tests covering:
1. `test_render_statusline_empty_stdin` — empty JSON input produces valid 4-line output with defaults
2. `test_render_statusline_with_context` — JSON with context_window data produces correct percentages
3. `test_render_statusline_with_model` — JSON with model.display_name shows correct model
4. `test_render_statusline_with_cost` — JSON with cost data formats correctly
5. `test_fast_cache_state_parsing` — Verify STATE.md parsing with Markdown bold format
6. `test_fast_cache_execution_state` — Verify execution-state.json parsing for build progress
7. `test_format_helpers` — Token formatting (K/M), duration formatting, progress bar generation
**Acceptance:** `cargo test` passes all new statusline tests.
