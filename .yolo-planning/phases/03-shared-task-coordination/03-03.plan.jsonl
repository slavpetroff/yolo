{"p":"03","n":"03","t":"execute-protocol Step 4 and Step 7 parallel Senior dispatch","w":2,"d":["03-01","03-02"],"xd":[],"mh":{"tr":["Step 4 spawns multiple Senior agents concurrently for plans in the same wave when team_mode=teammate","Step 7 spawns multiple Senior agents concurrently for plans in the same wave when team_mode=teammate (mirroring Step 4)","Parallel Senior dispatch activates only when wave has 2+ plans; single-plan waves dispatch one Senior directly","When team_mode=task Step 4 and Step 7 behavior is identical to current sequential dispatch","Each concurrent Senior receives exactly one plan.jsonl (no shared plans)","Verification gate for Step 4 requires ALL plans enriched before exit","Verification gate for Step 7 requires ALL plans have code-review.jsonl with r:approve before exit","Senior registration is on-demand: all Seniors for a wave registered before dispatch"],"ar":[{"p":"references/execute-protocol.md","pv":"team_mode=teammate.*concurrent Senior","c":"Step 4 documents parallel Senior dispatch for teammate mode with 2+ plan threshold"},{"p":"references/execute-protocol.md","pv":"Step 7.*team_mode=teammate.*concurrent Senior","c":"Step 7 documents parallel Senior dispatch mirroring Step 4 pattern with 2+ plan threshold"},{"p":"references/execute-protocol.md","pv":"Step 4.*exit gate.*concurrent","c":"Step 4 exit gate handles concurrent Senior completion"},{"p":"references/execute-protocol.md","pv":"Step 7.*exit gate.*concurrent","c":"Step 7 exit gate handles concurrent Senior completion with code-review.jsonl verification"}],"kl":[{"fr":"references/execute-protocol.md Step 4","to":"agents/yolo-senior.md ## Parallel Review","vi":"Step 4 references Senior parallel review capability"},{"fr":"references/execute-protocol.md Step 4","to":"references/teammate-api-patterns.md ## Task Coordination","vi":"Step 4 references task coordination patterns"},{"fr":"references/execute-protocol.md Step 7","to":"agents/yolo-senior.md ## Parallel Review","vi":"Step 7 references Senior parallel review capability (same section covers both steps)"}]},"obj":"Rewrite execute-protocol.md Step 4 (Design Review) and Step 7 (Code Review) to support parallel Senior dispatch via Teammate API when team_mode=teammate with 2+ plan threshold, with sequential fallback for team_mode=task (REQ-03)","sk":["commit"],"fm":["references/execute-protocol.md"],"auto":true}
{"id":"T1","tp":"auto","a":"Add team_mode conditional block to execute-protocol.md Step 4 (Design Review) documenting parallel Senior dispatch: when team_mode=teammate AND wave has 2+ plans, group plans by wave, register one Senior per plan in the current wave, dispatch all concurrently via SendMessage, collect senior_spec results. When wave has exactly 1 plan, dispatch a single Senior directly with no parallel coordination overhead (D11). When team_mode=task, preserve current sequential per-plan loop unchanged.","f":["references/execute-protocol.md"],"v":"Step 4 contains team_mode conditional with parallel dispatch for teammate mode, 2+ plan threshold documented, and sequential for task mode","done":"Step 4 parallel Senior dispatch documented with 2+ plan threshold and both mode paths","spec":"Modify file: references/execute-protocol.md. In Step 4: Design Review (Senior Agent) section (starts at line 204), modify the existing content at step 3 (line 212: 'For each plan.jsonl without enriched specs'). The current step 3 documents a sequential for-each loop. Replace the content of steps 3-6 (lines 212-227) with a team_mode conditional block. Structure: (1) Keep existing line 210-211 (step 1 update execution state, step 2 compile context) unchanged. (2) Add a new numbered item 3 with team_mode conditional: '3. **Dispatch Senior(s):**'. Under this, add two indented blocks: (a) '**When team_mode=teammate:**' block containing: 'Group remaining plans by wave. For the current wave: If wave has 2+ plans: register one Senior per plan in the wave as teammates (if not already registered). Dispatch all Seniors concurrently via SendMessage, each receiving one plan.jsonl path + architecture.toon + critique.jsonl (if exists) + compiled context. Collect senior_spec messages from all dispatched Seniors. If wave has exactly 1 plan: dispatch a single Senior directly (no parallel coordination overhead -- single-plan waves use sequential dispatch even in teammate mode). See agents/yolo-senior.md ## Parallel Review for Senior-side protocol.' (b) '**When team_mode=task (default):**' block containing: 'For each plan.jsonl without enriched specs (tasks missing spec field): Spawn yolo-senior with Task tool: model \"${SENIOR_MODEL}\", mode \"design_review\", provide plan.jsonl path, architecture.toon path, critique.jsonl path (if exists), compiled context. Display: Spawning Senior for design review ({plan})...' This preserves the existing sequential behavior as the task-mode path. (3) Keep the Tool permissions block (lines 219-223) within BOTH paths (it applies regardless of mode). (4) Keep steps 4-6 (Senior reads plan, enriches, commits) unchanged -- these describe Senior's internal behavior which is identical in both modes. (5) Modify the EXIT GATE (line 228) to add a teammate mode note: 'In teammate mode, Lead verifies ALL plans in the current wave have non-empty spec fields after collecting all senior_spec messages. All plans in wave must be enriched before proceeding to the next wave or to Step 5.'","ts":""}
{"id":"T2","tp":"auto","a":"Update Step 4 exit gate documentation in execute-protocol.md to handle concurrent Senior completion: all plans in wave must have enriched specs before proceeding. Lead verifies by checking each plan.jsonl for non-empty spec fields after all senior_spec messages received.","f":["references/execute-protocol.md"],"v":"Step 4 exit gate documents concurrent completion verification","done":"Exit gate handles parallel Senior completion verification","spec":"Modify file: references/execute-protocol.md. In Step 4, the EXIT GATE is at line 228. The current text is: '**EXIT GATE:** Artifact: enriched plan.jsonl (all tasks have non-empty `spec`). State: `steps.design_review = complete`. Commit: `chore(state): design_review complete phase {N}`.' Expand this to handle concurrent completion: Replace the EXIT GATE line with: '7. **EXIT GATE:** Artifact: enriched plan.jsonl (all tasks in ALL plans have non-empty `spec`). When team_mode=teammate: Lead waits for senior_spec messages from all dispatched Seniors in the current wave. After all received, Lead verifies each plan.jsonl: `jq -r .spec` on every task line must return non-empty value. If any plan has tasks without specs, Senior failed -- Lead escalates. When team_mode=task: sequential verification unchanged (each plan checked after its Senior completes). State: `steps.design_review = complete`. Commit: `chore(state): design_review complete phase {N}`.' The key addition is the 'Lead waits for senior_spec messages from all dispatched Seniors' paragraph for teammate mode.","ts":""}
{"id":"T3","tp":"auto","a":"Add team_mode=teammate block to execute-protocol.md Step 7 (Code Review) for parallel Senior dispatch mirroring Step 4 pattern: when team_mode=teammate AND wave has 2+ completed plans, group completed plans by wave, register one Senior per plan, dispatch concurrently, collect code_review_result messages. When wave has exactly 1 plan, dispatch a single Senior directly (D11). When team_mode=task, preserve current sequential code review. (D2, C2)","f":["references/execute-protocol.md"],"v":"Step 7 contains team_mode conditional with parallel Senior dispatch mirroring Step 4 pattern with 2+ plan threshold","done":"Step 7 parallel Senior dispatch documented mirroring Step 4 with threshold","spec":"Modify file: references/execute-protocol.md. In Step 7: Code Review (Senior Agent) section (starts at line 301). The current step 2 (line 306: 'For each completed plan:') documents a sequential loop. Replace steps 2-3 (lines 306-319) with a team_mode conditional block mirroring the Step 4 pattern from T1. Structure: (1) Keep step 1 (line 305: update execution state) unchanged. (2) Add a new numbered item 2 with team_mode conditional: '2. **Dispatch Senior(s):**'. Under this, add two indented blocks: (a) '**When team_mode=teammate:**' block containing: 'Group completed plans by wave. For the current wave: If wave has 2+ completed plans: register one Senior per plan as teammates. Dispatch all Seniors concurrently via SendMessage, each receiving one plan.jsonl path + git diff of plan commits + test-plan.jsonl (if exists). Collect code_review_result messages from all dispatched Seniors. If wave has exactly 1 completed plan: dispatch a single Senior directly (no parallel coordination overhead). See agents/yolo-senior.md ## Parallel Review for Senior-side protocol.' (b) '**When team_mode=task (default):**' block containing the existing sequential behavior: 'For each completed plan: Spawn yolo-senior with Task tool: model \"${SENIOR_MODEL}\", mode \"code_review\", provide plan.jsonl path, git diff of plan commits, test-plan.jsonl (if exists). Display: Spawning Senior for code review ({plan})...' (3) Keep the Tool permissions block within BOTH paths. (4) Keep steps 3-6 (Senior reviews code, TDD compliance, code-review.jsonl production, changes_requested flow) unchanged -- these describe Senior's internal behavior. (5) Keep step 7 (Senior commits) and step 8 (Verify code-review.jsonl) unchanged.","ts":""}
{"id":"T4","tp":"auto","a":"Update Step 7 exit gate in execute-protocol.md to handle concurrent Senior completion: all plans must have code-review.jsonl with r:approve before proceeding. Lead verifies after all code_review_result messages received from concurrent Seniors. (D2, C2)","f":["references/execute-protocol.md"],"v":"Step 7 exit gate documents concurrent Senior completion verification with code-review.jsonl r:approve check","done":"Step 7 exit gate handles concurrent code review completion","spec":"Modify file: references/execute-protocol.md. In Step 7, the EXIT GATE is at line 332. The current text is: '9. **EXIT GATE:** Artifact: `code-review.jsonl` (r: \"approve\"). State: `steps.code_review = complete`. Commit: `chore(state): code_review complete phase {N}`.' Expand this to handle concurrent completion: Replace the EXIT GATE line with: '9. **EXIT GATE:** Artifact: `code-review.jsonl` per plan (r: \"approve\"). When team_mode=teammate: Lead waits for code_review_result messages from all dispatched Seniors in the current wave. After all received, Lead verifies each plan has code-review.jsonl with `r: \"approve\"` in line 1 (via `jq -r .r` equals \"approve\"). If any plan has changes_requested after cycle 2, Senior escalates to Lead per existing protocol. When team_mode=task: sequential verification unchanged (each plan checked after its Senior completes). State: `steps.code_review = complete`. Commit: `chore(state): code_review complete phase {N}`.' The key addition is the 'Lead waits for code_review_result messages' paragraph for teammate mode, mirroring the Step 4 exit gate pattern from T2.","ts":""}
