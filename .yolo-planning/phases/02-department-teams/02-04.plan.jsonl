{"p":"02","n":"04","t":"Tests: agent section validation, dept-orchestrate teammate routing, mock integration","w":3,"d":["02-01","02-02","02-03","02-05"],"xd":[{"p":"01","n":"04","a":"tests/unit/resolve-team-mode.bats","r":"Test pattern reference for team_mode-related bats tests"}],"mh":{"tr":["Static tests verify all 23 agents (4 from Phase 1 + 19 from Phase 2) have Teammate API sections","Unit tests verify dept-orchestrate outputs team_mode and spawn_strategy fields","Mock integration tests validate spawnTeam/SendMessage patterns are documented consistently","All 957+ existing tests pass unchanged (zero regression)"],"ar":[{"p":"tests/static/agent-teammate-sections.bats","pv":"@test","c":"static tests checking all 23 agent files for Teammate API section presence"},{"p":"tests/unit/dept-orchestrate-teammate.bats","pv":"@test","c":"unit tests for team_mode routing in dept-orchestrate spawn plans"},{"p":"tests/integration/teammate-mock.bats","pv":"@test","c":"mock integration tests validating spawnTeam/SendMessage pattern consistency"}],"kl":[{"fr":"tests/static/agent-teammate-sections.bats","to":"agents/yolo-*.md","vi":"tests check every yolo-*.md agent file for ## Teammate API"},{"fr":"tests/unit/dept-orchestrate-teammate.bats","to":"scripts/dept-orchestrate.sh","vi":"tests invoke dept-orchestrate.sh with team_mode configs"},{"fr":"tests/integration/teammate-mock.bats","to":"references/teammate-api-patterns.md","vi":"tests validate pattern consistency across agents and reference docs"}]},"obj":"Comprehensive test coverage for Phase 2: static validation of agent Teammate API sections, unit tests for dept-orchestrate teammate routing, mock integration tests for spawnTeam/SendMessage pattern consistency. Plus full regression run.","sk":["commit"],"fm":["tests/static/agent-teammate-sections.bats","tests/unit/dept-orchestrate-teammate.bats","tests/integration/teammate-mock.bats"],"auto":true}
{"id":"T1","tp":"auto","a":"Create tests/static/agent-teammate-sections.bats: verify all 23 agent files (lead, dev, senior, architect from Phase 1 + tester x3, qa x3, qa-code x3, security, owner from Phase 2 + fe-lead, fe-senior, fe-dev, fe-architect, ux-lead, ux-senior, ux-dev, ux-architect from Phase 2) contain '## Teammate API' section. Verify each section contains 'team_mode=teammate' guard text. Verify each section references @references/teammate-api-patterns.md (except owner which uses file-based).","f":["tests/static/agent-teammate-sections.bats"],"v":"All tests pass, covering 23 agent files for section presence","done":"Static agent Teammate API section tests created and green, committed","spec":"File: tests/static/agent-teammate-sections.bats\n\nShebang + header:\n  #!/usr/bin/env bats\n  # agent-teammate-sections.bats -- Static validation: all 23 agents have Teammate API sections\n\nsetup():\n  load '../test_helper/common'\n  # No fixtures needed -- reads real agent files via $AGENTS_DIR from common.bash\n\nDefine AGENTS array (bash array, 23 entries) listing ALL agent filenames without path:\n  AGENTS=(\n    yolo-lead.md yolo-senior.md yolo-dev.md yolo-architect.md\n    yolo-tester.md yolo-fe-tester.md yolo-ux-tester.md\n    yolo-qa.md yolo-fe-qa.md yolo-ux-qa.md\n    yolo-qa-code.md yolo-fe-qa-code.md yolo-ux-qa-code.md\n    yolo-security.md yolo-owner.md\n    yolo-fe-lead.md yolo-fe-senior.md yolo-fe-dev.md yolo-fe-architect.md\n    yolo-ux-lead.md yolo-ux-senior.md yolo-ux-dev.md yolo-ux-architect.md\n  )\n  Place this array definition OUTSIDE setup() at file-level scope so it is accessible to all @test functions.\n\nTest functions (8 total):\n\n@test 'exactly 23 agents require Teammate API sections':\n  Assert ${#AGENTS[@]} equals 23. This is a canary test -- if the count changes, this test catches it.\n\n@test 'all 23 agent files exist':\n  Loop AGENTS array. For each: assert_file_exists \"$AGENTS_DIR/$agent\". This ensures the test is testing real files, not stale names.\n\n@test 'all 23 agents contain ## Teammate API section':\n  Loop AGENTS array. For each: run grep -c '## Teammate API' \"$AGENTS_DIR/$agent\"; assert_success; verify output >= 1. Use a failure message that includes $agent name for debuggability: [[ $status -eq 0 ]] || fail \"Missing ## Teammate API in $agent\"\n\n@test 'all 23 agents contain team_mode=teammate guard':\n  Loop AGENTS array. For each: run grep -c 'team_mode=teammate' \"$AGENTS_DIR/$agent\"; assert that output >= 1. On failure: fail \"Missing team_mode=teammate guard in $agent\"\n\n@test '22 agents reference @references/teammate-api-patterns.md (owner excluded)':\n  Define PATTERN_AGENTS as AGENTS minus yolo-owner.md (22 entries). Loop: run grep '@references/teammate-api-patterns.md' \"$AGENTS_DIR/$agent\"; assert_success. Separate assertion for owner: run grep '@references/teammate-api-patterns.md' \"$AGENTS_DIR/yolo-owner.md\"; assert_failure (owner uses file-based, no @reference).\n\n@test 'owner agent documents file-based rationale':\n  run grep -c 'file-based' \"$AGENTS_DIR/yolo-owner.md\"; assert_success; assert output >= 1. This verifies owner's Teammate API section explains why it uses file-based instead of SendMessage.\n\n@test 'shared agents (critic, scout, debugger) do NOT have Teammate API section':\n  EXCLUDED=(yolo-critic.md yolo-scout.md yolo-debugger.md). Loop: run grep '## Teammate API' \"$AGENTS_DIR/$agent\"; assert_failure. These agents are Task-tool-only per C5 resolution.\n\n@test 'no agent files with Teammate API section are missing from test list':\n  Glob all agents/yolo-*.md files. For each file with '## Teammate API' section (grep -l), assert it is in AGENTS array. This catches new agents added after this test was written that have the section but are not in the test list.\n\nPattern notes:\n  - Follow tests/static/protocol-file-coord-refs.bats pattern: setup() loads common only, tests use grep on real project files via $PROJECT_ROOT or $AGENTS_DIR.\n  - Use assert_success / assert_failure from bats-assert.\n  - Each test function should have a descriptive name in single quotes.\n  - Use 'fail' with descriptive messages when looping to identify which agent failed.","ts":"File: tests/static/agent-teammate-sections.bats (this IS the test file -- ts describes the test cases the Dev must implement)\n\nFramework: BATS (bats-core) with bats-assert, bats-file helpers loaded via common.bash\n\nTest cases (8):\n  1. 'exactly 23 agents require Teammate API sections' -- assert array length is 23. Catches accidental additions/removals from the list.\n  2. 'all 23 agent files exist' -- loop + assert_file_exists. Catches stale filenames in test list.\n  3. 'all 23 agents contain ## Teammate API section' -- grep per file. Happy path: all present. Failure: missing section in any agent.\n  4. 'all 23 agents contain team_mode=teammate guard' -- grep per file. Catches agents that have the section header but not the conditional guard.\n  5. '22 agents reference @references/teammate-api-patterns.md (owner excluded)' -- 22 positive + 1 negative (owner). Validates the @reference link presence.\n  6. 'owner agent documents file-based rationale' -- grep 'file-based' in owner. Validates owner's unique pattern.\n  7. 'shared agents (critic, scout, debugger) do NOT have Teammate API section' -- 3 negative assertions. Validates C5 exclusion.\n  8. 'no agent files with Teammate API section are missing from test list' -- glob + cross-check. Catches drift.\n\nMocking: None needed. Static tests read real files.\nAssertions: assert_success, assert_failure, assert_file_exists, fail with descriptive messages.\nCoverage: all 23 included agents, 3 excluded agents, owner special case, drift detection."}
{"id":"T2","tp":"auto","a":"Create tests/unit/dept-orchestrate-teammate.bats: test dept-orchestrate.sh with team_mode=teammate config. Verify output includes team_mode field. Verify each wave dept entry is an object with spawn_strategy and team_name fields. Test backward compatibility: team_mode=task config produces task spawn_strategy. Test edge cases: missing team_mode in config defaults to task behavior.","f":["tests/unit/dept-orchestrate-teammate.bats"],"v":"All tests pass covering teammate routing, task fallback, and edge cases","done":"dept-orchestrate teammate routing tests created and green, committed","spec":"File: tests/unit/dept-orchestrate-teammate.bats\n\nShebang + header:\n  #!/usr/bin/env bats\n  # dept-orchestrate-teammate.bats -- Unit tests for dept-orchestrate.sh team_mode routing\n  # Tests the teammate-mode extensions added in plan 02-02 T3.\n  # Complements tests/unit/dept-orchestrate.bats (existing wave structure tests).\n\nsetup():\n  load '../test_helper/common'\n  load '../test_helper/fixtures'\n  mk_test_workdir\n  SUT=\"$SCRIPTS_DIR/dept-orchestrate.sh\"\n\nHelper mk_teammate_config():\n  Takes 5 args: backend(bool), frontend(bool), uiux(bool), workflow(string), team_mode(string).\n  Creates $TEST_WORKDIR/.yolo-planning/config.json with departments + department_workflow + team_mode + agent_teams fields.\n  When team_mode=teammate: set agent_teams=true.\n  When team_mode=task: set agent_teams=true (but team_mode overrides).\n  Use jq -n with --argjson and --arg. Pattern from existing dept-orchestrate.bats mk_config().\n  ALSO: set CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS=1 in the helper when team_mode=teammate (resolve-team-mode.sh needs it).\n\nHelper run_orchestrate():\n  Same pattern as existing dept-orchestrate.bats: run bash \"$SUT\" \"$config\" \"$phase_dir\"\n\nIMPORTANT: Per decision from decisions.jsonl line 20 (02-02/T3), the depts field in wave output changed from string[] to object[]. Each dept entry is now: {\"dept\":\"backend\",\"spawn_strategy\":\"spawnTeam\"|\"task\",\"team_name\":\"yolo-backend\"} (team_name present only when spawn_strategy=spawnTeam). ALL test assertions must use .depts[N].dept for dept name, .depts[N].spawn_strategy for strategy, .depts[N].team_name for team name. Do NOT assert .depts[0] as a bare string.\n\nAlso: The output now includes a top-level team_mode field. Assert via jq -r '.team_mode'.\n\nTest functions (9 total):\n\n@test 'teammate mode: output includes team_mode=teammate':\n  mk_teammate_config true false false backend_only teammate\n  run_orchestrate. assert_success.\n  local tm; tm=$(echo \"$output\" | jq -r '.team_mode')\n  assert_equal \"$tm\" \"teammate\"\n\n@test 'teammate mode: backend-only has spawn_strategy=spawnTeam':\n  mk_teammate_config true false false backend_only teammate\n  run_orchestrate. assert_success.\n  local strategy; strategy=$(echo \"$output\" | jq -r '.waves[0].depts[0].spawn_strategy')\n  assert_equal \"$strategy\" \"spawnTeam\"\n\n@test 'teammate mode: backend-only has team_name=yolo-backend':\n  mk_teammate_config true false false backend_only teammate\n  run_orchestrate. assert_success.\n  local tn; tn=$(echo \"$output\" | jq -r '.waves[0].depts[0].team_name')\n  assert_equal \"$tn\" \"yolo-backend\"\n\n@test 'teammate mode: parallel 3-dept has correct team_names':\n  mk_teammate_config true true true parallel teammate\n  run_orchestrate. assert_success.\n  # Wave 0: uiux\n  local ux_tn; ux_tn=$(echo \"$output\" | jq -r '.waves[0].depts[0].team_name')\n  assert_equal \"$ux_tn\" \"yolo-uiux\"\n  # Wave 1: frontend + backend\n  local fe_tn be_tn\n  fe_tn=$(echo \"$output\" | jq -r '[.waves[1].depts[] | select(.dept==\"frontend\")][0].team_name')\n  be_tn=$(echo \"$output\" | jq -r '[.waves[1].depts[] | select(.dept==\"backend\")][0].team_name')\n  assert_equal \"$fe_tn\" \"yolo-frontend\"\n  assert_equal \"$be_tn\" \"yolo-backend\"\n\n@test 'teammate mode: all depts have spawn_strategy=spawnTeam':\n  mk_teammate_config true true true parallel teammate\n  run_orchestrate. assert_success.\n  # Count depts with spawn_strategy != spawnTeam (should be 0)\n  local bad_count; bad_count=$(echo \"$output\" | jq '[.waves[].depts[] | select(.spawn_strategy != \"spawnTeam\")] | length')\n  assert_equal \"$bad_count\" \"0\"\n\n@test 'task mode: output includes team_mode=task':\n  mk_teammate_config true false false backend_only task\n  run_orchestrate. assert_success.\n  local tm; tm=$(echo \"$output\" | jq -r '.team_mode')\n  assert_equal \"$tm\" \"task\"\n\n@test 'task mode: depts have spawn_strategy=task':\n  mk_teammate_config true true true parallel task\n  run_orchestrate. assert_success.\n  local bad_count; bad_count=$(echo \"$output\" | jq '[.waves[].depts[] | select(.spawn_strategy != \"task\")] | length')\n  assert_equal \"$bad_count\" \"0\"\n\n@test 'task mode: no team_name field present':\n  mk_teammate_config true false false backend_only task\n  run_orchestrate. assert_success.\n  local tn; tn=$(echo \"$output\" | jq -r '.waves[0].depts[0].team_name // \"null\"')\n  assert_equal \"$tn\" \"null\"\n\n@test 'missing team_mode in config defaults to task behavior':\n  # Create config WITHOUT team_mode field (only departments + workflow)\n  mkdir -p \"$TEST_WORKDIR/.yolo-planning\"\n  jq -n '{departments:{backend:true,frontend:false,uiux:false},department_workflow:\"backend_only\"}' > \"$TEST_WORKDIR/.yolo-planning/config.json\"\n  run_orchestrate. assert_success.\n  local tm; tm=$(echo \"$output\" | jq -r '.team_mode')\n  assert_equal \"$tm\" \"task\"\n  local strategy; strategy=$(echo \"$output\" | jq -r '.waves[0].depts[0].spawn_strategy')\n  assert_equal \"$strategy\" \"task\"\n\nPattern notes:\n  - Follow tests/unit/dept-orchestrate.bats exactly for setup/helper structure.\n  - Use jq for all JSON assertions (project convention: never grep/sed on JSON).\n  - Each test is independent (mk_test_workdir in setup creates fresh temp dir).\n  - Export CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS=1 in teammate tests, unset in task tests.\n  - Wave structure assertions (wave count, dept order, gates) are already covered in existing dept-orchestrate.bats -- this file tests ONLY the team_mode extensions.","ts":"File: tests/unit/dept-orchestrate-teammate.bats (this IS the test file)\n\nFramework: BATS with bats-assert, fixtures helpers\n\nTest cases (9):\n  1. 'teammate mode: output includes team_mode=teammate' -- verify top-level team_mode field in JSON output. Happy path.\n  2. 'teammate mode: backend-only has spawn_strategy=spawnTeam' -- verify dept object has spawn_strategy. Happy path.\n  3. 'teammate mode: backend-only has team_name=yolo-backend' -- verify team_name follows yolo-{dept} convention. Happy path.\n  4. 'teammate mode: parallel 3-dept has correct team_names' -- verify yolo-uiux, yolo-frontend, yolo-backend across waves. Multi-dept happy path.\n  5. 'teammate mode: all depts have spawn_strategy=spawnTeam' -- negative count assertion (0 bad entries). Comprehensive check.\n  6. 'task mode: output includes team_mode=task' -- backward compatibility. task mode still works.\n  7. 'task mode: depts have spawn_strategy=task' -- task mode produces task strategy, not spawnTeam.\n  8. 'task mode: no team_name field present' -- team_name only exists in teammate mode.\n  9. 'missing team_mode in config defaults to task behavior' -- edge case: config without team_mode field.\n\nMocking: Uses mk_test_workdir for isolated temp dirs. Creates config.json fixtures inline. Sets/unsets CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS env var.\nAssertions: assert_success, assert_equal, jq-based value extraction.\nCoverage: teammate happy path (3 tests), multi-dept teammate (2 tests), task backward compat (2 tests), edge case (1 test), structure (1 test)."}
{"id":"T3","tp":"auto","a":"Create tests/integration/teammate-mock.bats: mock integration tests that validate pattern consistency. Test 1: all SendMessage schemas referenced in agent files match schemas in handoff-schemas.md. Test 2: all agent Teammate API escalation targets match their hierarchy (tester->senior, qa->lead, etc). Test 3: cross-team-protocol transport table entries match agent Teammate API sections. Test 4: teammate-api-patterns.md registration section includes all Phase 2 agents.","f":["tests/integration/teammate-mock.bats"],"v":"All mock integration tests pass","done":"Mock integration tests created and green, committed","spec":"File: tests/integration/teammate-mock.bats\n\nShebang + header:\n  #!/usr/bin/env bats\n  # teammate-mock.bats -- Integration tests validating cross-file pattern consistency\n  # Verifies that agent Teammate API sections, handoff-schemas.md, cross-team-protocol.md,\n  # and teammate-api-patterns.md are all mutually consistent.\n\nsetup():\n  load '../test_helper/common'\n  # Uses $PROJECT_ROOT, $AGENTS_DIR from common.bash\n  REFS_DIR=\"$PROJECT_ROOT/references\"\n  SCHEMAS=\"$REFS_DIR/handoff-schemas.md\"\n  CROSS_TEAM=\"$REFS_DIR/cross-team-protocol.md\"\n  PATTERNS=\"$REFS_DIR/teammate-api-patterns.md\"\n\nTest functions (10 total):\n\n--- Group 1: Schema references match handoff-schemas.md ---\n\n@test 'all SendMessage schema types referenced in agents exist in handoff-schemas.md':\n  Extract all schema type names from agents that have Teammate API sections.\n  For each agent file in agents/yolo-*.md containing '## Teammate API':\n    grep for '\"type\": \"' or '\"type\":\"' patterns within the Teammate API section.\n    Extract the type values (e.g., dev_progress, dev_blocker, test_plan_result, etc.).\n  For each unique type found: run grep -c \"$type\" \"$SCHEMAS\"; assert_success.\n  Concrete types expected: dev_progress, dev_blocker, test_plan_result, architecture_design, senior_spec, code_review_result, code_review_changes, qa_result, qa_code_result, security_audit, shutdown_request, shutdown_response, escalation.\n  Implementation approach: use a TYPES array of known schema types, loop and verify each exists in both agent files AND handoff-schemas.md.\n\n@test 'handoff-schemas.md test_plan_result header says Tester -> Senior (not Lead)':\n  run grep 'test_plan_result' \"$SCHEMAS\"\n  assert_success\n  assert_output --partial 'Tester -> Senior'\n  # Negative: must NOT say Tester -> Lead\n  run grep 'test_plan_result.*Tester -> Lead' \"$SCHEMAS\"\n  assert_failure\n\n--- Group 2: Escalation targets match hierarchy ---\n\nDefine expected escalation mapping at file-level:\n  declare -A ESCALATION_MAP=(\n    [yolo-tester.md]=\"Senior\"      [yolo-fe-tester.md]=\"FE Senior\"      [yolo-ux-tester.md]=\"UX Senior\"\n    [yolo-dev.md]=\"Senior\"          [yolo-fe-dev.md]=\"FE Senior\"         [yolo-ux-dev.md]=\"UX Senior\"\n    [yolo-senior.md]=\"Lead\"         [yolo-fe-senior.md]=\"FE Lead\"        [yolo-ux-senior.md]=\"UX Lead\"\n    [yolo-architect.md]=\"Lead\"      [yolo-fe-architect.md]=\"FE Lead\"     [yolo-ux-architect.md]=\"UX Lead\"\n    [yolo-qa.md]=\"Lead\"             [yolo-fe-qa.md]=\"FE Lead\"            [yolo-ux-qa.md]=\"UX Lead\"\n    [yolo-qa-code.md]=\"Lead\"        [yolo-fe-qa-code.md]=\"FE Lead\"       [yolo-ux-qa-code.md]=\"UX Lead\"\n    [yolo-security.md]=\"Lead\"\n  )\n  Note: yolo-owner.md and yolo-lead.md/yolo-fe-lead.md/yolo-ux-lead.md are excluded -- Leads have no SendMessage escalation target (they ARE the team lead), Owner is not in any team.\n\n@test 'tester agents SendMessage target is Senior (all 3 depts)':\n  for agent in yolo-tester.md yolo-fe-tester.md yolo-ux-tester.md; do\n    # Check Reports to: line contains Senior (not Lead)\n    run grep 'Reports to:' \"$AGENTS_DIR/$agent\"\n    assert_success\n    assert_output --partial 'Senior'\n  done\n\n@test 'dev agents SendMessage target is Senior (all 3 depts)':\n  for agent in yolo-dev.md yolo-fe-dev.md yolo-ux-dev.md; do\n    run grep 'Reports to:' \"$AGENTS_DIR/$agent\"\n    assert_success\n    assert_output --partial 'Senior'\n  done\n\n@test 'qa and qa-code agents SendMessage target is Lead (all 3 depts)':\n  for agent in yolo-qa.md yolo-fe-qa.md yolo-ux-qa.md yolo-qa-code.md yolo-fe-qa-code.md yolo-ux-qa-code.md; do\n    run grep 'Reports to:' \"$AGENTS_DIR/$agent\"\n    assert_success\n    assert_output --partial 'Lead'\n  done\n\n@test 'security agent SendMessage target is Lead':\n  run grep 'Reports to:' \"$AGENTS_DIR/yolo-security.md\"\n  assert_success\n  assert_output --partial 'Lead'\n\n--- Group 3: Cross-team-protocol transport table consistency ---\n\n@test 'cross-team-protocol documents SendMessage for intra-department in teammate mode':\n  run grep 'SendMessage within team' \"$CROSS_TEAM\"\n  assert_success\n\n@test 'cross-team-protocol documents file-based for cross-department in teammate mode':\n  run grep -c 'File-based.*UNCHANGED' \"$CROSS_TEAM\"\n  assert_success\n  # At least 2 entries: Lead->Lead and Lead->Owner\n  [ \"$output\" -ge 2 ]\n\n--- Group 4: teammate-api-patterns.md completeness ---\n\n@test 'teammate-api-patterns.md documents Task-Only Agents section':\n  run grep 'Task-Only Agents' \"$PATTERNS\"\n  assert_success\n  # Verify all 3 excluded agents mentioned\n  run grep -c 'critic\\|scout\\|debugger' \"$PATTERNS\"\n  assert_success\n  [ \"$output\" -ge 3 ]\n\n@test 'teammate-api-patterns.md documents on-demand registration with step numbers':\n  # Verify step-to-role mapping documented\n  run grep 'step 5' \"$PATTERNS\"\n  assert_success\n  run grep 'step 8' \"$PATTERNS\"\n  assert_success\n  run grep 'step 9' \"$PATTERNS\"\n  assert_success\n\nPattern notes:\n  - Follow tests/integration/ pattern (e.g., hook-chain.bats): setup loads common, tests validate cross-file consistency.\n  - Use grep for content matching on markdown files (no jq needed, these are .md files).\n  - Tests validate CONSISTENCY between files, not file content in isolation (that is static test territory).\n  - Each test should have clear failure messages. Use assert_output --partial for content checks.\n  - The declare -A (associative array) for ESCALATION_MAP is informational/documentary only -- the actual test functions do explicit per-agent grep checks for clarity and debuggability rather than looping the map.","ts":"File: tests/integration/teammate-mock.bats (this IS the test file)\n\nFramework: BATS with bats-assert loaded via common.bash\n\nTest cases (10):\n  Group 1 - Schema consistency (2 tests):\n    1. 'all SendMessage schema types referenced in agents exist in handoff-schemas.md' -- cross-reference schema type strings between agent files and handoff-schemas.md. Happy path: all types found in both.\n    2. 'handoff-schemas.md test_plan_result header says Tester -> Senior (not Lead)' -- C3 resolution verification. Positive + negative assertion.\n  Group 2 - Escalation targets (4 tests):\n    3. 'tester agents SendMessage target is Senior (all 3 depts)' -- 3 agent files checked. Happy path: all say Senior.\n    4. 'dev agents SendMessage target is Senior (all 3 depts)' -- 3 agent files checked.\n    5. 'qa and qa-code agents SendMessage target is Lead (all 3 depts)' -- 6 agent files checked.\n    6. 'security agent SendMessage target is Lead' -- 1 agent file.\n  Group 3 - Cross-team-protocol (2 tests):\n    7. 'cross-team-protocol documents SendMessage for intra-department in teammate mode' -- transport table consistency.\n    8. 'cross-team-protocol documents file-based for cross-department in teammate mode' -- verifies UNCHANGED file-based cross-dept.\n  Group 4 - teammate-api-patterns.md (2 tests):\n    9. 'teammate-api-patterns.md documents Task-Only Agents section' -- C5 resolution check, verifies critic/scout/debugger mentioned.\n    10. 'teammate-api-patterns.md documents on-demand registration with step numbers' -- C7 resolution check, verifies steps 5/8/9.\n\nMocking: None needed. Integration tests read real project files.\nAssertions: assert_success, assert_failure, assert_output --partial, numeric comparison on grep -c output.\nCoverage: schema consistency (cross-file), hierarchy consistency (agent files vs docs), transport table (cross-team-protocol), completeness (patterns doc)."}
{"id":"T4","tp":"auto","a":"Run full regression test suite (all 957+ tests) to confirm zero regression. Fix any failures found in Phase 2 changes. Document test count in summary.","f":[],"v":"All tests pass: 957+ existing + new Phase 2 tests","done":"Full regression passes with zero failures, test count documented","spec":"No test file to create. This task is a verification-only task.\n\nSteps:\n1. Run full test suite: find tests -name '*.bats' -exec bats {} + (from $PROJECT_ROOT)\n   Alternative: bats tests/static/ tests/unit/ tests/integration/ tests/containment/ tests/perf/\n   (list all test directories explicitly to ensure none are missed)\n2. Capture output. Assert exit code 0 (all tests pass).\n3. Count total tests from output (bats reports 'N tests, 0 failures').\n4. If ANY test fails:\n   a. Identify root cause (Phase 2 change or pre-existing).\n   b. Fix the failing test or the code it tests (one commit per fix, type: fix).\n   c. Re-run full suite to confirm fix.\n   d. Repeat until zero failures.\n5. Document final test count in the plan summary (02-04.summary.jsonl).\n   Expected: 957 + (8 from T1) + (9 from T2) + (10 from T3) = 984+ tests total.\n   The exact count will vary if other Phase 2 plans added tests.\n\nSpecific regression risks to watch:\n  - tests/unit/dept-orchestrate.bats: 8 existing tests assert .depts[0] as string.\n    Per decisions.jsonl line 21, these were updated in plan 02-02 T3 to use .depts[0].dept.\n    If 02-02 T3 was incomplete, these 8 tests will fail. Fix: update assertions.\n  - tests/static/protocol-file-coord-refs.bats: test 10 ('spawnTeam in protocol files') asserts\n    spawnTeam does NOT appear in cross-team-protocol.md. If 02-03 T3 added spawnTeam text\n    to cross-team-protocol.md, this test may fail. Fix: verify the text is in a teammate mode\n    context section, not in the general body.\n  - tests/unit/resolve-team-mode.bats: should be unaffected (no changes to resolve-team-mode.sh in Phase 2).\n\nCommit: Only if fixes are needed. Commit message: fix(02-department-teams): resolve regression in {test-file}","ts":""}
