{"p":"02-03","n":"Protocol and Documentation Updates","t":4,"w":2,"d":["02-01","02-02"],"mh":{"tr":["execute-protocol.md Multi-Department Execution section documents background Task subagent spawning, polling loops, and gate mechanics","multi-dept-protocol.md Phase Execution replaces placeholder parallelism with concrete file-based coordination mechanism","cross-team-protocol.md handoff gates reference dept-gate.sh with exact file paths and validation commands","company-hierarchy.md notes background Task subagent approach for parallel execution","All protocol docs preserve single-dept Task tool path unchanged","No references to spawnTeam, SendMessage, or Teammate API in coordination context"],"ar":[{"p":"references/execute-protocol.md","pv":"grep -c 'dept-orchestrate.sh' references/execute-protocol.md returns at least 1","c":"execute-protocol references dept-orchestrate.sh for spawn plan generation"},{"p":"references/multi-dept-protocol.md","pv":"grep -c 'dept-status' references/multi-dept-protocol.md returns at least 2","c":"multi-dept-protocol references dept-status.sh for status tracking and dept-status-{dept}.json files"},{"p":"references/cross-team-protocol.md","pv":"grep -c 'dept-gate.sh' references/cross-team-protocol.md returns at least 3","c":"cross-team-protocol references dept-gate.sh for each of the 3 handoff gates"},{"p":"references/company-hierarchy.md","pv":"grep -c 'background Task subagent' references/company-hierarchy.md returns at least 1","c":"company-hierarchy documents background Task subagent approach"}],"kl":[{"fr":"references/execute-protocol.md","to":"scripts/dept-orchestrate.sh","vi":"execute-protocol instructs go.md to call dept-orchestrate.sh for spawn plan"},{"fr":"references/multi-dept-protocol.md","to":"references/cross-team-protocol.md","vi":"multi-dept dispatch references cross-team handoff gates for file-based coordination"},{"fr":"references/execute-protocol.md","to":"scripts/dept-cleanup.sh","vi":"execute-protocol instructs cleanup on phase completion or failure"}]},"obj":"Update 4 protocol and documentation files to replace placeholder parallelism and Teammate API references with concrete file-based coordination using background Task subagents, sentinel files, and the new coordination scripts.","sk":["commit"],"fm":["references/execute-protocol.md","references/multi-dept-protocol.md","references/cross-team-protocol.md","references/company-hierarchy.md","tests/static/protocol-file-coord-refs.bats"]}
{"id":"02-03-01","n":"Update execute-protocol.md for file-based orchestration","f":["references/execute-protocol.md"],"d":[],"ac":["Multi-Department Execution section expanded with inline orchestration instructions","Documents: dept-orchestrate.sh call to get spawn plan JSON","Documents: spawn department Leads as background Task subagents (run_in_background=true)","Documents: polling loop pattern (while + sleep 0.5 + file existence check + timeout guard)","Documents: dept-gate.sh invocation for each handoff gate","Documents: dept-cleanup.sh call on completion or failure","Documents: .phase-orchestration.json creation and schema","Step 10 Sign-off updated: includes dept-cleanup.sh call for multi-dept cleanup","Execution State Transitions table: notes .phase-orchestration.json as additional state file when multi_dept=true","Existing single-dept Task tool path preserved verbatim, no changes to Steps 1-10 for single-dept","REQ-03 mapped in orchestration section"],"spec":"FILE: references/execute-protocol.md\n\nSECTION 1 — Multi-Department Execution (lines 396-411).\nReplace the ENTIRE section from '## Multi-Department Execution' through the end of the file (before '## Output Format') with the expanded version below. Preserve the '## Output Format' section at the very end UNCHANGED.\n\nThe replacement text for ## Multi-Department Execution must contain these subsections IN ORDER:\n\n### Detection paragraph (keep existing first line):\n**Detection:** `multi_dept` from resolve-departments.sh. If false: skip this section entirely. All Steps 1-10 above apply to single-dept unchanged.\n\n### Orchestration subsection (NEW):\n**When multi_dept=true:**\n\n1. **Generate spawn plan:**\n   ```bash\n   SPAWN_PLAN=$(bash ${CLAUDE_PLUGIN_ROOT}/scripts/dept-orchestrate.sh \\\n     --config .yolo-planning/config.json --phase-dir {phase-dir})\n   ```\n   Returns JSON: `{\"waves\":[{\"id\":1,\"depts\":[\"uiux\"],\"gate\":\"handoff-ux-complete\"},{\"id\":2,\"depts\":[\"frontend\",\"backend\"],\"gate\":\"all-depts-complete\"}],\"timeout_minutes\":30}`\n\n2. **Create orchestration state:**\n   Write `.phase-orchestration.json` to phase directory with schema:\n   ```json\n   {\n     \"phase\": \"{N}\",\n     \"multi_dept\": true,\n     \"workflow\": \"parallel\",\n     \"departments\": {\n       \"uiux\": {\"status\":\"pending\",\"step\":\"\",\"started\":\"\",\"completed\":\"\"},\n       \"frontend\": {\"status\":\"pending\",\"step\":\"\",\"started\":\"\",\"completed\":\"\"},\n       \"backend\": {\"status\":\"pending\",\"step\":\"\",\"started\":\"\",\"completed\":\"\"}\n     },\n     \"gates\": {\n       \"ux-complete\": {\"status\":\"pending\",\"passed_at\":\"\"},\n       \"api-contract\": {\"status\":\"pending\",\"passed_at\":\"\"},\n       \"all-depts\": {\"status\":\"pending\",\"passed_at\":\"\"}\n     },\n     \"integration_qa\": {\"status\":\"pending\"},\n     \"security\": {\"status\":\"pending\"},\n     \"owner_signoff\": {\"status\":\"pending\"},\n     \"started_at\": \"ISO8601\",\n     \"timeout_minutes\": 30\n   }\n   ```\n   Commit: `chore(state): orchestration state phase {N}`\n\n3. **Spawn department Leads per wave:**\n   For each wave in spawn plan, spawn department Leads as **background Task subagents** (`run_in_background=true`):\n   ```\n   For each dept in wave.depts:\n     Spawn {dept} Lead as Task subagent:\n       - run_in_background: true\n       - model: resolved via resolve-agent-model.sh for {dept}-lead role\n       - Provide: dept CONTEXT file, phase-dir, ROADMAP.md, REQUIREMENTS.md\n       - Lead runs full 10-step workflow using foreground Task subagents internally\n       - On completion: Lead writes .dept-status-{dept}.json via dept-status.sh\n       - On completion: Lead writes handoff sentinel (e.g., .handoff-ux-complete)\n   ```\n\n4. **Poll for gate satisfaction:**\n   After spawning a wave, enter polling loop:\n   ```bash\n   # Polling loop pattern (per-gate)\n   ELAPSED=0\n   TIMEOUT=$((TIMEOUT_MINUTES * 60))\n   while ! bash ${CLAUDE_PLUGIN_ROOT}/scripts/dept-gate.sh \\\n     --gate {gate-name} --phase-dir {phase-dir} --no-poll; do\n     sleep 0.5\n     ELAPSED=$((ELAPSED + 1))\n     if [ \"$ELAPSED\" -ge \"$((TIMEOUT * 2))\" ]; then\n       echo \"TIMEOUT: Gate {gate-name} not satisfied after ${TIMEOUT_MINUTES}m\"\n       bash ${CLAUDE_PLUGIN_ROOT}/scripts/dept-cleanup.sh \\\n         --phase-dir {phase-dir} --reason timeout\n       STOP with per-department status report\n     fi\n   done\n   ```\n   Interval: 500ms (sleep 0.5). Timeout: configurable (default 30 minutes).\n\n5. **On all departments complete:**\n   - Verify via `dept-gate.sh --gate all-depts --phase-dir {phase-dir}`\n   - Proceed to Integration QA (foreground, Step 8 equivalent)\n   - Proceed to Security audit (foreground, Step 9 equivalent)\n   - Proceed to Owner sign-off (Step 10)\n\n6. **Cleanup on completion or failure:**\n   ```bash\n   bash ${CLAUDE_PLUGIN_ROOT}/scripts/dept-cleanup.sh \\\n     --phase-dir {phase-dir} --reason {complete|failure|timeout}\n   ```\n   Removes: .dept-status-*.json, .handoff-*, .dept-lock-*, .phase-orchestration.json\n\n### References paragraph (keep existing cross-references, update text):\n**Full protocol details:** @references/multi-dept-protocol.md for dispatch flow and coordination files. @references/cross-team-protocol.md for handoff gate definitions. REQ-03: Multi-department orchestration via file-based coordination.\n\n### Execution state extension paragraph:\n**Execution state extension:** `.execution-state.json` gains `departments` object when multi_dept=true, mirroring `.phase-orchestration.json` department statuses for resume support.\n\nSECTION 2 — Step 10 Sign-off (lines 338-375).\nIn Step 10 item 4, the existing text says: '**Shutdown teammates:** Send shutdown to each, wait for approval, clean up.'\nReplace that SINGLE line (item 4) with:\n'4. **Cleanup:** If multi_dept=true, run `bash ${CLAUDE_PLUGIN_ROOT}/scripts/dept-cleanup.sh --phase-dir {phase-dir} --reason complete` to remove coordination files. If single-dept: no additional cleanup.'\nPreserve items 1-3 and 5-8 of Step 10 UNCHANGED.\n\nSECTION 3 — Execution State Transitions table (lines 377-394).\nAfter the last row (Step 10) of the table, add a new NOTE paragraph:\n'**Multi-department note:** When `multi_dept=true`, `.phase-orchestration.json` is created alongside `.execution-state.json` and tracks per-department status and gate state. See ## Multi-Department Execution above for schema.'\n\nDO NOT MODIFY: Lines 1-395 (Steps 1-9, Pre-Execution, Verification Gates, Context Scoping) except for the Step 10 item 4 change described above. The single-dept 10-step workflow is preserved verbatim.\n\nALSO DO NOT MODIFY: The '## Output Format' section at the very end of the file. Keep it exactly as-is.","ts":"FILE: tests/static/protocol-file-coord-refs.bats\nTests 1-4 cover this task (execute-protocol.md assertions).\n\nTest 1: 'execute-protocol.md references dept-orchestrate.sh'\n  run grep -c 'dept-orchestrate.sh' \"$PROJECT_ROOT/references/execute-protocol.md\"\n  assert_success\n  [ \"$output\" -ge 1 ]\n\nTest 2: 'execute-protocol.md references dept-cleanup.sh'\n  run grep -c 'dept-cleanup.sh' \"$PROJECT_ROOT/references/execute-protocol.md\"\n  assert_success\n  [ \"$output\" -ge 1 ]\n\nTest 3: 'execute-protocol.md references run_in_background'\n  run grep -c 'run_in_background' \"$PROJECT_ROOT/references/execute-protocol.md\"\n  assert_success\n  [ \"$output\" -ge 1 ]\n\nTest 4: 'execute-protocol.md preserves single-dept Task tool path'\n  run grep 'Task tool' \"$PROJECT_ROOT/references/execute-protocol.md\"\n  assert_success"}
{"id":"02-03-02","n":"Update multi-dept-protocol.md for concrete mechanism","f":["references/multi-dept-protocol.md"],"d":["02-03-01"],"ac":["Phase Execution section: replaces 'Run in PARALLEL' with concrete background Task subagent mechanism","New section: Coordination Files -- lists all file types (.dept-status-{dept}.json, .handoff-*, .dept-lock-*, .phase-orchestration.json) with schemas","New section: Polling Mechanism -- documents interval (500ms), timeout (configurable), error handling","New section: Cleanup -- when and what dept-cleanup.sh removes","Per-Department 10-Step Execution: each dept Lead spawned as background Task subagent, runs foreground Task subagents internally","Integration QA section: uses dept-gate.sh --gate all-depts to verify all departments complete","Owner Sign-off: references dept-cleanup.sh for post-phase cleanup","Removes any references to spawnTeam or SendMessage for coordination purposes"],"spec":"FILE: references/multi-dept-protocol.md\n\nPRESERVE UNCHANGED:\n- Lines 1-3 (title + intro paragraph)\n- Lines 5-12 (## Pre-Execution Extensions section)\n- Lines 14-15 (## Phase Execution heading + subheading)\n- Lines 86-97 (### Cross-Department Artifact Exchange table)\n- Lines 131-152 (## Display Format section)\n\nSECTION 1 — Phase Execution: Step 0 (lines 16-44).\nKeep Step 0 (Step 0a + Step 0b) EXACTLY as-is. No changes to Owner Context Gathering or Critique Review.\n\nSECTION 2 — Context Delegation Protocol (lines 42-44).\nKeep EXACTLY as-is.\n\nSECTION 3 — Step 1-10: Department Dispatch (lines 46-78).\nReplace the 'parallel' workflow code block (lines 48-68) with a concrete version. The replacement must:\n\na) Replace the text 'Run in PARALLEL' (line 59) with 'Run as parallel background Task subagents (run_in_background=true)'.\n\nb) Replace the bare code block (lines 50-68) with this expanded version:\n```\n1. UI/UX Department: Spawned as background Task subagent\n   ├── run_in_background: true\n   ├── Steps 1-10: Critique -> ... -> Sign-off (foreground Task subagents internally)\n   ├── Produce: design-handoff.jsonl, design-tokens.jsonl, component-specs.jsonl\n   └── On completion: write .dept-status-uiux.json + .handoff-ux-complete sentinel\n\n2. HANDOFF GATE: dept-gate.sh --gate ux-complete --phase-dir {phase-dir}\n   Validates: .handoff-ux-complete exists + design artifacts valid\n\n3. Frontend + Backend: Spawned as parallel background Task subagents\n   ├── Frontend: run_in_background=true, reads UX handoff artifacts\n   ├── Backend: run_in_background=true, independent execution\n   ├── Each writes .dept-status-{dept}.json on completion\n   └── go.md polls via dept-gate.sh --gate all-depts\n\n4. API CONTRACT GATE: dept-gate.sh --gate api-contract --phase-dir {phase-dir}\n   Non-blocking: FE and BE negotiate async via api-contracts.jsonl with flock\n\n5. Integration QA: dept-gate.sh --gate all-depts verifies all departments complete\n   Then runs cross-department verification (foreground)\n\n6. Security: Shared Security audits all departments (foreground)\n\n7. Owner Sign-off: Final review\n   On completion: bash dept-cleanup.sh --phase-dir {phase-dir} --reason complete\n```\n\nc) Keep the 'sequential' and 'backend_only' blocks (lines 70-78) as-is.\n\nSECTION 4 — Per-Department 10-Step Execution (lines 80-86).\nReplace the paragraph (lines 82-86) with:\n'Each department runs the same 10-step workflow from `execute-protocol.md`. Department Leads are spawned as **background Task subagents** (`run_in_background=true`) by go.md. Internally, each Lead spawns its specialists (Critic, Architect, Senior, Dev, etc.) as **foreground Task subagents** — the same proven single-agent workflow. The only change is the outer spawning mechanism; the inner 10-step is identical to single-dept mode.'\nThen keep the bullet list of department-specific items (agents, context, architecture file, artifact schemas).\n\nSECTION 5 — NEW SECTION: ## Coordination Files.\nInsert AFTER the Cross-Department Artifact Exchange section (after line 97) and BEFORE the Integration QA section. Contents:\n\n'## Coordination Files\n\nAll coordination files live in the phase directory. Created by dept-status.sh and dept-gate.sh. Cleaned up by dept-cleanup.sh.\n\n| File Pattern | Purpose | Schema | Written By |\n|---|---|---|---|\n| `.dept-status-{dept}.json` | Per-department status tracking | `{\"dept\":\"backend\",\"status\":\"running\",\"step\":\"implementation\",\"started_at\":\"ISO\",\"updated_at\":\"ISO\",\"plans_complete\":2,\"plans_total\":3,\"error\":\"\"}` | dept-status.sh (called by dept Lead) |\n| `.handoff-ux-complete` | Sentinel: UX workflow finished | Empty file (existence = gate passed) | UX Lead on Step 10 completion |\n| `.handoff-api-contract` | Sentinel: API contract agreed | Empty file | BE Lead after api-contracts.jsonl agreed |\n| `.dept-lock-{dept}` | flock lockfile for atomic status writes | N/A (flock internal) | dept-status.sh |\n| `.phase-orchestration.json` | Master orchestration state | See execute-protocol.md ## Multi-Department Execution | go.md at orchestration start |\n\nAll coordination files are prefixed with `.` (hidden) to distinguish from user artifacts.'\n\nSECTION 6 — NEW SECTION: ## Polling Mechanism.\nInsert after ## Coordination Files:\n\n'## Polling Mechanism\n\ngo.md polls for gate satisfaction using a simple loop:\n\n- **Interval:** 500ms (`sleep 0.5`)\n- **Timeout:** Configurable, default 30 minutes per gate. Read from spawn plan JSON `timeout_minutes` field.\n- **Check method:** `bash dept-gate.sh --gate {name} --phase-dir {dir} --no-poll` — single check, exit 0 if satisfied, exit 1 if not.\n- **Timeout handling:** After elapsed seconds exceed `timeout_minutes * 60`, STOP with error. Run `dept-cleanup.sh --phase-dir {dir} --reason timeout`. Display per-department status report (read each .dept-status-{dept}.json for current step and error).\n- **Error handling:** If dept-gate.sh exits 2 (gate check error, e.g., corrupt status file), STOP with error. Run dept-cleanup.sh --reason failure.'\n\nSECTION 7 — NEW SECTION: ## Cleanup.\nInsert after ## Polling Mechanism:\n\n'## Cleanup\n\nRun `bash dept-cleanup.sh --phase-dir {phase-dir} --reason {reason}` at:\n- Phase completion (reason=complete): after Owner sign-off\n- Gate timeout (reason=timeout): after any polling timeout\n- Failure (reason=failure): after any unrecoverable error\n\nRemoves: `.dept-status-*.json`, `.handoff-*`, `.dept-lock-*`, `.phase-orchestration.json`\nPreserves: All user artifacts (plan.jsonl, summary.jsonl, architecture.toon, etc.)'\n\nSECTION 8 — Integration QA (lines 98-110).\nKeep existing content. Add at the START of the section (after the heading, before item 1):\n'**Gate check:** Before running Integration QA, verify all departments are complete via `bash dept-gate.sh --gate all-depts --phase-dir {phase-dir}`. This validates every active department has `.dept-status-{dept}.json` with `status: \"complete\"` and at least one summary.jsonl.'\n\nSECTION 9 — Owner Sign-off Process (lines 115-130).\nKeep items 1-4. After item 5, add item 6:\n'6. Run `bash dept-cleanup.sh --phase-dir {phase-dir} --reason complete` to remove coordination files.'\n\nSECTION 10 — Execution State Extensions (lines 131-133).\nReplace the brief paragraph with:\n'## Execution State Extensions\n\n`.execution-state.json` gains `departments` object when multi_dept=true:\n```json\n\"departments\": {\n  \"uiux\": {\"status\":\"complete\",\"step\":\"signoff\"},\n  \"frontend\": {\"status\":\"running\",\"step\":\"implementation\"},\n  \"backend\": {\"status\":\"running\",\"step\":\"code_review\"}\n}\n```\nMirrored from `.phase-orchestration.json`. Updated by state-updater.sh on each plan/summary write. See `execute-protocol.md ## Multi-Department Execution` for full `.phase-orchestration.json` schema.'\n\nNEGATIVE CONSTRAINTS:\n- Do NOT add references to spawnTeam, SendMessage, or Teammate API anywhere in this file.\n- Do NOT remove or modify the Display Format section.\n- Do NOT change the sequential or backend_only workflow descriptions (they are unaffected by this architecture).","ts":"FILE: tests/static/protocol-file-coord-refs.bats\nTests 5-6 cover this task (multi-dept-protocol.md assertions).\n\nTest 5: 'multi-dept-protocol.md contains dept-status references'\n  run grep -c 'dept-status' \"$PROJECT_ROOT/references/multi-dept-protocol.md\"\n  assert_success\n  [ \"$output\" -ge 2 ]\n\nTest 6: 'multi-dept-protocol.md contains Coordination Files section'\n  run grep 'Coordination Files' \"$PROJECT_ROOT/references/multi-dept-protocol.md\"\n  assert_success"}
{"id":"02-03-03","n":"Update cross-team-protocol.md and company-hierarchy.md","f":["references/cross-team-protocol.md","references/company-hierarchy.md"],"d":["02-03-01"],"ac":["cross-team-protocol.md Gate 1 (UX -> FE+BE): references dept-gate.sh --gate ux-complete with exact validation commands","cross-team-protocol.md Gate 2 (FE <-> BE API Contract): references dept-gate.sh --gate api-contract","cross-team-protocol.md Gate 3 (Integration QA): references dept-gate.sh --gate all-depts","Each gate documents: sentinel file path, validation checks, timeout, failure handling","Gate validation bash examples updated to use dept-gate.sh instead of direct jq checks","company-hierarchy.md Multi-Department Structure section: adds note that parallel execution uses background Task subagents (run_in_background=true), not Teammate API","company-hierarchy.md: notes coordination via file-based gates (.dept-status-{dept}.json, .handoff-* sentinels)","Both files: no behavioral changes, documentation-only updates"],"spec":"FILE 1: references/cross-team-protocol.md\n\nPRESERVE UNCHANGED:\n- Lines 1-75 (everything before ## Handoff Gates): title, Department Execution Order diagram, Workflow Modes table, Communication Rules, Context Isolation Rules. ALL unchanged.\n- Lines 132-149 (## Conflict Resolution, ## Handoff Artifact Schemas): ALL unchanged.\n\nSECTION 1 — Gate 1: UI/UX -> Frontend + Backend (lines 78-95).\nKeep the heading, trigger paragraph, and required artifacts list UNCHANGED.\nReplace the **Validation** bash block (lines 88-93) with:\n```bash\n# Automated gate check via dept-gate.sh\nbash ${CLAUDE_PLUGIN_ROOT}/scripts/dept-gate.sh \\\n  --gate ux-complete --phase-dir {phase-dir} --no-poll\n# Exit 0: gate satisfied (sentinel exists + artifacts valid)\n# Exit 1: gate not satisfied\n# Exit 2: validation error\n\n# dept-gate.sh internally validates:\n# - .handoff-ux-complete sentinel file exists\n# - design-handoff.jsonl exists with status: \"complete\"\n# - design-tokens.jsonl exists\n# - component-specs.jsonl exists with all status: \"ready\"\n```\n\nKeep the 'If gate fails' paragraph (line 95) UNCHANGED.\n\nAfter the 'If gate fails' paragraph, add:\n'**Timeout:** 30 minutes (configurable). On timeout: `dept-cleanup.sh --phase-dir {phase-dir} --reason timeout`. UX Lead must resolve.'\n\nSECTION 2 — Gate 2: Frontend <-> Backend API Contract (lines 97-107).\nKeep heading, trigger, and workflow steps 1-4 UNCHANGED.\nKeep 'If conflict' paragraph UNCHANGED.\nAfter the 'If conflict' paragraph, add:\n'**Validation:** `bash dept-gate.sh --gate api-contract --phase-dir {phase-dir} --no-poll`. Checks api-contracts.jsonl has at least one entry with `status: \"agreed\"`. Non-blocking gate — FE and BE proceed in parallel and negotiate async. Both use flock locking via dept-status.sh for atomic writes to api-contracts.jsonl.'\n\nSECTION 3 — Gate 3: Integration QA (lines 109-119).\nKeep heading and trigger UNCHANGED.\nReplace the **Required** section (lines 113-119) with:\n'**Gate check:**\n```bash\nbash ${CLAUDE_PLUGIN_ROOT}/scripts/dept-gate.sh \\\n  --gate all-depts --phase-dir {phase-dir} --no-poll\n# Validates:\n# - Every active department has .dept-status-{dept}.json with status: \"complete\"\n# - Every department has at least one summary.jsonl\n```\n\n**Required after gate passes:**\n- Cross-department integration points tested:\n  - Frontend consumes Backend API correctly\n  - Frontend renders UI/UX design tokens correctly\n  - Backend validates data shapes Frontend sends\n\n**Timeout:** 60 minutes (configurable). On timeout: display per-department status report from .dept-status-{dept}.json files.'\n\nSECTION 4 — Gate 4: Owner Sign-off (lines 120-130).\nKeep ENTIRELY unchanged.\n\nSECTION 5 — Communication Rules line 68.\nThe existing line 68 says: 'No ad-hoc SendMessage between departments -- use defined schemas.'\nReplace with: 'No ad-hoc messaging between departments -- all cross-department data passes through handoff artifacts and file-based gates.'\nThis is the only SendMessage reference in this file and it should be removed.\n\nFILE 2: references/company-hierarchy.md\n\nPRESERVE UNCHANGED:\n- Lines 1-183 (everything before ## Multi-Department Structure)\n- Lines 199-234 (## Resume Protocol, ## Command Routing Table, everything after Multi-Department Structure)\n\nSECTION 1 — Multi-Department Structure (lines 184-197).\nKeep the existing content (lines 184-197) UNCHANGED. After the last paragraph ('Each department runs the same 10-step workflow independently...', line 197), add TWO new paragraphs:\n\nParagraph 1:\n'**Parallel execution model:** When `department_workflow` = \"parallel\", department Leads are spawned as **background Task subagents** (`run_in_background=true`). go.md orchestrates wave-based dispatch: UX first (if active), then FE + BE in parallel after the UX handoff gate passes. Each Lead runs its full 10-step workflow using foreground Task subagents internally. This uses the proven Task tool architecture -- no Teammate API (spawnTeam/SendMessage) dependency.'\n\nParagraph 2:\n'**File-based coordination:** Cross-department synchronization uses file-based gates in the phase directory: `.dept-status-{dept}.json` for per-department status tracking, `.handoff-*` sentinel files for handoff gates, and `.phase-orchestration.json` for master orchestration state. All writes are atomic via flock locking in `scripts/dept-status.sh`. See `references/multi-dept-protocol.md` for coordination file schemas and `references/cross-team-protocol.md` for gate validation commands.'\n\nDo NOT modify the ### Department Escalation subsection (lines 199-205).","ts":"FILE: tests/static/protocol-file-coord-refs.bats\nTests 7-8 cover this task (cross-team-protocol.md and company-hierarchy.md assertions).\n\nTest 7: 'cross-team-protocol.md references dept-gate.sh at least 3 times'\n  run grep -c 'dept-gate.sh' \"$PROJECT_ROOT/references/cross-team-protocol.md\"\n  assert_success\n  [ \"$output\" -ge 3 ]\n\nTest 8: 'company-hierarchy.md references background Task subagent'\n  run grep 'background Task subagent' \"$PROJECT_ROOT/references/company-hierarchy.md\"\n  assert_success"}
{"id":"02-03-04","n":"Write protocol validation tests","f":["tests/static/protocol-file-coord-refs.bats"],"d":["02-03-01","02-03-02","02-03-03"],"ac":["tests/static/protocol-file-coord-refs.bats has minimum 8 tests","Tests: execute-protocol.md contains dept-orchestrate.sh reference","Tests: execute-protocol.md contains dept-cleanup.sh reference","Tests: execute-protocol.md contains run_in_background reference","Tests: multi-dept-protocol.md contains dept-status reference","Tests: multi-dept-protocol.md contains Coordination Files section","Tests: cross-team-protocol.md contains dept-gate.sh reference (at least 3 occurrences)","Tests: company-hierarchy.md contains background Task subagent reference","Tests: execute-protocol.md preserves existing single-dept Task tool path (grep for 'Task tool' returns match)","All tests use grep/file-content assertions on protocol files","All tests pass with bats"],"spec":"FILE: tests/static/protocol-file-coord-refs.bats (CREATE NEW FILE)\n\nFollow existing bats test patterns from tests/static/convention-compliance.bats and tests/static/department-agents.bats.\n\nFILE STRUCTURE:\n```bash\n#!/usr/bin/env bats\n# protocol-file-coord-refs.bats -- Validate protocol files reference file-based coordination\n\nsetup() {\n  load '../test_helper/common'\n}\n```\n\nTHEN write exactly these 10 tests (minimum 8 required, write all 10 for completeness):\n\nTest 1: 'execute-protocol.md references dept-orchestrate.sh'\n  run grep -c 'dept-orchestrate.sh' \"$PROJECT_ROOT/references/execute-protocol.md\"\n  assert_success\n  Assert output (count) is >= 1: [ \"$output\" -ge 1 ]\n\nTest 2: 'execute-protocol.md references dept-cleanup.sh'\n  run grep -c 'dept-cleanup.sh' \"$PROJECT_ROOT/references/execute-protocol.md\"\n  assert_success\n  Assert output >= 1\n\nTest 3: 'execute-protocol.md references run_in_background'\n  run grep -c 'run_in_background' \"$PROJECT_ROOT/references/execute-protocol.md\"\n  assert_success\n  Assert output >= 1\n\nTest 4: 'execute-protocol.md preserves single-dept Task tool path'\n  run grep 'Task tool' \"$PROJECT_ROOT/references/execute-protocol.md\"\n  assert_success\n  (Verifies the single-dept references to Task tool still exist)\n\nTest 5: 'multi-dept-protocol.md contains dept-status references'\n  run grep -c 'dept-status' \"$PROJECT_ROOT/references/multi-dept-protocol.md\"\n  assert_success\n  Assert output >= 2\n\nTest 6: 'multi-dept-protocol.md contains Coordination Files section'\n  run grep 'Coordination Files' \"$PROJECT_ROOT/references/multi-dept-protocol.md\"\n  assert_success\n\nTest 7: 'cross-team-protocol.md references dept-gate.sh at least 3 times'\n  run grep -c 'dept-gate.sh' \"$PROJECT_ROOT/references/cross-team-protocol.md\"\n  assert_success\n  Assert output >= 3 (one for each of Gate 1, Gate 2, Gate 3)\n\nTest 8: 'company-hierarchy.md references background Task subagent'\n  run grep 'background Task subagent' \"$PROJECT_ROOT/references/company-hierarchy.md\"\n  assert_success\n\nTest 9: 'multi-dept-protocol.md contains Polling Mechanism section'\n  run grep 'Polling Mechanism' \"$PROJECT_ROOT/references/multi-dept-protocol.md\"\n  assert_success\n\nTest 10: 'no protocol files reference spawnTeam for coordination'\n  run grep -r 'spawnTeam' \"$PROJECT_ROOT/references/execute-protocol.md\" \"$PROJECT_ROOT/references/multi-dept-protocol.md\" \"$PROJECT_ROOT/references/cross-team-protocol.md\" \"$PROJECT_ROOT/references/company-hierarchy.md\"\n  assert_failure\n  (grep returning no matches = exit 1 = assert_failure confirms absence)\n\nNOTES:\n- Use assert_success and assert_failure from bats-assert (loaded via common helper).\n- Use $PROJECT_ROOT from test_helper/common.bash (resolves to repo root).\n- Use run to capture output, then assert on $output for count checks.\n- Each test is self-contained, no inter-test dependencies.\n- Count checks use [ \"$output\" -ge N ] pattern (same as department-agents.bats).\n\nCOMMIT: docs(phase-2): protocol validation tests 02-03","ts":""}
