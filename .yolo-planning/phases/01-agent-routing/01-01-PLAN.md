---
phase: "01"
plan: "01"
title: "Add subagent_type routing to execute-protocol spawn points"
wave: 1
depends_on: []
must_haves:
  - "Step 3 Dev TaskCreate includes subagent_type: yolo:yolo-dev"
  - "Step 2b Architect TaskCreate includes subagent_type: yolo:yolo-architect and maxTurns"
  - "Step 3d QA remediation Dev TaskCreate includes subagent_type: yolo:yolo-dev and maxTurns"
  - "Subagent_type mapping table added to execute-protocol"
  - "All existing tests pass"
---

# Plan 01-01: Add subagent_type routing to execute-protocol spawn points

## Goal

Fix all three Task tool spawn points in `skills/execute-protocol/SKILL.md` to include `subagent_type` so that specialized agents with proper tool constraints, turn limits, and permission modes are used instead of generic general-purpose agents. Add a mapping table for reference.

## Tasks

### Task 1: Add subagent_type mapping table to execute-protocol

**Files:** `skills/execute-protocol/SKILL.md`

**Implementation:**
- Insert a subagent_type mapping table in the Step 3 section, before the model resolution block (before line 401), as a reference for all spawn points in the protocol.
- Table content:

```markdown
**Agent routing (subagent_type):** All Task tool spawn points in this protocol MUST include `subagent_type` to route to specialized agents with role-specific tool constraints, turn limits, and permission modes.

| Role | subagent_type | Agent definition |
|------|--------------|-----------------|
| Dev | `yolo:yolo-dev` | `agents/yolo-dev.md` |
| Architect | `yolo:yolo-architect` | `agents/yolo-architect.md` |
| Lead | `yolo:yolo-lead` | `agents/yolo-lead.md` |
| Reviewer | `yolo:yolo-reviewer` | `agents/yolo-reviewer.md` |
| QA | `yolo:yolo-qa` | `agents/yolo-qa.md` |
```

**Verification:**
- Table appears in SKILL.md before the model resolution block
- All 5 agent types are listed with correct subagent_type values

### Task 2: Add subagent_type to Step 3 Dev TaskCreate

**Files:** `skills/execute-protocol/SKILL.md`

**Implementation:**
- In the Step 3 TaskCreate block (lines 412-424), add `subagent_type: "yolo:yolo-dev"` to the code block.
- The block currently has subject, description, and activeForm. Add subagent_type after activeForm.
- Update the existing CRITICAL comment (line 428) to include subagent_type alongside model and maxTurns.

Updated TaskCreate block should read:
```
subject: "Execute {NN-MM}: {plan-title}"
description: |
  {DEV_CONTEXT}
  ...
activeForm: "Executing {NN-MM}"
subagent_type: "yolo:yolo-dev"
```

Updated CRITICAL comment:
```
**CRITICAL:** Pass `model: "${DEV_MODEL}"`, `maxTurns: ${DEV_MAX_TURNS}`, and `subagent_type: "yolo:yolo-dev"` parameters to the Task tool invocation when spawning Dev teammates.
```

**Verification:**
- `subagent_type: "yolo:yolo-dev"` appears in the Step 3 TaskCreate block
- CRITICAL comment updated to mention subagent_type

### Task 3: Add subagent_type and maxTurns to Step 2b Architect TaskCreate

**Files:** `skills/execute-protocol/SKILL.md`

**Implementation:**
- In the Step 2b Architect TaskCreate block (lines 162-186), add `subagent_type: "yolo:yolo-architect"` after the existing `model: "${ARCH_MODEL}"` line.
- Add `maxTurns` resolution before the review loop. After the `ARCH_MODEL` resolution (line 121), add:
```bash
ARCH_MAX_TURNS=$("$HOME/.cargo/bin/yolo" resolve-turns architect .yolo-planning/config.json "{effort}")
```
- Add `maxTurns: ${ARCH_MAX_TURNS}` to the TaskCreate block.

Updated TaskCreate block tail:
```
  activeForm: "Revising plan {NN-MM} (cycle {REVIEW_CYCLE})"
  model: "${ARCH_MODEL}"
  maxTurns: ${ARCH_MAX_TURNS}
  subagent_type: "yolo:yolo-architect"
```

**Verification:**
- `subagent_type: "yolo:yolo-architect"` appears in the Step 2b TaskCreate block
- `ARCH_MAX_TURNS` resolution added after `ARCH_MODEL` resolution
- `maxTurns: ${ARCH_MAX_TURNS}` appears in the TaskCreate block

### Task 4: Add subagent_type and maxTurns to Step 3d QA remediation Dev TaskCreate

**Files:** `skills/execute-protocol/SKILL.md`

**Implementation:**
- In the Step 3d QA remediation Dev TaskCreate block (lines 708-729), add `subagent_type: "yolo:yolo-dev"` after the existing `model: "${DEV_MODEL}"` line.
- Add `maxTurns: ${DEV_MAX_TURNS}` to the TaskCreate block (DEV_MAX_TURNS is already resolved in Step 3).

Updated TaskCreate block tail:
```
  activeForm: "QA remediation cycle {QA_CYCLE} for plan {NN-MM}"
  model: "${DEV_MODEL}"
  maxTurns: ${DEV_MAX_TURNS}
  subagent_type: "yolo:yolo-dev"
```

**Verification:**
- `subagent_type: "yolo:yolo-dev"` appears in the Step 3d TaskCreate block
- `maxTurns: ${DEV_MAX_TURNS}` appears in the Step 3d TaskCreate block

### Task 5: Verify all spawn points and run tests

**Files:** none (verification only)

**Implementation:**
- Grep `skills/execute-protocol/SKILL.md` for all `subagent_type` occurrences â€” expect exactly 3 (Step 3, Step 2b, Step 3d) plus 1 in the mapping table header.
- Grep for all `TaskCreate` or `subject:` patterns to confirm no spawn points were missed.
- Run existing bats tests to confirm no regressions.

**Verification:**
- 3 spawn-point subagent_type entries found in SKILL.md
- All existing tests pass with 0 failures
