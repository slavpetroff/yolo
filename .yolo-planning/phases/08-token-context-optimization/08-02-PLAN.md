---
phase: "08"
plan: "02"
title: "Fix compile-context output path and optimize prefer_teams"
wave: 1
depends_on: []
must_haves:
  - "SKILL.md compile-context call uses {phase-dir} not {phases_dir} as output directory"
  - "Single-plan phases skip TeamCreate/TeamDelete regardless of prefer_teams config"
  - "All token-budget and context references use {phase-dir}/.context-dev.md consistently"
---

# Plan 02: Fix compile-context Output Path and Optimize prefer_teams

## Goal

Two SKILL.md improvements: (T3) fix the compile-context output directory argument to use the phase subdirectory for concurrency safety, and (T4) optimize the prefer_teams logic to skip team creation when only 1 uncompleted plan exists in a phase.

## Tasks

### Task 1: Fix compile-context output path in SKILL.md (T3)

**Files:** `skills/execute-protocol/SKILL.md`

**Bug:** Line ~128 calls compile-context with `{phases_dir}` as the output directory:
```
"$HOME/.cargo/bin/yolo" compile-context {phase} dev {phases_dir} {plan_path}
```

But `{phases_dir}` is the root `phases/` directory, so the output lands at `phases/.context-dev.md`. If two phases execute concurrently, they overwrite each other. The docs at line 129 claim the output is at `{phase-dir}/.context-dev.md` which is the phase subdirectory.

**Fix:** Change line ~128 to use `{phase-dir}` instead of `{phases_dir}`:
```
"$HOME/.cargo/bin/yolo" compile-context {phase} dev {phase-dir} {plan_path}
```

This makes the CLI write `.context-dev.md` to the phase subdirectory (e.g., `phases/08-token-context-optimization/.context-dev.md`), which is concurrency-safe and matches the documentation.

**Verification:** Read SKILL.md and confirm the compile-context call uses `{phase-dir}`. All subsequent references at lines ~141, ~165 already use `{phase-dir}/.context-dev.md` so they remain correct.

### Task 2: Add single-plan optimization to prefer_teams (T4)

**Files:** `skills/execute-protocol/SKILL.md`

**Current behavior (lines ~60-81):** The prefer_teams decision tree creates a team when:
- `prefer_teams='always'`: Always create team, even for 1 plan
- `prefer_teams='when_parallel'`: Only create team when 2+ uncompleted plans
- `prefer_teams='auto'`: Same as when_parallel

**Optimization:** When exactly 1 uncompleted plan exists in the phase, skip TeamCreate/TeamDelete regardless of the prefer_teams setting. A team of 1 agent adds overhead (TeamCreate, TaskCreate, TaskUpdate, SendMessage, TeamDelete) with zero parallelism benefit.

**Fix:** Add a plan-count pre-check before the prefer_teams decision tree:

```markdown
**Single-plan optimization:** Before evaluating prefer_teams, count uncompleted plans for this phase. If exactly 1 uncompleted plan exists:
- Skip TeamCreate entirely — single agent mode, no team overhead
- Spawn Dev agent directly via Task tool (no team_name parameter)
- Skip TeamDelete in Step 5

This optimization applies regardless of the prefer_teams config value. Teams only provide value when 2+ agents can work in parallel.
```

Then modify the team creation decision tree to add this as a first check:
1. Count uncompleted plans (from .execution-state.json or plan files)
2. If count == 1: force single-agent mode (skip TeamCreate)
3. If count >= 2: evaluate prefer_teams config as before

Also update the shutdown gate (Step 5, lines ~387-395) to check whether a team was created before attempting TeamDelete:

```markdown
**HARD GATE — Shutdown before ANY output or state updates:** If a team was created (count was >= 2 AND prefer_teams permitted it):
```

**Verification:** Read the updated SKILL.md. Confirm the single-plan optimization is documented before the prefer_teams decision tree. Confirm Step 5 shutdown gate references the optimization.
