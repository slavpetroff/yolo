{"p":"04","n":"03","t":"Agent health tracking and circuit breakers","w":2,"d":["04-02"],"xd":[{"p":"02","n":"02","a":".yolo-planning/phases/02-department-teams/02-02.summary.jsonl","r":"department team structure from Phase 2"},{"p":"03","n":"01","a":".yolo-planning/phases/03-shared-task-coordination/03-01.summary.jsonl","r":"task coordination patterns from Phase 3"}],"mh":{"tr":["Agent lifecycle events tracked: start, idle, stop, disappeared","Per-department circuit breaker states: closed (healthy), open (fallen back), half-open (probing)","Circuit breaker isolation: one department failure does not cascade to other departments","Health tracking is prompt-level (agent instructions), not a background daemon","Circuit breaker state is in-memory within Lead session, not persisted to disk","No custom heartbeat protocol -- uses existing SendMessage idle/active patterns","Disappeared agent timeout is hardcoded 60s (not configurable, zero-config principle)"],"ar":[{"p":"agents/yolo-lead.md","pv":"file exists","c":"contains ## Agent Health Tracking and ## Circuit Breaker sections"},{"p":"references/teammate-api-patterns.md","pv":"file exists","c":"contains ## Health Tracking section"},{"p":"references/handoff-schemas.md","pv":"file exists","c":"contains agent_health_event schema"}],"kl":[{"fr":"agents/yolo-lead.md ## Agent Health Tracking","to":"references/teammate-api-patterns.md ## Health Tracking","vi":"Lead instructions reference patterns doc for health event format"},{"fr":"agents/yolo-lead.md ## Circuit Breaker","to":"agents/yolo-lead.md ## Fallback Behavior","vi":"circuit breaker open state triggers fallback cascade"}]},"obj":"Add prompt-level agent health tracking and per-department circuit breakers to Lead agent instructions and reference docs (REQ-03)","sk":["commit"],"fm":["agents/yolo-lead.md","agents/yolo-fe-lead.md","agents/yolo-ux-lead.md","references/teammate-api-patterns.md","references/handoff-schemas.md","tests/static/agent-health-circuit-breaker.bats"],"auto":true}
{"id":"T1","a":"Add ## Health Tracking section to references/teammate-api-patterns.md documenting: (1) agent lifecycle states (start, idle, stop, disappeared), (2) timestamp tracking for each state transition, (3) timeout detection when expected signals do not arrive, (4) recovery trigger (Task tool fallback) when agent disappears mid-task. Include agent_health_event schema with fields: agent_id, dept, state, timestamp, prev_state.","f":["references/teammate-api-patterns.md"],"v":"Section exists with lifecycle states and timeout detection documented","done":"## Health Tracking section present with complete schema","td":[],"tp":"auto","spec":"MODIFY file: references/teammate-api-patterns.md.\n\nINSERTION POINT: Insert the new ## Health Tracking section AFTER the ## Fallback Cascade section (added by plan 04-02 T2) and BEFORE the existing ## Task Mode Fallback section. Per architecture.toon C1 resolution, the final order is: ... ## Fallback Cascade (from 04-02), ## Health Tracking (from 04-03), ## Task Mode Fallback (existing).\n\nTo find the insertion point: locate the line '## Task Mode Fallback' (currently at line 320, but will be shifted down by the Fallback Cascade section added by 04-02). Insert BEFORE that line.\n\nSection content to add:\n\n```markdown\n## Health Tracking\n\n> This section is active ONLY when team_mode=teammate.\n\nLead monitors teammate health via SendMessage response patterns. No custom heartbeat protocol -- health is inferred from existing communication.\n\n### Agent Lifecycle States\n\n| State | Meaning | Trigger |\n|-------|---------|--------|\n| `start` | Agent registered and receiving first assignment | addTeammate completes |\n| `idle` | Agent completed work, waiting for next assignment | task_complete received, no new task assigned |\n| `stop` | Agent received shutdown_request and sent shutdown_response | shutdown protocol completes |\n| `disappeared` | Agent has not responded within 60s of expected signal | Timeout on SendMessage response |\n\n### Tracking Algorithm\n\nLead maintains an in-memory map: `agent_health = Map<agent_id, {state, timestamp, prev_state, dept}>`.\n\n1. On addTeammate success: set state=start, timestamp=now.\n2. On receiving task_complete: set state=idle, timestamp=now.\n3. On sending task assignment: update timestamp (expected response within 60s).\n4. On receiving shutdown_response: set state=stop, timestamp=now.\n5. On timeout (60s since last expected response): set state=disappeared, trigger recovery.\n\n### Recovery on Disappeared Agent\n\nWhen an agent enters `disappeared` state:\n1. Log: \"[HEALTH] Agent {agent_id} disappeared after 60s timeout.\"\n2. Remove agent's files from claimed_files set.\n3. Mark agent's in-progress task as available.\n4. Trigger Tier 2 fallback (see ## Fallback Cascade) -- reassign work via Task tool.\n5. Update circuit breaker state (see agents/yolo-lead.md ## Circuit Breaker).\n\n### agent_health_event Schema\n\n```json\n{\n  \"type\": \"agent_health_event\",\n  \"agent_id\": \"dev-1\",\n  \"dept\": \"backend\",\n  \"state\": \"start | idle | stop | disappeared\",\n  \"timestamp\": \"2026-02-17T10:30:00Z\",\n  \"prev_state\": \"idle\",\n  \"timeout_triggered\": false\n}\n```\n\nThis event is logged internally by Lead for debugging. It is NOT sent via SendMessage -- it is a Lead-internal tracking record.\n```\n\nInsert with blank lines before and after the section.","ts":""}
{"id":"T2","a":"Add agent_health_event and circuit_breaker_state schemas to references/handoff-schemas.md. agent_health_event: {type, agent_id, dept, state, timestamp, prev_state, timeout_triggered}. circuit_breaker_state: {dept, state (closed/open/half-open), opened_at, failure_count, last_probe_at}.","f":["references/handoff-schemas.md"],"v":"Both schemas present in handoff-schemas.md","done":"agent_health_event and circuit_breaker_state schemas documented","td":[],"tp":"auto","spec":"MODIFY file: references/handoff-schemas.md.\n\nINSERTION POINT: Add both schemas AFTER the existing ## `escalation` section (which ends at line 242) and BEFORE the ## `task_claim` section (which starts at line 244). This places the health/circuit breaker schemas with the other non-teammate-specific schemas, before the teammate-only task coordination schemas.\n\nContent to add:\n\n```markdown\n## `agent_health_event` (Lead internal, when team_mode=teammate)\n\nLead-internal health tracking record. NOT sent via SendMessage -- logged locally for debugging and circuit breaker state transitions.\n\n```json\n{\n  \"type\": \"agent_health_event\",\n  \"agent_id\": \"dev-1\",\n  \"dept\": \"backend\",\n  \"state\": \"start | idle | stop | disappeared\",\n  \"timestamp\": \"2026-02-17T10:30:00Z\",\n  \"prev_state\": \"idle\",\n  \"timeout_triggered\": false\n}\n```\n\n## `circuit_breaker_state` (Lead internal, when team_mode=teammate)\n\nPer-department circuit breaker state. Lead-internal -- used to decide fallback behavior. NOT sent via SendMessage.\n\n```json\n{\n  \"type\": \"circuit_breaker_state\",\n  \"dept\": \"backend\",\n  \"state\": \"closed | open | half-open\",\n  \"opened_at\": \"2026-02-17T10:30:00Z\",\n  \"failure_count\": 2,\n  \"last_probe_at\": \"2026-02-17T10:35:00Z\"\n}\n```\n```\n\nInsert with blank lines separating from surrounding sections.","ts":""}
{"id":"T3","a":"Add ## Agent Health Tracking section to agents/yolo-lead.md: Lead monitors teammate lifecycle via SendMessage patterns, logs state transitions, detects disappeared agents via hardcoded 60s timeout (not configurable, zero-config principle). Add ## Circuit Breaker section: Lead maintains per-department circuit breaker state (in-memory). State machine: closed -> open (on failure), open -> half-open (after cooldown), half-open -> closed (on success) or open (on failure). When open, department uses Task tool fallback. Also add one-line cross-reference to agents/yolo-fe-lead.md and agents/yolo-ux-lead.md under their ## Teammate API section: 'For health tracking and circuit breaker patterns, see agents/yolo-lead.md ## Agent Health Tracking and ## Circuit Breaker.'","f":["agents/yolo-lead.md","agents/yolo-fe-lead.md","agents/yolo-ux-lead.md"],"v":"Both sections present in yolo-lead.md with hardcoded 60s timeout; cross-references present in fe-lead and ux-lead","done":"## Agent Health Tracking and ## Circuit Breaker sections in yolo-lead.md; cross-references in yolo-fe-lead.md and yolo-ux-lead.md","td":["T1","T2"],"tp":"auto","spec":"THREE files to modify:\n\n**File 1: agents/yolo-lead.md**\n\nINSERTION POINT: Insert ## Agent Health Tracking and ## Circuit Breaker sections AFTER the ## Fallback Behavior section (added by plan 04-02 T3) and BEFORE ## Context. Per architecture.toon C1 resolution, the order is: ## Fallback Behavior, ## Agent Health Tracking, ## Circuit Breaker, ## Context.\n\nTo find insertion point: locate '## Context' (currently line 145, but shifted by 04-02 additions). Insert both sections BEFORE '## Context'.\n\nSection 1 content:\n\n```markdown\n## Agent Health Tracking\n\n> This section is active ONLY when team_mode=teammate. When team_mode=task, no health tracking needed.\n\nMonitor teammate lifecycle via SendMessage response patterns. No custom heartbeat -- health inferred from existing communication. See references/teammate-api-patterns.md ## Health Tracking for full schema.\n\n### Lifecycle States\n\nTrack each teammate: start (registered), idle (waiting), stop (shutdown complete), disappeared (60s timeout).\n\n### Timeout Detection\n\nAfter assigning a task or sending any request, expect a response within 60 seconds (hardcoded constant). If no response arrives within 60s:\n1. Set agent state to `disappeared`.\n2. Log: \"[HEALTH] Agent {id} disappeared (60s timeout).\"\n3. Remove from claimed_files.\n4. Mark in-progress task as available.\n5. Trigger fallback per ## Fallback Behavior.\n6. Update circuit breaker per ## Circuit Breaker.\n```\n\nSection 2 content (immediately after):\n\n```markdown\n## Circuit Breaker\n\n> This section is active ONLY when team_mode=teammate. When team_mode=task, no circuit breaker needed.\n\nPer-department circuit breaker. In-memory state within Lead session (not persisted to disk). See references/handoff-schemas.md ## circuit_breaker_state for schema.\n\n### State Machine\n\n- **Closed** (default): Teammate API working normally. All agents spawned as teammates.\n- **Open**: Teammate API has failed for this department. All new agents spawned via Task tool. Entered when: disappeared agent count >= 2 within 5 minutes.\n- **Half-Open**: After 2 minutes in open state, Lead probes by spawning ONE agent as teammate. If probe succeeds (agent responds within 60s), transition to closed. If probe fails, transition back to open.\n\n### Transitions\n\n| From | To | Trigger |\n|------|----|---------|\n| Closed | Open | 2+ disappeared agents within 5 minutes |\n| Open | Half-Open | 2 minutes elapsed since entering open state |\n| Half-Open | Closed | Probe agent responds successfully |\n| Half-Open | Open | Probe agent disappears (60s timeout) |\n\n### Department Isolation\n\nEach department has its own independent circuit breaker. Backend open does not affect Frontend or UI/UX. State is tracked per-department in Lead's in-memory map.\n```\n\n**File 2: agents/yolo-fe-lead.md**\n\nINSERTION POINT: Inside the ## Teammate API section. Add a new subsection AFTER the ### Fallback Behavior subsection (added by 04-02 T3) and BEFORE ## Summary Aggregation. If ### Fallback Behavior was added after ### Unchanged Behavior (line ~103), add this after it:\n\n```markdown\n### Health Tracking and Circuit Breaker\n\nFor health tracking and circuit breaker patterns, see agents/yolo-lead.md ## Agent Health Tracking and ## Circuit Breaker. Apply same patterns with frontend team (yolo-frontend).\n```\n\n**File 3: agents/yolo-ux-lead.md**\n\nINSERTION POINT: Same position relative to the ### Fallback Behavior subsection added by 04-02 T3. Add AFTER ### Fallback Behavior and BEFORE ## Summary Aggregation:\n\n```markdown\n### Health Tracking and Circuit Breaker\n\nFor health tracking and circuit breaker patterns, see agents/yolo-lead.md ## Agent Health Tracking and ## Circuit Breaker. Apply same patterns with uiux team (yolo-uiux).\n```","ts":""}
{"id":"T4","a":"Create tests/static/agent-health-circuit-breaker.bats with tests validating: (1) yolo-lead.md contains ## Agent Health Tracking section, (2) yolo-lead.md contains ## Circuit Breaker section, (3) teammate-api-patterns.md contains ## Health Tracking section, (4) handoff-schemas.md contains agent_health_event schema, (5) handoff-schemas.md contains circuit_breaker_state schema, (6) all 4 lifecycle states (start, idle, stop, disappeared) mentioned in patterns doc, (7) all 3 circuit breaker states (closed, open, half-open) mentioned in lead agent.","f":["tests/static/agent-health-circuit-breaker.bats"],"v":"All static validation tests pass","done":"7+ test cases, all passing","td":["T1","T2","T3"],"tp":"auto","spec":"Create NEW file: tests/static/agent-health-circuit-breaker.bats.\n\nSHEBANG: #!/usr/bin/env bats with comment: # agent-health-circuit-breaker.bats -- Static validation: health tracking and circuit breaker documentation\n\nsetup(): load '../test_helper/common' (provides AGENTS_DIR, PROJECT_ROOT, assert_* functions). Define: PATTERNS=\"$PROJECT_ROOT/references/teammate-api-patterns.md\". SCHEMAS=\"$PROJECT_ROOT/references/handoff-schemas.md\".\n\nTest cases:\n\n1. '@test \"yolo-lead.md contains Agent Health Tracking section\"': run grep '## Agent Health Tracking' \"$AGENTS_DIR/yolo-lead.md\"; assert_success.\n\n2. '@test \"yolo-lead.md contains Circuit Breaker section\"': run grep '## Circuit Breaker' \"$AGENTS_DIR/yolo-lead.md\"; assert_success.\n\n3. '@test \"teammate-api-patterns.md contains Health Tracking section\"': run grep '## Health Tracking' \"$PATTERNS\"; assert_success.\n\n4. '@test \"handoff-schemas.md contains agent_health_event schema\"': run grep 'agent_health_event' \"$SCHEMAS\"; assert_success.\n\n5. '@test \"handoff-schemas.md contains circuit_breaker_state schema\"': run grep 'circuit_breaker_state' \"$SCHEMAS\"; assert_success.\n\n6. '@test \"Health Tracking documents all 4 lifecycle states\"': for state in start idle stop disappeared; do run grep \"$state\" \"$PATTERNS\"; assert_success || fail \"Missing state: $state in teammate-api-patterns.md\"; done. (Note: use a loop with individual assertions. Each state grep must succeed.)\n\nAlternative implementation for test 6 (avoid subshell issues with bats):\n```bash\n@test \"Health Tracking documents all 4 lifecycle states\" {\n  run grep -c 'start\\|idle\\|stop\\|disappeared' \"$PATTERNS\"\n  assert_success\n  # At minimum 4 matches (one per state)\n  [ \"$output\" -ge 4 ]\n}\n```\n\n7. '@test \"Circuit Breaker documents all 3 states\"': run grep -c 'closed\\|open\\|half-open' \"$AGENTS_DIR/yolo-lead.md\"; assert_success; [ \"$output\" -ge 3 ].\n\n8. '@test \"health tracking uses hardcoded 60s timeout\"': run grep '60' \"$AGENTS_DIR/yolo-lead.md\"; assert_success. (Verify the 60s constant appears in the lead agent.)\n\n9. '@test \"circuit breaker is per-department\"': run grep -i 'per-department\\|department isolation' \"$AGENTS_DIR/yolo-lead.md\"; assert_success.\n\n10. '@test \"health tracking and circuit breaker are prompt-level only (no persistent state)\"': Comment in test: # C9 acknowledged limitation: these are prompt-level instructions, not executable scripts. # Behavioral testing would require spawning actual Teammate API sessions. run grep 'in-memory' \"$AGENTS_DIR/yolo-lead.md\"; assert_success.\n\nTotal: 10 test cases. All are static file content checks (grep-based). This is intentional per C9 resolution.","ts":""}
