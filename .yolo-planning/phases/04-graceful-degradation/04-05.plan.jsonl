{"p":"04","n":"05","t":"Orphaned team cleanup and integration tests","w":4,"d":["04-03","04-04"],"xd":[{"p":"01","n":"01","a":".yolo-planning/phases/01-team-abstraction-layer/01-01.summary.jsonl","r":"session-start.sh foundation from Phase 1"}],"mh":{"tr":["session-start.sh detects and cleans up stale .dept-status-*.json files from prior sessions","Orphaned cleanup logs actions for debugging","All 880+ existing tests pass after all Phase 4 changes","Integration tests validate configuration cascade and documentation coverage","Per-department circuit breaker isolation verified in tests","team_mode=auto correctly selects optimal mode in integration test"],"ar":[{"p":"scripts/session-start.sh","pv":"file exists","c":"contains .dept-status-*.json cleanup logic"},{"p":"tests/integration/graceful-degradation.bats","pv":"file exists","c":"integration tests for configuration cascade and documentation coverage"},{"p":"tests/unit/session-start-cleanup.bats","pv":"file exists","c":"unit tests for orphaned .dept-status cleanup"}],"kl":[{"fr":"scripts/session-start.sh orphaned team cleanup","to":"references/teammate-api-patterns.md ## Team Cleanup","vi":"session-start cleanup references the same team cleanup patterns"},{"fr":"tests/integration/graceful-degradation.bats","to":"scripts/resolve-team-mode.sh","vi":"integration tests exercise resolve-team-mode.sh auto detection"}]},"obj":"Implement orphaned .dept-status cleanup in session-start.sh and create integration tests validating the complete configuration cascade, circuit breaker isolation, and all Phase 4 features (REQ-03)","sk":["commit"],"fm":["scripts/session-start.sh","tests/integration/graceful-degradation.bats","tests/unit/session-start-cleanup.bats"],"auto":true}
{"id":"T1","a":"Add orphaned .dept-status cleanup section to scripts/session-start.sh: (1) detect .dept-status-*.json files in .yolo-planning/ older than 24 hours (stale from crashed sessions), (2) clean up stale .dept-status files, (3) log cleanup actions to stderr for debugging, (4) guard with team_mode check -- only run cleanup if agent_teams=true in config. Must not break any existing session-start.sh behavior. No reference to .team-state files (do not exist). The existing .execution-state.json reconciliation (lines 196-233) is already handled -- this adds only .dept-status cleanup.","f":["scripts/session-start.sh"],"v":"session-start.sh contains .dept-status-*.json cleanup block, existing behavior unchanged","done":"Orphaned .dept-status cleanup section present, all existing session-start tests pass","td":[],"tp":"auto","spec":"MODIFY file: scripts/session-start.sh (389 lines currently).\n\nINSERTION POINT: Add the .dept-status cleanup block AFTER the existing 'Reconcile orphaned execution state' section (which ends at line 233 with the closing fi) and BEFORE the '# --- Project state ---' section (which starts at line 236 with the comment). This keeps cleanup logic grouped with the other reconciliation code.\n\nInsert after line 233 (the closing fi of the exec state reconciliation) and before line 236 (# --- Project state ---):\n\n```bash\n# --- Orphaned .dept-status cleanup ---\n# Clean stale .dept-status-*.json files from prior crashed sessions.\n# Only runs when agent_teams=true in config (no cleanup needed for task-only mode).\n# D5: targets .dept-status-*.json only (no .team-state files exist).\nif [ -d \"$PLANNING_DIR\" ] && [ -f \"$PLANNING_DIR/config.json\" ]; then\n  DEPT_CLEANUP_TEAMS=$(jq -r '.agent_teams // true' \"$PLANNING_DIR/config.json\" 2>/dev/null)\n  if [ \"$DEPT_CLEANUP_TEAMS\" = \"true\" ]; then\n    NOW_EPOCH=$(date +%s)\n    STALE_THRESHOLD=$((24 * 60 * 60))  # 24 hours in seconds\n    for dept_file in \"$PLANNING_DIR\"/.dept-status-*.json; do\n      [ -f \"$dept_file\" ] || continue\n      if [ \"$(uname)\" = \"Darwin\" ]; then\n        FILE_EPOCH=$(stat -f %m \"$dept_file\" 2>/dev/null || echo \"$NOW_EPOCH\")\n      else\n        FILE_EPOCH=$(stat -c %Y \"$dept_file\" 2>/dev/null || echo \"$NOW_EPOCH\")\n      fi\n      FILE_AGE=$((NOW_EPOCH - FILE_EPOCH))\n      if [ \"$FILE_AGE\" -gt \"$STALE_THRESHOLD\" ]; then\n        echo \"YOLO: cleaning stale dept-status file: $(basename \"$dept_file\") (age: ${FILE_AGE}s)\" >&2\n        rm -f \"$dept_file\"\n      fi\n    done\n  fi\nfi\n```\n\nKey implementation details:\n- Uses stat -f %m (macOS) / stat -c %Y (Linux) for file modification time, matching the existing pattern at line 49 and 51 of the same script.\n- 24-hour threshold (86400 seconds) per D5 architecture decision.\n- Logs to stderr (echo ... >&2) per standard session-start.sh convention (see line 144, 163, 174 for similar stderr logging patterns).\n- Guards on agent_teams=true from config.json -- skips entirely when agent_teams is false or not set to true.\n- The glob .dept-status-*.json matches files like .dept-status-backend.json, .dept-status-frontend.json.\n- [ -f \"$dept_file\" ] || continue handles the case where no matching files exist (glob expands to literal).\n- Does NOT touch .execution-state.json reconciliation (already handled at lines 196-233).\n- Does NOT reference .team-state files (do not exist per D5).","ts":""}
{"id":"T2","a":"Create tests/unit/session-start-cleanup.bats with tests for orphaned .dept-status cleanup: (1) cleanup removes .dept-status-*.json files older than 24h, (2) cleanup skips recent .dept-status-*.json files, (3) cleanup skips when agent_teams=false, (4) cleanup logs actions to stderr, (5) existing session-start behavior unaffected (config migration, compaction marker, exec state reconciliation all still work).","f":["tests/unit/session-start-cleanup.bats"],"v":"All unit tests pass","done":"5+ test cases, all passing","td":["T1"],"tp":"auto","spec":"Create NEW file: tests/unit/session-start-cleanup.bats.\n\nSHEBANG: #!/usr/bin/env bats with comment: # session-start-cleanup.bats -- Unit tests for orphaned .dept-status cleanup in session-start.sh\n\nsetup(): load '../test_helper/common' (provides SCRIPTS_DIR, PROJECT_ROOT). load '../test_helper/fixtures'. mk_test_workdir. Define SUT=\"$SCRIPTS_DIR/session-start.sh\".\n\nNOTE: session-start.sh is a SessionStart hook script. It reads .yolo-planning/ relative to cwd. Tests must set up the expected directory structure in TEST_WORKDIR and run the script from there. The script outputs JSON to stdout and logs to stderr.\n\nHelper function for creating stale .dept-status files:\n```bash\nmk_stale_dept_status() {\n  local name=\"$1\" age_hours=\"${2:-25}\"\n  local file=\"$TEST_WORKDIR/.yolo-planning/.dept-status-${name}.json\"\n  echo '{\"department\":\"'\"$name\"'\",\"status\":\"complete\"}' > \"$file\"\n  # Set modification time to age_hours ago\n  if [ \"$(uname)\" = \"Darwin\" ]; then\n    touch -t \"$(date -v-${age_hours}H +%Y%m%d%H%M.%S)\" \"$file\"\n  else\n    touch -d \"-${age_hours} hours\" \"$file\"\n  fi\n}\n```\n\nHelper for creating fresh .dept-status files:\n```bash\nmk_fresh_dept_status() {\n  local name=\"$1\"\n  echo '{\"department\":\"'\"$name\"'\",\"status\":\"complete\"}' > \"$TEST_WORKDIR/.yolo-planning/.dept-status-${name}.json\"\n  # File has current timestamp by default\n}\n```\n\nTest cases:\n\n1. '@test \"removes stale .dept-status files older than 24h\"': mkdir -p \"$TEST_WORKDIR/.yolo-planning\". echo '{\"agent_teams\":true}' > \"$TEST_WORKDIR/.yolo-planning/config.json\". mk_stale_dept_status \"backend\" 25. Run: cd \"$TEST_WORKDIR\" && run bash \"$SUT\". Assert: [ ! -f \"$TEST_WORKDIR/.yolo-planning/.dept-status-backend.json\" ].\n\n2. '@test \"preserves recent .dept-status files\"': mkdir -p \"$TEST_WORKDIR/.yolo-planning\". echo '{\"agent_teams\":true}' > \"$TEST_WORKDIR/.yolo-planning/config.json\". mk_fresh_dept_status \"frontend\". Run: cd \"$TEST_WORKDIR\" && run bash \"$SUT\". Assert: [ -f \"$TEST_WORKDIR/.yolo-planning/.dept-status-frontend.json\" ].\n\n3. '@test \"skips cleanup when agent_teams=false\"': mkdir -p \"$TEST_WORKDIR/.yolo-planning\". echo '{\"agent_teams\":false}' > \"$TEST_WORKDIR/.yolo-planning/config.json\". mk_stale_dept_status \"backend\" 25. Run: cd \"$TEST_WORKDIR\" && run bash \"$SUT\". Assert: [ -f \"$TEST_WORKDIR/.yolo-planning/.dept-status-backend.json\" ]. (File should still exist because cleanup was skipped.)\n\n4. '@test \"logs cleanup actions to stderr\"': mkdir -p \"$TEST_WORKDIR/.yolo-planning\". echo '{\"agent_teams\":true}' > \"$TEST_WORKDIR/.yolo-planning/config.json\". mk_stale_dept_status \"backend\" 25. Run: cd \"$TEST_WORKDIR\" && run bash \"$SUT\" 2>&1. (Capture stderr in output.) Assert output contains 'cleaning stale dept-status'.\n\nNote on test 4: bats 'run' captures both stdout and stderr. Use: run bash -c \"cd '$TEST_WORKDIR' && bash '$SUT' 2>&1\" to merge stderr into stdout for assertion.\n\n5. '@test \"existing session-start output unchanged\"': mkdir -p \"$TEST_WORKDIR/.yolo-planning\". echo '{\"agent_teams\":true}' > \"$TEST_WORKDIR/.yolo-planning/config.json\". Run: cd \"$TEST_WORKDIR\" && run bash \"$SUT\". assert_success. Verify output is valid JSON: echo \"$output\" | jq empty. (session-start.sh should still produce valid JSON hookSpecificOutput.)\n\nNote: session-start.sh expects to be run from a git repo. If tests fail because of missing git context, use mk_git_repo from fixtures.bash before running.","ts":""}
{"id":"T3","a":"Create tests/integration/graceful-degradation.bats (renamed from fallback-cascade.bats) with integration tests: (1) team_mode=auto with env var set selects teammate via resolve-team-mode.sh, (2) team_mode=auto without env var falls back to task, (3) team_mode=teammate without env var falls back to task with fallback_notice, (4) teammate-api-patterns.md documents all 3 fallback tiers (configuration cascade validation), (5) yolo-lead.md documents circuit breaker states (documentation coverage), (6) full test suite regression -- run test-summary.sh and verify PASS output with N >= 880.","f":["tests/integration/graceful-degradation.bats"],"v":"All integration tests pass, regression threshold N >= 880","done":"6+ test cases covering configuration cascade, documentation coverage, and regression at N >= 880","td":["T1","T2"],"tp":"auto","spec":"Create NEW file: tests/integration/graceful-degradation.bats.\n\nSHEBANG: #!/usr/bin/env bats with comment: # graceful-degradation.bats -- Integration tests: configuration cascade, documentation coverage, regression\n\nsetup(): load '../test_helper/common' (provides SCRIPTS_DIR, PROJECT_ROOT, AGENTS_DIR). load '../test_helper/fixtures'. mk_test_workdir. Define: RESOLVE=\"$SCRIPTS_DIR/resolve-team-mode.sh\". SUMMARY=\"$SCRIPTS_DIR/test-summary.sh\". PATTERNS=\"$PROJECT_ROOT/references/teammate-api-patterns.md\". LEAD=\"$AGENTS_DIR/yolo-lead.md\".\n\nTest cases -- Configuration Cascade Validation (real script execution):\n\n1. '@test \"auto mode with env var selects teammate (config cascade)\"': export CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS=1. echo '{\"team_mode\":\"auto\",\"agent_teams\":true}' > \"$TEST_WORKDIR/cfg.json\". run bash \"$RESOLVE\" \"$TEST_WORKDIR/cfg.json\". assert_success. assert_line 'team_mode=teammate'. assert_line 'auto_detected=true'.\n\n2. '@test \"auto mode without env var falls back to task (config cascade)\"': unset CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS 2>/dev/null || true. echo '{\"team_mode\":\"auto\",\"agent_teams\":true}' > \"$TEST_WORKDIR/cfg.json\". run bash \"$RESOLVE\" \"$TEST_WORKDIR/cfg.json\". assert_success. assert_line 'team_mode=task'. assert_line 'fallback_notice=true'.\n\n3. '@test \"auto mode with agent_teams=false falls back to task (config cascade)\"': export CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS=1. echo '{\"team_mode\":\"auto\",\"agent_teams\":false}' > \"$TEST_WORKDIR/cfg.json\". run bash \"$RESOLVE\" \"$TEST_WORKDIR/cfg.json\". assert_success. assert_line 'team_mode=task'. assert_line 'fallback_notice=true'.\n\n4. '@test \"teammate mode without env var falls back to task (config cascade)\"': unset CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS 2>/dev/null || true. echo '{\"team_mode\":\"teammate\",\"agent_teams\":true}' > \"$TEST_WORKDIR/cfg.json\". run bash \"$RESOLVE\" \"$TEST_WORKDIR/cfg.json\". assert_success. assert_line 'team_mode=task'. assert_line 'fallback_notice=true'.\n\nDocumentation Coverage Tests (static checks in integration context):\n\n5. '@test \"teammate-api-patterns.md documents all 3 fallback tiers\"': run grep -c '### Tier' \"$PATTERNS\". assert_success. [ \"$output\" -ge 3 ]. (Verify at least 3 '### Tier' subsections exist in the Fallback Cascade section.)\n\n6. '@test \"yolo-lead.md documents all circuit breaker states\"': for state in Closed Open Half-Open; do run grep \"$state\" \"$LEAD\"; assert_success || fail \"Missing circuit breaker state: $state\"; done.\n\nAlternative for test 6 (avoid bats loop issues):\n```bash\n@test \"yolo-lead.md documents all circuit breaker states\" {\n  run grep -c 'Closed\\|Open\\|Half-Open' \"$LEAD\"\n  assert_success\n  [ \"$output\" -ge 3 ]\n}\n```\n\n7. '@test \"yolo-lead.md documents all Phase 4 sections\"': Verify all 4 new sections exist:\n```bash\n@test \"yolo-lead.md has all Phase 4 resilience sections\" {\n  run grep '## Fallback Behavior' \"$LEAD\"\n  assert_success\n  run grep '## Agent Health Tracking' \"$LEAD\"\n  assert_success\n  run grep '## Circuit Breaker' \"$LEAD\"\n  assert_success\n  run grep '## Shutdown Protocol Enforcement' \"$LEAD\"\n  assert_success\n}\n```\n\nRegression Test:\n\n8. '@test \"full test suite passes with N >= 880\"': run bash \"$SUMMARY\". assert_success. [[ \"$output\" =~ ^PASS ]]. local count; count=$(echo \"$output\" | grep -oE '[0-9]+' | head -1); [ \"$count\" -ge 880 ].\n\nNote: Test 8 runs the full test suite via test-summary.sh (created in plan 04-01). This is the regression gate ensuring all Phase 4 changes do not break existing tests. The threshold of 880 accounts for the approximately 20+ new tests added by Phase 4.\n\nTotal: 8 test cases (4 configuration cascade, 3 documentation coverage, 1 regression).","ts":""}
