{"p":"04","n":"04","t":"Shutdown protocol enforcement","w":3,"d":["04-02","04-03"],"xd":[{"p":"02","n":"03","a":".yolo-planning/phases/02-department-teams/02-03.summary.jsonl","r":"shutdown protocol skeleton from Phase 2"}],"mh":{"tr":["Lead sends shutdown_request to all teammates with deadline","Teammates complete current work, commit artifacts, send shutdown_response","Lead verifies all responses received before team cleanup","Timeout handling: if teammate does not respond within deadline, log and proceed","Shutdown protocol documented in both Lead and all teammate agent files","execute-protocol.md Step 10 references shutdown protocol","shutdown_request and shutdown_response schemas in handoff-schemas.md"],"ar":[{"p":"agents/yolo-lead.md","pv":"file exists","c":"contains ## Shutdown Protocol Enforcement section with timeout handling"},{"p":"references/execute-protocol.md","pv":"file exists","c":"Step 10 references shutdown protocol via teammate-api-patterns.md"},{"p":"references/teammate-api-patterns.md","pv":"file exists","c":"## Shutdown Protocol section has timeout and verification details"},{"p":"references/handoff-schemas.md","pv":"file exists","c":"contains shutdown_request and shutdown_response schemas"}],"kl":[{"fr":"references/execute-protocol.md Step 10","to":"agents/yolo-lead.md ## Shutdown Protocol Enforcement","vi":"Step 10 sign-off triggers shutdown protocol in teammate mode"},{"fr":"agents/yolo-lead.md ## Shutdown Protocol Enforcement","to":"references/teammate-api-patterns.md ## Shutdown Protocol","vi":"Lead instructions reference canonical shutdown patterns"}]},"obj":"Enforce the shutdown protocol with timeout handling, verification, and logging in Lead agent and all teammate agent files","sk":["commit"],"fm":["agents/yolo-lead.md","references/teammate-api-patterns.md","references/execute-protocol.md","references/handoff-schemas.md","tests/static/shutdown-protocol.bats","agents/yolo-dev.md","agents/yolo-senior.md","agents/yolo-architect.md","agents/yolo-tester.md","agents/yolo-qa.md","agents/yolo-qa-code.md","agents/yolo-security.md","agents/yolo-fe-lead.md","agents/yolo-ux-lead.md","agents/yolo-fe-dev.md","agents/yolo-ux-dev.md"],"auto":true}
{"id":"T1","a":"Enhance ## Shutdown Protocol section in references/teammate-api-patterns.md with: (1) detailed timeout handling -- if teammate does not respond within deadline_seconds, Lead logs the timeout and proceeds with cleanup, (2) verification checklist -- Lead checks each teammate responded, (3) incomplete work logging -- any in_progress responses logged to summary.jsonl deviations field, (4) error recovery -- if shutdown itself fails, Lead force-proceeds with artifact verification.","f":["references/teammate-api-patterns.md"],"v":"Shutdown protocol section has timeout, verification, and error recovery documented","done":"Enhanced ## Shutdown Protocol with all 4 subsections","td":[],"tp":"auto","spec":"MODIFY file: references/teammate-api-patterns.md.\n\nTARGET: The existing ### Shutdown Protocol section under ## Team Lifecycle (lines 44-68). This section already contains the basic 3-step shutdown and schemas. ENHANCE it in place -- do NOT create a new top-level section.\n\nReplace the existing ### Shutdown Protocol content (lines 44-68) with the enhanced version:\n\n```markdown\n### Shutdown Protocol\n\nTwo-phase shutdown with timeout handling and verification:\n\n**Phase 1: Request**\n1. Lead sends `shutdown_request` message to ALL registered teammates via SendMessage.\n2. Include `deadline_seconds` (default: 30) and `reason` (phase_complete, timeout, or error).\n3. Start a deadline timer for each teammate.\n\n**Phase 2: Collection**\n4. Collect `shutdown_response` from each teammate.\n5. For each response, check `status` field:\n   - `clean`: Teammate completed work and committed artifacts. Ideal outcome.\n   - `in_progress`: Teammate could not finish within deadline. Log pending_work to summary.jsonl `dv` (deviations) field.\n   - `error`: Teammate encountered an error during shutdown. Log error details.\n6. **Timeout handling:** If a teammate does not respond within `deadline_seconds`:\n   - Log: \"[SHUTDOWN] Timeout: {agent_id} did not respond within {deadline_seconds}s.\"\n   - Mark teammate as timed_out in shutdown tracking.\n   - Do NOT block on the non-responsive teammate -- proceed with other responses.\n7. **Verification checklist:** After deadline expires, Lead verifies:\n   - All teammates either responded or timed out (no unaccounted agents).\n   - All `artifacts_committed: true` responses are verified via `git status` (clean for team files).\n   - Any `in_progress` work is logged to summary.jsonl deviations.\n8. **Error recovery:** If the shutdown protocol itself fails (e.g., SendMessage unavailable):\n   - Lead force-proceeds with artifact verification (git status, summary.jsonl).\n   - Lead logs: \"[SHUTDOWN] Protocol failed, force-proceeding with cleanup.\"\n   - Any uncommitted work is logged as deviation.\n\nshutdown_request schema:\n```json\n{\n  \"type\": \"shutdown_request\",\n  \"reason\": \"phase_complete | timeout | error\",\n  \"deadline_seconds\": 30\n}\n```\n\nshutdown_response schema:\n```json\n{\n  \"type\": \"shutdown_response\",\n  \"status\": \"clean | in_progress | error\",\n  \"pending_work\": [],\n  \"artifacts_committed\": true\n}\n```\n```\n\nThis replaces lines 44-68 in the current file. Keep ### Team Cleanup (line 70 onwards) unchanged -- it already references the shutdown protocol.","ts":""}
{"id":"T2","a":"Add ## Shutdown Protocol Enforcement section to agents/yolo-lead.md (canonical) with the complete Lead-side shutdown algorithm: (1) collect list of registered teammates per department, (2) send shutdown_request via SendMessage to each, (3) start deadline timer, (4) collect shutdown_response messages, (5) on timeout: log non-responding teammates, mark their work as incomplete in deviations, (6) verify all artifacts committed (git status clean for team files), (7) write final summary artifacts, (8) team auto-cleanup on Lead session end. Also update references/execute-protocol.md Step 10 with conditional shutdown trigger. Also add one-line cross-reference to agents/yolo-fe-lead.md and agents/yolo-ux-lead.md.","f":["agents/yolo-lead.md","references/execute-protocol.md","agents/yolo-fe-lead.md","agents/yolo-ux-lead.md"],"v":"Section present in yolo-lead.md with 8-step algorithm; Step 10 has teammate-mode shutdown trigger; cross-references in fe-lead and ux-lead","done":"## Shutdown Protocol Enforcement in yolo-lead.md; execute-protocol.md Step 10 updated; cross-references in fe-lead and ux-lead","td":["T1"],"tp":"auto","spec":"THREE files to modify:\n\n**File 1: agents/yolo-lead.md**\n\nINSERTION POINT: Insert ## Shutdown Protocol Enforcement section AFTER ## Circuit Breaker (added by plan 04-03 T3) and BEFORE ## Context. Per architecture.toon C1 resolution, the final order is: ... ## Circuit Breaker, ## Shutdown Protocol Enforcement, ## Context.\n\nTo find insertion point: locate '## Context' (shifted by previous plan additions). Insert BEFORE '## Context'.\n\nSection content:\n\n```markdown\n## Shutdown Protocol Enforcement\n\n> This section is active ONLY when team_mode=teammate. When team_mode=task, shutdown is handled by Task tool session termination (no explicit protocol needed).\n\nLead executes the shutdown protocol at Step 10 (sign-off) or on unrecoverable error. See references/teammate-api-patterns.md ### Shutdown Protocol for message schemas.\n\n### 8-Step Shutdown Algorithm\n\n1. **Collect teammates:** Build list of all registered teammates for this department from in-memory roster.\n2. **Send shutdown_request:** For each teammate, send shutdown_request via SendMessage with reason and deadline_seconds=30.\n3. **Start deadline timer:** Track 30s deadline per teammate.\n4. **Collect responses:** Receive shutdown_response from each teammate. Track: responded (clean/in_progress/error) or timed_out.\n5. **Handle timeouts:** After 30s, any teammate that has not responded is marked timed_out. Log: \"[SHUTDOWN] Timeout: {agent_id} did not respond within 30s.\" Do not block.\n6. **Verify artifacts:** Run `git status` to confirm all team-modified files are committed. If uncommitted files exist, log as deviation.\n7. **Write final summaries:** Ensure all summary.jsonl files are written and committed. Any in_progress or timed_out work logged in deviations.\n8. **Cleanup:** Team auto-cleans when Lead session ends. No explicit team deletion needed.\n\n### Trigger\n\nShutdown is triggered at Step 10 (sign-off) in execute-protocol.md. After the sign-off decision (SHIP or HOLD), Lead executes shutdown if team_mode=teammate. See references/execute-protocol.md Step 10 item 3.5.\n```\n\n**File 2: references/execute-protocol.md**\n\nINSERTION POINT: In Step 10 (starts at line 505), insert a new item 3.5 between existing item 3 (Decision, line 516-518) and item 4 (Cleanup, line 519). This is the shutdown trigger for teammate mode.\n\nContent to insert after line 518 ('Issues remain -> HOLD...'):\n\n```markdown\n3.5. **Teammate shutdown (team_mode=teammate only):** If team_mode=teammate, Lead executes the shutdown protocol before cleanup:\n   - Send `shutdown_request` to all registered teammates per agents/yolo-lead.md ## Shutdown Protocol Enforcement.\n   - Collect responses (30s deadline).\n   - Log timeouts and incomplete work as deviations.\n   - When team_mode=task: skip this step entirely (Task tool sessions end naturally).\n```\n\n**File 3: agents/yolo-fe-lead.md**\n\nINSERTION POINT: Inside ## Teammate API section. Add a new subsection AFTER ### Health Tracking and Circuit Breaker (added by 04-03 T3) and BEFORE ## Summary Aggregation:\n\n```markdown\n### Shutdown Protocol Enforcement\n\nFor shutdown enforcement protocol, see agents/yolo-lead.md ## Shutdown Protocol Enforcement. Apply same patterns with frontend team (yolo-frontend).\n```\n\n**File 4: agents/yolo-ux-lead.md**\n\nINSERTION POINT: Same position, after ### Health Tracking and Circuit Breaker, before ## Summary Aggregation:\n\n```markdown\n### Shutdown Protocol Enforcement\n\nFor shutdown enforcement protocol, see agents/yolo-lead.md ## Shutdown Protocol Enforcement. Apply same patterns with uiux team (yolo-uiux).\n```","ts":""}
{"id":"T3","a":"Add ## Shutdown Response section to agents/yolo-dev.md (canonical, full content) documenting teammate-side shutdown behavior: (1) on receiving shutdown_request, complete current task if in progress (do not start new tasks), (2) commit any pending artifacts, (3) send shutdown_response with status (clean/in_progress/error) and artifacts_committed flag, (4) if cannot complete within deadline, send in_progress status with pending_work list. Add one-line cross-reference to ALL other teammate agents: yolo-senior.md, yolo-architect.md, yolo-tester.md, yolo-qa.md, yolo-qa-code.md, yolo-security.md, yolo-fe-dev.md, yolo-ux-dev.md. Cross-reference line: 'For shutdown response protocol, follow agents/yolo-dev.md ## Shutdown Response.' (9 files total: 1 canonical + 8 cross-refs)","f":["agents/yolo-dev.md","agents/yolo-senior.md","agents/yolo-architect.md","agents/yolo-tester.md","agents/yolo-qa.md","agents/yolo-qa-code.md","agents/yolo-security.md","agents/yolo-fe-dev.md","agents/yolo-ux-dev.md"],"v":"Section present in yolo-dev.md with 4-step response protocol; cross-references in all 8 other teammate agents","done":"## Shutdown Response in yolo-dev.md; cross-references in 8 other agent files","td":["T1"],"tp":"auto","spec":"NINE files to modify (1 canonical + 8 cross-references):\n\n**File 1 (canonical): agents/yolo-dev.md**\n\nINSERTION POINT: Insert ## Shutdown Response section AFTER ## Task Self-Claiming (which ends at line 155 with 'Cross-references: Full task coordination patterns...') and BEFORE ## Constraints & Effort (which starts at line 157). This places the shutdown response with the other teammate-specific sections.\n\nSection content:\n\n```markdown\n## Shutdown Response\n\n> This section is active ONLY when team_mode=teammate. When team_mode=task, sessions end naturally (no explicit shutdown protocol).\n\nWhen receiving a `shutdown_request` via SendMessage from Lead:\n\n1. **Stop claiming:** Do NOT call TaskList or claim new tasks. If in the middle of the claim loop, exit the loop.\n2. **Complete current task:** If a task is in progress, finish it and commit. Do not abandon mid-task work.\n3. **Commit pending artifacts:** Stage and commit any uncommitted files. Use `scripts/git-commit-serialized.sh` for safe concurrent commits.\n4. **Send shutdown_response:** Via SendMessage to Lead:\n   - `status: \"clean\"` if all work committed and no pending tasks.\n   - `status: \"in_progress\"` if current task cannot finish within deadline. Include `pending_work` list describing incomplete items.\n   - `status: \"error\"` if commit failed or unexpected error occurred.\n   - `artifacts_committed: true` if all modified files are staged and committed.\n5. **Wait for session end:** After sending response, do not take further actions. Session terminates when Lead ends the team.\n\nSchema: See references/handoff-schemas.md ## shutdown_request and ## shutdown_response.\n```\n\n**Files 2-9 (cross-references):**\n\nFor EACH of the following 8 agent files, add a single cross-reference line inside their existing ## Teammate API section. The cross-reference goes as the LAST subsection before the section ends (before ## Context or ## Constraints & Effort, whichever comes first after ## Teammate API).\n\nCross-reference content (identical for all 8 files):\n\n```markdown\n### Shutdown Response\n\nFor shutdown response protocol, follow agents/yolo-dev.md ## Shutdown Response.\n```\n\nInsertion points per file:\n\n- **agents/yolo-senior.md**: ## Teammate API starts at line 83. Insert ### Shutdown Response AFTER ## Parallel Review (ends ~line 141) and BEFORE ## Context (line 143).\n- **agents/yolo-architect.md**: ## Teammate API starts at line 71. Insert ### Shutdown Response AFTER the last subsection in ## Teammate API and BEFORE ## Context (line 100).\n- **agents/yolo-tester.md**: ## Teammate API starts at line 66. Insert ### Shutdown Response AFTER the last subsection in ## Teammate API and BEFORE ## Constraints & Effort (line 112).\n- **agents/yolo-qa.md**: ## Teammate API starts at line 58. Insert ### Shutdown Response AFTER the last subsection in ## Teammate API and BEFORE ## Context (line 107).\n- **agents/yolo-qa-code.md**: ## Teammate API starts at line 90. Insert ### Shutdown Response AFTER the last subsection in ## Teammate API and BEFORE ## Context (line 142).\n- **agents/yolo-security.md**: ## Teammate API starts at line 125. Insert ### Shutdown Response AFTER the last subsection in ## Teammate API and BEFORE ## Context (line 162).\n- **agents/yolo-fe-dev.md**: ## Teammate API starts at line 74. Insert ### Shutdown Response AFTER the last subsection in ## Teammate API and BEFORE ## Context (line 150).\n- **agents/yolo-ux-dev.md**: ## Teammate API starts at line 83. Insert ### Shutdown Response AFTER the last subsection in ## Teammate API and BEFORE ## Context (line 159).","ts":""}
{"id":"T4","a":"Add shutdown_request and shutdown_response schemas to references/handoff-schemas.md as new sections. shutdown_request: {type, reason, deadline_seconds}. shutdown_response: {type, status, pending_work, artifacts_committed}. Place after ## escalation section and before ## Cross-Department Schemas section.","f":["references/handoff-schemas.md"],"v":"handoff-schemas.md contains shutdown_request and shutdown_response sections","done":"Both schemas present in handoff-schemas.md","td":[],"tp":"auto","spec":"MODIFY file: references/handoff-schemas.md.\n\nINSERTION POINT: Add the two schemas AFTER the ## `summary_aggregation` section (which ends at line 295 with 'In task mode, Dev writes summary.jsonl directly and this schema is not used.') and BEFORE the '---' separator line (line 297) and the ## Cross-Department Schemas section (line 299). This places the shutdown schemas with the other teammate-mode schemas.\n\nNOTE: Plan 04-03 T2 adds agent_health_event and circuit_breaker_state schemas AFTER ## escalation (line 242) and BEFORE ## task_claim (line 244). The shutdown schemas here go in a DIFFERENT location -- after summary_aggregation, before Cross-Department Schemas. Both insertions are valid because they do not overlap.\n\nContent to add:\n\n```markdown\n## `shutdown_request` (Lead -> Teammates, when team_mode=teammate)\n\nLead sends to all registered teammates to initiate graceful shutdown.\n\n```json\n{\n  \"type\": \"shutdown_request\",\n  \"reason\": \"phase_complete | timeout | error\",\n  \"deadline_seconds\": 30\n}\n```\n\nSent at Step 10 (sign-off) or on unrecoverable error. See references/teammate-api-patterns.md ### Shutdown Protocol for the full protocol. See agents/yolo-lead.md ## Shutdown Protocol Enforcement for Lead-side algorithm.\n\n## `shutdown_response` (Teammates -> Lead, when team_mode=teammate)\n\nTeammate sends to Lead after receiving shutdown_request.\n\n```json\n{\n  \"type\": \"shutdown_response\",\n  \"status\": \"clean | in_progress | error\",\n  \"pending_work\": [\"task T3 implementation incomplete\"],\n  \"artifacts_committed\": true\n}\n```\n\nSee agents/yolo-dev.md ## Shutdown Response for teammate-side protocol.\n```\n\nInsert with blank lines before and after. The '---' separator and ## Cross-Department Schemas header should follow after the new sections.","ts":""}
{"id":"T5","a":"Create tests/static/shutdown-protocol.bats validating: (1) yolo-lead.md contains ## Shutdown Protocol Enforcement section, (2) yolo-dev.md contains ## Shutdown Response section, (3) teammate-api-patterns.md shutdown section mentions deadline_seconds and timeout handling, (4) execute-protocol.md Step 10 references shutdown protocol, (5) handoff-schemas.md contains shutdown_request and shutdown_response schemas.","f":["tests/static/shutdown-protocol.bats"],"v":"All static tests pass","done":"5+ test cases, all passing","td":["T1","T2","T3","T4"],"tp":"auto","spec":"Create NEW file: tests/static/shutdown-protocol.bats.\n\nSHEBANG: #!/usr/bin/env bats with comment: # shutdown-protocol.bats -- Static validation: shutdown protocol documentation across all files\n\nsetup(): load '../test_helper/common' (provides AGENTS_DIR, PROJECT_ROOT, assert_* functions). Define: PATTERNS=\"$PROJECT_ROOT/references/teammate-api-patterns.md\". SCHEMAS=\"$PROJECT_ROOT/references/handoff-schemas.md\". EXEC_PROTO=\"$PROJECT_ROOT/references/execute-protocol.md\".\n\nTest cases:\n\n1. '@test \"yolo-lead.md contains Shutdown Protocol Enforcement section\"': run grep '## Shutdown Protocol Enforcement' \"$AGENTS_DIR/yolo-lead.md\"; assert_success.\n\n2. '@test \"yolo-dev.md contains Shutdown Response section\"': run grep '## Shutdown Response' \"$AGENTS_DIR/yolo-dev.md\"; assert_success.\n\n3. '@test \"teammate-api-patterns.md shutdown mentions deadline_seconds\"': run grep 'deadline_seconds' \"$PATTERNS\"; assert_success.\n\n4. '@test \"teammate-api-patterns.md shutdown mentions timeout handling\"': run grep -i 'timeout' \"$PATTERNS\"; assert_success.\n\n5. '@test \"execute-protocol.md Step 10 references shutdown\"': run grep -A 5 'Step 10' \"$EXEC_PROTO\" | grep -qi 'shutdown'; -- actually, better to just grep the file for 'shutdown' near Step 10. Use: run grep 'shutdown' \"$EXEC_PROTO\"; assert_success.\n\nAlternative for test 5:\n```bash\n@test \"execute-protocol.md references shutdown protocol\" {\n  run grep 'shutdown' \"$EXEC_PROTO\"\n  assert_success\n}\n```\n\n6. '@test \"handoff-schemas.md contains shutdown_request schema\"': run grep 'shutdown_request' \"$SCHEMAS\"; assert_success.\n\n7. '@test \"handoff-schemas.md contains shutdown_response schema\"': run grep 'shutdown_response' \"$SCHEMAS\"; assert_success.\n\n8. '@test \"8 teammate agents have Shutdown Response cross-reference\"': Count agents with 'Shutdown Response' cross-reference. Expected: yolo-senior.md, yolo-architect.md, yolo-tester.md, yolo-qa.md, yolo-qa-code.md, yolo-security.md, yolo-fe-dev.md, yolo-ux-dev.md = 8 files.\n```bash\n@test \"8 teammate agents reference Shutdown Response\" {\n  local count=0\n  for agent in yolo-senior.md yolo-architect.md yolo-tester.md yolo-qa.md yolo-qa-code.md yolo-security.md yolo-fe-dev.md yolo-ux-dev.md; do\n    if grep -q 'Shutdown Response' \"$AGENTS_DIR/$agent\"; then\n      count=$((count + 1))\n    fi\n  done\n  [ \"$count\" -eq 8 ]\n}\n```\n\n9. '@test \"FE and UX Leads reference Shutdown Protocol Enforcement\"': \n```bash\n@test \"FE and UX Leads reference Shutdown Protocol Enforcement\" {\n  run grep 'Shutdown Protocol Enforcement' \"$AGENTS_DIR/yolo-fe-lead.md\"\n  assert_success\n  run grep 'Shutdown Protocol Enforcement' \"$AGENTS_DIR/yolo-ux-lead.md\"\n  assert_success\n}\n```\n\n10. '@test \"shutdown protocol mentions 30s deadline\"': run grep '30' \"$AGENTS_DIR/yolo-lead.md\" | grep -qi 'deadline\\|shutdown\\|second'; -- simpler: run grep 'deadline_seconds.*30\\|30s\\|30 second' \"$AGENTS_DIR/yolo-lead.md\"; assert_success. Or just: run grep '30s' \"$AGENTS_DIR/yolo-lead.md\"; assert_success.\n\nTotal: 10 test cases. All are static file content checks.","ts":""}
