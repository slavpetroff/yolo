{"p":"04","n":"02","t":"Fallback cascade and team_mode auto detection","w":1,"d":[],"xd":[{"p":"01","n":"03","a":".yolo-planning/phases/01-team-abstraction-layer/01-03.summary.jsonl","r":"resolve-team-mode.sh foundation from Phase 1"},{"p":"02","n":"01","a":".yolo-planning/phases/02-department-teams/02-01.summary.jsonl","r":"agent Teammate API sections from Phase 2"}],"mh":{"tr":["team_mode=auto correctly detects API availability via env var and config flag only (no dry-run probe)","If CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS env var not set, auto-falls back to task with logged warning","Fallback cascade order: teammate -> task -> error with logging at each step","All changes additive -- zero regression on team_mode=task behavior","resolve-team-mode.sh outputs 3 lines when auto: team_mode, fallback_notice, auto_detected; 2 lines for task/teammate (backward compatible)"],"ar":[{"p":"scripts/resolve-team-mode.sh","pv":"file exists, contains auto mode logic","c":"handles team_mode=auto with env-var + config check (no dry-run probe)"},{"p":"references/teammate-api-patterns.md","pv":"file exists","c":"contains ## Fallback Cascade section"}],"kl":[{"fr":"scripts/resolve-team-mode.sh","to":"references/teammate-api-patterns.md ## Task Mode Fallback","vi":"script implements the fallback cascade documented in patterns"}]},"obj":"Implement team_mode=auto detection in resolve-team-mode.sh and document the full fallback cascade (teammate -> task -> error) in agent instructions (REQ-03)","sk":["commit"],"fm":["scripts/resolve-team-mode.sh","references/teammate-api-patterns.md","tests/unit/resolve-team-mode.bats","agents/yolo-lead.md","agents/yolo-fe-lead.md","agents/yolo-ux-lead.md"],"auto":true}
{"id":"T1","a":"Enhance scripts/resolve-team-mode.sh to support team_mode=auto: (1) check CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS env var is set, (2) check agent_teams != false in config. If both pass, output team_mode=teammate. If either fails, output team_mode=task with fallback_notice=true. Output auto_detected=true|false as 3rd line ONLY when input team_mode is auto. When team_mode is task or teammate, output remains exactly 2 lines (backward compatible). No dry-run probe -- auto detection uses env-var + config only.","f":["scripts/resolve-team-mode.sh"],"v":"Script handles auto mode correctly: env var + config check, 3 lines for auto, 2 lines for task/teammate","done":"resolve-team-mode.sh contains auto mode branch with env-var + config logic, no dry-run probe","td":[],"tp":"auto","spec":"MODIFY file: scripts/resolve-team-mode.sh (45 lines currently).\n\n1. UPDATE HEADER COMMENT (lines 8-11): Add 'auto' to the team_mode values: 'team_mode=task|teammate|auto'. Add comment for auto_detected: '# auto_detected=true|false (3rd line, only when input team_mode=auto)'. Update the Usage line to mention auto mode.\n\n2. AFTER the existing jq read (line 25): The IFS read already extracts TEAM_MODE and AGENT_TEAMS. No change needed to the jq expression -- it already reads team_mode from config which can now be 'auto'.\n\n3. ADD NEW AUTO MODE BLOCK: Insert AFTER line 27 (FALLBACK_NOTICE=\"false\") and BEFORE line 29 (# Validation: agent_teams). Add:\n\n```bash\n# Auto mode: detect optimal team_mode from environment\nif [ \"$TEAM_MODE\" = \"auto\" ]; then\n  AUTO_INPUT=true\n  # Check preconditions for teammate mode\n  if [ \"$AGENT_TEAMS\" = \"true\" ] && [ -n \"${CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS:-}\" ]; then\n    TEAM_MODE=\"teammate\"\n  else\n    TEAM_MODE=\"task\"\n    FALLBACK_NOTICE=\"true\"\n  fi\nelse\n  AUTO_INPUT=false\nfi\n```\n\n4. EXISTING VALIDATION BLOCKS (lines 29-41): Keep these UNCHANGED. They handle the case where team_mode=teammate was explicitly set but env var or agent_teams is missing. The auto block above resolves to either 'task' or 'teammate' before these checks run, so they serve as a second validation layer for the explicit teammate case.\n\n5. MODIFY OUTPUT SECTION (lines 43-44): Replace the existing echo lines with:\n\n```bash\necho \"team_mode=$TEAM_MODE\"\necho \"fallback_notice=$FALLBACK_NOTICE\"\nif [ \"$AUTO_INPUT\" = true ]; then\n  echo \"auto_detected=${AUTO_INPUT}\"\nfi\n```\n\nWait -- per D4, the 3rd line should be auto_detected=true|false, where the value indicates whether auto was the input mode (always true when output). Actually re-reading the architecture: 'Output auto_detected=true|false ONLY when input team_mode is auto.' The value should reflect whether teammate was successfully auto-detected: auto_detected=true when auto resolved to teammate, auto_detected=false when auto fell back to task. So:\n\n```bash\necho \"team_mode=$TEAM_MODE\"\necho \"fallback_notice=$FALLBACK_NOTICE\"\nif [ \"$AUTO_INPUT\" = true ]; then\n  if [ \"$TEAM_MODE\" = \"teammate\" ]; then\n    echo \"auto_detected=true\"\n  else\n    echo \"auto_detected=false\"\n  fi\nfi\n```\n\n6. BACKWARD COMPATIBILITY: When TEAM_MODE is 'task' or 'teammate' (not auto), AUTO_INPUT=false, so the 3rd line is never output. Exactly 2 lines, same as before. All existing tests pass without modification (auto mode tests are added in T4).\n\n7. NO DRY-RUN PROBE: Do not add any spawnTeam, Teammate API, or network call. The only checks are: (a) AGENT_TEAMS string comparison, (b) env var existence check. Both are pure bash, no external calls.","ts":"File: tests/unit/resolve-team-mode.bats. Framework: bats. Existing file with 10 tests (tests 1-10). Add new tests AFTER test 10. Test cases for auto mode:\n\n1. '@test \"auto mode with env var set and agent_teams=true resolves to teammate\"': export CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS=1; echo '{\"team_mode\":\"auto\",\"agent_teams\":true}' > \"$TEST_WORKDIR/cfg.json\"; run bash \"$SUT\" \"$TEST_WORKDIR/cfg.json\"; assert_success; assert_line 'team_mode=teammate'; assert_line 'auto_detected=true'.\n\n2. '@test \"auto mode without env var falls back to task\"': unset CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS; echo '{\"team_mode\":\"auto\",\"agent_teams\":true}' > \"$TEST_WORKDIR/cfg.json\"; run bash \"$SUT\" \"$TEST_WORKDIR/cfg.json\"; assert_success; assert_line 'team_mode=task'; assert_line 'fallback_notice=true'; assert_line 'auto_detected=false'.\n\n3. '@test \"auto mode with env var but agent_teams=false falls back to task\"': export CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS=1; echo '{\"team_mode\":\"auto\",\"agent_teams\":false}' > \"$TEST_WORKDIR/cfg.json\"; run bash \"$SUT\" \"$TEST_WORKDIR/cfg.json\"; assert_success; assert_line 'team_mode=task'; assert_line 'fallback_notice=true'; assert_line 'auto_detected=false'.\n\n4. '@test \"auto mode outputs exactly 3 lines\"': export CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS=1; echo '{\"team_mode\":\"auto\",\"agent_teams\":true}' > \"$TEST_WORKDIR/cfg.json\"; run bash \"$SUT\" \"$TEST_WORKDIR/cfg.json\"; local lc; lc=$(echo \"$output\" | wc -l | tr -d ' '); [ \"$lc\" -eq 3 ].\n\n5. '@test \"task mode still outputs exactly 2 lines (backward compat)\"': echo '{\"team_mode\":\"task\",\"agent_teams\":true}' > \"$TEST_WORKDIR/cfg.json\"; run bash \"$SUT\" \"$TEST_WORKDIR/cfg.json\"; local lc; lc=$(echo \"$output\" | wc -l | tr -d ' '); [ \"$lc\" -eq 2 ]."}
{"id":"T2","a":"Add ## Fallback Cascade section to references/teammate-api-patterns.md documenting the 3-tier fallback: (1) Teammate API (team_mode=teammate), (2) Task tool (team_mode=task), (3) Error with clear message. Document triggers for each fallback level: env var missing, spawnTeam failure, teammate unresponsive. Include logging expectations at each transition.","f":["references/teammate-api-patterns.md"],"v":"Section exists with all 3 tiers and trigger conditions documented","done":"## Fallback Cascade section present in teammate-api-patterns.md","td":[],"tp":"auto","spec":"MODIFY file: references/teammate-api-patterns.md.\n\nINSERTION POINT: Insert the new ## Fallback Cascade section BEFORE the existing ## Task Mode Fallback section (which starts at line 320). The new section goes after ## Task-Level Blocking (ends around line 318) and before ## Task Mode Fallback (line 320).\n\nSection content to add:\n\n```markdown\n## Fallback Cascade\n\nThree-tier graceful degradation when Teammate API is unavailable or fails mid-execution.\n\n### Tier 1: Teammate API (Preferred)\n\nConditions: team_mode=teammate (explicit or auto-detected), CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS env var set, agent_teams=true in config. All agents spawned via spawnTeam/addTeammate, communication via SendMessage.\n\n### Tier 2: Task Tool Fallback\n\nTriggers:\n- **Pre-execution:** resolve-team-mode.sh detects env var missing OR agent_teams=false. Outputs team_mode=task with fallback_notice=true.\n- **Runtime:** spawnTeam call fails (API error, timeout, unsupported). Lead catches failure and switches to Task tool for remaining agents.\n- **Mid-execution:** Teammate becomes unresponsive (60s timeout, see ## Health Tracking). Lead reassigns work via Task tool.\n\nBehavior: All agent spawning reverts to Task tool. File-based communication replaces SendMessage. Existing escalation chains, schemas, and artifact formats unchanged. Only the transport mechanism changes.\n\nLogging: Lead logs each fallback transition to stderr: \"[FALLBACK] {reason}: switching from teammate to task for {agent/department}\"\n\n### Tier 3: Error (Terminal)\n\nTriggers:\n- Task tool also fails (model unavailable, permissions error).\n- No further fallback possible.\n\nBehavior: Lead logs error, commits any partial artifacts, escalates to Architect with escalation schema. Phase execution halts with clear error message.\n\n### Department Isolation\n\nFallback is per-department. If Backend teammate fails, only Backend falls back to Task tool. Frontend and UI/UX continue in teammate mode unaffected. Each Lead manages its own fallback state independently.\n```\n\nInsert this block on a new line after the last line of ## Task-Level Blocking section (the line with 'See `references/artifact-formats.md`...' at line 318) and before '## Task Mode Fallback' (line 320). Add a blank line before and after the new section.","ts":""}
{"id":"T3","a":"Add ## Fallback Behavior section to agents/yolo-lead.md (canonical) documenting Lead's responsibility for fallback decisions: (1) at spawn time (before work begins) based on resolve-team-mode.sh output, (2) on mid-execution failure (teammate unresponsive -> reassign via Task tool), (3) department-level isolation (one department failure does not cascade to others). Include decision tree for Lead. Also add one-line cross-reference to agents/yolo-fe-lead.md and agents/yolo-ux-lead.md under their existing ## Teammate API section: 'For fallback behavior, see agents/yolo-lead.md ## Fallback Behavior. Apply same patterns with frontend/uiux team names.'","f":["agents/yolo-lead.md","agents/yolo-fe-lead.md","agents/yolo-ux-lead.md"],"v":"Section exists in yolo-lead.md with spawn-time and mid-execution fallback documented; cross-references present in fe-lead and ux-lead","done":"## Fallback Behavior section present in yolo-lead.md; cross-references in yolo-fe-lead.md and yolo-ux-lead.md","td":["T2"],"tp":"auto","spec":"THREE files to modify:\n\n**File 1: agents/yolo-lead.md**\n\nINSERTION POINT: Insert ## Fallback Behavior section AFTER ## Summary Aggregation (which ends at line 143 with 'Cross-references: Full patterns...') and BEFORE ## Context (which starts at line 145). This follows the section ordering defined in architecture.toon C1 resolution.\n\nSection content:\n\n```markdown\n## Fallback Behavior\n\n> This section is active ONLY when team_mode=teammate or team_mode=auto. When team_mode=task, no fallback logic is needed.\n\nLead manages the fallback cascade. See references/teammate-api-patterns.md ## Fallback Cascade for tier definitions.\n\n### Spawn-Time Fallback\n\nBefore work begins, check resolve-team-mode.sh output:\n- If `team_mode=teammate` and `fallback_notice=false`: proceed with Teammate API.\n- If `team_mode=task` and `fallback_notice=true`: teammate was requested but unavailable. Use Task tool. Log: \"[FALLBACK] Pre-execution: teammate unavailable, using Task tool.\"\n- If `team_mode=task` and `fallback_notice=false`: Task tool was explicitly chosen. No fallback needed.\n\n### Mid-Execution Fallback\n\nIf a teammate becomes unresponsive during execution (60s timeout per ## Agent Health Tracking):\n1. Log the failure: \"[FALLBACK] Mid-execution: {agent} unresponsive after 60s.\"\n2. Mark the agent's current task as available (remove from claimed_files).\n3. Spawn a replacement agent via Task tool for the remaining work.\n4. Do NOT retry teammate creation -- the circuit breaker (## Circuit Breaker) manages retry policy.\n\n### Department Isolation\n\nFallback is per-department. If Backend's teammate fails, only Backend falls back. Frontend and UI/UX teams are unaffected. Each Lead tracks its own fallback state independently.\n```\n\n**File 2: agents/yolo-fe-lead.md**\n\nINSERTION POINT: Inside the existing ## Teammate API section (starts at line 84). Add a new subsection AFTER ### Unchanged Behavior (which ends at line 103) and BEFORE ## Summary Aggregation (which starts at line 105). Add this line:\n\n```markdown\n### Fallback Behavior\n\nFor fallback behavior, see agents/yolo-lead.md ## Fallback Behavior. Apply same patterns with frontend team names (yolo-frontend).\n```\n\n**File 3: agents/yolo-ux-lead.md**\n\nINSERTION POINT: Inside the existing ## Teammate API section (starts at line 78). Add a new subsection AFTER ### Unchanged Behavior (which ends at line 97) and BEFORE ## Summary Aggregation (which starts at line 99). Add this line:\n\n```markdown\n### Fallback Behavior\n\nFor fallback behavior, see agents/yolo-lead.md ## Fallback Behavior. Apply same patterns with uiux team names (yolo-uiux).\n```","ts":""}
{"id":"T4","a":"Extend tests/unit/resolve-team-mode.bats with tests for auto mode: (1) auto with env var set and agent_teams=true -> teammate, (2) auto with env var missing -> task with fallback_notice, (3) auto with env var set but agent_teams=false -> task with fallback_notice, (4) auto_detected output line present when auto mode, (5) auto mode still respects agent_teams=false override. Update existing test 9 ('outputs exactly 2 lines') to assert all output lines match ^[a-z_]+=.+ pattern (key=value format validation). Add new test: when team_mode=auto and env var set, outputs exactly 3 lines. Add new test: when team_mode=task, outputs exactly 2 lines (backward compatibility). Ensure all existing tests still pass.","f":["tests/unit/resolve-team-mode.bats"],"v":"All new and existing tests pass, auto mode covered, test 9 updated to key=value format validation","done":"5+ new test cases added, test 9 updated, total 15+ tests passing","td":["T1"],"tp":"auto","spec":"MODIFY file: tests/unit/resolve-team-mode.bats (currently 125 lines, 10 tests).\n\n**Modification 1 -- Update test 9 (lines 105-113):**\n\nReplace the existing test 9 body. Current test:\n```bash\n@test \"outputs exactly 2 lines\" {\n  run bash \"$SUT\" \"$TEST_WORKDIR/nonexistent.json\"\n  assert_success\n  local line_count\n  line_count=$(echo \"$output\" | wc -l | tr -d ' ')\n  [ \"$line_count\" -eq 2 ]\n}\n```\n\nReplace with:\n```bash\n@test \"all output lines match key=value format\" {\n  run bash \"$SUT\" \"$TEST_WORKDIR/nonexistent.json\"\n  assert_success\n  while IFS= read -r line; do\n    [[ \"$line\" =~ ^[a-z_]+=.+ ]] || fail \"Line does not match key=value: $line\"\n  done <<< \"$output\"\n}\n```\n\nThis validates output format without hardcoding line count, accommodating both 2-line (task/teammate) and 3-line (auto) outputs.\n\n**Modification 2 -- Add new tests AFTER test 10 (after line 124):**\n\nAdd the following 7 new test cases:\n\n```bash\n# --- 11. Auto mode with env var set and agent_teams=true -> teammate ---\n\n@test \"auto mode with env var and agent_teams=true resolves to teammate\" {\n  export CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS=1\n  echo '{\"team_mode\":\"auto\",\"agent_teams\":true}' > \"$TEST_WORKDIR/cfg.json\"\n  run bash \"$SUT\" \"$TEST_WORKDIR/cfg.json\"\n  assert_success\n  assert_line 'team_mode=teammate'\n  assert_line 'fallback_notice=false'\n  assert_line 'auto_detected=true'\n}\n\n# --- 12. Auto mode without env var -> task with fallback ---\n\n@test \"auto mode without env var falls back to task\" {\n  unset CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS 2>/dev/null || true\n  echo '{\"team_mode\":\"auto\",\"agent_teams\":true}' > \"$TEST_WORKDIR/cfg.json\"\n  run bash \"$SUT\" \"$TEST_WORKDIR/cfg.json\"\n  assert_success\n  assert_line 'team_mode=task'\n  assert_line 'fallback_notice=true'\n  assert_line 'auto_detected=false'\n}\n\n# --- 13. Auto mode with env var but agent_teams=false -> task ---\n\n@test \"auto mode with agent_teams=false falls back to task\" {\n  export CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS=1\n  echo '{\"team_mode\":\"auto\",\"agent_teams\":false}' > \"$TEST_WORKDIR/cfg.json\"\n  run bash \"$SUT\" \"$TEST_WORKDIR/cfg.json\"\n  assert_success\n  assert_line 'team_mode=task'\n  assert_line 'fallback_notice=true'\n  assert_line 'auto_detected=false'\n}\n\n# --- 14. Auto mode outputs exactly 3 lines ---\n\n@test \"auto mode outputs exactly 3 lines\" {\n  export CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS=1\n  echo '{\"team_mode\":\"auto\",\"agent_teams\":true}' > \"$TEST_WORKDIR/cfg.json\"\n  run bash \"$SUT\" \"$TEST_WORKDIR/cfg.json\"\n  assert_success\n  local line_count\n  line_count=$(echo \"$output\" | wc -l | tr -d ' ')\n  [ \"$line_count\" -eq 3 ]\n}\n\n# --- 15. Task mode still outputs exactly 2 lines ---\n\n@test \"task mode outputs exactly 2 lines\" {\n  echo '{\"team_mode\":\"task\",\"agent_teams\":true}' > \"$TEST_WORKDIR/cfg.json\"\n  run bash \"$SUT\" \"$TEST_WORKDIR/cfg.json\"\n  assert_success\n  local line_count\n  line_count=$(echo \"$output\" | wc -l | tr -d ' ')\n  [ \"$line_count\" -eq 2 ]\n}\n\n# --- 16. Teammate mode still outputs exactly 2 lines ---\n\n@test \"teammate mode outputs exactly 2 lines\" {\n  export CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS=1\n  echo '{\"team_mode\":\"teammate\",\"agent_teams\":true}' > \"$TEST_WORKDIR/cfg.json\"\n  run bash \"$SUT\" \"$TEST_WORKDIR/cfg.json\"\n  assert_success\n  local line_count\n  line_count=$(echo \"$output\" | wc -l | tr -d ' ')\n  [ \"$line_count\" -eq 2 ]\n}\n\n# --- 17. Auto mode with missing agent_teams field defaults to true ---\n\n@test \"auto mode with missing agent_teams defaults to true\" {\n  export CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS=1\n  echo '{\"team_mode\":\"auto\"}' > \"$TEST_WORKDIR/cfg.json\"\n  run bash \"$SUT\" \"$TEST_WORKDIR/cfg.json\"\n  assert_success\n  assert_line 'team_mode=teammate'\n  assert_line 'auto_detected=true'\n}\n```\n\nTotal tests after modification: 17 (10 original with test 9 updated + 7 new). Run bats tests/unit/resolve-team-mode.bats to verify all 17 pass.","ts":""}
