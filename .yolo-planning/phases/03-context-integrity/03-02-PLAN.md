---
phase: "03"
plan: "02"
title: "Step-ordering verification and delegation mandate reinforcement in SKILL.md"
wave: 1
depends_on: []
must_haves:
  - "execution-state.json schema includes steps_completed array initialized to []"
  - "Each protocol step (2, 2b, 3, 3c, 3d, 4, 4.5, 5) appends its ID to steps_completed"
  - "Step 5 validates all required steps present before marking complete — HARD STOP on missing"
  - "Delegation mandate at line 428 strengthened with anti-takeover language"
  - "Delegation reminders inserted at Steps 3c, 3d, and 5"
---

## Tasks

### Task 1: Add steps_completed to execution-state.json schema and step tracking

**Files:** `skills/execute-protocol/SKILL.md`

Add step-ordering verification infrastructure (REQ-05).

**Schema change (Step 2, item 7):**
Add `"steps_completed": []` to the execution-state.json initial write at line 30. The updated JSON block becomes:

```json
{
  "phase": N, "phase_name": "{slug}", "status": "running",
  "started_at": "{ISO 8601}", "wave": 1, "total_waves": N,
  "correlation_id": "{UUID}",
  "steps_completed": [],
  "plans": [{"id": "NN-MM", "title": "...", "wave": W, "status": "pending|complete"}]
}
```

**Step tracking — append step ID after each step completes:**

After each step's final action (before proceeding to the next step), add a jq command to append the step ID to `steps_completed`:

1. **After Step 2 completes** (after cross-phase deps validation, before Step 2b):
```bash
jq '.steps_completed += ["step_2"]' \
  .yolo-planning/.execution-state.json > /tmp/exec-state-tmp.json && \
  mv /tmp/exec-state-tmp.json .yolo-planning/.execution-state.json
```

2. **After Step 2b completes** (after review gate verdict, before Step 3):
```bash
jq '.steps_completed += ["step_2b"]' \
  .yolo-planning/.execution-state.json > /tmp/exec-state-tmp.json && \
  mv /tmp/exec-state-tmp.json .yolo-planning/.execution-state.json
```

3. **After Step 3 completes** (after all plans dispatched, before Step 3c):
```bash
jq '.steps_completed += ["step_3"]' \
  .yolo-planning/.execution-state.json > /tmp/exec-state-tmp.json && \
  mv /tmp/exec-state-tmp.json .yolo-planning/.execution-state.json
```

4. **After Step 3c completes** (after SUMMARY.md gate, before Step 3d):
```bash
jq '.steps_completed += ["step_3c"]' \
  .yolo-planning/.execution-state.json > /tmp/exec-state-tmp.json && \
  mv /tmp/exec-state-tmp.json .yolo-planning/.execution-state.json
```

5. **After Step 3d completes** (after QA gate, before Step 4/4.5/5):
```bash
jq '.steps_completed += ["step_3d"]' \
  .yolo-planning/.execution-state.json > /tmp/exec-state-tmp.json && \
  mv /tmp/exec-state-tmp.json .yolo-planning/.execution-state.json
```

6. **After Step 4 completes** (if active — after UAT, before Step 5). Conditional on UAT being active:
```bash
jq '.steps_completed += ["step_4"]' \
  .yolo-planning/.execution-state.json > /tmp/exec-state-tmp.json && \
  mv /tmp/exec-state-tmp.json .yolo-planning/.execution-state.json
```

**Commit:** `feat(skills): add step-ordering tracking to execution-state.json`

### Task 2: Add Step 5 validation gate and delegation reminders

**Files:** `skills/execute-protocol/SKILL.md`

Add the step-ordering validation at Step 5 (REQ-05) and delegation mandate reinforcement (REQ-06).

**Step 5 validation gate (add at the TOP of Step 5, before the shutdown gate):**

Insert a new "Step Ordering Verification" block before the existing "HARD GATE — Shutdown" block at line 1086:

```markdown
**HARD GATE — Step Ordering Verification:** Before ANY other Step 5 action, validate that all required protocol steps were completed:

```bash
REQUIRED_STEPS='["step_2","step_2b","step_3","step_3c","step_3d"]'
COMPLETED=$(jq -r '.steps_completed // []' .yolo-planning/.execution-state.json)
MISSING=$(jq -n --argjson req "$REQUIRED_STEPS" --argjson done "$COMPLETED" \
  '$req - $done | if length > 0 then . else empty end')
```

If `MISSING` is non-empty: **HARD STOP**. Display:
```
✗ Step ordering violation — skipped steps detected: {MISSING}
  Required: step_2 → step_2b → step_3 → step_3c → step_3d
  Completed: {COMPLETED}
  Action: Re-run phase execution from the first missing step.
```
Do NOT proceed. Do NOT mark phase complete.

If `MISSING` is empty: Display `✓ Step ordering verified — all required steps completed` and proceed.
```

**Delegation mandate reinforcement (REQ-06):**

1. **Strengthen existing mandate** at line 428 (the "Delegation directive" block). Replace the existing 4-line block with:

```markdown
**Delegation directive (all except Turbo):**
You are the team LEAD. NEVER implement tasks yourself. This is a HARD RULE that survives context compression.

- Delegate ALL implementation to Dev teammates via TaskCreate
- NEVER Write/Edit files in a plan's `files_modified` — only state files: STATE.md, ROADMAP.md, .execution-state.json, SUMMARY.md
- If Dev fails: guidance via SendMessage, not takeover. If all Devs unavailable: create new Dev.
- If you feel compelled to implement: STOP. Create a new Dev agent instead. You are LEAD, not Dev.
- At Turbo (or smart-routed to turbo): no team — Dev executes directly.
```

2. **Add reminder at Step 3c** (SUMMARY.md verification section). After the existing Step 3c heading, add:
```markdown
> **Role reminder:** You are LEAD. Do NOT edit plan files or source code yourself. Verify via reads only.
```

3. **Add reminder at Step 3d** (QA gate section). After the existing Step 3d heading, add:
```markdown
> **Role reminder:** You are LEAD. QA is agent-based — spawn yolo-qa, do not self-review.
```

4. **Add reminder at Step 5** (after the step ordering gate, before shutdown gate). Add:
```markdown
> **Role reminder:** You are LEAD. State updates only — no implementation, no file edits beyond state files.
```

**Commit:** `feat(skills): add step-ordering validation and delegation reinforcement`

