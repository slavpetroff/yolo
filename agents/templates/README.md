# Agent Templates

Template-based generation system for YOLO's 27 department agents (9 roles x 3 departments).

## Overview

Each agent file (`agents/yolo-*.md`) is generated by combining a **template** (`agents/templates/<role>.md`) with a **department overlay** (`agents/overlays/<dept>.json`). Templates contain `{{PLACEHOLDER}}` markers that get replaced with department-specific values from the overlay.

```
templates/dev.md  +  overlays/backend.json   ->  agents/yolo-dev.md
templates/dev.md  +  overlays/frontend.json  ->  agents/yolo-fe-dev.md
templates/dev.md  +  overlays/uiux.json      ->  agents/yolo-ux-dev.md
```

**Do not edit generated agent files directly.** They are overwritten on regeneration. Edit the template or overlay instead.

## How to Modify an Agent

1. **Role-wide change** (affects all 3 departments): Edit the template in `agents/templates/<role>.md`
2. **Department-specific change** (one department only): Edit the overlay in `agents/overlays/<dept>.json`
3. **Single agent change** (one role + one department): Add/override the key in the role-specific section of the overlay

After editing, regenerate:

```bash
# Single agent
scripts/generate-agent.sh --role dev --dept backend

# All 27 agents
scripts/regenerate-agents.sh --force
```

## generate-agent.sh

Combines one template with one overlay to produce a single agent file.

```
Usage: generate-agent.sh --role <role> --dept <dept> [--mode <mode>] [--dry-run] [--output <path>]

Options:
  --role <role>    architect, lead, senior, dev, tester, qa, qa-code, security, documenter
  --dept <dept>    backend, frontend, uiux
  --mode <mode>    Filter by workflow mode: plan, implement, review, qa, test, full (default: full)
  --dry-run        Print to stdout instead of writing file
  --output <path>  Custom output path
```

The script:
1. Merges `common` + role-specific overlay keys (role overrides common)
2. Replaces all `{{PLACEHOLDER}}` markers via jq gsub
3. Filters mode-gated sections (when `--mode` specified)
4. Prepends the `GENERATED` marker
5. Writes to `agents/yolo-<prefix><role>.md`

## regenerate-agents.sh

Batch wrapper that regenerates all 27 agents.

```
Usage: regenerate-agents.sh [--check] [--force] [--dry-run]

Options:
  --check     Exit 1 if any generated file is stale (CI validation)
  --force     Overwrite all without prompting
  --dry-run   Print output without writing files
```

After successful regeneration, writes a source hash to `agents/.agent-generation-hash`.

## model-profiles.json

`config/model-profiles.json` maps each role to a model tier (opus, sonnet, haiku) across 3 profiles (quality, balanced, budget). This is separate from templates -- templates use `model: inherit` in frontmatter, and the runtime resolves the actual model from the profile.

## Staleness Detection

Two mechanisms detect when agents need regeneration:

1. **Hash file** (`agents/.agent-generation-hash`): SHA-256 of all templates + overlays. If source files change but agents are not regenerated, the hash mismatches.
2. **Content diff** (`regenerate-agents.sh --check`): Generates each agent to a temp buffer and diffs against the on-disk file. Catches any manual edits to generated files.

Use in CI: `regenerate-agents.sh --check || echo "Agents are stale"`

## GENERATED Marker

Line 1 of every generated agent file:

```
<!-- GENERATED by generate-agent.sh -- DO NOT EDIT MANUALLY -->
```

This marker:
- Signals that the file is auto-generated and should not be hand-edited
- Is skipped by frontmatter validation (the `---` delimiter starts on line 2)
- Is preserved across regeneration cycles

## Overlay Structure

Each overlay file (`agents/overlays/<dept>.json`) has this structure:

```json
{
    "common": {
        "DEPT": "backend",
        "DEPT_PREFIX": "",
        "DEPT_LABEL": "",
        ...
    },
    "dev": {
        "ROLE_TITLE": "Junior Developer agent",
        "DEV_ARCHETYPE": "...",
        ...
    },
    "senior": { ... },
    "lead": { ... },
    "architect": { ... },
    "tester": { ... },
    "qa": { ... },
    "qa-code": { ... },
    "security": { ... },
    "documenter": { ... }
}
```

- **`common`**: Shared across all roles in this department (DEPT_PREFIX, DEPT_LABEL, team names, protocol refs)
- **Role sections**: Role-specific values that override common keys and fill role-specific placeholders
- Merge order: `common` + `role` (role wins on conflict)
- Departments: `backend.json` (no prefix), `frontend.json` (`fe-` prefix), `uiux.json` (`ux-` prefix)
