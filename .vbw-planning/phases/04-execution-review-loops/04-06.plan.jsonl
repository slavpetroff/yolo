{"p":"04","n":"06","t":"Tests for Phase 4 scripts and schemas","w":2,"d":["04-01","04-02","04-03","04-04","04-05"],"mh":["review-loop.sh unit tests covering approve/changes_requested/escalation paths","resolve-research-request.sh unit tests covering blocking/informational/validation","validate-summary.sh tests for sg field validation (present, absent, invalid)","escalation.jsonl static schema validation tests","test-results.jsonl static schema validation tests"],"obj":"Write bats unit tests for all new Phase 4 scripts and static schema validation tests for new JSONL artifacts. Follows Phase 3 pattern of comprehensive test coverage for every new script."}
{"id":"T1","tp":"create","a":"Create tests/unit/test-review-loop.bats: Test review-loop.sh with scenarios: (1) First cycle approve — exits 0, JSON output has cycles_used:1, result:'approve'; (2) First cycle changes_requested — exits with cycle status JSON, does not escalate; (3) Second cycle approve — exits 0, cycles_used:2; (4) Second cycle still changes_requested — exits 1, result:'escalated'; (5) Missing code-review.jsonl — exits with error; (6) Custom max_cycles from config — respects config override; (7) Plan ID filtering — only reads verdict for specified plan. Use bats-assert and bats-support. Create temp phase dirs with fixture code-review.jsonl files.","f":["tests/unit/test-review-loop.bats"],"v":"bats tests/unit/test-review-loop.bats runs without syntax errors","done":false}
{"id":"T2","tp":"create","a":"Create tests/unit/test-resolve-research-request.bats: Test resolve-research-request.sh with scenarios: (1) Blocking request — outputs dispatching status with timeout; (2) Informational request — outputs queued status; (3) Invalid request JSON — exits with error; (4) Missing required fields (query, request_type) — exits with error; (5) Custom timeout from config — respects research_requests.blocking_timeout_seconds; (6) Custom max concurrent scouts — respects research_requests.max_concurrent_scouts; (7) Appends to research.jsonl with ra and rt fields. Use temp dirs and fixture JSON.","f":["tests/unit/test-resolve-research-request.bats"],"v":"bats tests/unit/test-resolve-research-request.bats runs without syntax errors","done":false}
{"id":"T3","tp":"create","a":"Create tests/unit/test-validate-summary-sg.bats: Test validate-summary.sh sg field handling: (1) Valid summary with sg:[\"suggestion\"] — passes; (2) Valid summary without sg field — passes (optional); (3) Valid summary with sg:[] — passes (empty array ok); (4) Invalid sg type (sg:\"string\" not array) — fails; (5) Invalid sg element (sg:[123]) — fails (must be strings); (6) sg with empty string element — fails; (7) All existing validate-summary.sh tests still pass (backward compat). These extend existing test-validate-summary.bats if it exists, otherwise create new.","f":["tests/unit/test-validate-summary-sg.bats"],"v":"bats tests/unit/test-validate-summary-sg.bats runs without syntax errors","done":false}
{"id":"T4","tp":"create","a":"Create tests/static/test-escalation-jsonl-schema.bats: Static validation tests for escalation.jsonl format: (1) Valid open entry — parses, has required fields (id, dt, agent, reason, sb, tgt, sev, st); (2) Valid resolved entry — has res field; (3) Invalid sev value — rejected; (4) Invalid st value — rejected; (5) Missing sb field — rejected (scope_boundary is required); (6) ID reuse across entries (same escalation chain) — valid; (7) Append-only invariant: entries with same ID must have monotonically increasing dt timestamps. Fixture files with sample escalation.jsonl content.","f":["tests/static/test-escalation-jsonl-schema.bats"],"v":"bats tests/static/test-escalation-jsonl-schema.bats runs without syntax errors","done":false}
{"id":"T5","tp":"create","a":"Create tests/static/test-test-results-jsonl-schema.bats: Static validation tests for test-results.jsonl format: (1) Valid entry — parses, has required fields (plan, dept, phase, tc, ps, fl, dt, tasks); (2) Valid dept values only (backend, frontend, uiux); (3) Valid phase values only (red, green); (4) tasks[] entries have required fields (id, ps, fl, tf); (5) ps + fl = tc at top level; (6) Sum of tasks[].ps = top-level ps; (7) tf[] must be non-empty array of strings. Fixture files with sample test-results.jsonl content.","f":["tests/static/test-test-results-jsonl-schema.bats"],"v":"bats tests/static/test-test-results-jsonl-schema.bats runs without syntax errors","done":false}
