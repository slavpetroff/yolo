{"p":"04","n":"02","t":"Dev-Senior review loop with sg consumption","w":1,"d":["04-01"],"mh":["review-loop.sh script created with max 2 cycle enforcement","Senior agents read sg from summary.jsonl during code review","code-review.jsonl verdict extended with sg_reviewed and sg_promoted fields","All 3 Senior agents (BE, FE, UX) updated with sg consumption protocol","Cycle state tracked in code-review.jsonl cycle field"],"obj":"Create the review-loop.sh script to enforce max 2 Dev→Senior code review cycles with explicit state tracking. Update Senior agents to consume sg from summary.jsonl and emit sg_reviewed/sg_promoted in code-review.jsonl verdict."}
{"id":"T1","tp":"create","a":"Create scripts/review-loop.sh: Orchestrates the Dev→Senior code review cycle with max 2 rounds. Script takes args: --phase-dir, --plan-id, --config (path to defaults.json). Logic: (1) Read max_cycles from config (defaults.json review_loop.max_cycles, default 2); (2) For cycle 1..max_cycles: check code-review.jsonl verdict line for plan, if r='approve' → exit 0 with JSON {cycles_used, result:'approve', sg_promoted:[]}; if r='changes_requested' and cycle < max → output JSON {cycle, status:'changes_requested', findings:[from code-review.jsonl]} for orchestrator to route to Dev; (3) If cycle = max_cycles and still changes_requested → exit 1 with JSON {cycles_used, result:'escalated', reason:'max cycles exceeded'}. Script does NOT spawn agents — it reads artifacts and returns status. The orchestrator (execute-protocol.md) uses this to decide whether to re-dispatch Dev+Senior or escalate. Use set -euo pipefail. Parse with jq only.","f":["scripts/review-loop.sh"],"v":"File exists, bash -n scripts/review-loop.sh exits 0, grep -c 'max_cycles' scripts/review-loop.sh returns >= 1","done":false}
{"id":"T2","tp":"modify","a":"Update references/artifact-formats.md: Add sg_reviewed and sg_promoted to code-review.jsonl verdict (line 1) schema. New entries in the Key Dictionary: sg_reviewed (integer, count of Dev suggestions Senior evaluated), sg_promoted (string[], suggestions promoted to next iteration or decisions.jsonl). Add tdd field if not already present (tdd, string, 'pass'|'fail'|'skip'). Add a note: 'sg_reviewed and sg_promoted are optional — present only when summary.jsonl contains sg field. Added in Phase 4.'","f":["references/artifact-formats.md"],"v":"grep -c 'sg_reviewed' references/artifact-formats.md returns 1; grep -c 'sg_promoted' references/artifact-formats.md returns 1","done":false}
{"id":"T3","tp":"modify","a":"Update agents/yolo-senior.md Code Review mode: (1) Add to inputs list: 'summary.jsonl sg field (if present) — Dev suggestions for consideration'. (2) Add sg consumption protocol: 'After reviewing code diff, read sg[] from summary.jsonl for this plan. For each suggestion: evaluate architectural soundness and scope fit. Count total evaluated as sg_reviewed in verdict. If a suggestion is sound but out of current spec scope, add to sg_promoted[] in verdict and append to decisions.jsonl as a future consideration. If a suggestion is already addressed by the implementation, note but do not promote.' (3) Update code-review.jsonl verdict example to include sg_reviewed:2, sg_promoted:[\"Extract token parser to shared util\"]. (4) Update the Phase 4 metric hooks comment to reference actual fields: cycle_count=cycle field, sg_reviewed, sg_promoted.","f":["agents/yolo-senior.md"],"v":"grep -c 'sg_reviewed' agents/yolo-senior.md returns >= 2; grep -c 'sg_promoted' agents/yolo-senior.md returns >= 2","done":false}
{"id":"T4","tp":"modify","a":"Update agents/yolo-fe-senior.md Code Review mode: Same sg consumption protocol as T3. FE-specific: when evaluating sg[], also consider component reusability, accessibility improvements, and CSS-in-JS consolidation suggestions from FE Dev. Update verdict schema with sg_reviewed/sg_promoted.","f":["agents/yolo-fe-senior.md"],"v":"grep -c 'sg_reviewed' agents/yolo-fe-senior.md returns >= 1","done":false}
{"id":"T5","tp":"modify","a":"Update agents/yolo-ux-senior.md Code Review mode: Same sg consumption protocol as T3. UX-specific: when evaluating sg[], also consider design system consistency, token reuse, and user flow optimization suggestions from UX Dev. Update verdict schema with sg_reviewed/sg_promoted.","f":["agents/yolo-ux-senior.md"],"v":"grep -c 'sg_reviewed' agents/yolo-ux-senior.md returns >= 1","done":false}
