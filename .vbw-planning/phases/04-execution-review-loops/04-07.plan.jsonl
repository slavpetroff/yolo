{"p":"04","n":"07","t":"Wire into execute-protocol, config, context manifests, TOON files","w":2,"d":["04-01","04-02","04-03","04-04","04-05"],"mh":["execute-protocol.md Step 7 updated with research_request handling and test-results.jsonl write","execute-protocol.md Step 8 updated with review-loop.sh integration and sg consumption","config/defaults.json extended with review_loop and research_requests sections","config/context-manifest.json updated with new artifact types","compile-context.sh updated for Senior sg extraction and Scout ra attribution","CLAUDE.md updated with Phase 4 decisions"],"obj":"Wire all Phase 4 features into the orchestration layer: execute-protocol.md steps, config defaults, context manifests, compile-context.sh, and CLAUDE.md. This is the integration plan that connects all Phase 4 artifacts into the running system."}
{"id":"T1","tp":"modify","a":"Update config/defaults.json: Add review_loop section: {max_cycles: 2}. Add research_requests section: {enabled: true, blocking_timeout_seconds: 120, max_concurrent_scouts: 4}. Add escalation.scope_boundary_required: true to existing escalation section. These are additive — no existing keys change.","f":["config/defaults.json"],"v":"jq '.review_loop.max_cycles' config/defaults.json returns 2; jq '.research_requests.enabled' config/defaults.json returns true; jq '.escalation.scope_boundary_required' config/defaults.json returns true","done":false}
{"id":"T2","tp":"modify","a":"Update config/context-manifest.json: Add new artifact type entries: (1) escalation — agents that receive it: lead, qa, owner; fields: id, agent, sb, tgt, sev, st, res; (2) test-results — agents that receive it: qa, qa-code, senior; fields: plan, dept, phase, tc, ps, fl, tasks; (3) Update existing summary entry to include sg in fields list for senior role. (4) Update existing research entry to include ra, rt in fields list for lead, architect roles. No new roles added — just new artifact types for existing roles.","f":["config/context-manifest.json"],"v":"jq '.artifacts | keys | index(\"escalation\")' config/context-manifest.json returns non-null; jq '.artifacts | keys | index(\"test-results\")' config/context-manifest.json returns non-null","done":false}
{"id":"T3","tp":"modify","a":"Update scripts/compile-context.sh: (1) In the senior case block, add extraction of sg field from summary.jsonl when compiling code review context: 'if summary.jsonl exists and has sg field, include sg[] in .ctx-senior.toon under suggestions: header'. (2) In the scout case block, add ra (requesting_agent) field from research request context when available. (3) In the qa case block, add escalation.jsonl extraction (count of open/resolved escalations). (4) In the lead case block, add test-results.jsonl extraction (summary counts). All changes use jq for extraction, follow existing case block patterns.","f":["scripts/compile-context.sh"],"v":"grep -c 'sg' scripts/compile-context.sh returns >= 1; grep -c 'escalation' scripts/compile-context.sh returns >= 1","done":false}
{"id":"T4","tp":"modify","a":"Update references/execute-protocol.md Step 7 (Implementation): After the Dev TDD protocol section and before Post-task QA Gate, add 'Research Request Handling' subsection: 'When Dev emits research_request output (detected in dev_progress or standalone message), orchestrator routes through resolve-research-request.sh: (1) Read request JSON; (2) If blocking: spawn Scout synchronously via Task tool with query+context, wait for result, write to research.jsonl with ra+rt fields, send research_response back to Dev; (3) If informational: queue Scout spawn, Dev continues, findings appended to research.jsonl after current task.' Also add after post-task QA gate: 'Test Results Collection: After all tasks in a plan pass GREEN, Dev writes test-results.jsonl with structured per-task metrics. Commit: docs({phase}): test results {NN-MM}.'","f":["references/execute-protocol.md"],"v":"grep -c 'resolve-research-request.sh' references/execute-protocol.md returns >= 1; grep -c 'test-results.jsonl' references/execute-protocol.md returns >= 1","done":false}
{"id":"T5","tp":"modify","a":"Update references/execute-protocol.md Step 8 (Code Review): (1) Add review-loop.sh integration: 'Orchestrator calls review-loop.sh --phase-dir --plan-id --config to manage cycle tracking. Script returns JSON with cycle status. On changes_requested: route Senior findings to Dev, Dev fixes, recommit, re-review. On escalated (max cycles exceeded): Lead decides accept-with-issues or escalate to Architect.' (2) Add sg consumption: 'Senior reads sg field from summary.jsonl during code review. Senior evaluates each suggestion, counts as sg_reviewed, promotes sound out-of-scope suggestions to sg_promoted[] and appends to decisions.jsonl.' Update CLAUDE.md Key Decisions table with Phase 4 decisions: (1) review-loop.sh enforces max 2 cycles; (2) Scout on-demand via research_request; (3) escalation.jsonl with scope_boundary; (4) test-results.jsonl for structured GREEN results; (5) sg field for Dev→Senior suggestions.","f":["references/execute-protocol.md","CLAUDE.md"],"v":"grep -c 'review-loop.sh' references/execute-protocol.md returns >= 1; grep -c 'sg_reviewed' references/execute-protocol.md returns >= 1; grep -c 'review-loop.sh' CLAUDE.md returns >= 0","done":false}
