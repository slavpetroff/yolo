{"phase":10,"plan":"10-11","title":"Token measurement and before/after validation","wave":4,"depends_on":["10-06","10-07","10-08","10-09"],"must_haves":["Measured token savings per role per phase","Total per-phase savings >50% validated","ROADMAP triplication eliminated (measured)","Dev context reduced 80-95% (measured)","Architect budget overflow fixed (measured)"]}
{"id":"T1","title":"Create token-measure.sh for before/after comparison","spec":"Create scripts/db/token-measure.sh. Usage: token-measure.sh --phase <PHASE> [--role ROLE] [--db PATH] [--output json|toon]. Behavior: (1) Run compile-context.sh with --measure flag (existing) for file-based baseline, (2) Run compile-context.sh with DB-enabled path, (3) Compare token counts: file-based vs SQL-based per role, (4) Output table: role, file_tokens, sql_tokens, savings_pct, savings_abs. For --role flag, measure single role. Default measures all 16 roles. Store results in DB: CREATE TABLE token_measurements (phase, role, file_tokens INT, sql_tokens INT, measured_at).","files":["scripts/db/token-measure.sh"],"tests":["tests/unit/db/token-measure.bats: measures all roles, calculates savings correctly, stores in DB, JSON output valid"]}
{"id":"T2","title":"Validate ROADMAP triplication elimination","spec":"Create tests/integration/db/roadmap-dedup.bats. Test: (1) Set up DB with ROADMAP data imported, (2) Compile context for critic, architect, lead (the 3 ROADMAP readers), (3) Count total tokens for ROADMAP-derived content across all 3 roles, (4) Assert total < 2,000 tokens (vs 11,811 baseline = 83% savings), (5) Assert each role gets targeted data (critic gets full context, architect gets goals+reqs, lead gets summary), (6) Assert no role reads ROADMAP.md file directly when DB available.","files":["tests/integration/db/roadmap-dedup.bats"],"tests":["Self-testing: the test file IS the test"]}
{"id":"T3","title":"Validate Dev context reduction","spec":"Create tests/integration/db/dev-context-reduction.bats. Test: (1) Set up DB with a 7-task plan (realistic), (2) Compile context for dev role via file path: measure tokens, (3) Compile context for dev role via SQL path: measure tokens, (4) Assert SQL path < 150 tokens per task (vs 1,064 file-based), (5) Assert savings > 85%, (6) Assert spec field present and complete (no lossy truncation), (7) Test with 3 plans in phase: assert dev sees only assigned plan's tasks. Expected: 1,064 â†’ ~75 tokens = 93% savings.","files":["tests/integration/db/dev-context-reduction.bats"],"tests":["Self-testing: the test file IS the test"]}
{"id":"T4","title":"Validate Architect budget overflow fix","spec":"Create tests/integration/db/architect-budget.bats. Test: (1) Set up DB with large phase: ROADMAP (3,937 tokens worth), REQUIREMENTS (1,500 tokens), research (2,000 tokens), critique (1,000 tokens), codebase (500 tokens), (2) Compile architect context via file path: assert overflow triggers truncation, (3) Compile architect context via SQL path: assert NO overflow (targeted queries return only needed data), (4) Assert architect sees complete goals, requirements, and research (no lossy truncation), (5) Assert total SQL context < 5,000 token budget.","files":["tests/integration/db/architect-budget.bats"],"tests":["Self-testing: the test file IS the test"]}
{"id":"T5","title":"Create token-audit-report.sh for phase-level summary","spec":"Create scripts/db/token-audit-report.sh. Usage: token-audit-report.sh --phase <PHASE> [--db PATH] [--baseline PHASE]. Behavior: (1) Run token-measure.sh for all roles, (2) Aggregate: total_file_tokens, total_sql_tokens, total_savings, per_role_breakdown, (3) Compare against baseline phase if --baseline provided, (4) Output formatted report: phase header, per-role table, totals, verdict (PASS if >50% savings, WARN if 30-50%, FAIL if <30%). Store report in DB: token_audit_reports table. This is the Phase 10 success criteria validation tool.","files":["scripts/db/token-audit-report.sh"],"tests":["tests/unit/db/token-audit-report.bats: generates report, calculates totals, verdict logic correct, stores in DB"]}
