{"phase":10,"plan":"10-12","title":"Migration utilities and backward compatibility layer","wave":4,"depends_on":["10-06","10-07","10-08"],"must_haves":["Full migration from JSONL to SQLite for existing milestones","Backward compatible: all workflows work without DB","Rollback path: export DB back to JSONL files","Dual-write mode during transition","Migration tested on realistic data set"]}
{"id":"T1","title":"Create migrate-milestone.sh for full milestone migration","spec":"Create scripts/db/migrate-milestone.sh. Usage: migrate-milestone.sh --planning-dir <PATH> [--db PATH] [--dry-run]. Behavior: (1) Call init-db.sh to create/verify DB, (2) Import ROADMAP and requirements via import-roadmap.sh + import-requirements.sh, (3) For each phase directory: import all .plan.jsonl, .summary.jsonl, critique.jsonl, research.jsonl, decisions.jsonl, escalation.jsonl, gaps.jsonl, code-review.jsonl, test-plan.jsonl, test-results.jsonl, qa-gate-results.jsonl, security-audit.jsonl, (4) Import research-archive.jsonl, (5) Report: 'Migrated: N phases, M plans, K tasks, L research entries, J decisions'. --dry-run counts without importing.","files":["scripts/db/migrate-milestone.sh"],"tests":["tests/unit/db/migrate-milestone.bats: migrates all artifact types, dry-run counts correctly, idempotent re-migration"]}
{"id":"T2","title":"Create export-milestone.sh for DB-to-JSONL rollback","spec":"Create scripts/db/export-milestone.sh. Usage: export-milestone.sh --planning-dir <PATH> [--db PATH] [--phase PHASE]. Behavior: For each table, SELECT * and format as JSONL with abbreviated keys matching artifact-formats.md schemas. Write to appropriate files in phase directories: plans → {NN-MM}.plan.jsonl (header line + task lines), summaries → {NN-MM}.summary.jsonl, critique → critique.jsonl, etc. --phase exports single phase, default exports all. This is the safety net: if SQLite causes issues, export back to files and continue with file-based system.","files":["scripts/db/export-milestone.sh"],"tests":["tests/unit/db/export-milestone.bats: exported JSONL matches original format, plan header+tasks format correct, round-trip import→export matches source"]}
{"id":"T3","title":"Add dual-write mode to state-updater.sh","spec":"Modify scripts/state-updater.sh. Add DB write path: when yolo.db exists, update both files AND DB tables. Specifically: (1) On plan write: import-jsonl.sh --type plan, (2) On summary write: import-jsonl.sh --type summary, (3) On state transitions: update-status.sh for state table, (4) On execution-state changes: UPDATE execution_state table. This ensures DB stays in sync during the migration period when some code paths still write files directly. Detect DB via: [ -f \"${PLANNING_DIR}/yolo.db\" ].","files":["scripts/state-updater.sh"],"tests":["tests/unit/state-updater.bats: dual-write updates both file and DB, works without DB (backward compatible)"]}
{"id":"T4","title":"Add DB cleanup to session-stop.sh and cache-nuke.sh","spec":"Modify scripts/session-stop.sh: Add WAL checkpoint on session end (PRAGMA wal_checkpoint(PASSIVE)) to flush pending writes. Modify scripts/cache-nuke.sh: Add yolo.db and yolo.db-wal and yolo.db-shm to cleanup targets (alongside existing .ctx-*.toon cleanup). Add --keep-db flag to cache-nuke.sh to preserve DB while clearing other caches. This ensures clean session lifecycle for the DB.","files":["scripts/session-stop.sh","scripts/cache-nuke.sh"],"tests":["tests/unit/session-stop.bats: WAL checkpoint called on stop, tests/unit/cache-nuke.bats: DB files cleaned, --keep-db preserves DB"]}
{"id":"T5","title":"Create verify-migration.sh for migration integrity validation","spec":"Create scripts/db/verify-migration.sh. Usage: verify-migration.sh --planning-dir <PATH> [--db PATH]. Behavior: (1) For each JSONL file, count lines and compare with DB row count for corresponding table, (2) Spot-check: randomly select 5 entries from each artifact type, compare JSONL content with DB content, (3) Verify FTS5 indexes are populated (search for known terms), (4) Verify task queue state matches summary.jsonl completion status, (5) Report: mismatches, missing entries, extra entries, FTS coverage. Exit 0 if clean, exit 1 if discrepancies found.","files":["scripts/db/verify-migration.sh"],"tests":["tests/unit/db/verify-migration.bats: detects matching state, detects missing rows, detects FTS gaps, reports discrepancies"]}
