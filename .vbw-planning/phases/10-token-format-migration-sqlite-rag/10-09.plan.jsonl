{"phase":10,"plan":"10-09","title":"WAL mode stress testing and concurrent access hardening","wave":3,"depends_on":["10-01","10-03","10-04","10-06"],"must_haves":["15+ concurrent readers never block","Concurrent writes serialize correctly via WAL","busy_timeout prevents SQLITE_BUSY errors","No data corruption under parallel agent load","Deadlock-free transaction patterns"]}
{"id":"T1","title":"Create concurrent read stress test","spec":"Create tests/integration/db/concurrent-reads.bats. Test: (1) Initialize DB with 100+ tasks across 10 plans, (2) Launch 15 parallel subshells each calling get-task.sh, get-summaries.sh, search-research.sh simultaneously, (3) Verify all 15 return correct results (no SQLITE_BUSY, no empty results, no corruption), (4) Measure total wall-clock time (should be <2s for 15 parallel reads), (5) Verify WAL mode maintained throughout (PRAGMA journal_mode returns 'wal'). Use bash background jobs (&) and wait to parallelize.","files":["tests/integration/db/concurrent-reads.bats"],"tests":["Self-testing: the test file IS the test"]}
{"id":"T2","title":"Create concurrent write stress test","spec":"Create tests/integration/db/concurrent-writes.bats. Test: (1) Initialize DB with 20 pending tasks, (2) Launch 10 parallel subshells each calling next-task.sh (simulating 10 Dev agents claiming tasks), (3) Verify each task claimed exactly once (no double-assignment), (4) Verify total claimed = 10 (one per agent), (5) Verify remaining 10 tasks still pending. Also test: 5 parallel append-finding.sh calls to critique table, verify all 5 inserted (no lost writes). Test busy_timeout by adding a slow transaction and verifying others wait rather than fail.","files":["tests/integration/db/concurrent-writes.bats"],"tests":["Self-testing: the test file IS the test"]}
{"id":"T3","title":"Create mixed read-write concurrent test","spec":"Create tests/integration/db/concurrent-mixed.bats. Test: (1) Initialize DB with 30 tasks, (2) Launch mix of 5 writers (complete-task.sh) + 10 readers (get-summaries.sh, check-phase-status.sh) simultaneously, (3) Verify readers never see partial writes (atomicity), (4) Verify writers all succeed, (5) Final state matches expected (5 tasks complete, 25 pending), (6) check-phase-status.sh returns consistent percentages throughout. This validates WAL mode's readers-never-block-writers guarantee under real workload.","files":["tests/integration/db/concurrent-mixed.bats"],"tests":["Self-testing: the test file IS the test"]}
{"id":"T4","title":"Add connection pooling and retry logic to db-common.sh","spec":"Modify scripts/db/db-common.sh. Add: (1) SQLITE_BUSY_RETRIES=3 constant, (2) sql_with_retry() function that retries on SQLITE_BUSY with exponential backoff (100ms, 200ms, 400ms), (3) Ensure PRAGMA busy_timeout=5000 is set on every connection (not just init), (4) Add PRAGMA synchronous=NORMAL for write performance (WAL mode makes this safe), (5) Add connection validation: PRAGMA integrity_check before first query in each script (optional, --verify flag). Update all write scripts (insert-task.sh, complete-task.sh, append-finding.sh, update-status.sh) to use sql_with_retry() instead of raw sqlite3.","files":["scripts/db/db-common.sh"],"tests":["tests/unit/db/db-common.bats: retry logic handles simulated busy, PRAGMA set on every connection, integrity_check works"]}
{"id":"T5","title":"Add WAL checkpoint management","spec":"Create scripts/db/checkpoint-db.sh. Usage: checkpoint-db.sh [--db PATH] [--mode passive|full|restart|truncate]. Behavior: PRAGMA wal_checkpoint(MODE). Default mode is PASSIVE (non-blocking). Called by go.md at end of phase execution (after all agents complete) with --mode truncate to reclaim WAL space. Also add to init-db.sh: PRAGMA wal_autocheckpoint=1000 (checkpoint every 1000 pages). Add monitoring: output WAL size, pages in WAL, pages checkpointed. This prevents unbounded WAL growth during long phases with many agent writes.","files":["scripts/db/checkpoint-db.sh"],"tests":["tests/unit/db/checkpoint-db.bats: passive checkpoint succeeds, truncate reclaims space, WAL size reported"]}
